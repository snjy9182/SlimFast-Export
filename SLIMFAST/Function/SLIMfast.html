
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>SLIMfast</title><meta name="generator" content="MATLAB 7.12"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-07-02"><meta name="DC.source" content="SLIMfast.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">DATA</a></li><li><a href="#5">VISUALIZATION</a></li><li><a href="#6">ANALYSIS</a></li><li><a href="#7">LOCALIZATION</a></li><li><a href="#9">positions des parametres</a></li><li><a href="#10">detection pour un rayon moyen r0</a></li><li><a href="#11">estimation pour des pas de recherche</a></li><li><a href="#12">interval [-1,1] pour ij</a></li><li><a href="#13">interval [0.6,1.4] pour le rayon</a></li><li><a href="#16">Hypothese H0</a></li><li><a href="#17">pas de particule dans la fenetre</a></li><li><a href="#18">H0 = T/2*log(2*pi*sig0^2)-T/2 ;</a></li><li><a href="#19">Hypoth?se H1</a></li><li><a href="#20">une particule est au centre de la fenetre</a></li><li><a href="#21">amplitude inconnue, rayon fixe</a></li><li><a href="#22">generation masque gaussien de largeur (sigma)</a></li><li><a href="#23">egal a rayon</a></li><li><a href="#24">H1 = T/2*log(2*pi*sig1^2)-T/2 ;</a></li><li><a href="#25">pour test</a></li><li><a href="#26">carte_MV = -0.5*(H0 - H1) ;</a></li><li><a href="#27">detection et recherche des maximas</a></li><li><a href="#28">s_pfa = 28 ;</a></li><li><a href="#30">g de puissance unitaire</a></li><li><a href="#34">on stop si l_on sort des bornes</a></li><li><a href="#37">p_di, p_dj les precedents deplacements</a></li><li><a href="#38">qui ont conduit a p_r, p_i, p_j</a></li><li><a href="#39">on boucle, en diminuant les deplacements</a></li><li><a href="#40">tand que le nouveau critere en plus grand</a></li><li><a href="#42">puissance unitaire</a></li><li><a href="#43">alpha estime MV</a></li><li><a href="#44">m estime MV</a></li><li><a href="#45">critere avant deplacement</a></li><li><a href="#47">der_g</a></li><li><a href="#48">derder_g</a></li><li><a href="#49">der_J /2</a></li><li><a href="#50">derder_J /2</a></li><li><a href="#51">deplacement par Gauss-Newton</a></li><li><a href="#54">parametre dans liste_est :</a></li><li><a href="#55">liste_param = [num, i, j, alpha, sig^2, rayon, ok]</a></li><li><a href="#57">puissance unitaire</a></li><li><a href="#59">noise model</a></li><li><a href="#60">mean amplitude</a></li><li><a href="#61">offset</a></li><li><a href="#62">residuals</a></li><li><a href="#63">noise power</a></li><li><a href="#66">noise model</a></li><li><a href="#68">mean amplitude</a></li><li><a href="#69">offset</a></li><li><a href="#70">residuals</a></li><li><a href="#71">noise power</a></li><li><a href="#74">TRACKING</a></li><li><a href="#77">initialize parameter tables</a></li><li><a href="#78">set initial variance guess (20% by default) -&gt; nested by CPR</a></li><li><a href="#79">initialize tracks</a></li><li><a href="#81">CYCLE THROUGH ACTIVE TRAJECTORIES   %%</a></li><li><a href="#82">reconnection test</a></li><li><a href="#83">update tables</a></li><li><a href="#85">11/07/06</a></li><li><a href="#86">test for ephemerid detection</a></li><li><a href="#89">shift tables one step to the left</a></li><li><a href="#90">update tracks</a></li><li><a href="#93">boucle sur les particules</a></li><li><a href="#95">alpha</a></li><li><a href="#96">r</a></li><li><a href="#97">i,j</a></li><li><a href="#98">blink pour info</a></li><li><a href="#99">affection identique a (t_red-1)-1</a></li><li><a href="#100">pour compat avec mise_a_jour_tab</a></li><li><a href="#102">alpha</a></li><li><a href="#103">r</a></li><li><a href="#104">i,j</a></li><li><a href="#105">blink pour info</a></li><li><a href="#110">boucle sur les particules</a></li><li><a href="#111">alpha</a></li><li><a href="#112">modif le 12-11-07</a></li><li><a href="#113">compatibilite avec rapport_detection</a></li><li><a href="#114">suite a la prise en compte de la loi</a></li><li><a href="#115">uniforme + gaussien pour alpha</a></li><li><a href="#116">si modif verifer rapport_detection.m</a></li><li><a href="#118">on ne met a jour des stats mean var</a></li><li><a href="#119">que si on est en hypothese gaussienne</a></li><li><a href="#120">sinon on bloque les stats</a></li><li><a href="#121">determination du mode par vraisemblance</a></li><li><a href="#122">gaussienne (1)</a></li><li><a href="#124">uniforme (2)</a></li><li><a href="#126">r</a></li><li><a href="#127">i,j</a></li><li><a href="#128">borne a diff libre</a></li><li><a href="#130">blink pour info</a></li><li><a href="#132">determine la reference (parametre moyen)</a></li><li><a href="#133">et ecart type du param</a></li><li><a href="#134">determine sur la derniere zone de non blink</a></li><li><a href="#135">et limite a une longueur T</a></li><li><a href="#136">moy_alpha et sig_alpha (resp r) gardent leur valeur pendant un blink</a></li><li><a href="#137">moy_i/j ne sert pas</a></li><li><a href="#138">sig_i/j</a></li><li><a href="#139">sig_i/j voient leur valeur augmenter pendant le blink</a></li><li><a href="#140">en suivant la variation sqrt(nb_blink)*sig_i_avant_blink</a></li><li><a href="#141">pris en compte dans sigij_blink</a></li><li><a href="#142">param = 5 : alpha</a></li><li><a href="#143">param = 6 : r</a></li><li><a href="#144">param = 3 : i</a></li><li><a href="#145">param = 4 : j</a></li><li><a href="#146">offset de zone de blink nb_blink==(-offset)</a></li><li><a href="#147">duree de la derniere partie ON de la iTraj</a></li><li><a href="#149">si alpha, il faut aussi la valeur max</a></li><li><a href="#150">en plus de la valeur moyenne</a></li><li><a href="#151">on le met sur l'axe imaginaire! 160307</a></li><li><a href="#153">On bloque la valeur a la derniere valeur avant zone de blink</a></li><li><a href="#154">la derniere info valable dans le passe</a></li><li><a href="#159">evite les allocations sur des constantes</a></li><li><a href="#160">Pre-detection</a></li><li><a href="#161">reconnexion de la particule num part</a></li><li><a href="#162">set trajectory status to BLINK</a></li><li><a href="#164">plusieurs particule candidate</a></li><li><a href="#165">on prend celle la plus probable</a></li><li><a href="#166">limitation du nb de trajectoire</a></li><li><a href="#167">en competition</a></li><li><a href="#168">prise en compte des particules</a></li><li><a href="#169">qui seraient dans les boules de recherche</a></li><li><a href="#170">des trajectoires en competition</a></li><li><a href="#171">"On travail ici a l'ordre 1"</a></li><li><a href="#172">passage a l_ordre 1</a></li><li><a href="#173">limite du nb de particules</a></li><li><a href="#174">en competition</a></li><li><a href="#175">recherche de la meilleur config par</a></li><li><a href="#176">maximum de vraisemblance</a></li><li><a href="#177">pas le blink</a></li><li><a href="#178">mais possiblilite de nouvelle particule (&lt;)</a></li><li><a href="#180">nb_traj &gt; nb_part_boule</a></li><li><a href="#181">des particules ont blinkees</a></li><li><a href="#186">distances au point C</a></li><li><a href="#187">classement</a></li><li><a href="#190">init des trajectoires a tester</a></li><li><a href="#192">fenetre de recherche des trajectoires</a></li><li><a href="#193">boule de recherche en ecartype</a></li><li><a href="#195">trajectoires a tester</a></li><li><a href="#196">celles non encore reconnectees</a></li><li><a href="#197">test 22 11 07 : celles qui ne sont pas blinkee</a></li><li><a href="#198">on enleve la ref</a></li><li><a href="#199">les trajectoires en question</a></li><li><a href="#202">evite les allocations sur des constantes</a></li><li><a href="#203">generation d_un masque</a></li><li><a href="#207">evite les allocations sur des constantes</a></li><li><a href="#208">==============================================</a></li><li><a href="#209">test glrt avec parametre estime pour new traj</a></li><li><a href="#210">==============================================</a></li><li><a href="#212">glrt_1vue : le meme que dans carte_H0H1</a></li><li><a href="#213">mais ici calcule pour les parametres estimes</a></li><li><a href="#214">pour les particules nouvelles</a></li><li><a href="#216">P(x|H1)</a></li><li><a href="#217">deja calcule lors de l'estimation 1 vue</a></li><li><a href="#218">P(x|H0)</a></li><li><a href="#219">probleme lors des deflations!!!</a></li><li><a href="#221">==============================================</a></li><li><a href="#222">vraisemblance de la reconnexion traj <a href="-">-</a> part</a></li><li><a href="#223">==============================================</a></li><li><a href="#224">proba de reapparition pendant un blink (blinch)</a></li><li><a href="#225">gaussienne &gt; 0</a></li><li><a href="#226">nb_blink</a></li><li><a href="#227">intensite des pics</a></li><li><a href="#228">P(alpha|H1)</a></li><li><a href="#229">c'est un melange de loi uniforme et gaussienne</a></li><li><a href="#230">on travail a tres faible nombre d'echantillons</a></li><li><a href="#231">estimer la proportion uni/gauss est tres difficile</a></li><li><a href="#232">ancienne version _old</a></li><li><a href="#233">on fait plutot un test de vraisemblance uni/gauss</a></li><li><a href="#234">on est don, soit gaussienne, soit uniforme</a></li><li><a href="#235">nouvelle version : la loi est une combinaison</a></li><li><a href="#236">d'une loi uniforme et gaussienne</a></li><li><a href="#237">en effet, l'estimation conjointe des parametres</a></li><li><a href="#238">avec melange n'est possible qu'a grand nombre d echantillons</a></li><li><a href="#239">ici : a nombre d echantillons reduits on test si</a></li><li><a href="#240">le comportement et plutot gaussien ou uniforme (MV)</a></li><li><a href="#241">si uniforme, on garde les anciens parametres</a></li><li><a href="#242">si gaussien, on met a jour moyenne et variance</a></li><li><a href="#244">Attention, les para metres des lois (les stats m, var)</a></li><li><a href="#245">sont mis a jour par la fonction mise_a_jour_tab.m</a></li><li><a href="#246">dans les tableaux tab_moy et tab_var</a></li><li><a href="#248">si modif verifer mise_a_jour_tab.m</a></li><li><a href="#249">gaussienne (1)</a></li><li><a href="#250">uniforme (2)</a></li><li><a href="#251">vraisemblance de traj a intensitee full</a></li><li><a href="#252">nb_alpha_full = mod(tab_param(traj,7*t+8), Nb_STK);</a></li><li><a href="#253">vraisemblance position / mvt brownien (libre/confine)</a></li><li><a href="#254">P(n0|H1)</a></li><li><a href="#255">P(r|H1)</a></li><li><a href="#256">vraisemblance</a></li><li><a href="#259">offset de zone de blink nb_blink==(-offset)</a></li><li><a href="#260">sigi = sigj</a></li><li><a href="#261">prise en compte du blink pour sig_i/j</a></li><li><a href="#264">offset</a></li><li><a href="#265">offset de zone de blink nb_blink==(-offset)</a></li><li><a href="#266">offset = 0 si non_blink (&gt;0)</a></li><li><a href="#267">idem sinon ;</a></li><li><a href="#268">sigi = sigj</a></li><li><a href="#269">prise en compte du blink pour sig_i/j</a></li><li><a href="#272">permutation circulaire sur vec_part</a></li><li><a href="#273">limite a la taille nb_traj</a></li><li><a href="#275">si plus de particules que de traj</a></li><li><a href="#276">cas de nouvelle traj</a></li><li><a href="#277">on test les nb_traj premiere</a></li><li><a href="#280">EXTRAS</a></li><li><a href="#282">localization</a></li><li><a href="#283">render</a></li><li><a href="#284">filters</a></li><li><a href="#285">scalebar</a></li><li><a href="#286">optics</a></li><li><a href="#287">tracking</a></li><li><a href="#289">channel</a></li><li><a href="#290">localization</a></li><li><a href="#291">rendering</a></li><li><a href="#292">filters</a></li><li><a href="#293">optics</a></li><li><a href="#294">tracking</a></li><li><a href="#300">switch tabs</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> SLIMfast
dbstop <span class="string">if</span> <span class="string">error</span>
<span class="comment">%FRONTPAGE</span>
figure(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'root'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.4 0.9 0.2 eps],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'SLIMfast Build 1.103e'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'off'</span>);

h.menuDataLoad =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Load'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoad,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Imagestack'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @loadData);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoad,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Superstack'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @loadData);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoad,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Batch'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @batchLocalization);

h.menuDataLoadParCoords =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoad,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Particle Data'</span>,<span class="keyword">...</span>
    <span class="string">'Separator'</span>, <span class="string">'on'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoadParCoords,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'SLIMfast'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @loadData);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoadParCoords,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'FPALM'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @loadData,<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataLoad,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Tracking Data'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @loadData);

h.menuImageChannels =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Channels'</span>);
h.menuDataMode =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Mode'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataMode,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'monoView'</span>,<span class="keyword">...</span>
    <span class="string">'Checked'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @mergeChannels);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataMode,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'dualView'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @mergeChannels);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuDataMode,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'tripleView'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @mergeChannels);

h.menuImageChannel(1) =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'menuRedChannel'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Red Channel'</span>,<span class="keyword">...</span>
    <span class="string">'Separator'</span>, <span class="string">'on'</span>);
h.menuImageChannel(2) =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'menuGreenChannel'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Green Channel'</span>);
h.menuImageChannel(3) =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'menuBlueChannel'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Blue Channel'</span>);
h.menuImageChannel(4) =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'menuGrayChannel'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Gray Channel'</span>,<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>);
h.menuTrackChannel =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'menuTrackChannel'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.menuImageChannels,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Track Channel'</span>);

<span class="comment">% h.menuAnalyse =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Label', 'Analysis');</span>
<span class="comment">%</span>
<span class="comment">% h.menuAnalyseKinetics =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyse,...</span>
<span class="comment">%     'Label', 'Kinetics');</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseKinetics,...</span>
<span class="comment">%     'Label', 'Build Trajectories',...</span>
<span class="comment">%     'Callback', @buildTracks,...</span>
<span class="comment">%     'Enable', 'off')</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseKinetics,...</span>
<span class="comment">%     'Label', 'PICS',...</span>
<span class="comment">%     'Callback', @particleImageCorrelation)</span>
<span class="comment">%</span>
<span class="comment">% h.menuAnalyseFilters =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyse,...</span>
<span class="comment">%     'Label', 'Filters');</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseFilters,...</span>
<span class="comment">%     'Label', 'Co-Localization',...</span>
<span class="comment">%     'Callback', @colocFilter)</span>

<span class="comment">% h.menuAnalyseFilters =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyse,...</span>
<span class="comment">%     'Label', 'Particle Filters');</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseFilters,...</span>
<span class="comment">%     'Label', 'Clustering')</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseFilters,...</span>
<span class="comment">%     'Label', 'Cross-Clustering')</span>
<span class="comment">% uimenu(...</span>
<span class="comment">%     'Parent', h.menuAnalyseFilters,...</span>
<span class="comment">%     'Label', 'Co-Localization')</span>

<span class="comment">% h.menuVisualize =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Label', 'Visualization');</span>
<span class="comment">%</span>
<span class="comment">% %% scatter plot</span>
<span class="comment">% h.menuVisualizeScatter =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualize,...</span>
<span class="comment">%     'Label', 'Scatter Plot');</span>
<span class="comment">% h.menuVisualizeScatter2D =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter,...</span>
<span class="comment">%     'Label', '2-D');</span>
<span class="comment">% h.menuVisualizeScatter2DFrame =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter2D,...</span>
<span class="comment">%     'Label', 'Image',...</span>
<span class="comment">%     'Callback', @scatterPlot);</span>
<span class="comment">% h.menuVisualizeScatter2DMovie =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter2D,...</span>
<span class="comment">%     'Label', 'Movie',...</span>
<span class="comment">%     'Callback', @scatterPlot,...</span>
<span class="comment">%     'Enable', 'off');</span>
<span class="comment">% h.menuVisualizeScatter3D =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter,...</span>
<span class="comment">%     'Label', '3-D');</span>
<span class="comment">% h.menuVisualizeScatter3DFrame =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter3D,...</span>
<span class="comment">%     'Label', 'Image',...</span>
<span class="comment">%     'Callback', @scatterPlot);</span>
<span class="comment">% h.menuVisualizeScatter3DMovie =...</span>
<span class="comment">%     uimenu(...</span>
<span class="comment">%     'Parent', h.menuVisualizeScatter3D,...</span>
<span class="comment">%     'Label', 'Movie',...</span>
<span class="comment">%     'Callback', @scatterPlot,...</span>
<span class="comment">%     'Enable', 'off');</span>

h.extras =<span class="keyword">...</span>
    uimenu(<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Extras'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.extras,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Help'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @showHelp,<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.extras,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Credits'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @showCredits);
uimenu(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, h.extras,<span class="keyword">...</span>
    <span class="string">'Label'</span>, <span class="string">'Changelog'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @showChangeLog);

<span class="comment">%icon grafics</span>
icon.Arrow =<span class="keyword">...</span>
    [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 1 NaN, NaN, NaN, NaN];

icon.roi =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.colormap =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;<span class="keyword">...</span>
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;<span class="keyword">...</span>
    0, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0, 0, 0, NaN, 0, 0, NaN;<span class="keyword">...</span>
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0,; <span class="keyword">...</span>
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, 0, 0; <span class="keyword">...</span>
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, 0, NaN,; <span class="keyword">...</span>
    0, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0,; <span class="keyword">...</span>
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;<span class="keyword">...</span>
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;<span class="keyword">...</span>
    0, 0, NaN, 0, 0, NaN, NaN, 0, 0, NaN, NaN, 0, 0, 0, NaN, NaN,; <span class="keyword">...</span>
    0, NaN, 0, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN,; <span class="keyword">...</span>
    0, NaN, 0, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN; <span class="keyword">...</span>
    0, NaN, NaN, NaN, 0, NaN, 0, 0, 0, 0, NaN, 0, 0, 0, NaN, NaN,; <span class="keyword">...</span>
    0, NaN, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    0, NaN, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, NaN, NaN; <span class="keyword">...</span>
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.fit =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,0,0,0,0,0,0;
    NaN,0,0,0,0,0,NaN,0,0,NaN,0,0,0,0,0,0;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.options =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.opt2txt =<span class="keyword">...</span>
    [NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,0,0,NaN,0,NaN,NaN,0,NaN,0,0,0,0,0;
    NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;];

icon.save =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,NaN,0,NaN,0,0,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,NaN,0,NaN,0,0,0,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,0,0,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,NaN;
        NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.testLoc =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.locAll =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.intDist =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,NaN,0,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.s2nDist =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,0,NaN,NaN,NaN,NaN,0,NaN,0,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,NaN,NaN,NaN,0,0,NaN,0,NaN,0,NaN,NaN,0;
    0,0,0,0,NaN,NaN,0,0,NaN,NaN,0,NaN,NaN,0,NaN,0;
    NaN,NaN,NaN,0,NaN,0,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0;
    0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.precDist =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,0,0,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.locDist =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.maxProj =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,0,0,NaN,0,0,0,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.aveProj =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,0,0,NaN,0,0,0,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genMov =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genIm =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genTraj =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    NaN,0,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN,NaN,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.scatter3D = <span class="keyword">...</span>
[NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,0,NaN,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,0,NaN,0,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0;
    0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,0;
    NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.playMov =<span class="keyword">...</span>
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,NaN,0;
    0,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0;
    0,0,0,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    0,NaN,NaN,NaN,0,0,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

setappdata(1, <span class="string">'handles'</span>, h)
setappdata(1, <span class="string">'icons'</span>, icon)
setappdata(0, <span class="string">'searchPath'</span>, pwd)
<span class="keyword">end</span>
</pre><h2>DATA<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> loadData(src, event)
icon = getappdata(1, <span class="string">'icons'</span>);

<span class="comment">%initialize figure</span>
fig = figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);

<span class="keyword">switch</span> get(src, <span class="string">'Label'</span>)
    <span class="keyword">case</span> <span class="string">'Imagestack'</span>
        <span class="comment">%initialize variables</span>
        setappdata(fig,<span class="string">'isOwn'</span>,1)
        setappdata(fig,<span class="string">'isLoaded'</span>,0)
        setappdata(fig,<span class="string">'isSuperstack'</span>,0)
        setappdata(fig,<span class="string">'isTrack'</span>,0)
        setappdata(fig,<span class="string">'frame'</span>,1)
        setappdata(fig,<span class="string">'viewMode'</span>,<span class="string">'monoView'</span>)

        <span class="comment">%Loc Options</span>
        setappdata(fig,<span class="string">'locStart'</span>,1)
        setappdata(fig,<span class="string">'locEnd'</span>,inf)
        setappdata(fig,<span class="string">'errorRate'</span>,-6)
        setappdata(fig,<span class="string">'w2d'</span>,9)
        setappdata(fig,<span class="string">'dfltnLoops'</span>,0)
        setappdata(fig,<span class="string">'minInt'</span>,0)
        setappdata(fig,<span class="string">'locParallel'</span>,0)
        setappdata(fig,<span class="string">'nCores'</span>,1)
        setappdata(fig,<span class="string">'spatialCorrection'</span>,0)
        setappdata(fig,<span class="string">'isRadiusTol'</span>,0)
        setappdata(fig,<span class="string">'radiusTol'</span>,50)
        setappdata(fig,<span class="string">'posTol'</span>,1.5)
        setappdata(fig,<span class="string">'maxOptimIter'</span>,50)
        setappdata(fig,<span class="string">'termTol'</span>,-2)

        <span class="comment">%Bar Options</span>
        setappdata(fig,<span class="string">'isScalebar'</span>,0)
        setappdata(fig,<span class="string">'micronBarLength'</span>,1000)
        setappdata(fig,<span class="string">'isColormap'</span>,0)
        setappdata(fig,<span class="string">'isTimestamp'</span>,0)
        setappdata(fig,<span class="string">'timestampSize'</span>,2)
        setappdata(fig,<span class="string">'timestampInkrement'</span>,0.032)
        setappdata(fig,<span class="string">'colormapWidth'</span>,10)

        <span class="comment">%Render Options</span>
        setappdata(fig,<span class="string">'exfOld'</span>,1)
        setappdata(fig,<span class="string">'exfNew'</span>,5)
        setappdata(fig,<span class="string">'rW'</span>,50)
        setappdata(fig,<span class="string">'rStep'</span>,10)
        setappdata(fig,<span class="string">'rStart'</span>,1)
        setappdata(fig,<span class="string">'rEnd'</span>,inf)
        setappdata(fig,<span class="string">'rLive'</span>,0)
        setappdata(fig,<span class="string">'fps'</span>,25)
        setappdata(fig,<span class="string">'movCompression'</span>,1)
        setappdata(fig,<span class="string">'convMode'</span>,1)
        setappdata(fig,<span class="string">'intWeight'</span>,0.01)
        setappdata(fig,<span class="string">'sizeFac'</span>,1)
        setappdata(fig,<span class="string">'isCumsum'</span>,0)

        <span class="comment">%Filter Options</span>
        setappdata(fig,<span class="string">'isThreshLocPrec'</span>,0)
        setappdata(fig,<span class="string">'minLoc'</span>,0)
        setappdata(fig,<span class="string">'maxLoc'</span>,inf)
        setappdata(fig,<span class="string">'isThreshSNR'</span>,0)
        setappdata(fig,<span class="string">'minSNR'</span>,0)
        setappdata(fig,<span class="string">'maxSNR'</span>,inf)
        setappdata(fig,<span class="string">'isThreshDensity'</span>,0)
        setappdata(fig,<span class="string">'clusterMode'</span>,1)

        <span class="comment">%Optics Options</span>
        setappdata(fig,<span class="string">'pxSize'</span>,0.107)
        setappdata(fig,<span class="string">'cntsPerPhoton'</span>,20.2)
        setappdata(fig,<span class="string">'emWvlnth'</span>,571)
        setappdata(fig,<span class="string">'NA'</span>,1.35)
        setappdata(fig,<span class="string">'psfScale'</span>,1.35)
        setappdata(fig,<span class="string">'psfStd'</span>,1.03)

        [filename, pathname, isOK] = uigetfile(<span class="keyword">...</span>
            <span class="string">'*.tif'</span>, <span class="string">'Select Imagestack'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(0, <span class="string">'searchPath'</span>, pathname)
            setappdata(fig,<span class="string">'pathname'</span>,pathname)
            setappdata(fig,<span class="string">'filename'</span>,filename)

            I = imread([pathname filename],getappdata(fig,<span class="string">'frame'</span>));
            [height width] = size(I);
            setappdata(fig,<span class="string">'width'</span>,width)
            setappdata(fig,<span class="string">'height'</span>,height)
            setappdata(fig,<span class="string">'roiX0'</span>,0)
            setappdata(fig,<span class="string">'roiY0'</span>,0)
            setappdata(fig,<span class="string">'roi'</span>,[0 0 width height])
            setappdata(fig,<span class="string">'hROI'</span>,[])

            setappdata(fig,<span class="string">'intensityRange'</span>,[])

            figTitle = [<span class="string">'Frame 1 - '</span> getappdata(fig,<span class="string">'filename'</span>)];
            tagIntHist = <span class="string">'Pixel Intensity'</span>;
            badToggles = [2:8 20:36];
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">case</span> <span class="string">'Superstack'</span>
        menuFig =<span class="keyword">...</span>
            figure(<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.2 0.6 0.4 0.2],<span class="keyword">...</span>
            <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
            <span class="string">'Name'</span>, <span class="string">'Superstack Container'</span>,<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Resize'</span>, <span class="string">'off'</span>);

        hList =<span class="keyword">...</span>
            uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'listbox'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0 0.9 1],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10);

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.9 0.8 0.1 0.2],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 25,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'+'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, {@addStack, hList})

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.9 0.6 0.1 0.2],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 30,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'-'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, {@delStack, hList})

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.9 0.4 0.1 0.2],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'UP'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, {@moveUpStack, hList})

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.9 0.2 0.1 0.2],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'DOWN'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, {@moveDownStack, hList})

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.9 0 0.1 0.2],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'OK'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, {@buildSuperstack, hList})

        isOK = false;
        uiwait(menuFig)
    <span class="keyword">case</span> <span class="string">'SLIMfast'</span>
        [filename, pathname, isOK] = uigetfile(<span class="keyword">...</span>
            <span class="string">'*.mat'</span>, <span class="string">'Select Particle Data'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(0, <span class="string">'searchPath'</span>, pathname)
<span class="comment">%             imageBin = struct([]);</span>
            load([pathname filename])
            setappdata(fig,<span class="string">'pathname'</span>,pathname)
            setappdata(fig,<span class="string">'filename'</span>,imageBin.filename)

            <span class="comment">%initialize variables</span>
            setappdata(fig,<span class="string">'imageName'</span>,imageBin.imageName)

            setappdata(fig,<span class="string">'isOwn'</span>,1)
            setappdata(fig,<span class="string">'isLoaded'</span>,1)
            setappdata(fig,<span class="string">'isSuperstack'</span>,imageBin.isSuperstack)
            setappdata(fig,<span class="string">'isTrack'</span>,0)
            setappdata(fig,<span class="string">'frame'</span>,1)
            setappdata(fig,<span class="string">'viewMode'</span>,<span class="string">'monoView'</span>)

            <span class="comment">%Loc Options</span>
            <span class="keyword">if</span> all(isfield(imageBin,{<span class="string">'locStart'</span>,<span class="string">'locEnd'</span>}))
                setappdata(fig,<span class="string">'locStart'</span>,imageBin.locStart)
                setappdata(fig,<span class="string">'locEnd'</span>,imageBin.locEnd)
            <span class="keyword">else</span> <span class="comment">%for backward compatibility</span>
                setappdata(fig,<span class="string">'locStart'</span>,imageBin.rStart)
                setappdata(fig,<span class="string">'locEnd'</span>,imageBin.rEnd)
            <span class="keyword">end</span> <span class="comment">%try</span>

            setappdata(fig,<span class="string">'errorRate'</span>,imageBin.errorRate)
            setappdata(fig,<span class="string">'w2d'</span>,imageBin.w2d)
            setappdata(fig,<span class="string">'dfltnLoops'</span>,imageBin.dfltnLoops)
            setappdata(fig,<span class="string">'minInt'</span>,imageBin.minInt)
            setappdata(fig,<span class="string">'locParallel'</span>,imageBin.locParallel)
            setappdata(fig,<span class="string">'nCores'</span>,imageBin.nCores)
            setappdata(fig,<span class="string">'spatialCorrection'</span>,imageBin.spatialCorrection)
            setappdata(fig,<span class="string">'isRadiusTol'</span>,imageBin.isRadiusTol)
            setappdata(fig,<span class="string">'radiusTol'</span>,imageBin.radiusTol)
            setappdata(fig,<span class="string">'posTol'</span>,imageBin.posTol)
            setappdata(fig,<span class="string">'maxOptimIter'</span>,imageBin.maxOptimIter)
            setappdata(fig,<span class="string">'termTol'</span>,imageBin.termTol)

            <span class="comment">%Bar Options</span>
            setappdata(fig,<span class="string">'isScalebar'</span>,0)
            setappdata(fig,<span class="string">'micronBarLength'</span>,imageBin.micronBarLength)
            setappdata(fig,<span class="string">'isColormap'</span>,0)
            setappdata(fig,<span class="string">'isTimestamp'</span>,0)
            setappdata(fig,<span class="string">'timestampSize'</span>,imageBin.timestampSize)
            setappdata(fig,<span class="string">'timestampInkrement'</span>,imageBin.timestampInkrement)
            setappdata(fig,<span class="string">'colormapWidth'</span>,imageBin.colormapWidth)

            <span class="comment">%Render Options</span>
            setappdata(fig,<span class="string">'exfOld'</span>,imageBin.exfNew)
            setappdata(fig,<span class="string">'exfNew'</span>,imageBin.exfNew)
            setappdata(fig,<span class="string">'rW'</span>,imageBin.rW)
            setappdata(fig,<span class="string">'rStep'</span>,imageBin.rStep)
            setappdata(fig,<span class="string">'rStart'</span>,1)
            setappdata(fig,<span class="string">'rEnd'</span>,numel(imageBin.ctrsN))
            setappdata(fig,<span class="string">'rLive'</span>,imageBin.rLive)
            setappdata(fig,<span class="string">'fps'</span>,imageBin.fps)
            setappdata(fig,<span class="string">'movCompression'</span>,imageBin.movCompression)
            setappdata(fig,<span class="string">'convMode'</span>,1)
            setappdata(fig,<span class="string">'intWeight'</span>,255)
            setappdata(fig,<span class="string">'sizeFac'</span>,1)
            setappdata(fig,<span class="string">'isCumsum'</span>,imageBin.isCumsum)

            <span class="comment">%Thresh Options</span>
            setappdata(fig,<span class="string">'isThreshLocPrec'</span>,0)
            setappdata(fig,<span class="string">'minLoc'</span>,imageBin.minLoc)
            setappdata(fig,<span class="string">'maxLoc'</span>,imageBin.maxLoc)
            setappdata(fig,<span class="string">'isThreshSNR'</span>,0)
            setappdata(fig,<span class="string">'minSNR'</span>,imageBin.minSNR)
            setappdata(fig,<span class="string">'maxSNR'</span>,imageBin.maxSNR)
            setappdata(fig,<span class="string">'isThreshDensity'</span>,0)
            setappdata(fig,<span class="string">'clusterMode'</span>,1)

            <span class="comment">%Optics Options</span>
            setappdata(fig,<span class="string">'pxSize'</span>,imageBin.pxSize)
            <span class="keyword">if</span> isfield(imageBin,<span class="string">'frameSize'</span>)
                 setappdata(fig,<span class="string">'frameSize'</span>,imageBin.frameSize)
            <span class="keyword">else</span>
            setappdata(fig,<span class="string">'frameSize'</span>,40)
            <span class="keyword">end</span> <span class="comment">%if</span>
            setappdata(fig,<span class="string">'cntsPerPhoton'</span>,imageBin.cntsPerPhoton)
            setappdata(fig,<span class="string">'emWvlnth'</span>,imageBin.emWvlnth)
            setappdata(fig,<span class="string">'NA'</span>,imageBin.NA)
            setappdata(fig,<span class="string">'psfScale'</span>,imageBin.psfScale)
            setappdata(fig,<span class="string">'psfStd'</span>,imageBin.psfStd)

            <span class="comment">%tracking options</span>
            setappdata(fig,<span class="string">'trackStart'</span>,1)
            setappdata(fig,<span class="string">'trackEnd'</span>,inf)
            setappdata(fig,<span class="string">'Dmax'</span>,0.5)
            setappdata(fig,<span class="string">'searchExpFac'</span>,1.2)
            setappdata(fig,<span class="string">'statWin'</span>,10)
            setappdata(fig,<span class="string">'maxComp'</span>,1)
            setappdata(fig,<span class="string">'maxOffTime'</span>,2)
            setappdata(fig,<span class="string">'intLawWeight'</span>,0.9)
            setappdata(fig,<span class="string">'diffLawWeight'</span>,0.5)

            <span class="comment">%ROI Options</span>
            setappdata(fig,<span class="string">'width'</span>,imageBin.width)
            setappdata(fig,<span class="string">'height'</span>,imageBin.height)
            setappdata(fig,<span class="string">'roiX0'</span>,0)
            setappdata(fig,<span class="string">'roiY0'</span>,0)
            setappdata(fig,<span class="string">'roi'</span>,[0 0 imageBin.width imageBin.height])
            setappdata(fig,<span class="string">'hROI'</span>,[])

            setappdata(fig,<span class="string">'intensityRange'</span>,[0 255])
            setappdata(fig,<span class="string">'ctrsN'</span>,imageBin.ctrsN)

            <span class="comment">%rendering</span>
            roi = [0 0 imageBin.width imageBin.height];
            setappdata(fig,<span class="string">'startPnt'</span>,0)
            setappdata(fig,<span class="string">'elements'</span>,inf)
            data = preprocessData(fig, [1 1 0 0 0 0 0 1 0 0 0 0],roi);
            [I,width,height,N] = renderImage(data,roi,<span class="keyword">...</span>
                getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'width'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'height'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                getappdata(fig,<span class="string">'convMode'</span>));

            figTitle = [getappdata(fig,<span class="string">'filename'</span>) <span class="string">': '</span> num2str(N) <span class="string">' rendered'</span>];
            tagIntHist = <span class="string">'Particle Intensity'</span>;
            badToggles = [9:10 13:14 17:19 21:36];
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">case</span> <span class="string">'FPALM'</span>
        [filename, pathname,isOK] = uigetfile(<span class="keyword">...</span>
            <span class="string">'*.mat'</span>, <span class="string">'Select Particle Coordinates'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(1, <span class="string">'searchPath'</span>, pathname)

            load([pathname filename],<span class="keyword">...</span>
                <span class="string">'a0_all'</span>,<span class="string">'xf_all'</span>, <span class="string">'yf_all'</span>,<span class="string">'r0_all'</span>,<span class="keyword">...</span>
                <span class="string">'framenum_all'</span>, <span class="string">'file_info'</span>,<span class="string">'exf'</span>,<span class="string">'NA'</span>,<span class="keyword">...</span>
                <span class="string">'wvlnth'</span>,<span class="string">'pix_to_pho'</span>,<span class="string">'psf_scale'</span>,<span class="string">'q'</span>,<span class="keyword">...</span>
                <span class="string">'nmol_all'</span>,<span class="string">'total_molecules'</span>,<span class="string">'x_offset'</span>,<span class="keyword">...</span>
                <span class="string">'x_size'</span>, <span class="string">'y_offset'</span>, <span class="string">'y_size'</span>,<span class="keyword">...</span>
                <span class="string">'iprod_thresh'</span>,<span class="string">'bkgn'</span> )

            <span class="comment">%format conversion</span>
            [imageBin.filename,imageBin.pathname,isOK] =<span class="keyword">...</span>
                uiputfile(<span class="string">''</span> ,<span class="string">'Save converted Data to'</span>, pathname);
            <span class="keyword">if</span> isOK

                <span class="comment">%Predefined Variables</span>
                imageBin.isOwn = true;
                imageBin.isLoaded = true;
                imageBin.isSuperstack = false;
                imageBin.isTrack = false;
                imageBin.frame = 1;

                <span class="comment">%Loc Options</span>
                imageBin.errorRate = -6;
                imageBin.w2d = 9;
                imageBin.dfltnLoops = 0;
                imageBin.minInt = iprod_thresh;
                imageBin.locParallel = false;
                imageBin.nCores = 1;
                imageBin.spatialCorrection = false;
                imageBin.isRadiusTol = false;
                imageBin.radiusTol = 50;
                imageBin.posTol = 1.5;
                imageBin.maxOptimIter = 50;
                imageBin.termTol = -2;

                <span class="comment">%Bar Options</span>
                imageBin.isScalebar = 0;
                imageBin.micronBarLength = 1000;
                imageBin.isColormap = 0;
                imageBin.colormapWidth = 20;
                imageBin.isTimestamp = 0;
                imageBin.timestampSize = 2;
                imageBin.timestampInkrement = 0.032;

                <span class="comment">%Render Options</span>
                imageBin.exfOld = exf;
                imageBin.exfNew = exf;
                imageBin.rW = 50;
                imageBin.rStep = 10;
                imageBin.rStart = nan;
                imageBin.rEnd = nan;
                imageBin.rLive = false;
                imageBin.fps = 25;
                imageBin.movCompression = 1;
                imageBin.convMode = 1;
                imageBin.intWeight = 0.01;
                imageBin.sizeFac = 1;
                imageBin.isCumsum = false;

                <span class="comment">%Thresh Options</span>
                imageBin.isThreshLocPrec = false;
                imageBin.minLoc = 0;
                imageBin.maxLoc = inf;
                imageBin.isThreshSNR = false;
                imageBin.minSNR = 0;
                imageBin.maxSNR = inf;
                imageBin.isThreshDensity = false;

                <span class="comment">%Optics Options</span>
                imageBin.pxSize = q;
                imageBin.cntsPerPhoton = pix_to_pho;
                imageBin.emWvlnth = wvlnth*1000;
                imageBin.NA = NA;
                imageBin.psfScale = psf_scale;
                imageBin.psfStd = psf_scale*0.55*(wvlnth)/NA/1.17/q/2;

                imageBin.ctrsN = nmol_all';
                imageBin.nrI = file_info.stop-file_info.startPnt+1;

                imageBin.height = y_size;
                imageBin.width = x_size;
                imageBin.roi = [x_offset y_offset x_size y_size];

                fidY = fopen([imageBin.pathname imageBin.filename <span class="string">'.ctrsY'</span>], <span class="string">'a+'</span>);
                fidX = fopen([imageBin.pathname imageBin.filename <span class="string">'.ctrsX'</span>], <span class="string">'a+'</span>);
                fidSignal = fopen([imageBin.pathname imageBin.filename <span class="string">'.signal'</span>], <span class="string">'a+'</span>);
                fidNoise = fopen([imageBin.pathname imageBin.filename <span class="string">'.noise'</span>], <span class="string">'a+'</span>);
                fidRadius = fopen([imageBin.pathname imageBin.filename <span class="string">'.radius'</span>], <span class="string">'a+'</span>);
                fidFrame = fopen([imageBin.pathname imageBin.filename <span class="string">'.frame'</span>], <span class="string">'a+'</span>);

                fwrite(fidY,yf_all,<span class="string">'real*8'</span>);
                fwrite(fidX,xf_all,<span class="string">'real*8'</span>);
                fwrite(fidSignal,a0_all,<span class="string">'real*8'</span>);
                fwrite(fidNoise,ones(total_molecules,1)*bkgn,<span class="string">'real*8'</span>);
                fwrite(fidRadius,r0_all/2,<span class="string">'real*8'</span>); <span class="comment">% 1/e^2 -&gt; std</span>
                fwrite(fidFrame,framenum_all,<span class="string">'real*8'</span>);
                fclose(<span class="string">'all'</span>);

                <span class="comment">%preallocate frame</span>
                I = zeros(imageBin.roi(4)*imageBin.exfNew,<span class="keyword">...</span>
                    imageBin.roi(3)*imageBin.exfNew);

                ctrsXY = imageBin.roi(4)*imageBin.exfNew*<span class="keyword">...</span>
                    uint32((xf_all'-imageBin.roi(1)+1)*imageBin.exfNew)+<span class="keyword">...</span>
                    uint32((yf_all'-imageBin.roi(2)+1)*imageBin.exfNew);
                [ctrsXY unused take] = unique(ctrsXY);
                signal = accumarray(take,a0_all*imageBin.cntsPerPhoton);
                I(ctrsXY) = signal*imageBin.intWeight;

                psf = buildPSF(imageBin.sizeFac,<span class="keyword">...</span>
                    ceil(imageBin.roi(3)*imageBin.exfNew),<span class="keyword">...</span>
                    ceil(imageBin.roi(4)*imageBin.exfNew));

                I = fftshift(ifft2(fft2(I).*psf));
                pxRange = [0 255];
                figTitle = [imageBin.filename <span class="string">': '</span> num2str(total_molecules) <span class="string">' rendered'</span>];
                badToggles = [5 6 8 9 10 11 12 13 14 15 16 19 20 21 22 23];
            <span class="keyword">else</span>
                <span class="keyword">return</span>
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">case</span> <span class="string">'Tracking Data'</span>
        [filename, pathname,isOK] = uigetfile(<span class="keyword">...</span>
            <span class="string">'*.mat'</span>, <span class="string">'Select Tracking Data'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(0, <span class="string">'searchPath'</span>, pathname)

            [data,settings,par_per_frame] = deal([]);
            load([pathname filename])
            tracksize = cellfun(<span class="string">'size'</span>,data.tr,1);
            data.tr(tracksize &lt; 5) = [];

            setappdata(fig,<span class="string">'pathname'</span>,pathname)
            setappdata(fig,<span class="string">'tracks'</span>,data.tr)
            setappdata(fig,<span class="string">'nTracks'</span>,numel(data.tr))
            setappdata(fig,<span class="string">'ctrsN'</span>,par_per_frame)

            setappdata(fig,<span class="string">'isOwn'</span>,1)
            setappdata(fig,<span class="string">'isLoaded'</span>,1)
            setappdata(fig,<span class="string">'isSuperstack'</span>,0)
            setappdata(fig,<span class="string">'isTrack'</span>,1)
            setappdata(fig,<span class="string">'frame'</span>,1)
            setappdata(fig,<span class="string">'viewMode'</span>,<span class="string">'monoView'</span>)

            setappdata(fig,<span class="string">'trackColorMode'</span>,2)
            setappdata(fig,<span class="string">'trackColor'</span>,{[1 1 0],<span class="keyword">...</span>
                rand(getappdata(fig,<span class="string">'nTracks'</span>),3)})
            setappdata(fig,<span class="string">'trackWidth'</span>,1)
            setappdata(fig,<span class="string">'trackVisibility'</span>,1)

            setappdata(fig,<span class="string">'rW'</span>,1)
            setappdata(fig,<span class="string">'rStep'</span>,1)
            setappdata(fig,<span class="string">'rStart'</span>,1)
            setappdata(fig,<span class="string">'rEnd'</span>,settings.Frames)
            setappdata(fig,<span class="string">'isCumsum'</span>,1)
            setappdata(fig,<span class="string">'isTracksizeThresh'</span>,1)
            setappdata(fig,<span class="string">'minTracksize'</span>,15)
            setappdata(fig,<span class="string">'maxTracksize'</span>,inf)

            setappdata(fig,<span class="string">'pxSize'</span>,settings.px2micron)
            setappdata(fig,<span class="string">'frameSize'</span>,settings.Delay*1000)

            <span class="comment">%tracking options</span>
            setappdata(fig,<span class="string">'trackStart'</span>,1)
            setappdata(fig,<span class="string">'trackEnd'</span>,inf)
            setappdata(fig,<span class="string">'Dmax'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.MaxDiffusionCoefficient)
            setappdata(fig,<span class="string">'searchExpFac'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.ResearchDiameter)
            setappdata(fig,<span class="string">'statWin'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.AvaragingTimeWindow)
            setappdata(fig,<span class="string">'maxComp'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.CombinationTresh)
            setappdata(fig,<span class="string">'maxOffTime'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.BlinkingProbability)
            setappdata(fig,<span class="string">'intLawWeight'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.WeightUniformGaussianLaw)
            setappdata(fig,<span class="string">'diffLawWeight'</span>,<span class="keyword">...</span>
                settings.TrackingOptions.WeightMaxLocalDiffusion)

            <span class="comment">%ROI Options</span>
            width = settings.Width;
            height = settings.Height;
            setappdata(fig,<span class="string">'width'</span>,width)
            setappdata(fig,<span class="string">'height'</span>,height)
            setappdata(fig,<span class="string">'exfOld'</span>,1)
            setappdata(fig,<span class="string">'roiX0'</span>,0)
            setappdata(fig,<span class="string">'roiY0'</span>,0)
            setappdata(fig,<span class="string">'roi'</span>,[0 0 width height])
            setappdata(fig,<span class="string">'hROI'</span>,[])

            I = zeros(height,width);
            setappdata(fig,<span class="string">'intensityRange'</span>,[0 255])

            [pathname filename ext] = fileparts(settings.Filename);
            setappdata(fig,<span class="string">'filename'</span>,filename)

            figTitle = filename;
            tagIntHist = <span class="string">''</span>;
            badToggles = [2:14 17:29 32:36];
        <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%switch</span>

<span class="keyword">if</span> isOK
    logInImage(fig,[])
    set(fig,<span class="keyword">...</span>
        <span class="string">'Name'</span>, figTitle,<span class="keyword">...</span>
        <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
        <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
        <span class="string">'Color'</span>,  min(1,unifrnd(0.7,1,1,3)+<span class="keyword">...</span>
        double(randperm(RandStream.getDefaultStream,3)==1)),<span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
        <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
        <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>,<span class="keyword">...</span>
        <span class="string">'DeleteFcn'</span>, @logOutImage,<span class="keyword">...</span>
        <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
        <span class="string">'Visible'</span>, <span class="string">'on'</span>);
    ax = <span class="keyword">...</span>
        axes(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
        <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
        <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

    <span class="comment">%draw Image</span>
    iptsetpref(<span class="string">'ImshowAxesVisible'</span>,<span class="string">'off'</span>)
    hImage = imshow(I,getappdata(fig,<span class="string">'intensityRange'</span>));
    setappdata(fig,<span class="string">'hImage'</span>,hImage)

    <span class="keyword">if</span> getappdata(fig,<span class="string">'isTrack'</span>)
        <span class="comment">%plot tracks</span>
        tracksize = cellfun(<span class="string">'size'</span>,data.tr,1);
        <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'maxTracksize'</span>))
            hasSize = tracksize &gt;= getappdata(fig,<span class="string">'minTracksize'</span>);
        <span class="keyword">else</span>
            hasSize = tracksize &gt;= getappdata(fig,<span class="string">'minTracksize'</span>) &amp;<span class="keyword">...</span>
                tracksize &lt;= getappdata(fig,<span class="string">'maxTracksize'</span>);
        <span class="keyword">end</span> <span class="comment">%if</span>

        cmap =getappdata(fig,<span class="string">'trackColor'</span>);
        hTracks = zeros(getappdata(fig,<span class="string">'nTracks'</span>),1);
        <span class="keyword">for</span> trackID = 1:getappdata(fig,<span class="string">'nTracks'</span>)
            hTracks(trackID) = line(data.tr{trackID}(:,1),<span class="keyword">...</span>
                data.tr{trackID}(:,2),<span class="keyword">...</span>
                <span class="string">'Parent'</span>, ax,<span class="keyword">...</span>
                <span class="string">'Color'</span>, cmap{2}(trackID,:),<span class="keyword">...</span>
                <span class="string">'LineWidth'</span>, getappdata(fig,<span class="string">'trackWidth'</span>));
        <span class="keyword">end</span>
        setappdata(fig,<span class="string">'hTracks'</span>,hTracks)
        set(hTracks(~hasSize),<span class="string">'Visible'</span>,<span class="string">'off'</span>)
    <span class="keyword">end</span> <span class="comment">%if</span>

    <span class="comment">%personalize toolbar</span>
    hToolBar = findall(fig,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, {@saveImage,I,<span class="string">'8bit'</span>})
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.Arrow, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @previousFrame)
    uitoggletool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.playMov, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @showRawStack)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(fliplr(icon.Arrow), [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @nextFrame)
    uitoggletool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.roi, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @setROI)
    uitoggletool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.options, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @setOptions)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'max. Intensity'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.maxProj, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @zProject,<span class="keyword">...</span>
        <span class="string">'TooltipString'</span>, sprintf([<span class="string">'\n'</span> <span class="keyword">...</span>
        <span class="string">'Do a max. Intensity z-Projection. \n'</span> <span class="keyword">...</span>
        <span class="string">'Each Pixel in the final Image gets \n'</span> <span class="keyword">...</span>
        <span class="string">'the max. registered Pixelvalue \n'</span> <span class="keyword">...</span>
        <span class="string">'from the Imagestack.'</span>]))
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'mean Intensity'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.aveProj, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @zProject)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.colormap, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, <span class="string">'colormapeditor'</span>)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, tagIntHist,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.intDist, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @intHist)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.testLoc, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @showLocPreview)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.locAll, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @localization)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.precDist, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @locPrec)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.s2nDist, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @snrHist)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.locDist, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @detectionTrace)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.genTraj, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @buildTracks)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'Image'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.genIm, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @render)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'Movie'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.genMov, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @render)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'3D ImScatter'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.scatter3D, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @scatterPlot)

    hToggleList = findall(hToolBar);
    delete(hToggleList(badToggles))

    <span class="comment">%     jToolbar = get(get(imageBin.hToolBar,'JavaContainer'),'ComponentPeer');</span>
    <span class="comment">%     set(jToolbar,'Background',get(imageBin.hFig,'Color'));</span>

<span class="keyword">else</span>
    <span class="keyword">return</span>
<span class="keyword">end</span> <span class="comment">%if</span>

    <span class="keyword">function</span> addStack(src, event, hList)
        [stackname, stackpath,isOK] = uigetfile(<span class="string">'*.tif'</span>,<span class="keyword">...</span>
            <span class="string">'Select Imagestacks'</span>, getappdata(0,<span class="string">'searchPath'</span>),<span class="keyword">...</span>
            <span class="string">'MultiSelect'</span>, <span class="string">'on'</span>);
        <span class="keyword">if</span> isOK
            setappdata(0, <span class="string">'searchPath'</span>, stackpath)
            content = get(hList, <span class="string">'String'</span>);
            contentNew = cellstr(strcat(stackpath, stackname));
            content = [content',contentNew];
            set(hList, <span class="string">'String'</span>, content)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> delStack(src, event, hList)
        bad = get(hList, <span class="string">'Value'</span>);
        content = get(hList, <span class="string">'String'</span>);
        <span class="keyword">if</span> isempty(content)
            <span class="keyword">return</span>
        <span class="keyword">else</span>
            content(bad) = [];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, 1)
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> moveUpStack(src, event, hList)
        pos = get(hList, <span class="string">'Value'</span>);
        <span class="keyword">if</span> pos &gt; 1
            content = get(hList, <span class="string">'String'</span>);
            content(pos-1:pos) = [content(pos); content(pos-1)];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, pos-1)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> moveDownStack(src, event, hList)
        pos = get(hList, <span class="string">'Value'</span>);
        content = get(hList, <span class="string">'String'</span>);
        <span class="keyword">if</span> pos &lt; numel(content)
            content(pos:pos+1) = [content(pos+1); content(pos)];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, pos+1)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> buildSuperstack(src, event, hList)
        content = get(hList, <span class="string">'String'</span>);
        <span class="keyword">if</span> isempty(content)
            <span class="keyword">return</span>
        <span class="keyword">else</span>
            <span class="comment">%initialize variables</span>
            <span class="keyword">for</span> idx = 1:numel(content)
                [pathname_, filename_, ext_] = fileparts(content{idx});
                pathname{1,idx} = [pathname_ <span class="string">'\'</span>];
                filename{1,idx} = [filename_ ext_];
            <span class="keyword">end</span>
            setappdata(fig,<span class="string">'pathname'</span>,pathname)
            setappdata(fig,<span class="string">'filename'</span>,filename)

            setappdata(fig,<span class="string">'isOwn'</span>,1)
            setappdata(fig,<span class="string">'isLoaded'</span>,0)
            setappdata(fig,<span class="string">'isSuperstack'</span>,1)
            setappdata(fig,<span class="string">'isTrack'</span>,0)
            setappdata(fig,<span class="string">'frame'</span>,1)
            setappdata(fig,<span class="string">'stack'</span>,1)
            setappdata(fig,<span class="string">'stackSize'</span>,[])
            setappdata(fig,<span class="string">'viewMode'</span>,<span class="string">'monoView'</span>)

            <span class="comment">%Loc Options</span>
            setappdata(fig,<span class="string">'locStart'</span>,1)
            setappdata(fig,<span class="string">'locEnd'</span>,inf)
            setappdata(fig,<span class="string">'errorRate'</span>,-6)
            setappdata(fig,<span class="string">'w2d'</span>,9)
            setappdata(fig,<span class="string">'dfltnLoops'</span>,0)
            setappdata(fig,<span class="string">'minInt'</span>,0)
            setappdata(fig,<span class="string">'locParallel'</span>,0)
            setappdata(fig,<span class="string">'nCores'</span>,1)
            setappdata(fig,<span class="string">'spatialCorrection'</span>,0)
            setappdata(fig,<span class="string">'isRadiusTol'</span>,0)
            setappdata(fig,<span class="string">'radiusTol'</span>,50)
            setappdata(fig,<span class="string">'posTol'</span>,1.5)
            setappdata(fig,<span class="string">'maxOptimIter'</span>,50)
            setappdata(fig,<span class="string">'termTol'</span>,-2)

            <span class="comment">%Bar Options</span>
            setappdata(fig,<span class="string">'isScalebar'</span>,0)
            setappdata(fig,<span class="string">'micronBarLength'</span>,1000)
            setappdata(fig,<span class="string">'isColormap'</span>,0)
            setappdata(fig,<span class="string">'isTimestamp'</span>,0)
            setappdata(fig,<span class="string">'timestampSize'</span>,2)
            setappdata(fig,<span class="string">'timestampInkrement'</span>,0.032)
            setappdata(fig,<span class="string">'colormapWidth'</span>,10)

            <span class="comment">%Render Options</span>
            setappdata(fig,<span class="string">'exfOld'</span>,1)
            setappdata(fig,<span class="string">'exfNew'</span>,5)
            setappdata(fig,<span class="string">'rW'</span>,50)
            setappdata(fig,<span class="string">'rStep'</span>,10)
            setappdata(fig,<span class="string">'rStart'</span>,1)
            setappdata(fig,<span class="string">'rEnd'</span>,inf)
            setappdata(fig,<span class="string">'rLive'</span>,0)
            setappdata(fig,<span class="string">'fps'</span>,25)
            setappdata(fig,<span class="string">'movCompression'</span>,1)
            setappdata(fig,<span class="string">'convMode'</span>,1)
            setappdata(fig,<span class="string">'intWeight'</span>,0.01)
            setappdata(fig,<span class="string">'sizeFac'</span>,1)
            setappdata(fig,<span class="string">'isCumsum'</span>,0)

            <span class="comment">%Filter Options</span>
            setappdata(fig,<span class="string">'isThreshLocPrec'</span>,0)
            setappdata(fig,<span class="string">'minLoc'</span>,0)
            setappdata(fig,<span class="string">'maxLoc'</span>,inf)
            setappdata(fig,<span class="string">'isThreshSNR'</span>,0)
            setappdata(fig,<span class="string">'minSNR'</span>,0)
            setappdata(fig,<span class="string">'maxSNR'</span>,inf)
            setappdata(fig,<span class="string">'isThreshDensity'</span>,0)
            setappdata(fig,<span class="string">'clusterMode'</span>,1)

            <span class="comment">%Optics Options</span>
            setappdata(fig,<span class="string">'pxSize'</span>,0.107)
            setappdata(fig,<span class="string">'cntsPerPhoton'</span>,20.2)
            setappdata(fig,<span class="string">'emWvlnth'</span>,571)
            setappdata(fig,<span class="string">'NA'</span>,1.35)
            setappdata(fig,<span class="string">'psfScale'</span>,1.35)
            setappdata(fig,<span class="string">'psfStd'</span>,1.03)

            I = imread([pathname{1} filename{1}],<span class="keyword">...</span>
                getappdata(fig,<span class="string">'frame'</span>));
            [height width] = size(I);
            setappdata(fig,<span class="string">'width'</span>,width)
            setappdata(fig,<span class="string">'height'</span>,height)
            setappdata(fig,<span class="string">'roiX0'</span>,0)
            setappdata(fig,<span class="string">'roiY0'</span>,0)
            setappdata(fig,<span class="string">'roi'</span>,[0 0 width height])
            setappdata(fig,<span class="string">'hROI'</span>,[])

            setappdata(fig,<span class="string">'intensityRange'</span>,[])

            figTitle = [<span class="string">'Frame 1 - '</span> filename{1}];
            tagIntHist = <span class="string">'Pixel Intensity'</span>;
            badToggles = [2:8 20:36];

            close(menuFig)
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> saveImage(src,event,I,mode)
<span class="keyword">switch</span> mode
    <span class="keyword">case</span> <span class="string">'8bit'</span>
        I = uint8(I);
    <span class="keyword">case</span> <span class="string">'16bit'</span>
        I = uint16(I);
    <span class="keyword">otherwise</span>
<span class="keyword">end</span> <span class="comment">%switch</span>

[filename,pathname,isOK] =<span class="keyword">...</span>
    uiputfile(<span class="string">'.tif'</span> ,<span class="string">'Save to'</span>, getappdata(0,<span class="string">'searchPath'</span>));
<span class="keyword">if</span> isOK
    imwrite(I,[pathname filename])
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>

<span class="keyword">function</span> logInImage(src, event)
<span class="keyword">if</span> getappdata(src,<span class="string">'isLoaded'</span>)
    masterBinHandles = getappdata(1, <span class="string">'handles'</span>);
    <span class="keyword">if</span> getappdata(src,<span class="string">'isTrack'</span>)
        uimenu(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, masterBinHandles.menuTrackChannel,<span class="keyword">...</span>
            <span class="string">'Label'</span>, regexprep(getappdata(src,<span class="string">'filename'</span>),<span class="keyword">...</span>
            {<span class="string">'('</span>,<span class="string">')'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'{'</span>,<span class="string">'}'</span>,<span class="string">'+'</span>}, <span class="string">'_'</span>),<span class="keyword">...</span>
            <span class="string">'Callback'</span>, strcat(<span class="string">'if strcmp(get(gcbo, ''Checked''),''on'');'</span>,<span class="keyword">...</span>
            <span class="string">'set(gcbo, ''Checked'', ''off''); else;'</span>,<span class="keyword">...</span>
            <span class="string">'set(gcbo, ''Checked'', ''on''); end'</span>),<span class="keyword">...</span>
            <span class="string">'UserData'</span>, src);
    <span class="keyword">else</span>
        h1 =<span class="keyword">...</span>
            uimenu(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, masterBinHandles.menuImageChannel(1),<span class="keyword">...</span>
            <span class="string">'Label'</span>, regexprep(getappdata(src,<span class="string">'filename'</span>),<span class="keyword">...</span>
            {<span class="string">'('</span>,<span class="string">')'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'{'</span>,<span class="string">'}'</span>,<span class="string">'+'</span>}, <span class="string">'_'</span>),<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @changeCheckMode,<span class="keyword">...</span>
            <span class="string">'UserData'</span>, src);
        h2 =<span class="keyword">...</span>
            uimenu(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, masterBinHandles.menuImageChannel(2),<span class="keyword">...</span>
            <span class="string">'Label'</span>, regexprep(getappdata(src,<span class="string">'filename'</span>),<span class="keyword">...</span>
            {<span class="string">'('</span>,<span class="string">')'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'{'</span>,<span class="string">'}'</span>,<span class="string">'+'</span>}, <span class="string">'_'</span>),<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @changeCheckMode,<span class="keyword">...</span>
            <span class="string">'UserData'</span>, src);
        h3 =<span class="keyword">...</span>
            uimenu(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, masterBinHandles.menuImageChannel(3),<span class="keyword">...</span>
            <span class="string">'Label'</span>, regexprep(getappdata(src,<span class="string">'filename'</span>),<span class="keyword">...</span>
            {<span class="string">'('</span>,<span class="string">')'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'{'</span>,<span class="string">'}'</span>,<span class="string">'+'</span>}, <span class="string">'_'</span>),<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @changeCheckMode,<span class="keyword">...</span>
            <span class="string">'UserData'</span>, src);

        <span class="keyword">if</span> all(strcmp(<span class="string">'off'</span>, get(allchild(<span class="keyword">...</span>
                masterBinHandles.menuImageChannel(1)), <span class="string">'Checked'</span>)))
            set(h1, <span class="string">'Checked'</span>, <span class="string">'on'</span>)
        <span class="keyword">elseif</span> all(strcmp(<span class="string">'off'</span>, get(allchild(<span class="keyword">...</span>
                masterBinHandles.menuImageChannel(2)), <span class="string">'Checked'</span>)))
            set(h2, <span class="string">'Checked'</span>, <span class="string">'on'</span>)
        <span class="keyword">elseif</span> all(strcmp(<span class="string">'off'</span>, get(allchild(<span class="keyword">...</span>
                masterBinHandles.menuImageChannel(3)), <span class="string">'Checked'</span>)))
            set(h3, <span class="string">'Checked'</span>, <span class="string">'on'</span>)
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> logOutImage(src, event)
rootFig = findobj(0,<span class="string">'Tag'</span>,<span class="string">'root'</span>);

<span class="keyword">if</span> ~isempty(rootFig)
masterBinHandles = getappdata(1, <span class="string">'handles'</span>);
<span class="keyword">if</span> getappdata(src,<span class="string">'isTrack'</span>)
    delete(findobj(masterBinHandles.menuTrackChannel,<span class="string">'UserData'</span>, src));
<span class="keyword">else</span>
    delete(findobj(masterBinHandles.menuImageChannel,<span class="string">'UserData'</span>, src));
<span class="keyword">end</span> <span class="comment">%if</span>
delete(findobj(allchild(0),<span class="string">'Color'</span>,get(src,<span class="string">'Color'</span>)))
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>

<span class="keyword">function</span> showRawStack(src, event)
endOfStack = nextFrame(src, event);
pause(0.5)
<span class="keyword">while</span> ~endOfStack &amp;&amp; strcmp(get(src,<span class="string">'state'</span>),<span class="string">'on'</span>)
    endOfStack = nextFrame(src, event);
    pause(0.5)
<span class="keyword">end</span> <span class="comment">%while</span>
<span class="keyword">end</span>
<span class="keyword">function</span> previousFrame(src, event)
<span class="comment">% imageBin = getappdata(hFig, 'imageBin');</span>
fig = gcbf;
frame = getappdata(fig,<span class="string">'frame'</span>)-1;
pathname = getappdata(fig,<span class="string">'pathname'</span>);
filename = getappdata(fig,<span class="string">'filename'</span>);

<span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
    <span class="keyword">if</span> frame &gt; 0
        I = double(imread([pathname{getappdata(fig,<span class="string">'stack'</span>)}<span class="keyword">...</span>
            filename{getappdata(fig,<span class="string">'stack'</span>)}],frame));
        set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
            [<span class="string">'Frame: '</span> num2str(frame)<span class="keyword">...</span>
            <span class="string">' - '</span> filename{getappdata(fig,<span class="string">'stack'</span>)}])
    <span class="keyword">else</span>
        <span class="keyword">if</span> getappdata(fig,<span class="string">'stack'</span>) &gt; 1
            <span class="comment">%jump to previous stack</span>
            setappdata(fig,<span class="string">'stack'</span>,getappdata(fig,<span class="string">'stack'</span>)-1);
            stackSize = getappdata(fig,<span class="string">'stackSize'</span>);
            frame = stackSize(getappdata(fig,<span class="string">'stack'</span>));
            I = double(imread([pathname{getappdata(fig,<span class="string">'stack'</span>)}<span class="keyword">...</span>
                filename{getappdata(fig,<span class="string">'stack'</span>)}],frame));
            set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
                [<span class="string">'Frame: '</span> num2str(frame)<span class="keyword">...</span>
                <span class="string">' - '</span> filename{getappdata(fig,<span class="string">'stack'</span>)}])
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">else</span>
    <span class="keyword">if</span> frame &gt; 0
        I = imread([getappdata(fig,<span class="string">'pathname'</span>)<span class="keyword">...</span>
            getappdata(fig,<span class="string">'filename'</span>)],frame);
        set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
            [<span class="string">'Frame: '</span> num2str(frame) <span class="string">' - '</span> getappdata(fig,<span class="string">'filename'</span>)])
    <span class="keyword">else</span>
        <span class="keyword">return</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>
setappdata(fig,<span class="string">'frame'</span>,frame)
set(getappdata(fig,<span class="string">'hImage'</span>), <span class="string">'CData'</span>, I)
caxis([min(min(I)) max(max(I))])
<span class="keyword">end</span>
<span class="keyword">function</span> endOfStack = nextFrame(src, event)
fig = gcbf;
frame = getappdata(fig,<span class="string">'frame'</span>)+1;
pathname = getappdata(fig,<span class="string">'pathname'</span>);
filename = getappdata(fig,<span class="string">'filename'</span>);
endOfStack = false;

<span class="keyword">try</span>
    <span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
        I = double(imread([pathname{getappdata(fig,<span class="string">'stack'</span>)}<span class="keyword">...</span>
            filename{getappdata(fig,<span class="string">'stack'</span>)}],frame));
        set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
            [<span class="string">'Frame: '</span> num2str(frame) <span class="string">' - '</span> filename{getappdata(fig,<span class="string">'stack'</span>)}])
    <span class="keyword">else</span>
        I = imread([pathname filename],frame);
        set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
            [<span class="string">'Frame: '</span> num2str(frame) <span class="string">' - '</span> filename])
    <span class="keyword">end</span>
    setappdata(fig,<span class="string">'frame'</span>,frame)
<span class="keyword">catch</span>
    <span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
        <span class="comment">%jump to following imagestack</span>
        <span class="keyword">if</span> getappdata(fig,<span class="string">'stack'</span>) &lt; numel(filename)
            stackSize = getappdata(fig,<span class="string">'stackSize'</span>);
            stackSize(getappdata(fig,<span class="string">'stack'</span>)) = frame -1;
            setappdata(fig,<span class="string">'stackSize'</span>,stackSize)
            setappdata(fig,<span class="string">'stack'</span>,getappdata(fig,<span class="string">'stack'</span>)+1);
            setappdata(fig,<span class="string">'frame'</span>,1)

            I = double(imread([pathname{getappdata(fig,<span class="string">'stack'</span>)}<span class="keyword">...</span>
                filename{getappdata(fig,<span class="string">'stack'</span>)}],1));
            set(fig, <span class="string">'Name'</span>,<span class="keyword">...</span>
                [<span class="string">'Frame: 1 - '</span> filename{getappdata(fig,<span class="string">'stack'</span>)}])
        <span class="keyword">else</span>
            warndlg(<span class="string">'End of Stack reached'</span>, <span class="string">'Info'</span>)
            endOfStack = true;
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">else</span>
        warndlg(<span class="string">'End of Stack reached'</span>, <span class="string">'Info'</span>)
        endOfStack = true;
        <span class="keyword">return</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>
set(getappdata(fig,<span class="string">'hImage'</span>), <span class="string">'CData'</span>, I)
caxis([min(min(I)) max(max(I))])
<span class="keyword">end</span>

<span class="keyword">function</span> setROI(src, event)
fig = gcbf;

<span class="keyword">switch</span> get(src,<span class="string">'State'</span>)
    <span class="keyword">case</span> <span class="string">'on'</span>
        ax = findobj(fig,<span class="string">'Type'</span>,<span class="string">'axes'</span>);

        <span class="comment">%draw user defined ROI</span>
        hRoi = imrect(ax);
        setappdata(fig,<span class="string">'hROI'</span>,hRoi)

        hMenu = uicontextmenu;
        uimenu(hMenu, <span class="string">'Label'</span>, <span class="string">'Adjust ROI Placement'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @adjustROI);
        hPatch = findobj(hRoi,<span class="string">'Type'</span>,<span class="string">'patch'</span>);
        set(hPatch,<span class="string">'FaceColor'</span>, [1 1 1],<span class="keyword">...</span>
            <span class="string">'FaceAlpha'</span>, 0.3,<span class="keyword">...</span>
            <span class="string">'UIContextMenu'</span>, hMenu)

        pos = getPosition(hRoi);
        setappdata(fig,<span class="string">'roi'</span>,<span class="keyword">...</span>
            [pos(1)-0.5 pos(2)-0.5<span class="keyword">...</span>
            pos(3) pos(4)]/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            [getappdata(fig,<span class="string">'roiX0'</span>) getappdata(fig,<span class="string">'roiY0'</span>) 0 0])

        hRoiText = text(pos(1), pos(2),<span class="keyword">...</span>
            sprintf([<span class="string">' x0 = '</span> num2str(((pos(1)-0.5)/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            getappdata(fig,<span class="string">'roiX0'</span>))*getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' y0 = '</span> num2str((pos(2)-0.5)/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            getappdata(fig,<span class="string">'roiX0'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' width = '</span> num2str(pos(3)/getappdata(fig,<span class="string">'exfOld'</span>)*<span class="keyword">...</span>
            getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' height = '</span> num2str(pos(4)/getappdata(fig,<span class="string">'exfOld'</span>)*<span class="keyword">...</span>
            getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m'</span>]),<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Color'</span>, [0 1 0],<span class="keyword">...</span>
            <span class="string">'VerticalAlignment'</span>, <span class="string">'top'</span>);
        setappdata(fig,<span class="string">'hRoiText'</span>,hRoiText)

        addNewPositionCallback(hRoi,@posInfo);
        cnstrnts = get(ax,{<span class="string">'XLim'</span>,<span class="string">'YLim'</span>});
        fcn = makeConstrainToRectFcn(<span class="string">'imrect'</span>,<span class="keyword">...</span>
            cnstrnts{1}, cnstrnts{2});
        setPositionConstraintFcn(hRoi,fcn);
    <span class="keyword">case</span> <span class="string">'off'</span>
        <span class="keyword">if</span> ~isempty(getappdata(fig,<span class="string">'hROI'</span>))
        delete(getappdata(fig,<span class="string">'hROI'</span>))
        delete(getappdata(fig,<span class="string">'hRoiText'</span>))
        setappdata(fig,<span class="string">'hROI'</span>,[])
        setappdata(fig,<span class="string">'roi'</span>,<span class="keyword">...</span>
            [0 0 getappdata(fig,<span class="string">'width'</span>) getappdata(fig,<span class="string">'height'</span>)])
        <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">function</span> posInfo(pos)
        set(hRoiText, <span class="string">'Position'</span>, [pos(1) pos(2) 0],<span class="keyword">...</span>
            <span class="string">'String'</span>,sprintf([<span class="string">' x0 = '</span> num2str(((pos(1)-0.5)/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            getappdata(fig,<span class="string">'roiX0'</span>))*getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' y0 = '</span> num2str((pos(2)-0.5)/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            getappdata(fig,<span class="string">'roiX0'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' width = '</span> num2str(pos(3)/getappdata(fig,<span class="string">'exfOld'</span>)*<span class="keyword">...</span>
            getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m \n'</span>,<span class="keyword">...</span>
            <span class="string">' height = '</span> num2str(pos(4)/getappdata(fig,<span class="string">'exfOld'</span>)*<span class="keyword">...</span>
            getappdata(fig,<span class="string">'pxSize'</span>)) <span class="string">' ?m'</span>]))

        setappdata(fig,<span class="string">'roi'</span>,<span class="keyword">...</span>
            [pos(1)-0.5 pos(2)-0.5<span class="keyword">...</span>
            pos(3) pos(4)]/getappdata(fig,<span class="string">'exfOld'</span>)+<span class="keyword">...</span>
            [+getappdata(fig,<span class="string">'roiX0'</span>) +getappdata(fig,<span class="string">'roiY0'</span>) 0 0])
    <span class="keyword">end</span>
    <span class="keyword">function</span> adjustROI(src, event)
</pre><pre class="codeinput">        figNew =<span class="keyword">...</span>
            figure(<span class="keyword">...</span>
            <span class="string">'Tag'</span>, <span class="string">'home'</span>,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.8 0.5 0.15 0.15],<span class="keyword">...</span>
            <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Resize'</span>, <span class="string">'off'</span>);

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.33 0.67 0.34 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'UP'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.33 0 0.34 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'DOWN'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0.33 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'LEFT'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.67 0.33 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'RIGHT'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0.67 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'+width'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'-width'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.67 0.67 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'+height'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.67 0 0.33 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'-height'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.33 0.33 0.34 0.33],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'sync'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @moveROI,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>))

        <span class="keyword">function</span> moveROI(src, event)
            pos = ceil(getPosition(hRoi));
            <span class="keyword">switch</span> get(src, <span class="string">'String'</span>)
                <span class="keyword">case</span> <span class="string">'UP'</span>
                    <span class="keyword">if</span> pos(2) &gt; 1
                        setPosition(hRoi,pos-[0 1 0 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'DOWN'</span>
                    <span class="keyword">if</span> pos(2)+pos(4) &lt; cnstrnts{2}(2)
                        setPosition(hRoi,pos+[0 1 0 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'LEFT'</span>
                    <span class="keyword">if</span> pos(1) &gt; 1
                        setPosition(hRoi,pos-[1 0 0 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'RIGHT'</span>
                    <span class="keyword">if</span> pos(1)+pos(3) &lt; cnstrnts{1}(2)
                        setPosition(hRoi,pos+[1 0 0 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'+width'</span>
                    <span class="keyword">if</span> pos(1)+pos(3) &lt; cnstrnts{1}(2)
                        setPosition(hRoi,pos+[0 0 1 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'-width'</span>
                    <span class="keyword">if</span> pos(3) &gt; 1
                        setPosition(hRoi,pos-[0 0 1 0])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'+height'</span>
                    <span class="keyword">if</span> pos(2)+pos(4) &lt; cnstrnts{2}(2)
                        setPosition(hRoi,pos+[0 0 0 1])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'-height'</span>
                    <span class="keyword">if</span> pos(4) &gt; 1
                        setPosition(hRoi,pos-[0 0 0 1])
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">case</span> <span class="string">'sync'</span>
                    figs = findobj(0,<span class="string">'Type'</span>, <span class="string">'figure'</span>,<span class="keyword">...</span>
                        <span class="string">'-not'</span>, <span class="string">'Color'</span>, get(fig, <span class="string">'Color'</span>),<span class="keyword">...</span>
                        <span class="string">'-not'</span>, <span class="string">'Name'</span>,<span class="string">'SLIMfast Build 1.103e'</span>);

                    <span class="keyword">if</span> isempty(figs)
                        warndlg(<span class="string">'No ROI found to sync with'</span>, <span class="string">'Info'</span>)
                        <span class="keyword">return</span>
                    <span class="keyword">else</span>
                        <span class="keyword">if</span> iscell(figs)
                            figs = cell2mat(figs);
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        [selection,isOK] = listdlg(<span class="string">'ListString'</span>,<span class="keyword">...</span>
                            get(figs,<span class="string">'Name'</span>),<span class="string">'Name'</span>, <span class="string">'Sync To:'</span>);
                        <span class="keyword">if</span> isOK
                            api = iptgetapi(findobj(figs(selection),<span class="string">'Tag'</span>, <span class="string">'imrect'</span>));
                            setPosition(hRoi,api.getPosition())
                        <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span>
</pre><pre class="codeinput">    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>VISUALIZATION<a name="5"></a></h2><pre class="codeinput"><span class="keyword">function</span> showLocPreview(src, event)
fig = gcbf;

I = get(getappdata(fig,<span class="string">'hImage'</span>), <span class="string">'CData'</span>);

<span class="comment">%search for ROI</span>
<span class="keyword">if</span> isempty(getappdata(fig,<span class="string">'hROI'</span>))
    roi = ceil(getappdata(fig,<span class="string">'roi'</span>));
<span class="keyword">else</span>
    roi = ceil(getappdata(fig,<span class="string">'roi'</span>));
    I = I(roi(2):roi(2)+roi(4),<span class="keyword">...</span>
        roi(1):roi(1)+roi(3));
<span class="keyword">end</span>

optim = [<span class="keyword">...</span>
    getappdata(fig,<span class="string">'maxOptimIter'</span>)
    getappdata(fig,<span class="string">'termTol'</span>)
    getappdata(fig,<span class="string">'isRadiusTol'</span>)
    getappdata(fig,<span class="string">'radiusTol'</span>)
    getappdata(fig,<span class="string">'posTol'</span>)];

[list dfltI mask good] = <span class="keyword">...</span>
    detect_et_estime_part_1vue_deflt(<span class="keyword">...</span>
    double(I),<span class="keyword">...</span>
    getappdata(fig,<span class="string">'w2d'</span>),<span class="keyword">...</span>
    getappdata(fig,<span class="string">'psfStd'</span>),<span class="keyword">...</span>
    chi2inv(1-1/10^(getappdata(fig,<span class="string">'errorRate'</span>)*-1),1),<span class="keyword">...</span>
    getappdata(fig,<span class="string">'dfltnLoops'</span>),<span class="keyword">...</span>
    roi(3),roi(4),<span class="keyword">...</span>
    getappdata(fig,<span class="string">'minInt'</span>),<span class="keyword">...</span>
    optim);

figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, get(fig, <span class="string">'Position'</span>),<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, [<span class="string">'Frame: '</span> num2str(getappdata(fig,<span class="string">'frame'</span>))<span class="keyword">...</span>
    <span class="string">' ('</span> num2str(good) <span class="string">' Detections)'</span>],<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);
hToolBar = findall(gcf,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 15 16 17]))
axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, gcf,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

imshow(I, []);
rectangle(<span class="keyword">...</span>
    <span class="string">'Position'</span>,roi+[0.5 0.5 0 0],<span class="keyword">...</span>
    <span class="string">'EdgeColor'</span>, [1 0 0],<span class="keyword">...</span>
    <span class="string">'LineWidth'</span>, 1)
rho = linspace(0,2*pi,10)';
patch(repmat(1+roi(1)+list(:,2)',10,1)+<span class="keyword">...</span>
    cos(rho)*list(:,6)',<span class="keyword">...</span>
    repmat(1+roi(2)+list(:,1)',10,1)+<span class="keyword">...</span>
    sin(rho)*list(:,6)',<span class="keyword">...</span>
    repmat(shiftdim([1 0 0],-1),1,good),<span class="keyword">...</span>
    <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceAlpha'</span>, 0.5)
<span class="keyword">end</span>

<span class="keyword">function</span> mergeChannels(src, event)
<span class="keyword">if</span> strcmp(get(src,<span class="string">'Label'</span>),<span class="string">'monoView'</span>)
<span class="keyword">else</span>
    masterBinHandles = getappdata(1,<span class="string">'handles'</span>);
    icon = getappdata(1, <span class="string">'icons'</span>);

    <span class="comment">%update work mode</span>
    changeCheckMode(src,[])

    figNew = figure(<span class="keyword">...</span>
        <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
        <span class="string">'Toolbar'</span>,<span class="string">'figure'</span>,<span class="keyword">...</span>
        <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
        <span class="string">'Color'</span>, min(1,unifrnd(0.7,1,1,3)+<span class="keyword">...</span>
        double(randperm(RandStream.getDefaultStream,3)==1)),<span class="keyword">...</span>
        <span class="string">'Visible'</span>, <span class="string">'off'</span>);


    <span class="keyword">if</span> strcmp(get(src,<span class="string">'Label'</span>),<span class="string">'dualView'</span>)
        setappdata(figNew,<span class="string">'viewMode'</span>,<span class="string">'dualView'</span>)
    <span class="keyword">elseif</span> strcmp(get(src,<span class="string">'Label'</span>),<span class="string">'tripleView'</span>)
        setappdata(figNew,<span class="string">'viewMode'</span>,<span class="string">'tripleView'</span>)
    <span class="keyword">end</span> <span class="comment">%if</span>

    [imScrFig trackSrcFig] = getSelectedFigHandles;
    imCh = find(~isnan(imScrFig))';
    nImCh = numel(imCh);

    trackCh = find(~isnan(trackSrcFig))';
    nTrackCh = numel(trackCh);

    setappdata(figNew,<span class="string">'imSrcFig'</span>,imScrFig)
    setappdata(figNew,<span class="string">'imCh'</span>,imCh)
    setappdata(figNew,<span class="string">'nImCh'</span>,nImCh)

    setappdata(figNew,<span class="string">'trackSrcFig'</span>,trackSrcFig(trackCh))
    setappdata(figNew,<span class="string">'nTrackCh'</span>,nTrackCh)

    <span class="keyword">for</span> ch = imCh
        I(:,:,ch) = get(getappdata(imScrFig(ch),<span class="string">'hImage'</span>),<span class="string">'CData'</span>);
    <span class="keyword">end</span> <span class="comment">%for</span>
    [height width depth] = size(I);
    I = cat(3,I,zeros(height,width,3-depth));

    transferVarList(figNew,imScrFig(imCh),<span class="string">'merge'</span>)

    <span class="comment">%open image window</span>
    set([imScrFig(imCh);trackSrcFig], <span class="string">'Visible'</span>, <span class="string">'off'</span>)
    set(figNew,<span class="keyword">...</span>
        <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
        <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
        <span class="string">'DeleteFcn'</span>, {@splitChannels, [imScrFig(imCh);trackSrcFig]},<span class="keyword">...</span>
        <span class="string">'Visible'</span>, <span class="string">'on'</span>);
    axes(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
        <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
        <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

    <span class="comment">%customize toolbar</span>
    hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, {@saveImage,I,<span class="string">'8bit'</span>})
    uitoggletool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.roi, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @setROI)
    uitoggletool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.options, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @setOptions)
    uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'Image'</span>,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.genIm, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @render)
    uipushtool(<span class="keyword">...</span>
        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
        <span class="string">'Tag'</span>, <span class="string">'Movie'</span>,<span class="keyword">...</span>
        <span class="string">'CData'</span>, repmat(icon.genMov, [1 1 3]),<span class="keyword">...</span>
        <span class="string">'ClickedCallback'</span>, @render)
    hToggleList = findall(hToolBar);
    delete(hToggleList([5 7:15 18:23]))

    imshow(uint8(I), []);
    <span class="keyword">for</span> ch = 1:nTrackCh
        hTracks = copyobj(getappdata(trackSrcFig(ch),<span class="string">'hTracks'</span>),gca);
        xdata = get(hTracks,<span class="string">'XData'</span>);
        set(hTracks,{<span class="string">'XData'</span>}, cellfun(@(x) x*<span class="keyword">...</span>
            getappdata(figNew,<span class="string">'exfNew'</span>)-1, xdata, <span class="string">'un'</span>,0))
        ydata = get(hTracks,<span class="string">'YData'</span>);
        set(hTracks,{<span class="string">'YData'</span>}, cellfun(@(x) x*<span class="keyword">...</span>
            getappdata(figNew,<span class="string">'exfNew'</span>)-1, ydata, <span class="string">'un'</span>,0))
    <span class="keyword">end</span> <span class="comment">%for</span>
<span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">function</span> splitChannels(src, event, hFig)
        set(hFig, <span class="string">'Visible'</span>, <span class="string">'on'</span>)
        hList = allchild(masterBinHandles.menuDataMode);
        set(hList(1:3), <span class="string">'Checked'</span>, <span class="string">'off'</span>)
        set(hList(3), <span class="string">'Checked'</span>, <span class="string">'on'</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> render(src, event)
icon = getappdata(1, <span class="string">'icons'</span>);
fig = gcbf;

figNew = figure(<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Toolbar'</span>,<span class="string">'figure'</span>,<span class="keyword">...</span>
    <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>)-unifrnd(0.09,0.11,1,3),<span class="keyword">...</span>
    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

<span class="keyword">switch</span> getappdata(fig,<span class="string">'viewMode'</span>)
    <span class="keyword">case</span> <span class="string">'monoView'</span>
        transferVarList(figNew,fig,<span class="string">'render-mono'</span>)

        <span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
            <span class="keyword">case</span> <span class="string">'Image'</span> <span class="comment">%BUILD IMAGE</span>

                <span class="comment">%framerange selected</span>
                idx = [-1; cumsum(getappdata(figNew,<span class="string">'ctrsN'</span>))];
                <span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
                    setappdata(figNew,<span class="string">'startPnt'</span>,0)
                <span class="keyword">else</span>
                    setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
                    setappdata(figNew,<span class="string">'rEnd'</span>,numel(getappdata(figNew,<span class="string">'ctrsN'</span>)))
                    setappdata(figNew,<span class="string">'elements'</span>,inf)
                <span class="keyword">else</span>
                    setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                        max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1)
                <span class="keyword">end</span> <span class="comment">%if</span>

                <span class="comment">%rendering</span>
                roi = getappdata(fig,<span class="string">'roi'</span>);
                <span class="keyword">if</span> getappdata(fig,<span class="string">'convMode'</span>) == 1
                    returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                <span class="keyword">else</span>
                    returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                <span class="keyword">end</span> <span class="comment">%if</span>
                data = preprocessData(figNew,returnVal,roi);

                [imRendered,width,height,N] = renderImage(data,roi,<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'width'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'height'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'convMode'</span>));

                <span class="keyword">if</span> getappdata(figNew,<span class="string">'isColormap'</span>)
                    imRendered = imprintColormap(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        1);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(figNew,<span class="string">'isScalebar'</span>)
                    imRendered = imprintScalebar(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>), 1);
                <span class="keyword">end</span> <span class="comment">%if</span>

                setappdata(figNew,<span class="string">'roiX0'</span>, roi(1))
                setappdata(figNew,<span class="string">'roiY0'</span>, roi(2))
                setappdata(figNew,<span class="string">'exfOld'</span>,getappdata(fig,<span class="string">'exfNew'</span>))

                logInImage(figNew,[])
                set(figNew,<span class="keyword">...</span>
                    <span class="string">'Name'</span>, sprintf(<span class="string">'%s: %d/%d rendered'</span>,<span class="keyword">...</span>
                    getappdata(figNew,<span class="string">'filename'</span>),N,<span class="keyword">...</span>
                    sum(getappdata(figNew,<span class="string">'ctrsN'</span>))),<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                    <span class="string">'DeleteFcn'</span>, @logOutImage,<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                axes(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

                <span class="comment">%customize toolbar</span>
                hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, {@saveImage,imRendered,<span class="string">'8bit'</span>})
                uitoggletool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.roi, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @setROI)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.colormap, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, <span class="string">'colormapeditor'</span>)
                uitoggletool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.options, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @setOptions)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.opt2txt, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, {@exportSettings, <span class="string">'Image'</span>})
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'Particle Intensity'</span>,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.intDist, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @intHist)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.precDist, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @locPrec)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.s2nDist, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @snrHist)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.locDist, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @detectionTrace)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'Image'</span>,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.genIm, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @render)
                uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'Movie'</span>,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.genMov, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, @render)

                hToggleList = findall(hToolBar);
                delete(hToggleList([13:21 24:28]))

                <span class="comment">%draw Image</span>
                hImage = imshow(uint8(imRendered));
                setappdata(figNew,<span class="string">'hImage'</span>,hImage)
            <span class="keyword">case</span> <span class="string">'Movie'</span> <span class="comment">%BUILD MOVIE</span>

                <span class="comment">% create moviepreview</span>
                roi = getappdata(fig,<span class="string">'roi'</span>);
                <span class="keyword">if</span> getappdata(fig,<span class="string">'convMode'</span>) == 1
                    returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                <span class="keyword">else</span>
                    returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                <span class="keyword">end</span> <span class="comment">%if</span>

                previewFig = buildMoviePreview;
                colormapeditor
                uiwait(previewFig)

                <span class="comment">% create movie</span>
                <span class="comment">%preallocate avi-file on harddisk</span>
                [moviename,moviepath,isOK] =<span class="keyword">...</span>
                    uiputfile(<span class="string">'.avi'</span> ,<span class="string">'Save Movie to'</span>,<span class="keyword">...</span>
                    [getappdata(0,<span class="string">'searchPath'</span>) getappdata(fig,<span class="string">'filename'</span>)<span class="keyword">...</span>
                    <span class="string">'_WinSize_'</span> num2str(getappdata(fig,<span class="string">'rW'</span>))<span class="keyword">...</span>
                    <span class="string">'_Stepsize_'</span> num2str(getappdata(fig,<span class="string">'rStep'</span>)) <span class="string">'_movie'</span>]);
                <span class="keyword">if</span> isOK
                    <span class="comment">%set movies colormap and compression method</span>
                    comprssnMethod = {<span class="string">'RLE'</span>,<span class="string">'MSVC'</span>,<span class="string">'none'</span>};
                    hMovie = avifile([moviepath moviename],<span class="keyword">...</span>
                        <span class="string">'Colormap'</span>, cmap,<span class="keyword">...</span>
                        <span class="string">'Compression'</span>, comprssnMethod{getappdata(fig,<span class="string">'movCompression'</span>)},<span class="keyword">...</span>
                        <span class="string">'fps'</span>, getappdata(fig,<span class="string">'fps'</span>));

                    <span class="comment">% create movieframes</span>
                    hProgressbar = waitbar(0,<span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                        get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
                    movieFrames = max(ceil((getappdata(fig,<span class="string">'rEnd'</span>)-<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'rStart'</span>)+1-<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'rW'</span>))/getappdata(fig,<span class="string">'rStep'</span>)),1);
                    <span class="keyword">for</span> movieFrame = 1:movieFrames;
                        <span class="comment">%set datarange to load for movieframe</span>
                        <span class="keyword">if</span> movieFrame == 1
                            setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                            setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                getappdata(figNew,<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1); <span class="comment">%check 11/03/10</span>
                        <span class="keyword">elseif</span> movieFrame == movieFrames
                            <span class="keyword">if</span> getappdata(figNew,<span class="string">'isCumsum'</span>)
                                setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                    idx(getappdata(figNew,<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                            <span class="keyword">else</span>
                                setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                    idx(getappdata(figNew,<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                    (movieFrames-1)*getappdata(figNew,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                            <span class="keyword">end</span> <span class="comment">%if</span>
                            setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rEnd'</span>))-<span class="keyword">...</span>
                                getappdata(figNew,<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                        <span class="keyword">else</span>
                            <span class="keyword">if</span> getappdata(figNew,<span class="string">'isCumsum'</span>)
                                setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                    idx(getappdata(figNew,<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                            <span class="keyword">else</span>
                                setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                    idx(getappdata(figNew,<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                    (movieFrame-1)*getappdata(figNew,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                            <span class="keyword">end</span> <span class="comment">%if</span>
                            setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                (movieFrame-1)*getappdata(figNew,<span class="string">'rStep'</span>)+<span class="keyword">...</span>
                                getappdata(figNew,<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                getappdata(figNew,<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        <span class="keyword">if</span> getappdata(fig,<span class="string">'convMode'</span>) == 1
                            returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                        <span class="keyword">else</span>
                            returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        data = preprocessData(figNew,returnVal,roi);
                        [imMovie,width,height,N] = renderImage(data,roi,<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'width'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'height'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'convMode'</span>));

                        <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                            imMovie = imprintColormap(<span class="keyword">...</span>
                                imMovie,<span class="keyword">...</span>
                                width,<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                                1);
                        <span class="keyword">end</span>
                        <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                            imMovie = imprintScalebar(<span class="keyword">...</span>
                                imMovie,<span class="keyword">...</span>
                                width,<span class="keyword">...</span>
                                height,<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                1);
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                            imMovie = imprintTimestamp(<span class="keyword">...</span>
                                imMovie,<span class="keyword">...</span>
                                width,<span class="keyword">...</span>
                                height,<span class="keyword">...</span>
                                movieFrame*getappdata(fig,<span class="string">'timestampInkrement'</span>),<span class="keyword">...</span>
                                getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                1);
                        <span class="keyword">end</span> <span class="comment">%if</span>

                        hMovie = addframe(hMovie, uint8(imMovie));
                        waitbar(movieFrame/movieFrames,hProgressbar,<span class="keyword">...</span>
                            <span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                            get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
                    <span class="keyword">end</span>
                    delete(hProgressbar)

                    <span class="comment">%customize movie player</span>
                    hMovie = close(hMovie);
                    mplay([moviepath moviename],<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'fps'</span>));

                    hList = allchild(gcf);
                    hChilds = allchild(hList(2));
                    hToolBar = hList(1);
                    copyobj(hChilds(1:4),hToolBar)
                    delete(hList(2))
                    uipushtool(<span class="keyword">...</span>
                        <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                        <span class="string">'CData'</span>, repmat(icon.opt2txt, [1 1 3]),<span class="keyword">...</span>
                        <span class="string">'ClickedCallback'</span>, {@exportSettings, <span class="string">'Movie'</span>})

                    set(gcf, <span class="string">'Units'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                        <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                        <span class="string">'Name'</span>, <span class="string">'rendered Movie'</span>, <span class="string">'DockControls'</span>, <span class="string">'off'</span>)
                    set(findall(gcf, <span class="string">'Type'</span>, <span class="string">'uimenu'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                <span class="keyword">else</span>
                    <span class="keyword">return</span>
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">case</span> <span class="string">'Track Image'</span>
            <span class="keyword">case</span> <span class="string">'Track Movie'</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">case</span> <span class="string">'dualView'</span>
        <span class="comment">%receive channel composition</span>
        srcFig = getappdata(fig,<span class="string">'imSrcFig'</span>);
        imCh = getappdata(fig,<span class="string">'imCh'</span>);
        nImCh = getappdata(fig,<span class="string">'nImCh'</span>);
        trackSrcFig = getappdata(fig,<span class="string">'trackSrcFig'</span>);
        nTrackCh = getappdata(fig,<span class="string">'nTrackCh'</span>);

        <span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
            <span class="keyword">case</span> <span class="string">'Image'</span> <span class="comment">%BUILD IMAGE</span>
                <span class="keyword">for</span> ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),<span class="string">'ctrsN'</span>))];

                    <span class="comment">%%framerange selected</span>
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'rStart'</span>) == 1
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,0)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">if</span> isinf(getappdata(srcFig(ch),<span class="string">'rEnd'</span>))
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,inf)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>

                    <span class="comment">%rendering</span>
                    roi = getappdata(srcFig(ch),<span class="string">'roi'</span>);
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'convMode'</span>) == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    <span class="keyword">else</span>
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    imRendered(:,:,ch) = renderImage(data,roi,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));

                <span class="keyword">end</span> <span class="comment">%for</span>
                [height width depth] = size(imRendered);
                imRendered = cat(3,imRendered,<span class="keyword">...</span>
                    zeros(height,width,3-depth));

                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                    imRendered = imprintColormap(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                    imRendered = imprintScalebar(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                    imRendered = imprintTimestamp(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        0.000,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span> <span class="comment">%if</span>

                  set(figNew,<span class="keyword">...</span>
                    <span class="string">'Name'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                axes(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

                <span class="comment">%customize toolbar</span>
                hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                hToggleList = findall(hToolBar);
                    uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, {@saveImage,imRendered,<span class="string">'8bit'</span>})
                delete(hToggleList([2:10 13:17]))

                hImage = imshow(uint8(imRendered));
                setappdata(figNew,<span class="string">'hImage'</span>,hImage)

            <span class="keyword">case</span> <span class="string">'Movie'</span> <span class="comment">%BUILD MOVIE</span>

                previewFig = buildMoviePreview;
                answer = questdlg(<span class="string">'accept movie settings?'</span>,<span class="keyword">...</span>
                    <span class="string">'Question'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
                delete(previewFig)

                <span class="comment">% create movie</span>
                <span class="keyword">switch</span> answer
                    <span class="keyword">case</span> <span class="string">'Yes'</span>
                        <span class="comment">%preallocate avi-file on harddisk</span>
                        [moviename,moviepath,isOK] =<span class="keyword">...</span>
                            uiputfile(<span class="string">'.avi'</span> ,<span class="string">'Save Movie to'</span>,<span class="keyword">...</span>
                            [getappdata(0,<span class="string">'searchPath'</span>)<span class="keyword">...</span>
                            moviename <span class="string">'Stepsize_'</span><span class="keyword">...</span>
                            num2str(getappdata(fig,<span class="string">'rStep'</span>)) <span class="string">'_movie'</span>]);
                        <span class="keyword">if</span> isOK
                            <span class="comment">%set movies colormap and compression method</span>
                            hMovie = avifile([moviepath moviename],<span class="keyword">...</span>
                                <span class="string">'Compression'</span>, <span class="string">'none'</span>,<span class="keyword">...</span><span class="comment"> %no RLE MSVC for true color!</span>
                                <span class="string">'fps'</span>, getappdata(fig,<span class="string">'fps'</span>));

                            <span class="comment">% create movieframes</span>
                            <span class="keyword">if</span> nTrackCh &gt; 0
                                set(figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Position'</span>, [0 0 1 1],<span class="keyword">...</span>
                                    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                                    <span class="string">'Resize'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                                    <span class="string">'Name'</span>, <span class="string">'Movie Preview'</span>,<span class="keyword">...</span>
                                    <span class="string">'Visible'</span>, <span class="string">'on'</span>);
                                ax =<span class="keyword">...</span>
                                    axes(<span class="keyword">...</span>
                                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Position'</span>, [0 0 1 1]);
                                <span class="keyword">for</span> ch = 1:nTrackCh
                                    tracks{ch} = getappdata(trackSrcFig(ch),<span class="string">'tracks'</span>);

                                    movieFrames(3+ch) = ceil((getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>)-<span class="keyword">...</span>
                                        getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+1-<span class="keyword">...</span>
                                        getappdata(trackSrcFig(ch),<span class="string">'rW'</span>))/getappdata(fig,<span class="string">'rStep'</span>));
                                <span class="keyword">end</span>
                            <span class="keyword">else</span>
                                delete(figNew)
                            <span class="keyword">end</span> <span class="comment">%if</span>

                            hProgressbar = waitbar(0,<span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                                get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));

                            <span class="keyword">for</span> movieFrame = 1:max(movieFrames)
                                imMovie = zeros(height,width,3);
                                <span class="keyword">for</span> ch = imCh
                                    <span class="comment">%set datarange to load for movieframe</span>
                                    <span class="keyword">if</span> movieFrame == 1
                                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">elseif</span> movieFrame &gt;= movieFrames(ch)
                                        <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'isCumsum'</span>)
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">else</span>
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                (movieFrames(ch)-1)*getappdata(fig,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rEnd'</span>))-<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">else</span>
                                        <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'isCumsum'</span>)
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">else</span>
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                (movieFrame-1)*getappdata(fig,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                            (movieFrame-1)*getappdata(fig,<span class="string">'rStep'</span>)+<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">end</span> <span class="comment">%if</span>

                                    roi = getappdata(srcFig(ch),<span class="string">'roi'</span>);
                                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'convMode'</span>) == 1
                                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                                    <span class="keyword">else</span>
                                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                                    <span class="keyword">end</span> <span class="comment">%if</span>
                                    data = preprocessData(srcFig(ch),returnVal,roi);
                                    imMovie(:,:,ch) = renderImage(data,roi,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));
                                <span class="keyword">end</span> <span class="comment">%for</span>

                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                                    imMovie = imprintColormap(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                                        2);
                                <span class="keyword">end</span>
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                                    imMovie = imprintScalebar(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        height,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                        2);
                                <span class="keyword">end</span> <span class="comment">%if</span>
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                                    imMovie = imprintTimestamp(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        height,<span class="keyword">...</span>
                                        movieFrame*getappdata(fig,<span class="string">'timestampInkrement'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                        2);
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                <span class="keyword">if</span> nTrackCh &gt; 0
                                    imshow(uint8(imMovie), <span class="string">'Parent'</span>, ax);
                                    <span class="keyword">for</span> ch = 1:nTrackCh
                                        <span class="keyword">if</span> movieFrame == 1
                                            tracksize = cellfun(<span class="string">'size'</span>,tracks{ch},1);
                                            <span class="keyword">if</span> isinf(getappdata(trackSrcFig(ch),<span class="string">'maxTracksize'</span>))
                                                hasSize = tracksize &gt;= getappdata(trackSrcFig(ch),<span class="string">'minTracksize'</span>);
                                            <span class="keyword">else</span>
                                                hasSize = tracksize &gt;= getappdata(trackSrcFig(ch),<span class="string">'minTracksize'</span>) &amp;<span class="keyword">...</span>
                                                    tracksize &lt;= getappdata(trackSrcFig(ch),<span class="string">'maxTracksize'</span>);
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                            tracks{ch} = tracks{ch}(hasSize);

                                            cmap = getappdata(trackSrcFig(ch),<span class="string">'trackColor'</span>);
                                            <span class="keyword">switch</span> getappdata(trackSrcFig(ch),<span class="string">'trackColorMode'</span>)
                                                <span class="keyword">case</span> 2
                                                    trackList{ch} = cell2mat(cellfun(<span class="keyword">...</span>
                                                        @(x) x(:,1:4),tracks{ch}',<span class="string">'Un'</span>,0));
                                                    listIdxs = accumarray(trackList{ch}(:,4),<span class="keyword">...</span>
                                                        1:size(trackList{ch},1),[], @(x) {x});
                                                <span class="keyword">case</span> 1

                                                    trackList{ch} = cell2mat(cellfun(<span class="keyword">...</span>
                                                        @(x) [x(:,1:3);nan nan nan],tracks{ch}',<span class="string">'Un'</span>,0));
                                            <span class="keyword">end</span> <span class="comment">%switch</span>
                                            <span class="keyword">if</span> 1
                                                insideRoi{ch} = true(size(trackList{ch},1),1);
                                            <span class="keyword">else</span>
                                                insideRoi{ch} =<span class="keyword">...</span>
                                                    trackList{ch} &gt; roi(1) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,1) &lt; roi(1)+roi(3) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,2) &gt; roi(2) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,2) &lt; roi(2)+roi(4) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3));
                                                trackList{ch}(:,1) = trackList{ch}(:,1)-roi(1);
                                                trackList{ch}(:,2) = trackList{ch}(:,2)-roi(2);
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                            good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                isnan(trackList{ch}(:,3)) ;
                                        <span class="keyword">elseif</span> movieFrame &gt;= movieFrames(3+ch)
                                            <span class="keyword">if</span> getappdata(trackSrcFig(ch),<span class="string">'isCumsum'</span>)
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">else</span>
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;=<span class="keyword">...</span>
                                                    (getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>)) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                        <span class="keyword">else</span>
                                            <span class="keyword">if</span> getappdata(trackSrcFig(ch),<span class="string">'isCumsum'</span>)
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>) +<span class="keyword">...</span>
                                                    getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">else</span>
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;=<span class="keyword">...</span>
                                                    (getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>)) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>

                                        cmap = getappdata(trackSrcFig(ch),<span class="string">'trackColor'</span>);
                                        <span class="keyword">switch</span> getappdata(trackSrcFig(ch),<span class="string">'trackColorMode'</span>)
                                            <span class="keyword">case</span> 2
                                                <span class="keyword">for</span> id = unique(trackList{ch}(good,4))'
                                                    line(<span class="keyword">...</span>
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),1)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),2)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                        <span class="string">'Color'</span>, cmap{2}(id,:),<span class="keyword">...</span>
                                                        <span class="string">'LineWidth'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackWidth'</span>),<span class="keyword">...</span>
                                                        <span class="string">'Parent'</span>, ax);
                                                <span class="keyword">end</span>
                                            <span class="keyword">case</span> 1
                                                line(<span class="keyword">...</span>
                                                    trackList{ch}(good,1)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                    trackList{ch}(good,2)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                    <span class="string">'Color'</span>, cmap{1},<span class="keyword">...</span>
                                                    <span class="string">'LineWidth'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackWidth'</span>),<span class="keyword">...</span>
                                                    <span class="string">'Parent'</span>, ax);
                                        <span class="keyword">end</span> <span class="comment">%switch</span>
                                    <span class="keyword">end</span> <span class="comment">%for</span>
                                    drawnow
                                    tmpImMovie = getframe(ax);
                                    hMovie = addframe(hMovie,uint8(tmpImMovie.cdata));
                                <span class="keyword">else</span>
                                    hMovie = addframe(hMovie, uint8(imMovie));
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                waitbar(movieFrame/max(movieFrames),hProgressbar,<span class="keyword">...</span>
                                    <span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                                    get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
                            <span class="keyword">end</span> <span class="comment">%for</span>
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        delete(hProgressbar)

                        <span class="comment">%customize movie player</span>
                        <span class="comment">%customize movie player</span>
                        hMovie = close(hMovie);
                        mplay([moviepath moviename],<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'fps'</span>));

                        hList = allchild(gcf);
                        hChilds = allchild(hList(2));
                        hToolBar = hList(1);
                        copyobj(hChilds(1:4),hToolBar)
                        delete(hList(2))
                        uipushtool(<span class="keyword">...</span>
                            <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                            <span class="string">'CData'</span>, repmat(icon.opt2txt, [1 1 3]),<span class="keyword">...</span>
                            <span class="string">'ClickedCallback'</span>, {@exportSettings, <span class="string">'Movie'</span>})

                        set(gcf, <span class="string">'Units'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                            <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                            <span class="string">'Name'</span>, <span class="string">'rendered Movie'</span>, <span class="string">'DockControls'</span>, <span class="string">'off'</span>)
                        set(findall(gcf, <span class="string">'Type'</span>, <span class="string">'uimenu'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                    <span class="keyword">case</span> <span class="string">'No'</span>
                        <span class="keyword">return</span>
                <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">case</span> <span class="string">'tripleView'</span>
        <span class="comment">%receive channel composition</span>
        srcFig = getappdata(fig,<span class="string">'imSrcFig'</span>);
        imCh = getappdata(fig,<span class="string">'imCh'</span>);
        nImCh = getappdata(fig,<span class="string">'nImCh'</span>);
        trackSrcFig = getappdata(fig,<span class="string">'trackSrcFig'</span>);
        nTrackCh = getappdata(fig,<span class="string">'nTrackCh'</span>);

        <span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
            <span class="keyword">case</span> <span class="string">'Image'</span> <span class="comment">%BUILD IMAGE</span>
                                <span class="keyword">for</span> ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),<span class="string">'ctrsN'</span>))];

                    <span class="comment">%%framerange selected</span>
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'rStart'</span>) == 1
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,0)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">if</span> isinf(getappdata(srcFig(ch),<span class="string">'rEnd'</span>))
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,inf)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>

                    <span class="comment">%rendering</span>
                    roi = getappdata(srcFig(ch),<span class="string">'roi'</span>);
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'convMode'</span>) == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    <span class="keyword">else</span>
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    imRendered(:,:,ch) = renderImage(data,roi,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));

                <span class="keyword">end</span> <span class="comment">%for</span>
                [height width depth] = size(imRendered);
                imRendered = cat(3,imRendered,<span class="keyword">...</span>
                    zeros(height,width,3-depth));

                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                    imRendered = imprintColormap(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                    imRendered = imprintScalebar(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                    imRendered = imprintTimestamp(<span class="keyword">...</span>
                        imRendered,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        0.000,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span> <span class="comment">%if</span>

                  set(figNew,<span class="keyword">...</span>
                    <span class="string">'Name'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                axes(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

                <span class="comment">%customize toolbar</span>
                hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                hToggleList = findall(hToolBar);
                    uipushtool(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                    <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
                    <span class="string">'ClickedCallback'</span>, {@saveImage,imRendered,<span class="string">'8bit'</span>})
                delete(hToggleList(2:end))

                hImage = imshow(uint8(imRendered));
                setappdata(figNew,<span class="string">'hImage'</span>,hImage)

            <span class="keyword">case</span> <span class="string">'Movie'</span> <span class="comment">%BUILD MOVIE</span>

                previewFig = buildMoviePreview;
                answer = questdlg(<span class="string">'accept movie settings?'</span>,<span class="keyword">...</span>
                    <span class="string">'Question'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
                delete(previewFig)

                <span class="comment">% create movie</span>
                <span class="keyword">switch</span> answer
                    <span class="keyword">case</span> <span class="string">'Yes'</span>
                        <span class="comment">%preallocate avi-file on harddisk</span>
                        <span class="comment">%preallocate avi-file on harddisk</span>
                        [moviename,moviepath,isOK] =<span class="keyword">...</span>
                            uiputfile(<span class="string">'.avi'</span> ,<span class="string">'Save Movie to'</span>,<span class="keyword">...</span>
                            [getappdata(0,<span class="string">'searchPath'</span>)<span class="keyword">...</span>
                            moviename <span class="string">'Stepsize_'</span><span class="keyword">...</span>
                            num2str(getappdata(fig,<span class="string">'rStep'</span>)) <span class="string">'_movie'</span>]);
                        <span class="keyword">if</span> isOK
                            <span class="comment">%set movies colormap and compression method</span>
                            hMovie = avifile([moviepath moviename],<span class="keyword">...</span>
                                <span class="string">'Compression'</span>, <span class="string">'none'</span>,<span class="keyword">...</span><span class="comment"> %no RLE MSVC for true color!</span>
                                <span class="string">'fps'</span>, getappdata(fig,<span class="string">'fps'</span>));

                            <span class="comment">% create movieframes</span>
                            <span class="keyword">if</span> nTrackCh &gt; 0
                                set(figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Position'</span>, [0 0 1 1],<span class="keyword">...</span>
                                    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                                    <span class="string">'Resize'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                                    <span class="string">'Name'</span>, <span class="string">'Movie Preview'</span>,<span class="keyword">...</span>
                                    <span class="string">'Visible'</span>, <span class="string">'on'</span>);
                                ax =<span class="keyword">...</span>
                                    axes(<span class="keyword">...</span>
                                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Position'</span>, [0 0 1 1]);
                                <span class="keyword">for</span> ch = 1:nTrackCh
                                    tracks{ch} = getappdata(trackSrcFig(ch),<span class="string">'tracks'</span>);

                                    movieFrames(3+ch) = ceil((getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>)-<span class="keyword">...</span>
                                        getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+1-<span class="keyword">...</span>
                                        getappdata(trackSrcFig(ch),<span class="string">'rW'</span>))/getappdata(fig,<span class="string">'rStep'</span>));
                                <span class="keyword">end</span>
                            <span class="keyword">else</span>
                                delete(figNew)
                            <span class="keyword">end</span> <span class="comment">%if</span>

                            hProgressbar = waitbar(0,<span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                                get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
                            <span class="keyword">for</span> movieFrame = 1:max(movieFrames)
                                imMovie = zeros(height,width,3);
                                <span class="keyword">for</span> ch = imCh
                                    <span class="comment">%set datarange to load for movieframe</span>
                                    <span class="keyword">if</span> movieFrame == 1
                                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">elseif</span> movieFrame &gt;= movieFrames(ch)
                                        <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'isCumsum'</span>)
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">else</span>
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                (movieFrames(ch)-1)*getappdata(fig,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rEnd'</span>))-<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">else</span>
                                        <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'isCumsum'</span>)
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">else</span>
                                            setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                                idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                (movieFrame-1)*getappdata(fig,<span class="string">'rStep'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                            (movieFrame-1)*getappdata(fig,<span class="string">'rStep'</span>)+<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'startPnt'</span>)+1); <span class="comment">%check 11/03/10</span>
                                    <span class="keyword">end</span> <span class="comment">%if</span>
                                    roi = getappdata(srcFig(ch),<span class="string">'roi'</span>);
                                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'convMode'</span>) == 1
                                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                                    <span class="keyword">else</span>
                                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                                    <span class="keyword">end</span> <span class="comment">%if</span>
                                    data = preprocessData(srcFig(ch),returnVal,roi);
                                    imMovie(:,:,ch) = renderImage(data,roi,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));
                                <span class="keyword">end</span> <span class="comment">%for</span>

                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                                    imMovie = imprintColormap(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                                        3);
                                <span class="keyword">end</span>
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                                    imMovie = imprintScalebar(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        height,<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                        3);
                                <span class="keyword">end</span> <span class="comment">%if</span>
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                                    imMovie = imprintTimestamp(<span class="keyword">...</span>
                                        imMovie,<span class="keyword">...</span>
                                        width,<span class="keyword">...</span>
                                        height,<span class="keyword">...</span>
                                        movieFrame*getappdata(fig,<span class="string">'timestampInkrement'</span>),<span class="keyword">...</span>
                                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                                        3);
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                <span class="keyword">if</span> nTrackCh &gt; 0
                                    imshow(uint8(imMovie), <span class="string">'Parent'</span>, ax);
                                    <span class="keyword">for</span> ch = 1:nTrackCh
                                        <span class="keyword">if</span> movieFrame == 1
                                            tracksize = cellfun(<span class="string">'size'</span>,tracks{ch},1);
                                            <span class="keyword">if</span> isinf(getappdata(trackSrcFig(ch),<span class="string">'maxTracksize'</span>))
                                                hasSize = tracksize &gt;= getappdata(trackSrcFig(ch),<span class="string">'minTracksize'</span>);
                                            <span class="keyword">else</span>
                                                hasSize = tracksize &gt;= getappdata(trackSrcFig(ch),<span class="string">'minTracksize'</span>) &amp;<span class="keyword">...</span>
                                                    tracksize &lt;= getappdata(trackSrcFig(ch),<span class="string">'maxTracksize'</span>);
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                            tracks{ch} = tracks{ch}(hasSize);

                                            cmap = getappdata(trackSrcFig(ch),<span class="string">'trackColor'</span>);
                                            <span class="keyword">switch</span> getappdata(trackSrcFig(ch),<span class="string">'trackColorMode'</span>)
                                                <span class="keyword">case</span> 2
                                                    trackList{ch} = cell2mat(cellfun(<span class="keyword">...</span>
                                                        @(x) x(:,1:4),tracks{ch}',<span class="string">'Un'</span>,0));
                                                    listIdxs = accumarray(trackList{ch}(:,4),<span class="keyword">...</span>
                                                        1:size(trackList{ch},1),[], @(x) {x});
                                                <span class="keyword">case</span> 1

                                                    trackList{ch} = cell2mat(cellfun(<span class="keyword">...</span>
                                                        @(x) [x(:,1:3);nan nan nan],tracks{ch}',<span class="string">'Un'</span>,0));
                                            <span class="keyword">end</span> <span class="comment">%switch</span>
                                            <span class="keyword">if</span> 1
                                                insideRoi{ch} = true(size(trackList{ch},1),1);
                                            <span class="keyword">else</span>
                                                insideRoi{ch} =<span class="keyword">...</span>
                                                    trackList{ch} &gt; roi(1) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,1) &lt; roi(1)+roi(3) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,2) &gt; roi(2) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,2) &lt; roi(2)+roi(4) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3));
                                                trackList{ch}(:,1) = trackList{ch}(:,1)-roi(1);
                                                trackList{ch}(:,2) = trackList{ch}(:,2)-roi(2);
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                            good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                isnan(trackList{ch}(:,3)) ;
                                        <span class="keyword">elseif</span> movieFrame &gt;= movieFrames(3+ch)
                                            <span class="keyword">if</span> getappdata(trackSrcFig(ch),<span class="string">'isCumsum'</span>)
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">else</span>
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;=<span class="keyword">...</span>
                                                    (getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>)) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>) |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                        <span class="keyword">else</span>
                                            <span class="keyword">if</span> getappdata(trackSrcFig(ch),<span class="string">'isCumsum'</span>)
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>) +<span class="keyword">...</span>
                                                    getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">else</span>
                                                good = insideRoi{ch} &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &gt;=<span class="keyword">...</span>
                                                    (getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    movieFrame*getappdata(fig,<span class="string">'rStep'</span>)) &amp;<span class="keyword">...</span>
                                                    trackList{ch}(:,3) &lt;= getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>) +<span class="keyword">...</span>
                                                    getappdata(trackSrcFig(ch),<span class="string">'rW'</span>)-1 |<span class="keyword">...</span>
                                                    isnan(trackList{ch}(:,3)) ;
                                            <span class="keyword">end</span> <span class="comment">%if</span>
                                        <span class="keyword">end</span> <span class="comment">%if</span>

                                        cmap = getappdata(trackSrcFig(ch),<span class="string">'trackColor'</span>);
                                        <span class="keyword">switch</span> getappdata(trackSrcFig(ch),<span class="string">'trackColorMode'</span>)
                                            <span class="keyword">case</span> 2
                                                <span class="keyword">for</span> id = unique(trackList{ch}(good,4))'
                                                    line(<span class="keyword">...</span>
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),1)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),2)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                        <span class="string">'Color'</span>, cmap{2}(id,:),<span class="keyword">...</span>
                                                        <span class="string">'LineWidth'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackWidth'</span>),<span class="keyword">...</span>
                                                        <span class="string">'Parent'</span>, ax);
                                                <span class="keyword">end</span>
                                            <span class="keyword">case</span> 1
                                                line(<span class="keyword">...</span>
                                                    trackList{ch}(good,1)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                    trackList{ch}(good,2)*getappdata(fig,<span class="string">'exfNew'</span>)-1,<span class="keyword">...</span>
                                                    <span class="string">'Color'</span>, cmap{1},<span class="keyword">...</span>
                                                    <span class="string">'LineWidth'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackWidth'</span>),<span class="keyword">...</span>
                                                    <span class="string">'Parent'</span>, ax);
                                        <span class="keyword">end</span> <span class="comment">%switch</span>
                                    <span class="keyword">end</span> <span class="comment">%for</span>
                                    drawnow
                                    tmpImMovie = getframe(ax);
                                    hMovie = addframe(hMovie,uint8(tmpImMovie.cdata));
                                <span class="keyword">else</span>
                                    hMovie = addframe(hMovie, uint8(imMovie));
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                waitbar(movieFrame/max(movieFrames),hProgressbar,<span class="keyword">...</span>
                                    <span class="string">'Generating Movie...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                                    get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
                            <span class="keyword">end</span> <span class="comment">%for</span>
                        <span class="keyword">end</span> <span class="comment">%if</span>
                        delete(hProgressbar)

                        <span class="comment">%customize movie player</span>
                        <span class="comment">%customize movie player</span>
                        hMovie = close(hMovie);
                        mplay([moviepath moviename],<span class="keyword">...</span>
                            getappdata(fig,<span class="string">'fps'</span>));

                        hList = allchild(gcf);
                        hChilds = allchild(hList(2));
                        hToolBar = hList(1);
                        copyobj(hChilds(1:4),hToolBar)
                        delete(hList(2))
                        uipushtool(<span class="keyword">...</span>
                            <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
                            <span class="string">'CData'</span>, repmat(icon.opt2txt, [1 1 3]),<span class="keyword">...</span>
                            <span class="string">'ClickedCallback'</span>, {@exportSettings, <span class="string">'Movie'</span>})

                        set(gcf, <span class="string">'Units'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                            <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
                            <span class="string">'Name'</span>, <span class="string">'rendered Movie'</span>, <span class="string">'DockControls'</span>, <span class="string">'off'</span>)
                        set(findall(gcf, <span class="string">'Type'</span>, <span class="string">'uimenu'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                    <span class="keyword">case</span> <span class="string">'No'</span>
                        <span class="keyword">return</span>
                <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>
<span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">function</span> passCmap(src, event)
        cmap = get(src, <span class="string">'Colormap'</span>);
    <span class="keyword">end</span>
    <span class="keyword">function</span> previewFig = buildMoviePreview
        <span class="keyword">switch</span> getappdata(fig,<span class="string">'viewMode'</span>)
            <span class="keyword">case</span> <span class="string">'monoView'</span>
                idx = [-1; cumsum(getappdata(fig,<span class="string">'ctrsN'</span>))];

                <span class="comment">%first movieframe</span>
                            setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                            setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                idx(getappdata(figNew,<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                getappdata(figNew,<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1); <span class="comment">%check 11/03/10</span>

                data = preprocessData(figNew,returnVal,roi);
                [movieFrame,width,height,N] = renderImage(data,roi,<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'width'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'height'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'convMode'</span>));

                <span class="comment">%movie z-Projection</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
                    setappdata(figNew,<span class="string">'startPnt'</span>,0)
                <span class="keyword">else</span>
                    setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
                    setappdata(figNew,<span class="string">'rEnd'</span>,numel(getappdata(fig,<span class="string">'ctrsN'</span>)))
                    setappdata(figNew,<span class="string">'elements'</span>,inf)
                <span class="keyword">else</span>
                    setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                        max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1)
                <span class="keyword">end</span> <span class="comment">%if</span>
                data = preprocessData(figNew,returnVal,roi);
                movieProj = renderImage(data,roi,<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'width'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'height'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                    getappdata(fig,<span class="string">'convMode'</span>));

                mask = find(poly2mask([0 0 width],<span class="keyword">...</span>
                    [0 height height], height, width));
                movieProj(mask) = movieFrame(mask);

                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                    movieProj = imprintColormap(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        1);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                    movieProj = imprintScalebar(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        1);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                    movieProj = imprintTimestamp(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        0.000,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        1);
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">otherwise</span>
                moviename = [];
                <span class="keyword">for</span> ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),<span class="string">'ctrsN'</span>))];

                    roi = getappdata(srcFig(ch),<span class="string">'roi'</span>);
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'convMode'</span>) == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    <span class="keyword">else</span>
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    <span class="keyword">end</span> <span class="comment">%if</span>

                    <span class="comment">%first movieframe</span>
                                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1); <span class="comment">%check 11/03/10</span>
                                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>)+<span class="keyword">...</span>
                                            getappdata(srcFig(ch),<span class="string">'rW'</span>))-<span class="keyword">...</span>
                                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1); <span class="comment">%check 11/03/10</span>

                    data = preprocessData(srcFig(ch),returnVal,roi);
                    [movieFrame(:,:,ch),width(ch),height(ch),N(ch)] = renderImage(data,roi,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));

                    <span class="comment">%%movie z-Projection</span>
                    <span class="keyword">if</span> getappdata(srcFig(ch),<span class="string">'rStart'</span>) == 1
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,0)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rStart'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">if</span> isinf(getappdata(srcFig(ch),<span class="string">'rEnd'</span>))
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,inf)
                    <span class="keyword">else</span>
                        setappdata(srcFig(ch),<span class="string">'elements'</span>,<span class="keyword">...</span>
                            idx{ch}(getappdata(srcFig(ch),<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                            max(1,getappdata(srcFig(ch),<span class="string">'startPnt'</span>))+1)
                    <span class="keyword">end</span> <span class="comment">%if</span>

                    data = preprocessData(srcFig(ch),returnVal,roi);
                    movieProj(:,:,ch) = renderImage(data,roi,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'width'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'height'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'convMode'</span>));

                    mask = find(poly2mask([0 0 width(ch)],<span class="keyword">...</span>
                        [0 height(ch) height(ch)], height(ch), width(ch)));
                    movieProj(mask+(ch-1)*width(ch)*height(ch)) =<span class="keyword">...</span>
                        movieFrame(mask+(ch-1)*width(ch)*height(ch));

                    movieFrames(ch) = max(ceil((getappdata(srcFig(ch),<span class="string">'rEnd'</span>)-<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'rStart'</span>)+1-<span class="keyword">...</span>
                        getappdata(srcFig(ch),<span class="string">'rW'</span>))/getappdata(fig,<span class="string">'rStep'</span>)),1);
                    moviename = [moviename getappdata(srcFig(ch),<span class="string">'filename'</span>)<span class="keyword">...</span>
                        <span class="string">'_WinSize_'</span> num2str(getappdata(srcFig(imCh(1)),<span class="string">'rW'</span>)) <span class="string">'_'</span>];
                <span class="keyword">end</span> <span class="comment">%for</span>
                [height width depth] = size(movieProj);
                movieProj = cat(3,movieProj,<span class="keyword">...</span>
                    zeros(height,width,3-depth));

                <span class="keyword">switch</span> getappdata(fig,<span class="string">'viewMode'</span>)
                    <span class="keyword">case</span> <span class="string">'dualView'</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                    movieProj = imprintColormap(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                    movieProj = imprintScalebar(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                    movieProj = imprintTimestamp(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        0.000,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        2);
                <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">case</span> <span class="string">'tripleView'</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isColormap'</span>)
                    movieProj = imprintColormap(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isScalebar'</span>)
                    movieProj = imprintScalebar(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">if</span> getappdata(fig,<span class="string">'isTimestamp'</span>)
                    movieProj = imprintTimestamp(<span class="keyword">...</span>
                        movieProj,<span class="keyword">...</span>
                        width,<span class="keyword">...</span>
                        height,<span class="keyword">...</span>
                        0.000,<span class="keyword">...</span>
                        getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                        3);
                <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>

        <span class="comment">%open preview window</span>
        previewFig = figure(<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, figPos(width/height),<span class="keyword">...</span>
            <span class="string">'Name'</span>, <span class="string">'Movie Preview'</span>,<span class="keyword">...</span>
            <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Menubar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'DeleteFcn'</span>, @passCmap,<span class="keyword">...</span>
            <span class="string">'Visible'</span>, <span class="string">'on'</span>);

        previewAx =<span class="keyword">...</span>
            axes(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, previewFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0 1 1]);

        imshow(uint8(movieProj),<span class="keyword">...</span>
            <span class="string">'Parent'</span>,previewAx);

        line([0 width],[0 height],<span class="keyword">...</span>
            <span class="string">'Color'</span>, [1 1 1], <span class="string">'LineWidth'</span>, 3)
        text(0.25*width,0.75*height,<span class="string">'Frame 1'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,15, <span class="string">'Color'</span>, [1 1 1],<span class="keyword">...</span>
            <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>)
        text(0.75*width,0.25*height,<span class="string">'Accumulate'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,15, <span class="string">'Color'</span>, [1 1 1],<span class="keyword">...</span>
            <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>)

    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> [rI,width,height,N] = renderImage(data,roi,exf,width,height,intWeight,sizeFac,pxSize,mode)
<span class="comment">%calculate right-sided edges of pixels for superres image</span>
edgeY = (1:height*exf)/exf;
edgeX = (1:width*exf)/exf;

<span class="comment">%calculate size of superres image</span>
y0 = find(edgeY &gt;= roi(2), 1, <span class="string">'first'</span>);
y1 = find(edgeY &gt;= roi(2)+roi(4), 1, <span class="string">'first'</span>);
x0 = find(edgeX &gt;= roi(1), 1, <span class="string">'first'</span>);
x1 = find(edgeX &gt;= roi(1)+roi(3), 1, <span class="string">'first'</span>);

<span class="comment">%preallocate superres image</span>
height = y1-y0+1; width = x1-x0+1;
rI = zeros(height,width);

size(data.ctrsX)

<span class="keyword">if</span> ~isempty(data.ctrsX) &amp;&amp; ~isempty(data.ctrsY) &amp;&amp; ~isempty(data.photons)
    <span class="keyword">switch</span> mode
        <span class="keyword">case</span> 2 <span class="comment">%dynamic</span>
            lp2pix = (data.precision/(pxSize/exf)).^2*sizeFac^2;

            [cntY yc] = histc(data.ctrsY, edgeY(y0:y1));
            [cntX xc] = histc(data.ctrsX, edgeX(x0:x1));

            N=0;
            <span class="keyword">for</span> i=1:numel(xc)
                w = ceil(6*sqrt(lp2pix(i)));
                <span class="keyword">if</span> xc(i) - w &gt;= 1 &amp;&amp;<span class="keyword">...</span>
                        xc(i) + w &lt; ceil(roi(3)*exf) &amp;&amp;<span class="keyword">...</span>
                        yc(i) - w &gt;= 1 &amp;&amp;<span class="keyword">...</span>
                        yc(i) + w &lt; ceil(roi(4)*exf)
                    N = N+1;

    refi = (1:w)-floor(w/2)+yc(i);
    ii = (refi-(data.ctrsY(i)-roi(2))*exf)' * ones(1,w) ;
    refj = (1:w)-floor(w/2)+xc(i);
    jj = ones(w,1) * (refj-(data.ctrsX(i)-roi(1))*exf) ;

    rI((1:w)-floor(w/2)+yc(i),<span class="keyword">...</span>
        (1:w)-floor(w/2)+xc(i)) = <span class="keyword">...</span>
        rI((1:w)-floor(w/2)+yc(i),<span class="keyword">...</span>
        (1:w)-floor(w/2)+xc(i)) +<span class="keyword">...</span>
        intWeight*data.photons(i)/(2*pi*lp2pix(i))*<span class="keyword">...</span>
        exp(-(1/(2*lp2pix(i)))*(ii.*ii + jj.*jj)) ;
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">end</span> <span class="comment">%for</span>
        <span class="keyword">case</span> 1 <span class="comment">%fixed</span>
            N = numel(data.photons); <span class="comment">%count # rendered particles</span>

            <span class="comment">%calculate linear indices of particle detection for 2d-matrix</span>
            [cntY idxY] = histc(data.ctrsY, edgeY(y0:y1));
            [cntX idxX] = histc(data.ctrsX, edgeX(x0:x1));
            linIdx = idxX*height+idxY+1;
            [linIdx unused good] = unique(linIdx);

            rI(linIdx) = accumarray(good,intWeight);
            psf = buildPSF(sizeFac,width,height);
            rI = fftshift(ifft2(fft2(rI).* psf));
    <span class="keyword">end</span> <span class="comment">%switch</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="keyword">end</span>
<span class="keyword">function</span> I = imprintColormap(I, width, mapHeight, mode)
<span class="keyword">if</span> mode == 1
    colorRamp = repmat(round(linspace(0, 255, width)),<span class="keyword">...</span>
        mapHeight,1);
    I(end-mapHeight+1:end,:) = colorRamp;
<span class="keyword">else</span>
    cmapWidth = floor(width/4);
    colorRamp = round(linspace(0, 255, cmapWidth));
    colorRamp = repmat([colorRamp,<span class="keyword">...</span>
        ones(1,cmapWidth)*255, fliplr(colorRamp),<span class="keyword">...</span>
        zeros(1,width-3*cmapWidth)],mapHeight,1);
    <span class="keyword">if</span> mode == 3
        colorRamp3D = repmat(round(linspace(0, 255,<span class="keyword">...</span>
            mapHeight))',1,width);
        I(end-mapHeight+1:end,:,:) =<span class="keyword">...</span>
            cat(3,colorRamp, fliplr(colorRamp), colorRamp3D);
    <span class="keyword">else</span>
        I(end-mapHeight+1:end,:,:) =<span class="keyword">...</span>
            cat(3,colorRamp, fliplr(colorRamp), colorRamp*0);
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> I = imprintScalebar(I, width, height,<span class="keyword">...</span>
    exf, barLength, pxSize, sizeFac, mode)
barUnit = pxChars(height,width,<span class="keyword">...</span>
    [num2str(barLength) <span class="string">'nm'</span>],sizeFac);

pxBarLength = round(barLength/(1000*pxSize/exf));
pxBarHeight = ceil(max(exf/3,pxBarLength/20));
bar = ones(pxBarHeight,pxBarLength);

tmp = size(bar,2)-size(barUnit,2);
<span class="keyword">if</span> tmp &gt; 0
    bar = [[zeros(size(barUnit,1),floor(tmp/2)),<span class="keyword">...</span>
        barUnit, zeros(size(barUnit,1),ceil(tmp/2))];<span class="keyword">...</span>
        zeros(2,size(bar,2)); bar];
<span class="keyword">elseif</span> tmp &lt; 0
    bar = [barUnit;zeros(2,size(barUnit,2));<span class="keyword">...</span>
        [zeros(pxBarHeight,floor(-tmp/2)),bar,<span class="keyword">...</span>
        zeros(pxBarHeight,ceil(-tmp/2))]];
<span class="keyword">else</span>
    bar = [barUnit;zeros(2,size(bar,2));bar];
<span class="keyword">end</span> <span class="comment">%sif</span>

barOffsetX = 4*pxBarHeight;
barOffsetY = 4*pxBarHeight;
offset = height*(width-(size(bar,2)+barOffsetX))+barOffsetY;
idx = find([bar;zeros(height-size(bar,1),<span class="keyword">...</span>
    size(bar,2))])+offset;

<span class="keyword">if</span> mode == 1
    I(idx) = 255;
<span class="keyword">else</span>
    I([idx;idx+height*width;idx+2*height*width]) = 255;
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> I = imprintTimestamp(I, width, height,<span class="keyword">...</span>
    time, sizeFac, mode)
stamp = pxChars(height,width,<span class="keyword">...</span>
    [strrep(num2str(time, <span class="string">'%.3f'</span>),<span class="string">'.'</span>,<span class="string">'p'</span>) <span class="string">'_S'</span>],<span class="keyword">...</span>
    sizeFac);

barOffsetX = ceil(max(sizeFac*2,size(stamp,2)/5));
barOffsetY = barOffsetX;

idx = find([stamp;zeros(height-size(stamp,1),size(stamp,2))])+<span class="keyword">...</span>
    barOffsetX*height+barOffsetY;
<span class="keyword">if</span> mode == 1
    I(idx) = 255;
<span class="keyword">else</span>
    I([idx;idx+height*width;idx+2*height*width]) = 255;
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>

<span class="keyword">function</span> zProject(src, event)
icon = getappdata(1, <span class="string">'icons'</span>);
fig = gcbf;

<span class="comment">%search for ROI</span>
<span class="keyword">if</span> isempty(getappdata(fig,<span class="string">'hROI'</span>))
    roi = [1 1 <span class="keyword">...</span>
        getappdata(fig,<span class="string">'width'</span>) getappdata(fig,<span class="string">'height'</span>)];
<span class="keyword">else</span>
    roi = ceil(getappdata(fig,<span class="string">'roi'</span>));
<span class="keyword">end</span>
region = {[roi(2) roi(2)+roi(4)-1],<span class="keyword">...</span>
    [roi(1) roi(1)+roi(3)-1]};

hProgressbar = waitbar(0,<span class="string">'Processing...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
    get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
imageName = strcat(getappdata(fig,<span class="string">'pathname'</span>),<span class="keyword">...</span>
    getappdata(fig,<span class="string">'filename'</span>));
<span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
    <span class="keyword">for</span> stack = 1:numel(imageName)
        info = imfinfo(imageName{stack});
        frames = numel(info);
        <span class="keyword">if</span> stack == 1 <span class="comment">%initialize image</span>
            I = double(imread(imageName{stack}, 1,<span class="keyword">...</span>
                <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region));
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">for</span> frame = 2:frames
            <span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
                <span class="keyword">case</span> <span class="string">'max. Intensity'</span>
                    I = max(I,double(imread(imageName{stack},<span class="keyword">...</span>
                        frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region)));
                <span class="keyword">case</span> <span class="string">'mean Intensity'</span>
                    I = (I + double(imread(imageName{stack},<span class="keyword">...</span>
                        frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region)))/2;
            <span class="keyword">end</span> <span class="comment">%switch</span>
            waitbar(frame/frames,hProgressbar,<span class="keyword">...</span>
                <span class="string">'Processing...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
                get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
        <span class="keyword">end</span> <span class="comment">%for</span>
    <span class="keyword">end</span> <span class="comment">%for</span>
    delete(hProgressbar)
<span class="keyword">else</span>
    info = imfinfo(imageName);
    frames = numel(info);
    I = double(imread(imageName, 1,<span class="keyword">...</span>
        <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region));
    <span class="keyword">for</span> frame = 2:frames
        <span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
            <span class="keyword">case</span> <span class="string">'max. Intensity'</span>
                I = max(I,double(imread(imageName,<span class="keyword">...</span>
                    frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region)));
            <span class="keyword">case</span> <span class="string">'mean Intensity'</span>
                I = (I + double(imread(imageName,<span class="keyword">...</span>
                    frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region)))/2;
        <span class="keyword">end</span> <span class="comment">%switch</span>
        waitbar(frame/frames,hProgressbar,<span class="keyword">...</span>
            <span class="string">'Processing...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
            get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
    <span class="keyword">end</span> <span class="comment">%for</span>
    delete(hProgressbar)
<span class="keyword">end</span> <span class="comment">%if</span>
I = fix((I-min(I(:)))/(max(I(:))-min(I(:)))*255);

figNew =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, figPos(roi(3)/roi(4)),<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>)-unifrnd(0.09,0.11,1,3),<span class="keyword">...</span>
    <span class="string">'Name'</span>, [<span class="string">'z-Projection ('</span> <span class="keyword">...</span>
    get(src,<span class="string">'Tag'</span>) <span class="string">') - '</span> get(fig,<span class="string">'Name'</span>)],<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);
axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.05 0.9 0.9]);

hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
uipushtool(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
    <span class="string">'CData'</span>, repmat(icon.save, [1 1 3]),<span class="keyword">...</span>
    <span class="string">'ClickedCallback'</span>, {@saveImage,I,<span class="string">'8bit'</span>})
uipushtool(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
    <span class="string">'CData'</span>, repmat(icon.colormap, [1 1 3]),<span class="keyword">...</span>
    <span class="string">'ClickedCallback'</span>, <span class="string">'colormapeditor'</span>)
hToggleList = findall(hToolBar);
delete(hToggleList([4:12 15:19]))
imshow(uint8(I))
<span class="keyword">end</span>

<span class="keyword">function</span> scatterPlot(src, event)
fig = imgcf;
encodeType = {<span class="string">'x-coordinate [px]'</span>,<span class="string">'y-coordinate [px]'</span>,<span class="string">'signal amplitude [counts]'</span>,<span class="keyword">...</span>
    <span class="string">'noise amplitude [counts]'</span>,<span class="string">'background level [counts]'</span>,<span class="string">'psf radius [px]'</span>,<span class="string">'detection time [frames]'</span>,<span class="keyword">...</span>
    <span class="string">'# collected photons'</span>,<span class="string">'localization precision [micron]'</span>,<span class="string">'signal to noise ratio'</span>,<span class="keyword">...</span>
    <span class="string">'signal to background ratio'</span>,<span class="string">'cluster'</span>,<span class="string">'z-coordinate [px]'</span>,<span class="string">'channel'</span>};

menuFig =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.3 0.25 0.4 0.5],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Encoding Style'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'off'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0.9 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'weight'</span>)

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.8 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1st dim.:'</span>)

hxDim =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.8 0.55 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, encodeType,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

hxDimWeight =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.8 0.1 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.65 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'2nd dim.:'</span>)

hyDim =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.65 0.55 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, encodeType,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 2,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

hyDimWeight =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.65 0.1 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.5 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'3rd dim.:'</span>)

hzDim =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.5 0.55 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, encodeType,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 7,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

hzDimWeight =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.5 0.1 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.35 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'expansion:'</span>)

hExp =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.35 0.55 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, encodeType,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 9,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

hExpWeight =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.35 0.1 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.05 0.2 0.2 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'color:'</span>)

hColor =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.2 0.55 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, encodeType,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 7,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

hColorWeight =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.2 0.1 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.25 0.05 0.5 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'accept settings'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@buildScatterPlot,<span class="keyword">...</span>
    [hxDim,hyDim,hzDim,hExp,hColor<span class="keyword">...</span>
    hxDimWeight,hyDimWeight,hzDimWeight,hExpWeight,hColorWeight],<span class="keyword">...</span>
    get(src, <span class="string">'Tag'</span>)})

    <span class="keyword">function</span> buildScatterPlot(src,event,hList,mode)
        take = cell2mat(get(hList(1:5),<span class="string">'Value'</span>));
        weight = str2double(get(hList(6:10),<span class="string">'String'</span>));
        close(get(src,<span class="string">'Parent'</span>))

        returnVar = zeros(1,14); returnVar(take) = true;
        varNames = {<span class="string">'ctrsX'</span>,<span class="string">'ctrsY'</span>,<span class="string">'signal'</span>,<span class="string">'noise'</span>,<span class="string">'offset'</span>,<span class="string">'radius'</span>,<span class="string">'frame'</span>,<span class="keyword">...</span>
            <span class="string">'photons'</span>,<span class="string">'precision'</span>,<span class="string">'snr'</span>,<span class="string">'sbr'</span>,<span class="string">'class'</span>,<span class="string">'ctrsZ'</span>,<span class="string">'channel'</span>};

        figNew = figure(<span class="keyword">...</span>
            <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Toolbar'</span>,<span class="string">'figure'</span>,<span class="keyword">...</span>
            <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>)-unifrnd(0.09,0.11,1,3),<span class="keyword">...</span>
            <span class="string">'Visible'</span>, <span class="string">'off'</span>);

        <span class="keyword">switch</span> mode
            <span class="keyword">case</span> <span class="string">'2D ImScatter'</span>
                        <span class="keyword">switch</span> getappdata(fig,<span class="string">'viewMode'</span>)
                            <span class="keyword">case</span> <span class="string">'monoView'</span>
                                transferVarList(figNew,fig,<span class="string">'render-mono'</span>)
                                <span class="keyword">if</span> ~getappdata(fig,<span class="string">'isLoaded'</span>)
                                    localization(figNew);
                                <span class="keyword">end</span>

                                <span class="comment">%framerange selected</span>
                                idx = [-1; cumsum(getappdata(figNew,<span class="string">'ctrsN'</span>))];
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
                                    setappdata(figNew,<span class="string">'startPnt'</span>,0)
                                <span class="keyword">else</span>
                                    setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
                                <span class="keyword">end</span> <span class="comment">%if</span>
                                <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
                                    setappdata(figNew,<span class="string">'rEnd'</span>,numel(getappdata(figNew,<span class="string">'ctrsN'</span>)))
                                    setappdata(figNew,<span class="string">'elements'</span>,inf)
                                <span class="keyword">else</span>
                                    setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                                        max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1)
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                <span class="comment">%get ROI</span>
                                roi = getappdata(fig,<span class="string">'roi'</span>);
                                data = preprocessData(figNew,returnVar(1:12),roi);

                                setappdata(figNew,<span class="string">'roiX0'</span>, roi(1))
                                setappdata(figNew,<span class="string">'roiY0'</span>, roi(2))
                                setappdata(figNew,<span class="string">'exfOld'</span>,getappdata(fig,<span class="string">'exfNew'</span>))

                                set(figNew,<span class="keyword">...</span>
                                    <span class="string">'Name'</span>, [<span class="string">'2D Scatter: '</span> num2str(numel(data.(varNames{take(1)})))<span class="keyword">...</span>
                                    <span class="string">'\'</span> num2str(sum(getappdata(fig,<span class="string">'ctrsN'</span>))) <span class="string">' rendered'</span>],<span class="keyword">...</span>
                                    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                                    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                                    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>,<span class="keyword">...</span>
                                    <span class="string">'Visible'</span>, <span class="string">'on'</span>);
                                axes(<span class="keyword">...</span>
                                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Fontsize'</span>,15);

                                hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

                                color = jet(256);
                                cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),<span class="keyword">...</span>
                                    max(weight(5)*data.(varNames{take(5)})),256);
                                [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);

                                rho = linspace(0,2*pi,10)';
                                patch(repmat((weight(1)*data.(varNames{take(1)}))',10,1)+<span class="keyword">...</span>
                                    weight(4)*cos(rho)*data.(varNames{take(4)})',<span class="keyword">...</span>
                                    repmat((weight(2)*data.(varNames{take(2)}))',10,1)+<span class="keyword">...</span>
                                    weight(4)*sin(rho)*data.(varNames{take(4)})',<span class="keyword">...</span>
                                    shiftdim(color(cIdx,:),-1),<span class="keyword">...</span>
                                    <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceAlpha'</span>, 0.5)
                                axis (<span class="string">'equal'</span>,<span class="string">'ij'</span>)
                                set(gca,<span class="string">'CLim'</span>, [min(weight(5)*data.(varNames{take(5)}))<span class="keyword">...</span>
                                    max(weight(5)*data.(varNames{take(5)}))])
                                xlabel(encodeType{take(1)});
                                ylabel(encodeType{take(2)});
                                hCBar = colorbar;
                                set(get(hCBar, <span class="string">'YLabel'</span>),<span class="string">'String'</span>, encodeType{take(5)}, <span class="string">'FontSize'</span>, 15)
                            <span class="keyword">case</span> <span class="string">'dualView'</span>
                            <span class="keyword">case</span> <span class="string">'tripleView'</span>
                        <span class="keyword">end</span> <span class="comment">%switch</span>
            <span class="keyword">case</span> <span class="string">'3D ImScatter'</span>
                        <span class="keyword">switch</span> getappdata(fig,<span class="string">'viewMode'</span>)
                            <span class="keyword">case</span> <span class="string">'monoView'</span>
                                transferVarList(figNew,fig,<span class="string">'render-mono'</span>)

                                <span class="comment">%framerange selected</span>
                                idx = [-1; cumsum(getappdata(figNew,<span class="string">'ctrsN'</span>))];
                                <span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
                                    setappdata(figNew,<span class="string">'startPnt'</span>,0)
                                <span class="keyword">else</span>
                                    setappdata(figNew,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                                        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
                                <span class="keyword">end</span> <span class="comment">%if</span>
                                <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
                                    setappdata(figNew,<span class="string">'rEnd'</span>,numel(getappdata(figNew,<span class="string">'ctrsN'</span>)))
                                    setappdata(figNew,<span class="string">'elements'</span>,inf)
                                <span class="keyword">else</span>
                                    setappdata(figNew,<span class="string">'elements'</span>,<span class="keyword">...</span>
                                        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                                        max(1,getappdata(figNew,<span class="string">'startPnt'</span>))+1)
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                <span class="comment">%get ROI</span>
                                roi = getappdata(fig,<span class="string">'roi'</span>);
                                data = preprocessData(figNew,returnVar(1:12),roi);

                                setappdata(figNew,<span class="string">'roiX0'</span>, roi(1))
                                setappdata(figNew,<span class="string">'roiY0'</span>, roi(2))
                                setappdata(figNew,<span class="string">'exfOld'</span>,getappdata(fig,<span class="string">'exfNew'</span>))

                                pnts = numel(data.(varNames{take(1)}));
                                set(figNew,<span class="keyword">...</span>
                                    <span class="string">'Name'</span>, [<span class="string">'3D Scatter: '</span> num2str(pnts)<span class="keyword">...</span>
                                    <span class="string">'\'</span> num2str(sum(getappdata(fig,<span class="string">'ctrsN'</span>))) <span class="string">' rendered'</span>],<span class="keyword">...</span>
                                    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                                    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                                    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>,<span class="keyword">...</span>
                                    <span class="string">'Visible'</span>, <span class="string">'on'</span>);
                                axes(<span class="keyword">...</span>
                                    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
                                    <span class="string">'Box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
                                    <span class="string">'Projection'</span>, <span class="string">'perspective'</span>,<span class="keyword">...</span>
                                    <span class="string">'TickDir'</span>, <span class="string">'in'</span>);

                                hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 13 14 16 17 18]))

                                x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*<span class="keyword">...</span>
                                    [weight(1)*data.(varNames{take(1)}),<span class="keyword">...</span>
                                    weight(4)*data.(varNames{take(4)})]';
                                y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*<span class="keyword">...</span>
                                    [weight(2)*data.(varNames{take(2)}),<span class="keyword">...</span>
                                    weight(4)*data.(varNames{take(4)})]';
                                z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*<span class="keyword">...</span>
                                    [weight(3)*data.(varNames{take(3)}),<span class="keyword">...</span>
                                    weight(4)*data.(varNames{take(4)})]';
                                vertices = [x(:) y(:) z(:)];

                                faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;<span class="keyword">...</span>
                                    6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                                face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                                face = faceIdx+face';

                                color = jet(256);
                                cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),<span class="keyword">...</span>
                                    max(weight(5)*data.(varNames{take(5)})),256);
                                [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);
                                cIdx = reshape(repmat(cIdx',8,1),[1 8*pnts]);

                                patch(<span class="string">'Faces'</span>,face,<span class="string">'Vertices'</span>,vertices,<span class="keyword">...</span>
                                    <span class="string">'FaceVertexCData'</span>, color(cIdx,:),<span class="keyword">...</span>
                                    <span class="string">'FaceColor'</span>, <span class="string">'flat'</span>);

                                view(3)
                                axis (<span class="string">'vis3d'</span>)
                                set(gca,<span class="string">'CLim'</span>, [min(weight(5)*data.(varNames{take(5)}))<span class="keyword">...</span>
                                    max(weight(5)*data.(varNames{take(5)}))])
                                <span class="comment">%xlabel(encodeType{take(1)});</span>
                                <span class="comment">%ylabel(encodeType{take(2)});</span>
                                <span class="comment">%zlabel(encodeType{take(3)})</span>
                                hCBar = colorbar;
                                set(get(hCBar, <span class="string">'YLabel'</span>),<span class="string">'String'</span>,<span class="keyword">...</span>
                                    encodeType{take(5)}, <span class="string">'FontSize'</span>, 15)
                            <span class="keyword">case</span> <span class="string">'dualView'</span>
                                <span class="comment">%check for tracking data</span>
                                <span class="keyword">if</span> imageBin{2}.isTrack
                                    n = 1;
                                    m = 1;
                                <span class="keyword">else</span>
                                    n = 2;
                                    m = 0;
                                <span class="keyword">end</span> <span class="comment">%if</span>

                                <span class="comment">%get ROI</span>
                                hRoi = findobj(hFig,<span class="string">'Tag'</span>, <span class="string">'roi'</span>);
                                <span class="keyword">if</span> isempty(hRoi)
                                    roi = imageBin{1}.roi;
                                <span class="keyword">else</span>
                                    roi =<span class="keyword">...</span>
                                        get(hRoi,<span class="string">'UserData'</span>)/imageBin{1}.exfOld;
                                <span class="keyword">end</span>

                                fig =<span class="keyword">...</span>
                                    figure(<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'Position'</span>, figPos(imageBin{1}.roi(3)/imageBin{1}.roi(4)),<span class="keyword">...</span>
                                    <span class="string">'Color'</span>, get(hFig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                                    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                                    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                                    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);
                                ax =<span class="keyword">...</span>
                                    axes(<span class="keyword">...</span>
                                    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
                                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                                    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
                                    <span class="string">'Box'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
                                    <span class="string">'Projection'</span>, <span class="string">'perspective'</span>,<span class="keyword">...</span>
                                    <span class="string">'TickDir'</span>, <span class="string">'in'</span>,<span class="keyword">...</span>
                                    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);

                                hToolBar = findall(fig,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 13 14 16 17 18]))

                                <span class="keyword">for</span> ch = 1:n
                                    idx{ch} = [-1; cumsum(imageBin{ch}.ctrsN)];
                                    <span class="comment">%framerange selected</span>
                                    <span class="keyword">if</span> isnan(imageBin{ch}.rStart)
                                        startPnt = 0;
                                    <span class="keyword">else</span>
                                        startPnt = idx{ch}(imageBin{ch}.rStart)+1;
                                    <span class="keyword">end</span> <span class="comment">%if</span>
                                    <span class="keyword">if</span> isnan(imageBin{ch}.rEnd)
                                        elements = inf;
                                    <span class="keyword">else</span>
                                        elements = idx{ch}(imageBin{ch}.rEnd+1)-max(1,startPnt)+1;
                                    <span class="keyword">end</span> <span class="comment">%if</span>

                                    data = preprocessData(returnVar(1:12),imageBin{ch},startPnt,elements);
                                    pnts = numel(data.(varNames{take(1)}));

                                    x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*<span class="keyword">...</span>
                                        [weight(1)*data.(varNames{take(1)}),weight(4)*data.(varNames{take(4)})]';
                                    y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*<span class="keyword">...</span>
                                        [weight(2)*data.(varNames{take(2)}),weight(4)*data.(varNames{take(4)})]';
                                    z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*<span class="keyword">...</span>
                                        [weight(3)*data.(varNames{take(3)}),weight(4)*data.(varNames{take(4)})]';
                                    vertices = [x(:) y(:) z(:)];

                                    faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;<span class="keyword">...</span>
                                        6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                                    face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                                    face = faceIdx+face';

                                    <span class="keyword">if</span> strcmp(varNames{take(5)},<span class="string">'channel'</span>)
                                        color = [0 0 0]; color(ch) = 1;
                                        cIdx = 1;
                                    <span class="keyword">else</span>
                                        color = jet(256);
                                        cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),<span class="keyword">...</span>
                                            max(weight(5)*data.(varNames{take(5)})),256);
                                        [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);
                                        cIdx = reshape(repmat(cIdx',8,1),[1 8*pnts]);
                                    <span class="keyword">end</span> <span class="comment">%if</span>

                                    patch(<span class="string">'Faces'</span>,face,<span class="string">'Vertices'</span>,vertices,<span class="keyword">...</span>
                                        <span class="string">'FaceVertexCData'</span>, color(cIdx,:),<span class="keyword">...</span>
                                        <span class="string">'FaceColor'</span>, <span class="string">'flat'</span>,<span class="string">'Parent'</span>, ax);
                                <span class="keyword">end</span> <span class="comment">%for</span>
                                view(3)
                                axis (<span class="string">'vis3d'</span>,<span class="string">'tight'</span>)
                                <span class="comment">%                                 set(ax,'CLim', [min(weight(5)*data.(varNames{take(5)}))...</span>
                                <span class="comment">%                                     max(weight(5)*data.(varNames{take(5)}))])</span>
                                <span class="comment">%                         xlabel(encodeType{take(1)}); ylabel(encodeType{take(2)});</span>
                                <span class="comment">%                         zlabel(encodeType{take(3)})</span>
                                hCBar = colorbar;
                                set(get(hCBar, <span class="string">'YLabel'</span>),<span class="string">'String'</span>, encodeType{take(5)}, <span class="string">'FontSize'</span>, 15)

                                <span class="comment">%                                 set(fig, 'Name', ['3D Scatter: ' num2str(pnts)...</span>
                                <span class="comment">%                                     '\' num2str(sum(imageBin.ctrsN)) ' rendered'])</span>
                            <span class="keyword">case</span> <span class="string">'tripleView'</span>
                        <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>ANALYSIS<a name="6"></a></h2><pre class="codeinput"><span class="keyword">function</span> intHist(src, event)
fig = gcbf;

figNew =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, figPos(1)+[0 0 0.1 0],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Intensitydistribution'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);

hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

<span class="keyword">switch</span> get(src, <span class="string">'Tag'</span>)
    <span class="keyword">case</span> <span class="string">'Pixel Intensity'</span>
        set(figNew, <span class="string">'Name'</span>, <span class="string">'Pixel Intensity'</span>)
        <span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
            pathname = getappdata(fig,<span class="string">'pathname'</span>);
            filename = getappdata(fig,<span class="string">'filename'</span>);
            I = double(imread([pathname{getappdata(fig,<span class="string">'stack'</span>)}<span class="keyword">...</span>
                filename{getappdata(fig,<span class="string">'stack'</span>)}],getappdata(fig,<span class="string">'frame'</span>)));
        <span class="keyword">else</span>
            I = double(imread([getappdata(fig,<span class="string">'pathname'</span>)<span class="keyword">...</span>
                getappdata(fig,<span class="string">'filename'</span>)],getappdata(fig,<span class="string">'frame'</span>)));
        <span class="keyword">end</span> <span class="comment">%if</span>

        ax =<span class="keyword">...</span>
            axes(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);

        buildHistogram(ax,I(:),<span class="string">'counts'</span>)
        xlabel(ax,<span class="string">'Pixelintensity [counts]'</span>)

    <span class="keyword">case</span> <span class="string">'Particle Intensity'</span>
        icon = getappdata(1, <span class="string">'icons'</span>);
        uipushtool(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, hToolBar,<span class="keyword">...</span>
            <span class="string">'CData'</span>, repmat(icon.fit, [1 1 3]),<span class="keyword">...</span>
            <span class="string">'ClickedCallback'</span>, @fitDist,<span class="keyword">...</span>
            <span class="string">'Separator'</span>, <span class="string">'on'</span>)

        ax =<span class="keyword">...</span>
            subplot(20,1,[14,1],<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 20,<span class="keyword">...</span>
            <span class="string">'NextPlot'</span>, <span class="string">'add'</span>,<span class="keyword">...</span>
            <span class="string">'XTickLabel'</span>,<span class="string">''</span>);

        idx = [-1; cumsum(getappdata(fig,<span class="string">'ctrsN'</span>))];
        <span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
            setappdata(fig,<span class="string">'startPnt'</span>,0)
        <span class="keyword">else</span>
            setappdata(fig,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
                idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
            setappdata(fig,<span class="string">'rEnd'</span>,numel(getappdata(fig,<span class="string">'ctrsN'</span>)))
            setappdata(fig,<span class="string">'elements'</span>,inf)
        <span class="keyword">else</span>
            setappdata(fig,<span class="string">'elements'</span>,<span class="keyword">...</span>
                idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
                max(1,getappdata(fig,<span class="string">'startPnt'</span>))+1)
        <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="comment">%get roi</span>
        roi = getappdata(fig,<span class="string">'roi'</span>);
        data = preprocessData(fig,[0 0 0 0 0 0 0 1 0 0 0 0],roi);

        [freq, ctrs] = hist(data.photons,calcnbins(data.photons,<span class="string">'fd'</span>));
        hStair = stairs(ctrs,freq);
        set(hStair, <span class="keyword">...</span>
            <span class="string">'Tag'</span>, <span class="string">'Intensityhistogram'</span>,<span class="keyword">...</span>
            <span class="string">'Userdata'</span>, {freq,ksdensity(data.photons,ctrs)})
        set(fig, <span class="string">'Name'</span>, [<span class="string">'Particle Intensity: '</span> num2str(numel(data.photons)) <span class="string">'\'</span><span class="keyword">...</span>
            num2str(sum(getappdata(fig,<span class="string">'ctrsN'</span>))) <span class="string">' rendered'</span>])

        axis <span class="string">tight</span>
        ylabel(<span class="string">'Frequency'</span>);

        errAx =<span class="keyword">...</span>
            subplot(20,1,16:19,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 20,<span class="keyword">...</span>
            <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);
        ylabel(<span class="string">'Residuals'</span>);
        xlabel(<span class="string">'Particleintensity [photons]'</span>);
        linkaxes([ax errAx],<span class="string">'x'</span>)
<span class="keyword">end</span> <span class="comment">%switch</span>

    <span class="keyword">function</span> fitDist(src, event)
        fitFig =<span class="keyword">...</span>
            figure(<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.6 0.4 0.3 0.4],<span class="keyword">...</span>
            <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
            <span class="string">'Name'</span>, <span class="string">'Fit'</span>,<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'ToolBar'</span>, <span class="string">'none'</span>);

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.1 0.9 0.8 0.07],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'Subpopulations:'</span>)

        hTable =<span class="keyword">...</span>
            uitable(<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.05 0.15 0.9 0.6],<span class="keyword">...</span>
            <span class="string">'ColumnName'</span>, {<span class="string">'Fraction'</span>, <span class="string">'Photons'</span>, <span class="string">'Error'</span>},<span class="keyword">...</span>
            <span class="string">'ColumnFormat'</span>, {<span class="string">'numeric'</span>,<span class="string">'numeric'</span>,<span class="string">'numeric'</span>},<span class="keyword">...</span>
            <span class="string">'ColumnWidth'</span>, {104},<span class="keyword">...</span>
            <span class="string">'data'</span>, cell(3,3),<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 10);

        hSubpops(1) =<span class="keyword">...</span>
            uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.3 0.8 0.6 0.06],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'String'</span>, {<span class="string">'1x constraint'</span><span class="keyword">...</span>
            <span class="string">'1x constraint + 1x free'</span>, <span class="string">'2x constraint'</span>,<span class="keyword">...</span><span class="comment">.</span>
            <span class="string">'2x constraint + 1x free'</span>, <span class="string">'3x constraint'</span>,<span class="keyword">...</span>
            <span class="string">'3x constraint + 1x free'</span>, <span class="string">'4x constraint'</span>},<span class="keyword">...</span>
            <span class="string">'Value'</span>, 3);

        hSubpops(2) =<span class="keyword">...</span>
            uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.3 0.8 0.6 0.06],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'String'</span>, {<span class="string">'Scan for optimal # of fractions'</span>,<span class="keyword">...</span>
            <span class="string">'Set # of fractions w\o initial guess'</span>,<span class="keyword">...</span>
            <span class="string">'Set # of fractions with initial guess'</span>},<span class="keyword">...</span>
            <span class="string">'Value'</span>, 1,<span class="keyword">...</span>
            <span class="string">'Visible'</span>,<span class="string">'off'</span>);

        hMethod =<span class="keyword">...</span>
            uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.1 0.8 0.2 0.06],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'String'</span>, {<span class="string">'OLS'</span>,<span class="string">'MLE'</span>},<span class="keyword">...</span>
            <span class="string">'Value'</span>, 1,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @changeMethod);

        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
            <span class="string">'Parent'</span>, fitFig,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.1 0.05 0.8 0.06],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'FIT'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @estimatePar)

        <span class="keyword">function</span> changeMethod(src,event)
            set(hSubpops,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
            set(hSubpops(get(src,<span class="string">'Value'</span>)),<span class="string">'Visible'</span>,<span class="string">'on'</span>)
            vals = get(hStair,<span class="string">'UserData'</span>);
            set(hStair,<span class="string">'YData'</span>,vals{get(src,<span class="string">'Value'</span>)})

            delete(findobj(ax, <span class="string">'Tag'</span>, <span class="string">'fit'</span>))
            axis(ax,<span class="string">'tight'</span>)
        <span class="keyword">end</span>
        <span class="keyword">function</span> estimatePar(src, event)
            <span class="keyword">switch</span> get(hMethod,<span class="string">'Value'</span>)
                <span class="keyword">case</span> 1
                    <span class="keyword">switch</span> get(hSubpops(1), <span class="string">'Value'</span>)
                        <span class="keyword">case</span> 1
                            fractions = 1;
                            f = fittype(<span class="string">'gauss1'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal)
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf];
                        <span class="keyword">case</span> 2
                            fractions = 2;
                            f = fittype(<span class="string">'gauss2'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0];
                            uBnd = [inf,inf,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf];
                        <span class="keyword">case</span> 3
                            fractions = 2;
                            f = fittype(<span class="string">'gauss2'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf];
                        <span class="keyword">case</span> 4
                            fractions = 3;
                            f = fittype(<span class="string">'gauss3'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0,<span class="keyword">...</span>
                                0,startPnts(8)-startPnts(8)/100,0];
                            uBnd = [inf,inf,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(8)+startPnts(8)/100,inf];
                        <span class="keyword">case</span> 5
                            fractions = 3;
                            f = fittype(<span class="string">'gauss3'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0,<span class="keyword">...</span>
                                0,startPnts(8)-startPnts(8)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(8)+startPnts(8)/100,inf];
                        <span class="keyword">case</span> 6
                            fractions = 4;
                            f = fittype(<span class="string">'gauss4'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0,<span class="keyword">...</span>
                                0,startPnts(8)-startPnts(8)/100,0,<span class="keyword">...</span>
                                0,startPnts(11)-startPnts(11)/100,0];
                            uBnd = [inf,inf,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(8)+startPnts(8)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(11)+startPnts(11)/100,inf];
                        <span class="keyword">case</span> 7
                            fractions = 4;
                            f = fittype(<span class="string">'gauss4'</span>);
                            preVal = getappdata(fig,<span class="string">'preVal'</span>);
                            <span class="keyword">if</span> isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>);
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            <span class="keyword">end</span>
                            answer =<span class="keyword">...</span>
                                inputdlg(<span class="keyword">...</span>
                                coeffnames(f),<span class="keyword">...</span>
                                <span class="string">'StartValues'</span>,1,<span class="keyword">...</span>
                                preVal);
                            setappdata(fig,<span class="string">'preVal'</span>,answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,<span class="keyword">...</span>
                                0,startPnts(5)-startPnts(5)/100,0,<span class="keyword">...</span>
                                0,startPnts(8)-startPnts(8)/100,0,<span class="keyword">...</span>
                                0,startPnts(11)-startPnts(11)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(5)+startPnts(5)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(8)+startPnts(8)/100,inf,<span class="keyword">...</span>
                                inf,startPnts(11)+startPnts(11)/100,inf];
                    <span class="keyword">end</span> <span class="comment">%switch</span>
                    delete(findobj(ax, <span class="string">'Tag'</span>, <span class="string">'fit'</span>))
                    cla(errAx)

                    opt = fitoptions(<span class="string">'method'</span>,<span class="string">'NonlinearLeastSquares'</span>,<span class="keyword">...</span>
                        <span class="string">'StartPoint'</span>, startPnts,<span class="keyword">...</span>
                        <span class="string">'Lower'</span>, lBnd, <span class="string">'Upper'</span>, uBnd);
                    [fitFractions statsFraction outpuFractions] =<span class="keyword">...</span>
                        fit(ctrs',freq',f,opt);

                    plot(ax, ctrs, feval(fitFractions,ctrs),<span class="keyword">...</span>
                        <span class="string">'Color'</span>, [1 0 0], <span class="string">'LineWidth'</span>, 2, <span class="string">'Tag'</span>, <span class="string">'fit'</span>);
                    stem(errAx, ctrs, outpuFractions.residuals)
                    legend(errAx, [<span class="string">'RMSE = '</span> num2str(statsFraction.rmse)])

                    results = transpose(reshape(coeffvalues(fitFractions),<span class="keyword">...</span>
                        3,fractions));
                <span class="keyword">case</span> 2
                    options = statset(<span class="string">'MaxIter'</span>,1000);

                    <span class="keyword">switch</span> get(hSubpops(2), <span class="string">'Value'</span>)
                        <span class="keyword">case</span> 1
                            fractions = str2double(<span class="keyword">...</span>
                                inputdlg(<span class="string">'max. # Fractions:'</span>,<span class="string">'Scan Options'</span>));

                            AIC = zeros(1,fractions);
                            mixComponents = cell(1,fractions);
                            <span class="keyword">for</span> k = 1:fractions
                                mixComponents{k} = <span class="keyword">...</span>
                                    gmdistribution.fit(data.photons,k,<span class="keyword">...</span>
                                    <span class="string">'Options'</span>, options);
                                AIC(k)= mixComponents{k}.AIC;
                            <span class="keyword">end</span>
                            [minAIC,fractions] = min(AIC);
                            mixComponents = mixComponents{fractions};
                        <span class="keyword">case</span> 2
                            fractions = str2double(<span class="keyword">...</span>
                                inputdlg(<span class="string">'# of Fractions:'</span>,<span class="string">'Fit Options'</span>));

                            mixComponents = <span class="keyword">...</span>
                                gmdistribution.fit(data.photons,fractions,<span class="keyword">...</span>
                                <span class="string">'Options'</span>, options);
                        <span class="keyword">case</span> 3
                    <span class="keyword">end</span> <span class="comment">%switch</span>
                    delete(findobj(ax, <span class="string">'Tag'</span>, <span class="string">'fit'</span>))
                    cla(errAx)

                    <span class="comment">%                 [P,nlogl] = posterior(mixComponents,data.photons);</span>

                    plot(ax, ctrs', pdf(mixComponents,ctrs'),<span class="keyword">...</span>
                        <span class="string">'Color'</span>, [1 0 0], <span class="string">'LineWidth'</span>, 2, <span class="string">'Tag'</span>, <span class="string">'fit'</span>);
                    results = [mixComponents.PComponents'./<span class="keyword">...</span>
                        sqrt(2*pi*mixComponents.Sigma(:)),<span class="keyword">...</span>
                        mixComponents.mu,<span class="keyword">...</span>
                        sqrt(mixComponents.Sigma(:))];
            <span class="keyword">end</span>

            gauss = @(x,a,b,c) a*exp(-((x-b)/c).^2);
            ctrsInterp = linspace(min(ctrs),max(ctrs),10*numel(ctrs))';
            freqSub = zeros(fractions,numel(ctrsInterp));
            <span class="keyword">for</span> N = 1:fractions
                freqSub(N,:) = gauss(ctrsInterp,<span class="keyword">...</span>
                    results(N,1),results(N,2),results(N,3));
                plot(ax, ctrsInterp, freqSub(N,:), <span class="string">'r'</span>, <span class="string">'Tag'</span>, <span class="string">'fit'</span>)
            <span class="keyword">end</span> <span class="comment">%for</span>
            axis(ax,<span class="string">'tight'</span>)

            <span class="keyword">switch</span> get(hMethod,<span class="string">'Value'</span>)
                <span class="keyword">case</span> 1
                    set(hTable, <span class="string">'data'</span>, [sum(freqSub,2)/sum(freq) results(:,2:3)])
                <span class="keyword">case</span> 2
                    set(hTable, <span class="string">'data'</span>, [mixComponents.PComponents' results(:,2:3)])
            <span class="keyword">end</span> <span class="comment">%switch</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> locPrec(src, event)
fig = gcbf;

idx = [-1; cumsum(getappdata(fig,<span class="string">'ctrsN'</span>))];
<span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
    setappdata(fig,<span class="string">'startPnt'</span>,0)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
    setappdata(fig,<span class="string">'rEnd'</span>,numel(getappdata(fig,<span class="string">'ctrsN'</span>)))
    setappdata(fig,<span class="string">'elements'</span>,inf)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'elements'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
        max(1,getappdata(fig,<span class="string">'startPnt'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%get ROI</span>
roi = getappdata(fig,<span class="string">'roi'</span>);
data = preprocessData(fig,[0 0 0 0 0 0 0 0 1 0 0 0],roi);

figNew =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, figPos(1)+[0 0 0.2 0],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, [<span class="string">'Loc. Precision: '</span> num2str(numel(data.precision)) <span class="string">'\'</span><span class="keyword">...</span>
    num2str(sum(getappdata(fig,<span class="string">'ctrsN'</span>))) <span class="string">' rendered'</span>],<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);

hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);

buildHistogram(ax,data.precision*1000,<span class="string">'nm'</span>)
xlabel(ax,<span class="string">'Localization Precision [nm]'</span>)
<span class="keyword">end</span>
<span class="keyword">function</span> snrHist(src, event)
fig = gcbf;

idx = [-1; cumsum(getappdata(fig,<span class="string">'ctrsN'</span>))];
<span class="keyword">if</span> getappdata(fig,<span class="string">'rStart'</span>) == 1
    setappdata(fig,<span class="string">'startPnt'</span>,0)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'rStart'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'rEnd'</span>))
    setappdata(fig,<span class="string">'rEnd'</span>,numel(getappdata(fig,<span class="string">'ctrsN'</span>)))
    setappdata(fig,<span class="string">'elements'</span>,inf)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'elements'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'rEnd'</span>)+1)-<span class="keyword">...</span>
        max(1,getappdata(fig,<span class="string">'startPnt'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%get ROI</span>
roi = getappdata(fig,<span class="string">'roi'</span>);
data = preprocessData(fig,[0 0 0 0 0 0 0 0 0 1 0 0],roi);

figNew =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, figPos(1)+[0 0 0.2 0],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, [<span class="string">'Loc. Precision: '</span> num2str(numel(data.snr)) <span class="string">'\'</span><span class="keyword">...</span>
    num2str(sum(getappdata(fig,<span class="string">'ctrsN'</span>))) <span class="string">' rendered'</span>],<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);

hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);

buildHistogram(ax,data.snr,<span class="string">''</span>)
xlabel(ax,<span class="string">'Signal to Noise Ratio'</span>)
<span class="keyword">end</span>
<span class="keyword">function</span> detectionTrace(src, event)
fig = gcbf;

figNew =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, figPos(1)+[0 0 0.2 0],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Detectiontrace'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>);
hToolBar = findall(figNew,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax(1) =<span class="keyword">...</span>
    subplot(2,1,1,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 20,<span class="keyword">...</span>
    <span class="string">'NextPlot'</span>, <span class="string">'add'</span>);

ctrsN = getappdata(fig,<span class="string">'ctrsN'</span>);
plot(ax(1), ctrsN)
plot(ax(1), smooth(ctrsN,0.25,<span class="string">'loess'</span>),<span class="keyword">...</span>
    <span class="string">'Color'</span>, [1 0 0], <span class="string">'LineWidth'</span>, 2)
axis <span class="string">tight</span>
xlabel(<span class="string">'Frame'</span>); ylabel(<span class="string">'Particledetections'</span>);

ax(2) =<span class="keyword">...</span>
    subplot(2,1,2,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, figNew,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 20);

buildHistogram(ax(2),ctrsN,<span class="string">''</span>)
xlabel(ax(2),<span class="string">'Particledetections'</span>)
<span class="keyword">end</span>

<span class="keyword">function</span> interactionStudy(src,event)
<span class="keyword">end</span>

<span class="keyword">function</span> colocFilter(src,event)
fig = imgcf;
srcFig = getappdata(fig,<span class="string">'imSrcFig'</span>);
imCh = getappdata(fig,<span class="string">'imCh'</span>);
nImCh = getappdata(fig,<span class="string">'nImCh'</span>);

returnValue = [1 1 0 0 0 0 1 1 0 0 0 0];
<span class="keyword">for</span> ch = 1:nImCh
    <span class="comment">%load whole list</span>
    setappdata(srcFig(imCh(ch)),<span class="string">'startPnt'</span>,0)
    setappdata(srcFig(imCh(ch)),<span class="string">'endPnt'</span>,inf)
    roi = [0 0 <span class="keyword">...</span>
        getappdata(srcFig(imCh(ch)),<span class="string">'width'</span>)<span class="keyword">...</span>
        getappdata(srcFig(imCh(ch)),<span class="string">'height'</span>)];
    data{ch} =<span class="keyword">...</span>
        preprocessData(srcFig(imCh(ch)),returnValue,roi);
<span class="keyword">end</span> <span class="comment">%for</span>
width = getappdata(srcFig(imCh(1)),<span class="string">'width'</span>);
height = getappdata(srcFig(imCh(1)),<span class="string">'height'</span>);

<span class="comment">%max. allowed distance [px]</span>
thresh = 2;

hProgressbar = waitbar(0,<span class="string">'Generating Images...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
    get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
<span class="keyword">for</span> frame = 1:getappdata(srcFig(imCh(1)),<span class="string">'rEnd'</span>)
    [idx{1} idx{2}] = filterData(data);
    nColoc(frame) = numel(idx{1});

    <span class="keyword">if</span> nColoc(frame) &gt; 0
        <span class="comment">%calculate linear indices of particle detection for 2d-matrix</span>
        [cntY idxY] = histc(data{1}.ctrsY(idx{1}),1:height);
        [cntX idxX] = histc(data{1}.ctrsX(idx{1}),1:width);
        linIdx = idxX*height+idxY+1;
        [linIdx unused subs] = unique(linIdx);

        imRendered = zeros(height,width);
        imRendered(linIdx) = accumarray(subs,data{1}.photons(idx{1})*20.2);
        psf = buildPSF(1,width,height);
        imRendered = fftshift(ifft2(fft2(imRendered).* psf));
        imwrite(uint8(imRendered),<span class="keyword">...</span>
            [getappdata(srcFig(imCh(1)),<span class="string">'pathname'</span>)<span class="keyword">...</span>
            getappdata(srcFig(imCh(1)),<span class="string">'filename'</span>) <span class="string">'_faked.tif'</span>],<span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Writemode'</span>, <span class="string">'append'</span>)

        [cntY idxY] = histc(data{2}.ctrsY(idx{2}),1:height);
        [cntX idxX] = histc(data{2}.ctrsX(idx{2}),1:width);
        linIdx = idxX*height+idxY+1;
        [linIdx unused subs] = unique(linIdx);

        imRendered = zeros(height,width);
        imRendered(linIdx) = accumarray(subs,data{1}.photons(idx{1})*20.2);
        psf = buildPSF(1,width,height);
        imRendered = fftshift(ifft2(fft2(imRendered).* psf));
        imwrite(uint8(imRendered),<span class="keyword">...</span>
            [getappdata(srcFig(imCh(2)),<span class="string">'pathname'</span>)<span class="keyword">...</span>
            getappdata(srcFig(imCh(2)),<span class="string">'filename'</span>) <span class="string">'_faked.tif'</span>],<span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Writemode'</span>, <span class="string">'append'</span>)
    <span class="keyword">else</span>
        imRendered = zeros(height,width,<span class="string">'uint8'</span>);
        imwrite(imRendered,<span class="keyword">...</span>
            [getappdata(srcFig(imCh(1)),<span class="string">'pathname'</span>)<span class="keyword">...</span>
            getappdata(srcFig(imCh(1)),<span class="string">'filename'</span>) <span class="string">'_faked.tif'</span>],<span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Writemode'</span>, <span class="string">'append'</span>)
        imwrite(imRendered,<span class="keyword">...</span>
            [getappdata(srcFig(imCh(2)),<span class="string">'pathname'</span>)<span class="keyword">...</span>
            getappdata(srcFig(imCh(2)),<span class="string">'filename'</span>) <span class="string">'_faked.tif'</span>],<span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Writemode'</span>, <span class="string">'append'</span>)
        <span class="keyword">continue</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
    waitbar(frame/getappdata(srcFig(imCh(1)),<span class="string">'rEnd'</span>),<span class="keyword">...</span>
        hProgressbar,<span class="string">'Generating Images...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
        get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
<span class="keyword">end</span> <span class="comment">%for</span>
delete(hProgressbar)

[outputname,outputpath,isOK] = uiputfile(<span class="keyword">...</span>
    <span class="string">'.txt'</span> ,<span class="string">'Save #CoLoc/Frame to'</span>, getappdata(0,<span class="string">'searchPath'</span>));
fid = fopen([outputpath outputname], <span class="string">'wt'</span>);
fprintf(fid,<span class="string">'%.0f \n'</span>,nColoc)
fclose(fid);

    <span class="keyword">function</span> [idxCh1 idxCh2] = filterData(data)
        good{1} = (data{1}.frame == frame);
        good{2} = (data{2}.frame == frame);

        sizey1 = numel(data{1}.ctrsY(good{1}));
        sizey2 = numel(data{2}.ctrsY(good{2}));

        y1Mat = repmat(data{1}.ctrsY(good{1}),1,sizey2);
        y2Mat = repmat(data{2}.ctrsY(good{2})',sizey1,1);
        yDiffMat = (y1Mat-y2Mat).^2;

        sizex1 = numel(data{1}.ctrsX(good{1}));
        sizex2 = numel(data{2}.ctrsX(good{2}));

        x1Mat = repmat(data{1}.ctrsX(good{1}),1,sizex2);
        x2Mat = repmat(data{2}.ctrsX(good{2})',sizex1,1);
        xDiffMat = (x1Mat-x2Mat).^2;

        d = sqrt(yDiffMat+xDiffMat);
        good = min(d,1) &amp; min(d,2);
        [idxCh1 idxCh2] = find(d &lt;= thresh &amp; good);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> particleImageCorrelation(src,event)
fig = imgcf;

<span class="comment">%set correlation sampling rate</span>
samplingRate = 5; <span class="comment">%[px^-1]</span>
dMax = 15; <span class="comment">%[px]</span>

roi = getappdata(fig,<span class="string">'roi'</span>);
<span class="comment">%reduce field of view to obtain</span>
<span class="comment">%true distribution of step sizes up</span>
<span class="comment">%to a distance dMax</span>
roi = [max(roi(1:2),dMax),<span class="keyword">...</span>
    min(roi(3:4),<span class="keyword">...</span>
    [getappdata(fig,<span class="string">'width'</span>) <span class="keyword">...</span>
    getappdata(fig,<span class="string">'height'</span>)]-dMax)];

data = preprocessData(fig,[1 1 0 0 0 0 1 0 0 0 0 0],roi);

nIm = numel(getappdata(fig,<span class="string">'ctrsN'</span>));
nPnts = numel(data.ctrsX);

<span class="comment">%generate 2d-projected tree</span>
pntList = [data.ctrsX data.ctrsY];
tree = kdtree_build(pntList);

<span class="comment">%average particle # for increasing dt</span>
pntsPerFrame = accumarray(data.frame,1);
muPnts = zeros(1,nIm-1);
<span class="keyword">for</span> dt = 1:nIm-1
    muPnts(dt) = mean(pntsPerFrame(1:nIm-dt));
<span class="keyword">end</span>

Ccum = zeros(dMax,nIm-1);
<span class="keyword">for</span> d = 1:ceil(dMax*samplingRate)
    <span class="comment">%reset count matrix</span>
    cnts = zeros(nPnts,nIm-1);
    <span class="keyword">for</span> pnt = 1:nPnts
        iNN = kdtree_ball_query(tree,<span class="keyword">...</span>
            pntList(pnt,:),d/samplingRate);
        dt = data.frame(iNN)-data.frame(pnt);
        <span class="comment">%allow only temporal forward correlation</span>
        good = (dt&gt;0);
        <span class="keyword">if</span> any(good)
            <span class="comment">%overlap integral for image pairs separated</span>
            <span class="comment">%by dt</span>
            cnts(pnt,:) = accumarray(dt(good),1,[nIm-1 1]);
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%for</span>
    <span class="comment">%average over n*dt and normalize to average</span>
    <span class="comment">%particle # for n*dt</span>
    Ccum(d,:) = (sum(cnts)./(nIm-1:-1:1))./muPnts;
<span class="keyword">end</span> <span class="comment">%for</span>
kdtree_delete(tree)

<span class="comment">%calculate spatial correction term</span>
z = []; x = []; y = [];
<span class="keyword">for</span> dt = 1:nIm-1
    linStart = find(Ccum(:,dt)&gt;1,1,<span class="string">'first'</span>);
    z = [z; Ccum(linStart:end,dt)];
    y = [y; ((linStart:dMax*samplingRate)/samplingRate)'];
    x = [x; ones(dMax*samplingRate-linStart+1,1)*dt];
<span class="keyword">end</span>
[b,bint,r,rint,stats] =<span class="keyword">...</span>
    regress(z,[ones(size(z)) x y.^2]);
[XFIT,YFIT] = meshgrid(1:nIm-1,<span class="keyword">...</span>
    ((1:ceil(dMax*samplingRate))/samplingRate).^2);
ZHAT = b(2)*XFIT + b(3)*YFIT;
Ccum = Ccum-ZHAT;

<span class="comment">%control figure</span>
<span class="comment">% figure;</span>
<span class="comment">% surf(XFIT(1,:),YFIT(:,1),...</span>
<span class="comment">%     Ccum,'EdgeColor','flat','FaceAlpha', 0.9)</span>
<span class="comment">% hold on</span>
<span class="comment">% plot3(x, y.^2, z, 'm.')</span>
<span class="comment">% plot3(XFIT,YFIT,ZHAT+b(1), 'r-')</span>
<span class="keyword">end</span>
</pre><h2>LOCALIZATION<a name="7"></a></h2><pre class="codeinput"><span class="keyword">function</span> localization(src,event)
fig = gcbf;
imageBin = getappdata(fig);

imageBin.imageName = strcat(imageBin.pathname,<span class="keyword">...</span>
    imageBin.filename);

<span class="comment">%select localization output filename</span>
<span class="keyword">if</span> iscell(imageBin.filename)
    <span class="comment">%if there are multiple filenames, find their union</span>
    cnt = 1;
    <span class="keyword">while</span> all(strncmp(imageBin.filename{1},<span class="keyword">...</span>
            imageBin.filename,cnt))
        cnt = cnt+1;
    <span class="keyword">end</span> <span class="comment">%while</span>
    <span class="keyword">if</span> cnt &gt; 1
        imageBin.filename = imageBin.filename{1}(1:cnt-1);
    <span class="keyword">else</span>
        <span class="comment">%no union</span>
        imageBin.filename = [];
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">else</span>
    imageBin.filename = imageBin.filename(1:end-4);
<span class="keyword">end</span> <span class="comment">%if</span>
[imageBin.filename,imageBin.pathname,isOK] =<span class="keyword">...</span>
    uiputfile(<span class="string">''</span>,<span class="string">'Save to'</span>,<span class="keyword">...</span>
    [getappdata(0,<span class="string">'searchPath'</span>)<span class="keyword">...</span>
    imageBin.filename]);
<span class="keyword">if</span> isOK
    <span class="comment">%check if filename already existent in folder</span>
    [imageBin.filename, imageBin.pathname, abort] =<span class="keyword">...</span>
        checkNameExistance(imageBin.filename,imageBin.pathname);
    <span class="keyword">if</span> abort
        <span class="keyword">return</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">else</span>
    <span class="keyword">return</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%search for ROI</span>
<span class="keyword">if</span> isempty(getappdata(fig,<span class="string">'hROI'</span>))
    imageBin.roi =<span class="keyword">...</span>
        [1 1 getappdata(fig,<span class="string">'width'</span>)<span class="keyword">...</span>
        getappdata(fig,<span class="string">'height'</span>)];
<span class="keyword">else</span>
    imageBin.roi = ceil(getappdata(fig,<span class="string">'roi'</span>));
<span class="keyword">end</span>
tic
<span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
    N = 0;
    findStartPnt = 1;
    foundEndPnt = 0;
    <span class="keyword">for</span> file = 1:numel(imageBin.imageName)
        info = imfinfo(imageBin.imageName{file});

        N = N + numel(info);
        <span class="keyword">if</span> findStartPnt
            <span class="keyword">if</span> N &gt;= getappdata(fig,<span class="string">'locStart'</span>)
                startPnt = getappdata(fig,<span class="string">'locStart'</span>)-<span class="keyword">...</span>
                    (N-numel(info));
                findStartPnt = 0;
            <span class="keyword">else</span>
                <span class="comment">%loop until startPnt is inside actual stack</span>
                <span class="keyword">continue</span>
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">else</span>
            startPnt = 1;
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'locEnd'</span>))
            endPnt = numel(info);
        <span class="keyword">else</span>
            <span class="keyword">if</span> N &gt; getappdata(fig,<span class="string">'locEnd'</span>)
                endPnt = numel(info)-<span class="keyword">...</span>
                    (N-getappdata(fig,<span class="string">'locEnd'</span>));
                foundEndPnt = 1;
            <span class="keyword">elseif</span> N == getappdata(fig,<span class="string">'locEnd'</span>)
                endPnt = numel(info);
                foundEndPnt = 1;
            <span class="keyword">else</span>
                endPnt = numel(info);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
        imageBin.imageName{file}
        imageBin.ctrsN{file} = localizeParticles(imageBin.imageName{file},<span class="keyword">...</span>
            startPnt,endPnt,info,imageBin);
        <span class="keyword">if</span> foundEndPnt
            <span class="keyword">break</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%for</span>
    imageBin.ctrsN = vertcat(imageBin.ctrsN{:});
<span class="keyword">else</span>
    info = imfinfo(imageBin.imageName);
    <span class="keyword">if</span> isnan(getappdata(fig,<span class="string">'locStart'</span>))
        startPnt = 1;
    <span class="keyword">else</span>
        startPnt = getappdata(fig,<span class="string">'locStart'</span>);
    <span class="keyword">end</span> <span class="comment">%if</span>

    <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'locEnd'</span>))
        endPnt = numel(info);
    <span class="keyword">else</span>
        endPnt = getappdata(fig,<span class="string">'locEnd'</span>);
    <span class="keyword">end</span> <span class="comment">%if</span>
    imageBin.imageName
    imageBin.ctrsN = localizeParticles(imageBin.imageName,<span class="keyword">...</span>
        startPnt,endPnt,info,imageBin);
<span class="keyword">end</span>
toc
<span class="comment">%save localization matrix</span>
saveSettingsToDisk(imageBin)

    <span class="keyword">function</span> saveSettingsToDisk(imageBin)
        save([imageBin.pathname imageBin.filename <span class="string">'.mat'</span>],<span class="string">'imageBin'</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> batchLocalization(src,event)
menuFig =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0 0 1 1],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Batch Container'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'on'</span>);

hList =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'listbox'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0 0 0.8 1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @updatePanelVisibility);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0.18 0.05 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 25,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'+'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@addStack, hList})

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.18 0.05 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 30,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'-'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@delStack, hList})

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.9 0.18 0.05 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'UP'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@moveUpStack, hList})

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.95 0.18 0.05 0.1],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'DOWN'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@moveDownStack, hList})

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0 0.2 0.18],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 20,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'START'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, {@processBatch, hList})

hLocOptPanel =<span class="keyword">...</span>
    uipanel(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, menuFig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0.58 0.2 0.42],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'Title'</span>,<span class="string">'Localization'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.9 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Error Rate [10^]:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'This Value limits the Probability for Type One Error (False H0 Rejection), \n'</span><span class="keyword">...</span>
    <span class="string">'while estimation of the generalized likelihood ratio test. \n'</span><span class="keyword">...</span>
    <span class="string">'These Ratios follow aproximated a chi^2 distribution\n'</span><span class="keyword">...</span>
    <span class="string">'with degree of freedom (3 [signal, offset, noise]-2[offset, noise]) = 1'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'errRate'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.89 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, -6);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.82 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Detection Box [px]:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'Size of 2 dimensional sliding box inside whom a \n'</span><span class="keyword">...</span>
    <span class="string">'generalized likelihood ratio test (H0/H1) is performed with: \n'</span><span class="keyword">...</span>
    <span class="string">'H0 = no target (offset and noise) \n'</span><span class="keyword">...</span>
    <span class="string">'H1 = presence of target (signal, offset and noise) \n'</span><span class="keyword">...</span>
    <span class="string">'followed by subpixel estimation via Gauss-Newton Approximation'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'w2d'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.81 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 7);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.74 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Deflation Loops:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'This Value determines how often the detection process will be iterated. \n'</span><span class="keyword">...</span>
    <span class="string">'After each Iteration the detected Particles represented by their \n'</span><span class="keyword">...</span>
    <span class="string">'gaussian Intensity Profile will be subtracted from the Image. \n'</span><span class="keyword">...</span>
    <span class="string">'In this way small peaks initially covered can be detected.'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'dfltnLoops'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.73 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 0);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.66 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Intensity Thresh [cnts]:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'Defines the min. Signal Intensity expressed as'</span><span class="keyword">...</span>
    <span class="string">'offset-corrected amplitude of the Gaussian.'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'minInt'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.65 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 0);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'locParallel'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.58 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'use multiple cores'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>, false,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'If this option is checked the programm will perform \n'</span><span class="keyword">...</span>
    <span class="string">'the particle localization process using the specefied \n'</span><span class="keyword">...</span>
    <span class="string">'number of processor cores. \n'</span><span class="keyword">...</span>
    <span class="string">'The maximum of available cores will be used by default.'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'nCores'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.57 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, {<span class="string">'max'</span> <span class="string">'2'</span> <span class="string">'3'</span>},<span class="keyword">...</span>
    <span class="string">'Value'</span>, 1);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.45 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Optimization Settings'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.37 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'max. # iterations:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'maxOptimIter'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.36 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 50);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.29 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'term. tol. [10^]:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'termTol'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.28 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, -2);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'isRadiusTol'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.21 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'r0 tolerance [%]:'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>, false,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
    <span class="string">'If this option is checked the programm will optimize for \n'</span><span class="keyword">...</span>
    <span class="string">'the gaussian radius approximating the point spreads function std. \n'</span><span class="keyword">...</span><span class="comment">.</span>
    <span class="string">'If the tolerancelevel set is exceeded the particle will be discarded.'</span>]));

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'radiusTol'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.2 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 10);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.01 0.13 0.7 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'max. pos. refinement [px]:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, hLocOptPanel,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'posTol'</span>,<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.71 0.12 0.28 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'String'</span>, 1.5);

    <span class="keyword">function</span> addStack(src, event, hList)
        [stackname, stackpath,isOK] = uigetfile(<span class="string">'*.tif'</span>,<span class="keyword">...</span>
            <span class="string">'Select Imagestacks'</span>, getappdata(0,<span class="string">'searchPath'</span>),<span class="keyword">...</span>
            <span class="string">'MultiSelect'</span>, <span class="string">'on'</span>);
        <span class="keyword">if</span> isOK
            setappdata(0, <span class="string">'searchPath'</span>, stackpath)

            content = get(hList, <span class="string">'String'</span>);
            contentNew = cellstr(strcat(stackpath, stackname));
            content = [content', contentNew];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, 1)

            <span class="keyword">for</span> file = 1:numel(contentNew)
                set(findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                    <span class="string">'Title'</span>,<span class="string">'Optics'</span>),<span class="string">'Visible'</span>,<span class="string">'off'</span>)
                hOpticsPanel =<span class="keyword">...</span>
                    uipanel(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, contentNew{file},<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.8 0.28 0.2 0.3],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                    <span class="string">'Title'</span>,<span class="string">'Optics'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.84 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'Pixel Size [?m]:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'This Value is used to estimate the pixel to micron conversion factor. \n'</span><span class="keyword">...</span>
                    <span class="string">'In Theory: pixel size = phys. pixel size / total magnification(objectiv*ocular)\n'</span><span class="keyword">...</span>
                    <span class="string">'60, 1x = 0.267?m per pixel \n 60, 1.6x = 0.167?m per pixel \n'</span><span class="keyword">...</span>
                    <span class="string">'150, 1x = 0.107?m per pixel \n 150, 1.6x = 0.067?m per pixel'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'pxSize'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.83 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 0.107,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, @calcPSF);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.72 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'Emission [nm]:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'emWvlnth'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.71 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 571,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, @calcPSF);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.6 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'N.A.:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'NA'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.59 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 1.41,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, @calcPSF);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.48 0.66 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'PSF Scaling:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'psfScale'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.47 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 1.35,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, @calcPSF);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.36 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'PSF Std [px]:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'Standard deviation of the Gaussian modelling the \n'</span><span class="keyword">...</span>
                    <span class="string">'Microscope associated Point Spread Function.'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'psfStd'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.35 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 1.03,<span class="keyword">...</span>
                    <span class="string">'Enable'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.24 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'Counts/Photon:'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'cntsPerPhoton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.71 0.23 0.28 0.08],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Backgroundcolor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'String'</span>, 20.2);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, hOpticsPanel,<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'spatialCorrection'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0.01 0.12 0.7 0.07],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">'apply spatial correction'</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, false,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, @setSpatialCorrPath,<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'If this option is checked the programm will perform \n'</span><span class="keyword">...</span>
                    <span class="string">'a spatial transformation on the particle coordinates\n'</span><span class="keyword">...</span>
                    <span class="string">'when the localization process is finished. \n'</span><span class="keyword">...</span>
                    <span class="string">'The spatial transformation corrects for rotation and transition \n'</span><span class="keyword">...</span>
                    <span class="string">'between image channels'</span>]));
            <span class="keyword">end</span> <span class="comment">%for</span>
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> delStack(src, event, hList)
        bad = get(hList, <span class="string">'Value'</span>);
        content = get(hList, <span class="string">'String'</span>);
        <span class="keyword">if</span> isempty(content)
            <span class="keyword">return</span>
        <span class="keyword">else</span>
            delete(findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                <span class="string">'Tag'</span>,content{bad}))
            content(bad) = [];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, [])
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> moveUpStack(src, event, hList)
        pos = get(hList, <span class="string">'Value'</span>);
        <span class="keyword">if</span> pos &gt; 1
            content = get(hList, <span class="string">'String'</span>);
            content(pos-1:pos) = [content(pos); content(pos-1)];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, pos-1)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> moveDownStack(src, event, hList)
        pos = get(hList, <span class="string">'Value'</span>);
        content = get(hList, <span class="string">'String'</span>);
        <span class="keyword">if</span> pos &lt; numel(content)
            content(pos:pos+1) = [content(pos+1); content(pos)];
            set(hList, <span class="string">'String'</span>, content, <span class="string">'Value'</span>, pos+1)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatePanelVisibility(src, event)
        <span class="keyword">if</span> isempty(get(src,<span class="string">'String'</span>))
            <span class="keyword">return</span>
        <span class="keyword">else</span>
            set(findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                <span class="string">'Title'</span>,<span class="string">'Optics'</span>,<span class="keyword">...</span>
                <span class="string">'-and'</span>,<span class="string">'Type'</span>,<span class="string">'Uipanel'</span>),<span class="string">'Visible'</span>,<span class="string">'off'</span>)
            content = get(src,<span class="string">'String'</span>);
            set(findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                <span class="string">'Tag'</span>,content{get(src,<span class="string">'Value'</span>)},<span class="keyword">...</span>
                <span class="string">'-and'</span>,<span class="string">'Type'</span>,<span class="string">'Uipanel'</span>),<span class="string">'Visible'</span>,<span class="string">'on'</span>)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> calcPSF(src,event)
        hOpticsPanel = get(src,<span class="string">'Parent'</span>);
        psfStd = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'psfScale'</span>),<span class="string">'String'</span>))*<span class="keyword">...</span>
            0.55*(0.001*str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'emWvlnth'</span>),<span class="string">'String'</span>)))/<span class="keyword">...</span>
            str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'NA'</span>),<span class="string">'String'</span>))/1.17/<span class="keyword">...</span>
            str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'pxSize'</span>),<span class="string">'String'</span>))/2;
        set(findobj(hOpticsPanel,<span class="keyword">...</span>
            <span class="string">'Tag'</span>,<span class="string">'psfStd'</span>),<span class="string">'String'</span>,psfStd);
    <span class="keyword">end</span>
    <span class="keyword">function</span> setSpatialCorrPath(src,event)
        <span class="keyword">if</span> get(src,<span class="string">'Value'</span>)
            [tMatName, tMatPath, isOK] = uigetfile(<span class="keyword">...</span>
                <span class="string">'*.mat'</span>, <span class="string">'Select spatial Transformationmatrix'</span>,<span class="keyword">...</span>
                getappdata(0,<span class="string">'searchPath'</span>));
            <span class="keyword">if</span> isOK
                set(src,<span class="string">'UserData'</span>,[tMatPath tMatName])
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">else</span> <span class="comment">%clear userdata</span>
            set(src,<span class="string">'UserData'</span>,[])
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> processBatch(src, event, hList)
        files = get(hList,<span class="string">'String'</span>);
        <span class="keyword">for</span> file = 1:numel(files)
            <span class="comment">%Predefined Variables</span>
            imageBin.isOwn = true;
            imageBin.isLoaded = true;
            imageBin.isSuperstack = false;
            imageBin.isTrack = false;
            imageBin.frame = 1;

            <span class="comment">%Loc Options</span>
            hLocPanel = findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                <span class="string">'Title'</span>,<span class="string">'Localization'</span>, <span class="string">'-and'</span>, <span class="string">'Type'</span>, <span class="string">'Uipanel'</span>);
            imageBin.locStart = 1;
            imageBin.locEnd = inf;
            imageBin.errorRate = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'errRate'</span>),<span class="string">'String'</span>));
            imageBin.w2d = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'w2d'</span>),<span class="string">'String'</span>));
            imageBin.dfltnLoops = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'dfltnLoops'</span>),<span class="string">'String'</span>));
            imageBin.minInt = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'minInt'</span>),<span class="string">'String'</span>));
            imageBin.locParallel = get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'locParallel'</span>),<span class="string">'Value'</span>);
            imageBin.nCores = get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'nCores'</span>),<span class="string">'Value'</span>);
            imageBin.isRadiusTol = get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'isRadiusTol'</span>),<span class="string">'Value'</span>);
            imageBin.radiusTol = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'radiusTol'</span>),<span class="string">'String'</span>));
            imageBin.posTol = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'posTol'</span>),<span class="string">'String'</span>));
            imageBin.maxOptimIter = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'maxOptimIter'</span>),<span class="string">'String'</span>));
            imageBin.termTol = str2double(get(findobj(hLocPanel,<span class="string">'Tag'</span>,<span class="string">'termTol'</span>),<span class="string">'String'</span>));

            <span class="comment">%Bar Options</span>
            imageBin.isScalebar = 0;
            imageBin.micronBarLength = 1000;
            imageBin.isColormap = 0;
            imageBin.colormapWidth = 20;
            imageBin.isTimestamp = 0;
            imageBin.timestampSize = 2;
            imageBin.timestampInkrement = 0.032;

            <span class="comment">%Render Options</span>
            imageBin.exfOld = 5;
            imageBin.exfNew = 5;
            imageBin.rW = 50;
            imageBin.rStep = 10;
            imageBin.rStart = 1;
            imageBin.rEnd = inf;
            imageBin.rLive = false;
            imageBin.fps = 25;
            imageBin.movCompression = 1;
            imageBin.convMode = 1;
            imageBin.intWeight = 0.01;
            imageBin.sizeFac = 1;
            imageBin.isCumsum = false;

            <span class="comment">%Thresh Options</span>
            imageBin.isThreshLocPrec = false;
            imageBin.minLoc = 0;
            imageBin.maxLoc = inf;
            imageBin.isThreshSNR = false;
            imageBin.minSNR = 0;
            imageBin.maxSNR = inf;
            imageBin.isThreshDensity = false;

            <span class="comment">%Optics Options</span>
            hOpticsPanel = findobj(get(src,<span class="string">'Parent'</span>),<span class="keyword">...</span>
                <span class="string">'Tag'</span>,files{file}, <span class="string">'-and'</span>, <span class="string">'Type'</span>, <span class="string">'Uipanel'</span>);
            imageBin.pxSize = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'pxSize'</span>),<span class="string">'String'</span>));
            imageBin.cntsPerPhoton = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'cntsPerPhoton'</span>),<span class="string">'String'</span>));
            imageBin.emWvlnth = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'emWvlnth'</span>),<span class="string">'String'</span>));
            imageBin.NA = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'NA'</span>),<span class="string">'String'</span>));
            imageBin.psfScale = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'psfScale'</span>),<span class="string">'String'</span>));
            imageBin.psfStd = str2double(get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'psfStd'</span>),<span class="string">'String'</span>));
            imageBin.spatialCorrection = get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'spatialCorrection'</span>),<span class="string">'Value'</span>);
            <span class="keyword">if</span> imageBin.spatialCorrection
                imageBin.spatialCorrPath = get(findobj(hOpticsPanel,<span class="string">'Tag'</span>,<span class="string">'spatialCorrection'</span>),<span class="string">'UserData'</span>);
            <span class="keyword">end</span> <span class="comment">%if</span>

            imageBin.imageName = files{file};
            [imageBin.pathname, imageBin.filename, ext] = fileparts(imageBin.imageName);
            imageBin.pathname = [imageBin.pathname <span class="string">'\'</span>];

            startPnt = 1;
            <span class="keyword">if</span> 0
                <span class="keyword">for</span> subfile = 1:numel(imageBin.imageName)
                    info = imfinfo(imageBin.imageName{subfile});
                    imageBin.width = info(1).Width;
                    imageBin.height = info(1).Height;
                    imageBin.roi =<span class="keyword">...</span>
                        [1 1 imageBin.width imageBin.height];
                    <span class="keyword">if</span> file == 1
                        N = numel(info)-startPnt+1;
                    <span class="keyword">else</span>
                        startPnt = 1;
                        N = N + numel(info);
                        <span class="keyword">if</span> N &gt; endPnt
                            endPnt = N - endPnt;
                        <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">end</span> <span class="comment">%if</span>
                    imageBin = localizeParticles(imageBin.imageName{subfile},roi,<span class="keyword">...</span>
                        startPnt,endPnt,info,imageBin);
                <span class="keyword">end</span> <span class="comment">%for</span>
            <span class="keyword">else</span>
                info = imfinfo(imageBin.imageName);
                endPnt = numel(info);

                imageBin.width = info(1).Width;
                imageBin.height = info(1).Height;
                imageBin.roi =<span class="keyword">...</span>
                    [1 1 imageBin.width imageBin.height];

                imageBin.ctrsN = localizeParticles(imageBin.imageName,<span class="keyword">...</span>
                    startPnt,endPnt,info,imageBin);
            <span class="keyword">end</span> <span class="comment">%if</span>

            <span class="comment">%save localization matrix</span>
            save ([imageBin.pathname<span class="keyword">...</span>
                imageBin.filename <span class="string">'.mat'</span>], <span class="string">'imageBin'</span>)
            clear <span class="string">imageBin</span>
        <span class="keyword">end</span> <span class="comment">%for</span>
        msgbox(<span class="string">'Done!'</span>)
    <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">function</span> ctrsN = localizeParticles(<span class="keyword">...</span>
    imagename,startPnt,endPnt,info,imageBin)

region = {[imageBin.roi(2) imageBin.roi(2)+imageBin.roi(4)-1],<span class="keyword">...</span>
    [imageBin.roi(1) imageBin.roi(1)+imageBin.roi(3)-1]};

<span class="keyword">if</span> imageBin.locParallel
    <span class="comment">%startPnt localization procedure</span>
    data = cell(endPnt-startPnt+1,1);
    ctrsN = cell(endPnt-startPnt+1,1);
    <span class="keyword">switch</span> imageBin.nCores
        <span class="keyword">case</span> 1
            matlabpool <span class="string">local</span>
        <span class="keyword">case</span> 2
            matlabpool <span class="string">2</span>
        <span class="keyword">case</span> 3
            matlabpool <span class="string">3</span>
    <span class="keyword">end</span> <span class="comment">%switch</span>
    roiWidth = imageBin.roi(3);
    roiHeight = imageBin.roi(4);
    w2d = imageBin.w2d;
    psfStd = imageBin.psfStd;
    errorRate = imageBin.errorRate;
    dfltnLoops = imageBin.dfltnLoops;
    minInt = imageBin.minInt;
    optim = [imageBin.maxOptimIter,imageBin.termTol,<span class="keyword">...</span>
        imageBin.isRadiusTol,imageBin.radiusTol,<span class="keyword">...</span>
        imageBin.posTol];

    <span class="keyword">parfor</span> frame = startPnt:endPnt
        [data{frame} unused unused ctrsN{frame}] = <span class="keyword">...</span>
            detect_et_estime_part_1vue_deflt(<span class="keyword">...</span>
            double(imread(imagename,<span class="keyword">...</span>
            frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region)),<span class="keyword">...</span>
            w2d, psfStd,chi2inv(1-1/10^(errorRate*-1),1),<span class="keyword">...</span>
            dfltnLoops,roiWidth,roiHeight,minInt,optim);
    <span class="keyword">end</span> <span class="comment">%for</span>
    matlabpool <span class="string">close</span>

    time = [];
    <span class="keyword">for</span> frame = startPnt:endPnt
        time = [time;ones(ctrsN{frame},1)*frame];
    <span class="keyword">end</span> <span class="comment">%for</span>
    data = [vertcat(data{:}) time];
    <span class="keyword">if</span> imageBin.spatialCorrection
        data(:,1:2) = fliplr(tformfwd(imageBin.tMat,data(:,2),data(:,1)));
        bad = data(:,2)&lt;=roi(1) &amp; data(:,2)&gt;=roi(1)+roi(3)-1 &amp;<span class="keyword">...</span>
            data(:,1)&lt;=roi(2) &amp; data(:,1)&gt;=roi(2)+roi(4)-1;
        data(bad,:) = [];
    <span class="keyword">end</span> <span class="comment">%if</span>
    streamToDisk(data,<span class="keyword">...</span>
        [imageBin.pathname imageBin.filename])

    ctrsN = vertcat(ctrsN{:});
<span class="keyword">else</span> <span class="comment">%linear computation</span>
    iter = 0;
    hProgressbar = waitbar(0,<span class="string">'Localization...'</span>,<span class="string">'Color'</span>,<span class="keyword">...</span>
        get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
    <span class="keyword">for</span> frame = startPnt:endPnt
        iter = iter+1;
        I = imread(imagename,<span class="keyword">...</span>
            frame, <span class="string">'info'</span>, info, <span class="string">'PixelRegion'</span>, region);

        optim = [imageBin.maxOptimIter,imageBin.termTol,<span class="keyword">...</span>
            imageBin.isRadiusTol,imageBin.radiusTol,<span class="keyword">...</span>
            imageBin.posTol];

        [data deflatedIm binaryIm ctrsN(iter,1)] = <span class="keyword">...</span>
            detect_et_estime_part_1vue_deflt(<span class="keyword">...</span>
            double(I),imageBin.w2d, imageBin.psfStd,<span class="keyword">...</span>
            chi2inv(1-1/10^(imageBin.errorRate*-1),1),<span class="keyword">...</span>
            imageBin.dfltnLoops,imageBin.roi(3),<span class="keyword">...</span>
            imageBin.roi(4),imageBin.minInt,optim);

        <span class="keyword">if</span> 0
            imwrite(uint16(deflatedIm),<span class="keyword">...</span>
                [imagename(1:end-4) <span class="string">'_deflated.tif'</span>],<span class="keyword">...</span>
                <span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="string">'writemode'</span>,<span class="string">'append'</span>)
            imwrite(uint16(binaryIm),<span class="keyword">...</span>
                [imagename(1:end-4) <span class="string">'_binary.tif'</span>],<span class="keyword">...</span>
                <span class="string">'compression'</span>,<span class="string">'none'</span>,<span class="string">'writemode'</span>,<span class="string">'append'</span>)
        <span class="keyword">end</span>

        <span class="keyword">if</span> imageBin.rLive
            <span class="keyword">if</span> frame == startPnt
                fig =<span class="keyword">...</span>
                    figure(<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, figPos(imageBin.roi(3)/imageBin.roi(4)),<span class="keyword">...</span>
                    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
                    <span class="string">'Name'</span>, <span class="string">'Live Localization'</span>,<span class="keyword">...</span>
                    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
                    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>);
                ax =<span class="keyword">...</span>
                    axes(<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [0 0 1 1]);
                liveView = imshow(imadjust(I),[]);
                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                hDots = patch(repmat(1+data(:,2)',10,1)+cos(rho)*data(:,6)',<span class="keyword">...</span>
                    repmat(1+data(:,1)',10,1)+sin(rho)*data(:,6)',<span class="keyword">...</span>
                    repmat(shiftdim([1 0 0],-1),1,ctrsN(iter)),<span class="keyword">...</span>
                    <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>, <span class="string">'FaceAlpha'</span>, 0.5,<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, ax);
                drawnow
            <span class="keyword">elseif</span> frame == endPnt
                set(liveView, <span class="string">'CData'</span>, imadjust(I))
                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                set(hDots, <span class="string">'XData'</span>, repmat(1+data(:,2)',10,1)+<span class="keyword">...</span>
                    cos(rho)*data(:,6)', <span class="string">'YData'</span>, repmat(1+data(:,1)',10,1)+<span class="keyword">...</span>
                    sin(rho)*data(:,6)', <span class="string">'CData'</span>, repmat(shiftdim([1 0 0],-1),1,<span class="keyword">...</span>
                    ctrsN(iter)))
                drawnow
                close(fig)
            <span class="keyword">else</span>
                set(liveView, <span class="string">'CData'</span>, imadjust(I))

                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                set(hDots, <span class="string">'XData'</span>, repmat(1+data(:,2)',10,1)+<span class="keyword">...</span>
                    cos(rho)*data(:,6)', <span class="string">'YData'</span>, repmat(1+data(:,1)',10,1)+<span class="keyword">...</span>
                    sin(rho)*data(:,6)', <span class="string">'CData'</span>, repmat(shiftdim([1 0 0],-1),1,<span class="keyword">...</span>
                    ctrsN(iter)))
                drawnow
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="comment">%correct for imageBin.roi(crop)</span>
        <span class="comment">%data(:,1:2) = [data(:,1)+imageBin.roi(2)-1,data(:,2)+imageBin.roi(1)-1];</span>

        <span class="comment">%apply a nonreflective similarity transformation (correct for</span>
        <span class="comment">%scale, rotation and translation)</span>
        <span class="keyword">if</span> imageBin.spatialCorrection
            data(:,1:2) = fliplr(tformfwd(imageBin.tMat,data(:,2),data(:,1)));
            bad = data(:,2)&lt;=imageBin.roi(1) &amp; data(:,2)&gt;=imageBin.roi(1)+imageBin.roi(3)-1 &amp;<span class="keyword">...</span>
                data(:,1)&lt;=imageBin.roi(2) &amp; data(:,1)&gt;=imageBin.roi(2)+imageBin.roi(4)-1;
            data(bad,:) = [];
        <span class="keyword">end</span> <span class="comment">%if</span>

        streamToDisk([data ones(ctrsN(iter),1)*frame],<span class="keyword">...</span>
            [imageBin.pathname imageBin.filename])

        waitbar(iter/(endPnt-startPnt+1));
        <span class="comment">%,hProgressbar,...</span>
        <span class="comment">%    'Localization...','Color',...</span>
        <span class="comment">%    get(0,'defaultUicontrolBackgroundColor'));</span>
    <span class="keyword">end</span> <span class="comment">%for</span>
    delete(hProgressbar)
<span class="keyword">end</span> <span class="comment">%if</span>

    <span class="keyword">function</span> streamToDisk(data,outputname)
        <span class="comment">%stream data to harddisc</span>
        fidY = fopen([outputname <span class="string">'.ctrsY'</span>], <span class="string">'a+'</span>);
        fidX = fopen([outputname <span class="string">'.ctrsX'</span>], <span class="string">'a+'</span>);
        fidSignal = fopen([outputname <span class="string">'.signal'</span>], <span class="string">'a+'</span>);
        fidNoise = fopen([outputname <span class="string">'.noise'</span>], <span class="string">'a+'</span>);
        fidOffset = fopen([outputname <span class="string">'.offset'</span>], <span class="string">'a+'</span>);
        fidRadius = fopen([outputname <span class="string">'.radius'</span>], <span class="string">'a+'</span>);
        fidFrame = fopen([outputname <span class="string">'.frame'</span>], <span class="string">'a+'</span>);

        fwrite(fidY,data(:,1),<span class="string">'real*8'</span>); <span class="comment">%y-coordinate</span>
        fwrite(fidX,data(:,2),<span class="string">'real*8'</span>); <span class="comment">%x-coordinate</span>
        fwrite(fidSignal,data(:,3)/sqrt(pi)./data(:,6),<span class="string">'real*8'</span>); <span class="comment">%peak amplitude</span>
        fwrite(fidNoise,sqrt(data(:,4)),<span class="string">'real*8'</span>); <span class="comment">%noise std</span>
        fwrite(fidOffset,data(:,5),<span class="string">'real*8'</span>); <span class="comment">%background level</span>
        fwrite(fidRadius,data(:,6),<span class="string">'real*8'</span>); <span class="comment">%gaussian radius.</span>
        fwrite(fidFrame,data(:,8),<span class="string">'real*8'</span>); <span class="comment">%detected frame</span>

        fclose(<span class="string">'all'</span>);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> [lestime, input_deflt, dfin, ctrsN] =<span class="keyword">...</span>
    detect_et_estime_part_1vue_deflt(input, wn, r0, pfa, n_deflt,<span class="keyword">...</span>
    w,h,minInt,optim)

[lest,ldec,dfin] = detect_et_estime_part_1vue (input, wn, r0, pfa, optim) ;
input_deflt = deflat_part_est(input, lest, wn);
lestime = lest ;
<span class="keyword">if</span> n_deflt == 0
            border = ceil(wn/2);
        good = lestime(:,7) &amp; <span class="keyword">...</span>
            (lestime(:,4)/sqrt(pi)./lestime(:,6)&gt;minInt) &amp; <span class="keyword">...</span>
            (lestime(:,1)&gt;border) &amp; (lestime(:,1)&lt;h-border) &amp; <span class="keyword">...</span>
            (lestime(:,2)&gt;border) &amp; (lestime(:,2)&lt;w-border) ;
        lestime = lestime(good,:);
        ctrsN = sum(good);
        <span class="keyword">return</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="keyword">for</span> n=1:n_deflt
    [l,ld,d,N] = detect_et_estime_part_1vue (input_deflt, wn, r0, pfa, optim) ;
    lestime = [lestime ; l] ;
    <span class="comment">%%dfin += d</span>
    dfin = dfin | d ;
    input_deflt = deflat_part_est(input_deflt, l, wn);

    <span class="keyword">if</span> (N==0) || n == n_deflt
        border = ceil(wn/2);
        good = lestime(:,7) &amp; <span class="keyword">...</span>
            (lestime(:,4)/sqrt(pi)./lestime(:,6)&gt;minInt) &amp; <span class="keyword">...</span>
            (lestime(:,1)&gt;border) &amp; (lestime(:,1)&lt;h-border) &amp; <span class="keyword">...</span>
            (lestime(:,2)&gt;border) &amp; (lestime(:,2)&lt;w-border) ;
        lestime = lestime(good,:);
        ctrsN = sum(good);
        <span class="keyword">return</span>
    <span class="keyword">end</span>

<span class="keyword">end</span><span class="comment">%for</span>
<span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> [lestime, ldetect, d, Nestime] = detect_et_estime_part_1vue(input, wn, r0, pfa, optim)<span class="comment">%%, pas_ijr)</span>
</pre><pre class="codeinput">[Ni, Nj] = size(input) ;
</pre><h2>positions des parametres<a name="9"></a></h2><pre class="codeinput">Nparam = 7 ;
detect_i = 2 ;
detect_j = 3 ;
alpha = 4 ;
<span class="comment">% sig2 = 5 ;</span>
</pre><h2>detection pour un rayon moyen r0<a name="10"></a></h2><pre class="codeinput">[c,ldetect,d] = carte_H0H1_1vue(input, r0, wn, wn, pfa);
</pre><h2>estimation pour des pas de recherche<a name="11"></a></h2><h2>interval [-1,1] pour ij<a name="12"></a></h2><h2>interval [0.6,1.4] pour le rayon<a name="13"></a></h2><pre class="codeinput">Ndetect = size(ldetect, 1) ;
<span class="keyword">if</span> (Ndetect==0) <span class="comment">%no pixels meets glrt threshold</span>
    lestime = zeros(1,Nparam) ;
    Nestime = 0 ;
    <span class="keyword">return</span> ;
<span class="keyword">end</span><span class="comment">%if</span>

Nestime = 0 ;
bord = ceil(wn/2) ;
<span class="keyword">for</span> n=1:Ndetect
    test_bord = (ldetect(n,detect_i) &lt; bord) || (ldetect(n,detect_i) &gt; Ni-bord) || <span class="keyword">...</span>
        (ldetect(n,detect_j) &lt; bord) || (ldetect(n,detect_j) &gt; Nj-bord) ;
    <span class="keyword">if</span> ((ldetect(n,alpha) &gt; 0.0) &amp;&amp; (~test_bord) )
        Nestime = Nestime + 1 ;
        lestime(Nestime, :) = estim_param_part_GN(input, wn, ldetect(n,:), r0, optim) ;
    <span class="keyword">end</span><span class="comment">%if</span>
<span class="keyword">end</span><span class="comment">%for</span>

<span class="comment">% a la bonne taille</span>
<span class="keyword">if</span> (Nestime==0)
    lestime = zeros(1,Nparam) ;
<span class="keyword">else</span>
    lestime = lestime(1:Nestime,:) ;
<span class="keyword">end</span><span class="comment">%if</span>
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> [carte_MV, liste_detect, detect_pfa] = carte_H0H1_1vue(im, rayon, wn_x, wn_y, s_pfa)
</pre><pre class="codeinput">[N,M] = size(im) ;
T = wn_x*wn_y ; <span class="comment">% nombre de pixel dans la fenetre</span>
</pre><h2>Hypothese H0<a name="16"></a></h2><h2>pas de particule dans la fenetre<a name="17"></a></h2><pre class="codeinput">m = ones(wn_x,wn_y) ;
hm = expand_w(m, N, M) ;
tfhm = fft2(hm) ;
tfim = fft2(im) ;
m0 = real(fftshift(ifft2(tfhm .* tfim))) /T ;

im2 = im .* im ;
tfim2 = fft2(im2) ;
Sim2 = real(fftshift(ifft2(tfhm .* tfim2)));
</pre><h2>H0 = T/2*log(2*pi*sig0^2)-T/2 ;<a name="18"></a></h2><pre class="codeinput">T_sig0_2 = Sim2 - T*m0.^2 ;
</pre><h2>Hypoth?se H1<a name="19"></a></h2><h2>une particule est au centre de la fenetre<a name="20"></a></h2><h2>amplitude inconnue, rayon fixe<a name="21"></a></h2><h2>generation masque gaussien de largeur (sigma)<a name="22"></a></h2><h2>egal a rayon<a name="23"></a></h2><pre class="codeinput"><span class="comment">%%g = gausswin2(rayon, wn_x, wn_y) ;</span>
g = gausswin2(rayon, wn_x, wn_y, 0, 0) ;
gc = g - sum(g(:))/T ;
Sgc2 = sum(gc(:).^2) ;
hgc = expand_w(gc, N, M) ;
tfhgc = fft2(hgc) ;

alpha = real(fftshift(ifft2(tfhgc .* tfim))) / Sgc2 ;
</pre><h2>H1 = T/2*log(2*pi*sig1^2)-T/2 ;<a name="24"></a></h2><pre class="codeinput"><span class="comment">%%sig1_2 = sig0_2 - alpha.^2 * Sgc2 / T ;</span>
</pre><h2>pour test<a name="25"></a></h2><pre class="codeinput"><span class="comment">%sig1_2 = T_sig0_2/T - alpha.^2 * Sgc2 / T ;</span>
<span class="comment">%%imagesc(T_sig0_2/T);</span>
<span class="comment">%imagesc(sig1_2);</span>
<span class="comment">%%imagesc(sig1_2 ./ (T_sig0_2/T));</span>
</pre><h2>carte_MV = -0.5*(H0 - H1) ;<a name="26"></a></h2><p>carte_MV = - T * log(1 - (Sgc2 * alpha.^2) ./ T_sig0_2) ;</p><pre class="codeinput">test = 1 - (Sgc2 * alpha.^2) ./ T_sig0_2 ;
test = (test &gt; 0) .* test + (test &lt;= 0) ;
carte_MV = - T * log(test) ;
carte_MV(isnan(carte_MV)) = 0; <span class="comment">%CPR</span>
</pre><h2>detection et recherche des maximas<a name="27"></a></h2><h2>s_pfa = 28 ;<a name="28"></a></h2><pre class="codeinput">detect_masque = carte_MV &gt; s_pfa ;
<span class="keyword">if</span> (sum(detect_masque(:))==0)
    <span class="comment">%     warning('No target detected !') ; %#ok</span>
    liste_detect = zeros(1,6) ;
    detect_pfa = zeros(size(detect_masque)) ; <span class="comment">% ajout AS 4/12/7</span>
<span class="keyword">else</span>
</pre><pre class="codeinput">    detect_pfa = all_max_2d(carte_MV) &amp; detect_masque ;

    [di, dj] = find(detect_pfa) ;
    n_detect = size(di, 1) ;
    vind = N*(dj-1)+di ;
    valpha = alpha(:) ;
    alpha_detect = valpha(vind) ;

    sig1_2 = ( T_sig0_2 - alpha.^2 * Sgc2 ) / T ;
    vsig1_2 = sig1_2(:) ;
    sig2_detect = vsig1_2(vind) ;
</pre><h2>g de puissance unitaire<a name="30"></a></h2><pre class="codeinput">    <span class="comment">%%RSBdB_detect = 10*log10(alpha_detect.^2  ./ sig2_detect) ;</span>

    <span class="comment">%%liste_detect = [(1:n_detect)', di, dj, alpha_detect, sqrt(sig2_detect), RSBdB_detect] ;</span>
    liste_detect = [(1:n_detect)', di, dj, alpha_detect, sig2_detect, rayon*ones(n_detect,1),ones(n_detect,1)] ;
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%if</span>
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> out = expand_w(in, N, M)

[N_in, M_in] = size(in) ;

out = zeros(N,M) ;
<span class="comment">%nc = 1+floor(N/2 - N_in/2) ;</span>
<span class="comment">%mc = 1+floor(M/2 - M_in/2) ;</span>
<span class="comment">%out(nc:(nc+N_in-1) , mc:(mc+M_in-1)) = in ;</span>

nc = floor(N/2 - N_in/2) ;
mc = floor(M/2 - M_in/2) ;
out((nc+1):(nc+N_in) , (mc+1):(mc+M_in)) = in ;

<span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> carte_max = all_max_2d(input)

[N,M] = size(input) ;
ref = input(2:N-1, 2:M-1) ;

pos_max_h = input(1:N-2, 2:M-1) &lt; ref &amp; <span class="keyword">...</span>
    input(3:N  , 2:M-1) &lt; ref;
pos_max_v = input(2:N-1, 1:M-2) &lt; ref &amp; <span class="keyword">...</span>
    input(2:N-1, 3:M  ) &lt; ref;
pos_max_135 = input(1:N-2, 1:M-2) &lt; ref &amp; <span class="keyword">...</span>
    input(3:N  , 3:M  ) &lt; ref;
pos_max_45  = input(3:N  , 1:M-2) &lt; ref &amp; <span class="keyword">...</span>
    input(1:N-2, 3:M  ) &lt; ref;

carte_max = zeros(N,M) ;
carte_max(2:N-1, 2:M-1) = pos_max_h &amp; pos_max_v &amp; pos_max_135 &amp; pos_max_45 ;
carte_max = carte_max .* input ;

<span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> liste_param = estim_param_part_GN(im, wn, liste_info_param, r0, optim)

Pi = liste_info_param(2) ;
Pj = liste_info_param(3) ;
di = (1:wn)+Pi-floor(wn/2) ;
dj = (1:wn)+Pj-floor(wn/2) ;
im_part = im(di, dj) ;

<span class="keyword">if</span> 0
        options = optimset(<span class="keyword">...</span>
        <span class="string">'Algorithm'</span>, <span class="string">'Active-Set'</span>,<span class="keyword">...</span>
        <span class="string">'Display'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
        <span class="string">'UseParallel'</span>, <span class="string">'always'</span>);
    <span class="keyword">if</span> 0
    guess = [0,0,r0];
    bounds = [-1.5,-1.5,r0-r0*0.1;1.5,1.5,r0+r0*0.6];
    liste_param = gaussMLE(im_part,guess,bounds,options);
    <span class="keyword">else</span>
    guess = [0,0,r0,0,r0];
    bounds = [-1.5,-1.5,r0-r0*0.1,0,r0-r0*0.1;<span class="keyword">...</span>
        1.5,1.5,r0+r0*0.6,0.8,r0+r0*0.6];
    liste_param = gaussEllipticMLE(im_part,guess,bounds,options);
    <span class="keyword">end</span>
    liste_param(1:2) = liste_param(1:2)+[Pi Pj];
<span class="keyword">else</span>
    <span class="comment">%limits for optimization</span>
    bornes_ijr(1) = -optim(5) ;
    bornes_ijr(2) = optim(5) ;
    bornes_ijr(3) = -optim(5) ;
    bornes_ijr(4) = optim(5) ;
    bornes_ijr(5) = r0-optim(4)*r0/100 ;
    bornes_ijr(6) = r0+optim(4)*r0/100 ;

    r = r0 ;
    i = 0.0 ;
    j = 0.0 ;
    dr = 1 ;
    di = 1 ;
    dj = 1 ;
    fin = 10^optim(2) ;
    sig2 = inf ;
    cpt = 0 ;
    test = 1 ;
    ITER_MAX = optim(1) ;
    <span class="keyword">while</span> (test)
</pre><pre class="codeinput">        <span class="comment">%%[r, i, j, dr, di, dj, alpha, sig2] = deplt_GN_estimation (r, i, j, im_part) ;</span>
        [r, i, j, dr, di, dj, alpha, sig2, offset] = deplt_GN_estimation (r, i, j, im_part, sig2, dr, di, dj, optim) ;
        cpt = cpt + 1 ;
        <span class="keyword">if</span> optim(3)
            test = max([abs(di), abs(dj), abs(dr)]) &gt; fin ;
        <span class="keyword">else</span>
            test = max([abs(di), abs(dj)]) &gt; fin ;
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">if</span> (cpt &gt; ITER_MAX)
            test = 0 ;
        <span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>on stop si l_on sort des bornes<a name="34"></a></h2><pre class="codeinput">        result_ok = ~((i &lt; bornes_ijr(1)) || (i &gt; bornes_ijr(2)) || <span class="keyword">...</span>
            (j &lt; bornes_ijr(3)) || (j &gt; bornes_ijr(4)) || <span class="keyword">...</span>
            (r &lt; bornes_ijr(5)) || (r &gt; bornes_ijr(6)) ) ;
        test = test &amp; result_ok ;
</pre><pre class="codeinput">    <span class="keyword">end</span><span class="comment">%while</span>


    <span class="comment">% liste_info_param = [num, i, j, alpha, sig^2]</span>
    <span class="comment">% liste_param = [num, i, j, alpha, sig^2, rayon, ok]</span>

    liste_param = [Pi+i , <span class="keyword">...</span><span class="comment"> %y-coordinate</span>
        Pj+j , <span class="keyword">...</span><span class="comment"> %x-coordinate</span>
        alpha , <span class="keyword">...</span><span class="comment"> %mean amplitude</span>
        sig2 , <span class="keyword">...</span><span class="comment"> %noise power</span>
        offset, <span class="keyword">...</span><span class="comment"> %background level</span>
        r , <span class="keyword">...</span><span class="comment"> %r0</span>
        result_ok ];
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span><span class="comment">%fonction</span>
<span class="keyword">function</span> [n_r, n_i, n_j, dr, di, dj, alpha, sig2 m] = <span class="keyword">...</span>
    deplt_GN_estimation(p_r, p_i, p_j, x, sig2init, p_dr, p_di, p_dj, optim)
</pre><h2>p_di, p_dj les precedents deplacements<a name="37"></a></h2><h2>qui ont conduit a p_r, p_i, p_j<a name="38"></a></h2><pre class="codeinput">r0 = p_r ;
i0 = p_i ;
j0 = p_j ;
prec_rel = 10^optim(2) ;

verif_crit = 1 ;
pp_r = r0 - p_dr ;
pp_i = i0 - p_di ;
pp_j = j0 - p_dj ;

[wn_i, wn_j] = size(x) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;
</pre><h2>on boucle, en diminuant les deplacements<a name="39"></a></h2><h2>tand que le nouveau critere en plus grand<a name="40"></a></h2><pre class="codeinput">again = 1 ;
loops = 0;
<span class="keyword">while</span> (again)
</pre><pre class="codeinput">    loops = loops + 1;
    i = refi - i0 ;
    j = refj - j0 ;
    ii = i' * ones(1,wn_j) ; <span class="comment">%'</span>
    jj = ones(wn_i,1) * j ;
</pre><h2>puissance unitaire<a name="42"></a></h2><pre class="codeinput">    iiii = ii.*ii ;
    jjjj = jj.*jj ;
    iiii_jjjj = iiii + jjjj ;
    g = (1/(sqrt(pi)*r0)) * exp(-(1/(2*r0^2))*(iiii_jjjj)) ;
    gc = g - sum(g(:))/N ;
    Sgc2 = sum(gc(:).^2) ;
    g_div_sq_r0 = inv(r0^2) * g ;
</pre><h2>alpha estime MV<a name="43"></a></h2><pre class="codeinput">    <span class="keyword">if</span> (Sgc2 ~= 0)
        alpha = sum(sum(x .* gc)) / Sgc2 ;
    <span class="keyword">else</span>
        alpha = 0 ;
    <span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>m estime MV<a name="44"></a></h2><pre class="codeinput">    x_alphag = x - alpha.*g ;
    m = sum(sum(x_alphag))/N ;

    err = x_alphag - m ;
</pre><h2>critere avant deplacement<a name="45"></a></h2><pre class="codeinput">    sig2 = sum(sum(err.^2)) / N ;
    <span class="keyword">if</span> ((verif_crit) &amp;&amp; (sig2 &gt; sig2init))
        p_di = p_di / 10.0 ;
        p_dj = p_dj / 10.0 ;
        i0 = pp_i + p_di ;
        j0 = pp_j + p_dj ;
        <span class="keyword">if</span> optim(3)
            p_dr = p_dr / 10.0 ;
            r0 = pp_r + p_dr ;
        <span class="keyword">else</span>
            p_dr = 0;
            r0 = pp_r;
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">if</span> (max([abs(p_dr), abs(p_di), abs(p_dj)]) &gt; prec_rel)
            <span class="comment">%      if (max([abs(p_di), abs(p_dj)]) &gt; prec_rel)</span>
            n_r = p_r ;
            n_i = p_i ;
            n_j = p_j ;
            dr = 0 ;
            di = 0 ;
            dj = 0 ;
            <span class="keyword">return</span> ;
        <span class="keyword">end</span><span class="comment">%if</span>
    <span class="keyword">else</span>
        again = 0 ;
    <span class="keyword">end</span><span class="comment">%if</span>

    <span class="comment">% to avoid getting stuck in this loop</span>
    <span class="keyword">if</span> (loops &gt; 50)
        again = 0;
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%while</span>
</pre><h2>der_g<a name="47"></a></h2><pre class="codeinput">der_g_i0 =  ii .* g_div_sq_r0 ;
der_g_j0 =  jj .* g_div_sq_r0 ;
</pre><h2>derder_g<a name="48"></a></h2><pre class="codeinput">derder_g_i0 = (-1 + inv(r0^2)*iiii) .* g_div_sq_r0 ;
derder_g_j0 = (-1 + inv(r0^2)*jjjj) .* g_div_sq_r0 ;
</pre><h2>der_J /2<a name="49"></a></h2><pre class="codeinput">der_J_i0 = alpha * sum(sum(der_g_i0 .* err)) ;
der_J_j0 = alpha * sum(sum(der_g_j0 .* err)) ;
</pre><h2>derder_J /2<a name="50"></a></h2><pre class="codeinput">derder_J_i0 = alpha * sum(sum(derder_g_i0 .* err)) - alpha^2 * sum(sum(der_g_i0.^2)) ;
derder_J_j0 = alpha * sum(sum(derder_g_j0 .* err)) - alpha^2 * sum(sum(der_g_j0.^2)) ;
</pre><h2>deplacement par Gauss-Newton<a name="51"></a></h2><pre class="codeinput"><span class="keyword">if</span> optim(3)
    der_g_r0 = (-inv(r0) + inv(r0^3)*(iiii_jjjj)) .* g ;
    derder_g_r0 = (1 - 3*inv(r0^2)*iiii_jjjj) .* g_div_sq_r0 <span class="keyword">...</span>
        + (-inv(r0) + inv(r0^3)*(iiii_jjjj)) .* der_g_r0 ;
    der_J_r0 = alpha * sum(sum(der_g_r0 .* err)) ;
    derder_J_r0 = alpha * sum(sum(derder_g_r0 .* err)) - alpha^2 * sum(sum(der_g_r0.^2)) ;
    dr = - der_J_r0 / derder_J_r0 ;
    n_r = abs(r0 + dr) ; <span class="comment">%% r0 &gt; 0</span>
<span class="keyword">else</span>
    dr = 0;
    n_r = r0;
<span class="keyword">end</span> <span class="comment">%if</span>

di = - der_J_i0 / derder_J_i0 ;
dj = - der_J_j0 / derder_J_j0 ;

n_i = i0 + di ;
n_j = j0 + dj ;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> output = deflat_part_est(input, liste_est, wn)
</pre><pre class="codeinput">[idim, jdim] = size(input) ;
nb_part = size(liste_est, 1) ;

output = input ;
</pre><h2>parametre dans liste_est :<a name="54"></a></h2><h2>liste_param = [num, i, j, alpha, sig^2, rayon, ok]<a name="55"></a></h2><pre class="codeinput"><span class="keyword">for</span> part=1:nb_part
    <span class="keyword">if</span> (liste_est(part, 7) == 1)
        i0 = liste_est(part, 1) ;
        j0 = liste_est(part, 2) ;
        alpha = liste_est(part, 3) ;
        r0 = liste_est(part, 6) ;
        wn = ceil(6*r0); <span class="comment">% by CPR: 99% of Gaussian</span>

        pos_i = round(i0) ;
        dep_i = i0 - pos_i ;
        pos_j = round(j0) ;
        dep_j = j0 - pos_j ;

        alpha_g = alpha * gausswin2(r0, wn, wn, dep_i, dep_j) ;

        dd = (1:wn) - floor(wn/2) ;
        di = dd + pos_i ;
        iin = di &gt; 0 &amp; di &lt; idim+1;

        dj = dd + pos_j ;
        jin = dj &gt; 0 &amp; dj &lt; jdim+1;

        output(di(iin), dj(jin)) = <span class="keyword">...</span>
            output(di(iin), dj(jin)) - alpha_g(iin,jin) ;
    <span class="keyword">end</span><span class="comment">%if</span>
<span class="keyword">end</span><span class="comment">%for</span>
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> g = gausswin2(sig, wn_i, wn_j, offset_i, offset_j)

<span class="keyword">if</span> (nargin &lt; 5)
    offset_i = 0.0 ;
    offset_j = 0.0 ;
<span class="keyword">end</span><span class="comment">%if</span>

<span class="keyword">if</span> (nargin &lt; 3)
    wn_j = wn_i ;
<span class="keyword">end</span><span class="comment">%if</span>

refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
i = refi - offset_i ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;
j = refj - offset_j ;
ii = i' * ones(1,wn_j) ; <span class="comment">%'</span>
jj = ones(wn_i,1) * j ;
</pre><h2>puissance unitaire<a name="57"></a></h2><pre class="codeinput">g = (1/(sqrt(pi)*sig)) * exp(-(1/(2*sig^2))*(ii.*ii + jj.*jj)) ;
<span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> output = gaussMLE(raw,guess,bounds,options)
[wn_i, wn_j] = size(raw) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;

alpha = []; m = [];
[x,fval,flag] = fmincon(@modelfun,guess,[],[],[],[],<span class="keyword">...</span>
    bounds(1,:),bounds(2,:),[],options);
output = [x(1) x(2) alpha fval m  x(3) flag-flag+1];

    <span class="keyword">function</span> sig2 = modelfun(x)
</pre><pre class="codeinput">        i = refi - x(1) ;
        j = refj - x(2) ;
        ii = i' * ones(1,wn_j) ;
        jj = ones(wn_i,1) * j ;
</pre><h2>noise model<a name="59"></a></h2><pre class="codeinput">        iiii = ii.*ii ;
        jjjj = jj.*jj ;
        iiii_jjjj = iiii + jjjj ;
        g = (1/(sqrt(pi)*x(3)))*<span class="keyword">...</span>
            exp(-(1/(2*x(3)^2))*(iiii_jjjj)) ;
        gc = g - sum(g(:))/N ;
        Sgc2 = sum(gc(:).^2) ;
</pre><h2>mean amplitude<a name="60"></a></h2><pre class="codeinput">        alpha = sum(sum(raw .* gc)) / Sgc2 ;
</pre><h2>offset<a name="61"></a></h2><pre class="codeinput">        x_alphag = raw - alpha.*g ;
        m = sum(sum(x_alphag))/N ;
</pre><h2>residuals<a name="62"></a></h2><pre class="codeinput">        err = x_alphag - m ;
</pre><h2>noise power<a name="63"></a></h2><pre class="codeinput">        sig2 = sum(sum(err.^2)) / N ;
</pre><pre class="codeinput">    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> output = gaussEllipticMLE(raw,guess,bounds,options)
</pre><pre class="codeinput">[wn_i, wn_j] = size(raw) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;

        ii = refi' * ones(1,wn_j) ;
        jj = ones(wn_i,1) * refj ;
</pre><h2>noise model<a name="66"></a></h2><pre class="codeinput">        iiii = ii.*ii ;
        jjjj = jj.*jj ;
        iiii_jjjj = iiii + jjjj ;

alpha = []; m = [];

[x,fval,flag] = fmincon(@modelfun,guess,[],[],[],[],<span class="keyword">...</span>
    bounds(1,:),bounds(2,:),[],options);
output = [x(1) x(2) alpha fval m x(3) flag-flag+1];

[V, D] = eig([x(3),x(4);x(4),x(5)]);
t = linspace(0, 2*pi, 20);
u = [cos(t(:))'; sin(t(:))'];
w = (V * sqrt(D)) * u;
z = repmat([x(1); x(2)], [1 20]) + w;

figure;
imagesc(raw)
colormap <span class="string">gray</span>
patch(z(1,:)+5,z(2,:)+5,[1 0 0],<span class="keyword">...</span>
    <span class="string">'FaceAlpha'</span>, 0.6)
waitforbuttonpress
delete(gcf)

    <span class="keyword">function</span> sig2 = modelfun(x)
</pre><pre class="codeinput">        g = reshape(2*sqrt(pi)*<span class="keyword">...</span>
            mvnpdf(sqrt([iiii(:) jjjj(:)]),<span class="keyword">...</span>
            [x(1) x(2)],[x(3),x(4);x(4),x(5)]),<span class="keyword">...</span>
            [wn_i, wn_j]) ;
        gc = g - sum(g(:))/N ;
        Sgc2 = sum(gc(:).^2) ;
</pre><h2>mean amplitude<a name="68"></a></h2><pre class="codeinput">        alpha = sum(sum(raw .* gc)) / Sgc2 ;
</pre><h2>offset<a name="69"></a></h2><pre class="codeinput">        x_alphag = raw - alpha.*g ;
        m = sum(sum(x_alphag))/N ;
</pre><h2>residuals<a name="70"></a></h2><pre class="codeinput">        err = x_alphag - m ;
</pre><h2>noise power<a name="71"></a></h2><pre class="codeinput">        sig2 = sum(sum(err.^2)) / N ;
</pre><pre class="codeinput">    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2>TRACKING<a name="74"></a></h2><pre class="codeinput"><span class="keyword">function</span> buildTracks(src,event)

<span class="keyword">global</span> tab_param ;
<span class="keyword">global</span> tab_var ;
<span class="keyword">global</span> tab_moy ;

fig = gcbf;

settings.Width = getappdata(fig,<span class="string">'width'</span>);
settings.Height = getappdata(fig,<span class="string">'height'</span>);
settings.px2micron = getappdata(fig,<span class="string">'pxSize'</span>);
settings.Delay = getappdata(fig,<span class="string">'frameSize'</span>)/1000;

seuil_detec_1vue = chi2inv(1-10^getappdata(fig,<span class="string">'errorRate'</span>),1);
settings.TrackingOptions.FinalDetectionTresh = seuil_detec_1vue;

wn = getappdata(fig,<span class="string">'w2d'</span>);
settings.TrackingOptions.SizeDetectionBox = wn;

r0 = getappdata(fig,<span class="string">'psfStd'</span>);
settings.TrackingOptions.GaussianRadius = r0;

seuil_alpha = getappdata(fig,<span class="string">'minInt'</span>);
settings.TrackingOptions.ValidationTresh = seuil_alpha;

nb_defl = getappdata(fig,<span class="string">'dfltnLoops'</span>);
settings.TrackingOptions.NumberDeflationLoops = nb_defl;

T = getappdata(fig,<span class="string">'statWin'</span>);
settings.TrackingOptions.AvaragingTimeWindow = T;
assignin(<span class="string">'base'</span>, <span class="string">'T'</span>, T)

T_off = getappdata(fig,<span class="string">'maxOffTime'</span>)*-1;
settings.TrackingOptions.BlinkingProbability = T_off;
assignin(<span class="string">'base'</span>, <span class="string">'T_off'</span>, T_off)

sig_free = sqrt(getappdata(fig,<span class="string">'Dmax'</span>)/<span class="keyword">...</span>
    getappdata(fig,<span class="string">'pxSize'</span>)^2*<span class="keyword">...</span>
    4*getappdata(fig,<span class="string">'frameSize'</span>)/1000);
settings.TrackingOptions.MaxDiffusionCoefficient =<span class="keyword">...</span>
    getappdata(fig,<span class="string">'Dmax'</span>);
assignin(<span class="string">'base'</span>, <span class="string">'sig_free'</span>, sig_free)

Boule_free = getappdata(fig,<span class="string">'searchExpFac'</span>);
settings.TrackingOptions.ResearchDiameter = Boule_free;
assignin(<span class="string">'base'</span>, <span class="string">'Boule_free'</span>, Boule_free)

Nb_combi = getappdata(fig,<span class="string">'maxComp'</span>);
settings.TrackingOptions.CombinationTresh = Nb_combi;
assignin(<span class="string">'base'</span>, <span class="string">'Nb_combi'</span>, Nb_combi)

Poids_melange_aplha = getappdata(fig,<span class="string">'intLawWeight'</span>);
settings.TrackingOptions.WeightUniformGaussianLaw = Poids_melange_aplha;
assignin(<span class="string">'base'</span>, <span class="string">'Poids_melange_aplha'</span>, Poids_melange_aplha)

Poids_melange_diff = getappdata(fig,<span class="string">'diffLawWeight'</span>);
settings.TrackingOptions.WeightMaxLocalDiffusion = Poids_melange_diff;
assignin(<span class="string">'base'</span>, <span class="string">'Poids_melange_diff'</span>, Poids_melange_diff)

ctrsN = getappdata(fig,<span class="string">'ctrsN'</span>);
Nb_STK =  numel(ctrsN);
assignin(<span class="string">'base'</span>, <span class="string">'Nb_STK'</span>, Nb_STK)

<span class="comment">%t == T-T_off dans les tab_x reduits</span>
t_red = T-T_off ;
assignin(<span class="string">'base'</span>, <span class="string">'t_red'</span>, t_red)

filename = getappdata(fig,<span class="string">'imageName'</span>);
info = imfinfo(filename);
im_t = double(imread(filename, 1, <span class="string">'info'</span>, info)) ;
assignin(<span class="string">'base'</span>, <span class="string">'im_t'</span>, im_t)

idx = [-1; cumsum(getappdata(fig,<span class="string">'ctrsN'</span>))];
<span class="keyword">if</span> getappdata(fig,<span class="string">'trackStart'</span>) == 1
    setappdata(fig,<span class="string">'startPnt'</span>,0)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'startPnt'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'trackStart'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'trackEnd'</span>))
    setappdata(fig,<span class="string">'trackEnd'</span>,<span class="keyword">...</span>
        numel(getappdata(fig,<span class="string">'ctrsN'</span>)))
    setappdata(fig,<span class="string">'elements'</span>,inf)
<span class="keyword">else</span>
    setappdata(fig,<span class="string">'elements'</span>,<span class="keyword">...</span>
        idx(getappdata(fig,<span class="string">'trackEnd'</span>)+1)-<span class="keyword">...</span>
        max(1,getappdata(fig,<span class="string">'startPnt'</span>))+1)
<span class="keyword">end</span> <span class="comment">%if</span>
settings.Frames = getappdata(fig,<span class="string">'trackEnd'</span>)-<span class="keyword">...</span>
    getappdata(fig,<span class="string">'trackStart'</span>)+1;

<span class="comment">%get ROI</span>
roi = getappdata(fig,<span class="string">'roi'</span>);
data = preprocessData(fig,[1 1 1 1 1 1 1 0 0 0 0 0],roi);
trackID = 1:size(data.signal);

hProgressbar = waitbar(0,[<span class="string">'Processing Frame: '</span> num2str(1) <span class="string">':'</span><span class="keyword">...</span>
    num2str(Nb_STK)],<span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
<span class="keyword">for</span> t = getappdata(fig,<span class="string">'trackStart'</span>):getappdata(fig,<span class="string">'trackEnd'</span>)
</pre><pre class="codeinput">    <span class="comment">%first iteration</span>
    <span class="keyword">if</span> t == getappdata(fig,<span class="string">'trackStart'</span>)
</pre><pre class="codeinput">        <span class="comment">%fake detection list</span>
ind_valid = data.frame == 1;
par_per_frame(t) = sum(ind_valid);
lest = [(1:par_per_frame(t))' data.ctrsY(ind_valid) data.ctrsX(ind_valid)<span class="keyword">...</span>
    data.signal(ind_valid)*sqrt(pi).*data.radius(ind_valid)<span class="keyword">...</span>
    data.noise(ind_valid).^2 data.radius(ind_valid) ones(par_per_frame(t),1)];

<span class="comment">%preallocate tables</span>
tab_param = zeros(par_per_frame(t), 1+7*(t_red+1));
tab_var = tab_param;
<span class="comment">%tab_moy = zeros(ctrsN, 1+7*(t_red+1)) ;</span>
</pre><h2>initialize parameter tables<a name="77"></a></h2><pre class="codeinput">tab_param(:,1) = (1:par_per_frame(t))' ;
tab_param(:,2+7*(t_red-1):1+7*(t_red)) = [ones(par_per_frame(t),1), <span class="keyword">...</span>
    lest(:,[2,3,4,6]), zeros(par_per_frame(t),1), Nb_STK*ones(par_per_frame(t),1)];
tab_param(:,2+7*(t_red)) = 2*ones(par_per_frame(t),1) ;

tab_var(:,1)   = (1:par_per_frame(t))' ;
tab_var(:,2+7*(t_red-1):1+7*(t_red)) = [ones(par_per_frame(t),1), <span class="keyword">...</span>
    zeros(par_per_frame(t),4), lest(:,5), Nb_STK*ones(par_per_frame(t),1)];
tab_var(:,2+7*(t_red)) = 2*ones(par_per_frame(t),1) ;
tab_moy = tab_var ;
</pre><h2>set initial variance guess (20% by default) -&gt; nested by CPR<a name="78"></a></h2><pre class="codeinput">init_tab;
</pre><h2>initialize tracks<a name="79"></a></h2><pre class="codeinput">trackList = cell(1,par_per_frame(t));
<span class="keyword">for</span> track = tab_param(:,1)'
    <span class="keyword">if</span> tab_param(track,1+7*(t_red))&gt;0
        trackList{trackID(track)}(1,:) =<span class="keyword">...</span>
            [tab_param(track,7*(t_red-1)+[4 3 2])<span class="keyword">...</span>
            trackID(track) tab_param(track,7*(t_red-1)+5)<span class="keyword">...</span>
            tab_var(track,7*(t_red-1)+[7 3 5])];
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%for</span>

        <span class="keyword">continue</span>
</pre><pre class="codeinput">    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2>CYCLE THROUGH ACTIVE TRAJECTORIES   %%<a name="81"></a></h2><pre class="codeinput">    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    im_t = double(imread(filename, t, <span class="string">'info'</span>, info)) ;
assignin(<span class="string">'base'</span>, <span class="string">'im_t'</span>, im_t)

    ind_valid = data.frame == t;
    par_per_frame(t) = sum(ind_valid);
    lest = [(1:sum(ind_valid))' data.ctrsY(ind_valid) data.ctrsX(ind_valid)<span class="keyword">...</span>
    data.signal(ind_valid)*sqrt(pi).*data.radius(ind_valid)<span class="keyword">...</span>
    data.noise(ind_valid).^2 data.radius(ind_valid) ones(par_per_frame(t),1)];

    nb_traj_active = 0 ;
    nb_traj_blink = 0 ;

    isClosed = (tab_param(:,7*(t_red-1)+8) == T_off);
    <span class="keyword">if</span> any(isClosed)
        trackID(find(isClosed)) = [];
        tab_param(isClosed,:) = [];
        tab_var(isClosed,:) = [];
        tab_moy(isClosed,:) = [];
    <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="keyword">if</span> ~isempty(tab_param)
        tab_param(:,1) = 1:size(tab_param,1);
        tab_var(:,1) = tab_param(:,1);
        tab_moy(:,1) = tab_param(:,1);

        <span class="comment">%from longest ON to longest OFF(blink)</span>
    [unused, part_ordre_blk] = sort(-tab_param(:,7*(t_red-1)+8)) ;
    <span class="keyword">for</span> traj = part_ordre_blk'
</pre><h2>reconnection test<a name="82"></a></h2><pre class="codeinput">        <span class="keyword">if</span> (tab_param(traj, 7*(t_red-1)+8) &gt; T_off)
            part = reconnect_part(traj, t_red-1, lest, wn) ;
            nb_traj_active = nb_traj_active + 1 ;
            <span class="keyword">if</span> part == 0
                nb_traj_blink = nb_traj_blink + 1 ; <span class="comment">%counts # of trajectories with BLINK status</span>
            <span class="keyword">end</span><span class="comment">%if</span>
        <span class="keyword">else</span> <span class="comment">%no testing if trajectory is already terminated</span>
            part = 0;
        <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>update tables<a name="83"></a></h2><pre class="codeinput">        <span class="keyword">if</span> (part&gt;0)
            tab_param(traj, 7*(t_red)+[3 4 5 6]) =<span class="keyword">...</span>
                lest(part, [2 3 4 6]);
            tab_var(traj, 7*(t_red)+7) = lest(part, 5);
            <span class="keyword">if</span> (tab_param(traj, 7*(t_red-1)+8) &gt; 0) <span class="comment">%trajectory was not OFF</span>
                [LV_traj_part, flag_full_alpha] = rapport_detection(traj, t_red-1, lest, part, wn) ;
                <span class="comment">%increase BLINK value by Nb_STK</span>
                tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red-1)+8) + Nb_STK ;
                <span class="keyword">if</span> (flag_full_alpha==1) <span class="comment">%full ON</span>
                    <span class="comment">%increase BLINK value by 1</span>
                    tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red)+8) + 1 ;
                <span class="keyword">else</span>
                    tab_param(traj, 7*(t_red)+8) = <span class="keyword">...</span>
                        tab_param(traj, 7*(t_red)+8) - mod(tab_param(traj, 7*(t_red)+8), Nb_STK);
                <span class="keyword">end</span><span class="comment">%if</span>
            <span class="keyword">else</span>
                <span class="comment">%set BLINK value to initial ON value</span>
                tab_param(traj, 7*(t_red)+8) = Nb_STK ;
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">else</span>
</pre><pre class="codeinput">            tab_param(traj, 7*(t_red)+[3 4 5 6]) =<span class="keyword">...</span>
                [tab_param(traj, 7*(t_red-1)+[3 4]) 0 0];
            tab_var(traj, 7*(t_red)+7) = 0;

            <span class="comment">%decrease BLINK value</span>
            <span class="keyword">if</span> (tab_param(traj, 7*(t_red-1)+8) &lt; 0)
                tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red-1)+8)-1; <span class="comment">%blink -1</span>
            <span class="keyword">else</span>
                <span class="comment">%set BLINK value to initial OFF value</span>
                tab_param(traj, 7*(t_red)+8) = -1 ;
            <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>11/07/06<a name="85"></a></h2><h2>test for ephemerid detection<a name="86"></a></h2><pre class="codeinput">            <span class="keyword">if</span> (t&gt;3)
                <span class="keyword">if</span> (tab_param(traj, 7*(t_red-2)+8) == 0)
                    tab_param(traj, 7*(t_red)+8) = T_off ;
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput">        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="comment">%take reconnected particle out of game</span>
        <span class="keyword">if</span> (part&gt;0)
            lest(part, 2) = -lest(part, 2) ;
            lest(part, 3) = -lest(part, 3) ;
        <span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput">    <span class="keyword">end</span> <span class="comment">%for</span>
        <span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%     nb_traj_on = sum(tab_param(:, 7*(t_red)+8) &gt; 0) ;</span>
<span class="comment">%     set(h.activeTracksInfo,'String', sprintf('# elongated Trajectories: %g',nb_traj_on))</span>

<span class="comment">%     nb_traj_off = sum(tab_param(:, 7*(t_red)+8) &lt;= T_off);</span>
<span class="comment">%     set(h.terminatedTracksInfo,'String', sprintf('# terminated Trajectories: %g',nb_traj_off))</span>

<span class="comment">%     set(h.blinkingTracksInfo,'String', sprintf('# blinking Trajectories: %g',...</span>
<span class="comment">%         sum(tab_param(:, 7*(t_red)+8) &lt; 0)-nb_traj_off))</span>

    <span class="comment">%nb_non_affectees = sum(lest(:,2) &gt; 0) ; % # particles not belonging to a trajectory</span>
    nb_traj_avant_new = size(tab_param, 1) ;

    <span class="comment">%check on particles not assigned to an active trajectory</span>
    <span class="comment">%and in case initiate a new one</span>
    nb_non_aff_detect = false(par_per_frame(t),1);
    <span class="keyword">for</span> p=1:par_per_frame(t)
        <span class="keyword">if</span> (lest(p, 2) &gt; 0)
            glrt_1vue = rapport_detection(0, 0, lest, p, wn) ;
            <span class="keyword">if</span> ((glrt_1vue &gt; seuil_detec_1vue) &amp;&amp; (lest(p,4)/(sqrt(pi)*r0) &gt; seuil_alpha))
                nb_non_aff_detect(p) = true;
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%for</span>
    new_traj = sum(nb_non_aff_detect) ;
<span class="comment">%     set(h.newTracksInfo,'String', sprintf('# initiated Trajectories: %g',new_traj))</span>

    tab_param_new = [(1:new_traj)'+nb_traj_avant_new, zeros(new_traj,7*(t_red)),<span class="keyword">...</span>
        [ones(new_traj,1)*t, lest(nb_non_aff_detect, [2 3 4 6]),<span class="keyword">...</span>
        zeros(new_traj,1) ones(new_traj,1)*Nb_STK]]; <span class="comment">%by CPR</span>

    tab_param = [tab_param; tab_param_new];
    tab_var = [tab_var; zeros(new_traj,7*(t_red+1)+1)];
    tab_moy = [tab_moy; zeros(new_traj,7*(t_red+1)+1)];

    tab_var((1:new_traj)+nb_traj_avant_new, 7*(t_red)+7) =<span class="keyword">...</span>
        lest(nb_non_aff_detect, 5) ; <span class="comment">%sig2_b</span>
</pre><h2>shift tables one step to the left<a name="89"></a></h2><pre class="codeinput">    new_nb_traj = size(tab_param, 1) ;
    tab_param = [tab_param(:,1), <span class="keyword">...</span>
        tab_param(:,2+7*(1):1+7*(t_red+1)), <span class="keyword">...</span>
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;<span class="comment">%correction arnauld</span>

    tab_var = [tab_var(:,1), <span class="keyword">...</span>
        tab_var(:,2+7*(1):1+7*(t_red+1)), <span class="keyword">...</span>
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;

    tab_moy = [tab_moy(:,1), <span class="keyword">...</span>
        tab_moy(:,2+7*(1):1+7*(t_red+1)), <span class="keyword">...</span>
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;

    init_tab((1+nb_traj_avant_new):new_nb_traj) ; <span class="comment">%nested by CPR;</span>
    mise_a_jour_tab <span class="comment">%nested by CPR;</span>
</pre><h2>update tracks<a name="90"></a></h2><pre class="codeinput">    trackList = [trackList cell(1,new_traj)];
<span class="keyword">for</span> track = tab_param(:,1)'
    <span class="keyword">if</span> tab_param(track,1+7*(t_red))&gt;0
        trackList{trackID(track)}(end+1,:) =<span class="keyword">...</span>
            [tab_param(track,7*(t_red-1)+[4 3 2])<span class="keyword">...</span>
            trackID(track) tab_param(track,7*(t_red-1)+5)<span class="keyword">...</span>
            tab_var(track,7*(t_red-1)+[7 3 5])];
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%for</span>

    waitbar(t/Nb_STK,hProgressbar,[<span class="string">'Processing Frame: '</span> num2str(t) <span class="string">':'</span><span class="keyword">...</span>
        num2str(Nb_STK)],<span class="string">'Color'</span>,get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%%for</span>
delete(hProgressbar)

[filename,pathname,isOK] =<span class="keyword">...</span>
            uiputfile(<span class="string">'.mat'</span> ,<span class="string">'Save Tracking Data to'</span>,<span class="keyword">...</span>
            [getappdata(0,<span class="string">'searchPath'</span>)<span class="keyword">...</span>
            getappdata(fig,<span class="string">'filename'</span>) <span class="string">'_tracked'</span>]);
        settings.Filename = [pathname filename];
<span class="keyword">if</span> isOK
    setappdata(0,<span class="string">'searchPath'</span>,pathname)
    clear(<span class="string">'data'</span>)
    data.tr = trackList;
    par_per_frame = ctrsN;
        save ([pathname filename],<span class="keyword">...</span>
            <span class="string">'data'</span>, <span class="string">'settings'</span>, <span class="string">'par_per_frame'</span>)
<span class="keyword">end</span> <span class="comment">%if</span>

    <span class="keyword">function</span> init_tab(new_traj)
</pre><pre class="codeinput">        <span class="comment">% EN/ initialisation of tables of values</span>
        <span class="comment">% mean of parameters and variances (std)</span>
        <span class="comment">%</span>
        <span class="comment">% if input new_traj non null</span>
        <span class="comment">% then only this traj is init</span>
        <span class="comment">% otherwise all trajectories are (at the beginning)</span>
        <span class="keyword">if</span> (nargin &lt; 1)
            tab_traj = 1:par_per_frame(t) ;
            new = 0 ;
        <span class="keyword">else</span>
            tab_traj = new_traj ;
            new = 1 ;
        <span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>boucle sur les particules<a name="93"></a></h2><pre class="codeinput">        <span class="keyword">for</span> iTraj = tab_traj ;
</pre><h2>alpha<a name="95"></a></h2><pre class="codeinput">            local_param = tab_param(iTraj, 7*(t_red-1)+5) ; <span class="comment">% alpha</span>
            tab_moy(iTraj, 7*(t_red-1)+5) = local_param + sqrt(-1)*local_param ;<span class="comment">% moyenne,max</span>
            tab_var(iTraj, 7*(t_red-1)+5) = 0.2*local_param ; <span class="comment">% std</span>
</pre><h2>r<a name="96"></a></h2><pre class="codeinput">            local_param = tab_param(iTraj, 7*(t_red-1)+6) ;
            tab_moy(iTraj, 7*(t_red-1)+6) = local_param ;
            tab_var(iTraj, 7*(t_red-1)+6) = 0.2*local_param ;
</pre><h2>i,j<a name="97"></a></h2><pre class="codeinput">            tab_var(iTraj, 7*(t_red-1)+3) = sig_free ;
            tab_var(iTraj, 7*(t_red-1)+4) = sig_free ;
</pre><h2>blink pour info<a name="98"></a></h2><pre class="codeinput">            tab_moy(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
            tab_var(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
</pre><h2>affection identique a (t_red-1)-1<a name="99"></a></h2><h2>pour compat avec mise_a_jour_tab<a name="100"></a></h2><pre class="codeinput">            <span class="keyword">if</span> (new)
</pre><h2>alpha<a name="102"></a></h2><pre class="codeinput">                local_param = tab_param(iTraj, 7*(t_red-1)+5) ; <span class="comment">% alpha</span>
                tab_moy(iTraj, 7*((t_red-1)-1)+5) = local_param + sqrt(-1)*local_param ;<span class="comment">% moyenne,max</span>
                tab_var(iTraj, 7*((t_red-1)-1)+5) = 0.2*local_param ; <span class="comment">% std</span>
</pre><h2>r<a name="103"></a></h2><pre class="codeinput">                local_param = tab_param(iTraj, 7*(t_red-1)+6) ;
                tab_moy(iTraj, 7*((t_red-1)-1)+6) = local_param ;
                tab_var(iTraj, 7*((t_red-1)-1)+6) = 0.2*local_param ;
</pre><h2>i,j<a name="104"></a></h2><pre class="codeinput">                tab_var(iTraj, 7*((t_red-1)-1)+3) = sig_free ;
                tab_var(iTraj, 7*((t_red-1)-1)+4) = sig_free ;
</pre><h2>blink pour info<a name="105"></a></h2><pre class="codeinput">                tab_moy(iTraj, 7*((t_red-1)-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                tab_var(iTraj, 7*((t_red-1)-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
</pre><pre class="codeinput">            <span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput">        <span class="keyword">end</span> <span class="comment">%for</span>
</pre><pre class="codeinput">    <span class="keyword">end</span> <span class="comment">%function</span>
    <span class="keyword">function</span> mise_a_jour_tab
</pre><pre class="codeinput">        <span class="comment">% EN/ update of the tables of values</span>
        <span class="comment">% mean of parameters and variances (std)</span>

        <span class="comment">%fprintf(stderr,"in maj\n");</span>
</pre><h2>boucle sur les particules<a name="110"></a></h2><pre class="codeinput">        <span class="keyword">for</span> iTraj=1:new_nb_traj
            <span class="keyword">if</span> (tab_param(iTraj, 7*(t_red-1)+8)&gt;T_off)
</pre><h2>alpha<a name="111"></a></h2><h2>modif le 12-11-07<a name="112"></a></h2><h2>compatibilite avec rapport_detection<a name="113"></a></h2><h2>suite a la prise en compte de la loi<a name="114"></a></h2><h2>uniforme + gaussien pour alpha<a name="115"></a></h2><h2>si modif verifer rapport_detection.m<a name="116"></a></h2><pre class="codeinput">                <span class="comment">%%param = 5 ;</span>
                <span class="comment">%%[moy, sig] = calcul_reference(iTraj, (t_red-1), param, T) ;</span>
                <span class="comment">%%tab_moy(iTraj, 7*(t_red-1)+param) = moy ;%% test modif 160307</span>
                <span class="comment">%%tab_var(iTraj, 7*(t_red-1)+param) = sig ;</span>
                [moy, sig_alpha] = calcul_reference(5) ;
                alpha_moy = real(moy) ;
                alpha_max = imag(moy) ;
</pre><h2>on ne met a jour des stats mean var<a name="118"></a></h2><h2>que si on est en hypothese gaussienne<a name="119"></a></h2><h2>sinon on bloque les stats<a name="120"></a></h2><h2>determination du mode par vraisemblance<a name="121"></a></h2><pre class="codeinput">                LV_uni = -T*log(alpha_max) ;
                LV_gauss = -T/2*(1+log(2*pi*sig_alpha^2)) ;

                <span class="keyword">if</span> (LV_gauss &gt; LV_uni)
</pre><h2>gaussienne (1)<a name="122"></a></h2><pre class="codeinput">                    tab_moy(iTraj, 7*(t_red-1)+5) = alpha_moy + sqrt(-1)*alpha_max ;
                    tab_var(iTraj, 7*(t_red-1)+5) = sig_alpha ;
</pre><pre class="codeinput">                <span class="keyword">else</span>
</pre><h2>uniforme (2)<a name="124"></a></h2><pre class="codeinput">                    tab_moy(iTraj, 7*(t_red-1)+5) = tab_moy(iTraj, 7*((t_red-1)-1)+5) ;
                    tab_var(iTraj, 7*(t_red-1)+5) = tab_var(iTraj, 7*((t_red-1)-1)+5) ;
</pre><pre class="codeinput">                <span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>r<a name="126"></a></h2><pre class="codeinput">                [moy, sig] = calcul_reference(6) ;
                tab_moy(iTraj, 7*(t_red-1)+6) = moy ;
                tab_var(iTraj, 7*(t_red-1)+6) = sig ;
</pre><h2>i,j<a name="127"></a></h2><pre class="codeinput">                [moy, sig_i] = calcul_reference(3) ;
                [moy, sig_j] = calcul_reference(4) ;
                <span class="comment">%%tab_moy(iTraj, 7*(t_red-1)+4) = moy ;  %% inutile</span>
                sig_ij = sqrt(0.5*(sig_i^2+sig_j^2)) ;
                <span class="keyword">if</span> (sig_free &lt; sig_ij)
</pre><h2>borne a diff libre<a name="128"></a></h2><pre class="codeinput">                    sig_ij = sig_free ;
</pre><pre class="codeinput">                <span class="keyword">end</span><span class="comment">%if</span>
                tab_var(iTraj, 7*(t_red-1)+3) = sig_ij ;
                tab_var(iTraj, 7*(t_red-1)+4) = sig_ij ;
</pre><h2>blink pour info<a name="130"></a></h2><pre class="codeinput">                tab_moy(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                tab_var(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
</pre><pre class="codeinput">            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%for</span>
        <span class="keyword">function</span> [param_ref, sig_param] = calcul_reference(param)
</pre><h2>determine la reference (parametre moyen)<a name="132"></a></h2><h2>et ecart type du param<a name="133"></a></h2><h2>determine sur la derniere zone de non blink<a name="134"></a></h2><h2>et limite a une longueur T<a name="135"></a></h2><h2>moy_alpha et sig_alpha (resp r) gardent leur valeur pendant un blink<a name="136"></a></h2><h2>moy_i/j ne sert pas<a name="137"></a></h2><h2>sig_i/j<a name="138"></a></h2><h2>sig_i/j voient leur valeur augmenter pendant le blink<a name="139"></a></h2><h2>en suivant la variation sqrt(nb_blink)*sig_i_avant_blink<a name="140"></a></h2><h2>pris en compte dans sigij_blink<a name="141"></a></h2><h2>param = 5 : alpha<a name="142"></a></h2><h2>param = 6 : r<a name="143"></a></h2><h2>param = 3 : i<a name="144"></a></h2><h2>param = 4 : j<a name="145"></a></h2><h2>offset de zone de blink nb_blink==(-offset)<a name="146"></a></h2><pre class="codeinput">            <span class="keyword">if</span> (tab_param(iTraj, 7*(t_red-1)+8) &lt; 0)
                offset = tab_param(iTraj, 7*(t_red-1)+8)  ;
            <span class="keyword">else</span>
                offset = 0 ;
            <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>duree de la derniere partie ON de la iTraj<a name="147"></a></h2><pre class="codeinput">            nb_on = floor(tab_param(iTraj, 7*((t_red-1)+offset)+8)  / Nb_STK) ; <span class="comment">%% correct bug suite modif</span>
            <span class="keyword">if</span> (nb_on &gt; T)
                nb_on = T ;
            <span class="keyword">end</span> <span class="comment">%if</span>

            seuil = 3+1 ; <span class="comment">%T/2</span>

            <span class="keyword">if</span> (nb_on &gt;= seuil)
</pre><pre class="codeinput">                n=0:(nb_on-1) ;
                local_param = tab_param(iTraj, 7*((t_red-1)+offset-n)+param) ;
                sum_param = sum(local_param) ;
                sum_param2 = sum(local_param.^2) ;
                param_max = max(local_param) ; <span class="comment">%% 160307</span>
                param_ref = sum_param / nb_on ;
                sig_param = sqrt( sum_param2 / nb_on - param_ref^2) ;
</pre><h2>si alpha, il faut aussi la valeur max<a name="149"></a></h2><h2>en plus de la valeur moyenne<a name="150"></a></h2><h2>on le met sur l'axe imaginaire! 160307<a name="151"></a></h2><pre class="codeinput">                <span class="keyword">if</span> (param == 5)
                    param_ref = param_ref + sqrt(-1)*param_max ;
                <span class="keyword">end</span><span class="comment">%if</span>
</pre><pre class="codeinput">            <span class="keyword">else</span>
</pre><h2>On bloque la valeur a la derniere valeur avant zone de blink<a name="153"></a></h2><h2>la derniere info valable dans le passe<a name="154"></a></h2><pre class="codeinput">                <span class="keyword">if</span> (offset == 0)
                    pos_info = 1 ;<span class="comment">% la valeur precedente</span>
                <span class="keyword">else</span>
                    pos_info = -offset ; <span class="comment">% la derniere valeur avant blink</span>
                <span class="keyword">end</span><span class="comment">%if</span>

                param_ref = tab_moy(iTraj, 7*((t_red-1)-pos_info)+param) ;
                sig_param = tab_var(iTraj, 7*((t_red-1)-pos_info)+param) ;
</pre><pre class="codeinput">            <span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput">        <span class="keyword">end</span> <span class="comment">%function</span>
</pre><pre class="codeinput">    <span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">end</span>

<span class="keyword">function</span> part = reconnect_part(traj, t, lest, wn)
</pre><pre class="codeinput"><span class="comment">% EN/ function that search/detect the particle</span>
<span class="comment">% among those pre-detected, which best corresponds</span>
<span class="comment">% to the given trajectory</span>
<span class="comment">% returns the number of the particle in lest</span>
</pre><h2>evite les allocations sur des constantes<a name="159"></a></h2><p>global tab_param ; global tab_var ;</p><pre class="codeinput">Nb_combi = evalin(<span class="string">'base'</span>, <span class="string">'Nb_combi'</span>);
</pre><h2>Pre-detection<a name="160"></a></h2><pre class="codeinput"><span class="comment">%%% liste_param = [num, i, j, alpha, sig^2, rayon, ok]</span>

<span class="comment">%%% Estimation/Reconnexion</span>
<span class="comment">%%%              1    2  3     4       5          6          7      8</span>
<span class="comment">%%% tab_param = [num, t, i,    j,      alpha,     rayon,     m0,   ,blink]</span>
<span class="comment">%%% tab_var =   [num, t, sig_i,sig_jj, sig_alpha, sig_rayon, sig_b ,blink]</span>
</pre><h2>reconnexion de la particule num part<a name="161"></a></h2><pre class="codeinput"><span class="comment">%search for particles inside search radius of trajectory</span>
ind_boule = liste_part_boule([], traj, lest, t) ;
nb_part_boule = size(ind_boule, 1) ;


<span class="keyword">if</span> (nb_part_boule == 0)
</pre><h2>set trajectory status to BLINK<a name="162"></a></h2><pre class="codeinput">  part = 0 ;
</pre><pre class="codeinput"><span class="keyword">else</span>
</pre><h2>plusieurs particule candidate<a name="164"></a></h2><h2>on prend celle la plus probable<a name="165"></a></h2><pre class="codeinput">  <span class="comment">%look up if other trajectory are in competition for one of the particles</span>
  vec_traj_inter = liste_traj_inter(ind_boule, traj, lest, t) ;
  vec_traj = [traj; vec_traj_inter] ;
  nb_traj = size(vec_traj,1) ;
</pre><h2>limitation du nb de trajectoire<a name="166"></a></h2><h2>en competition<a name="167"></a></h2><pre class="codeinput">  <span class="keyword">if</span> (nb_traj &gt; Nb_combi)
<span class="comment">%     fprintf('--&gt; limitation combi for traj : traj %d\n', traj) ;</span>
    vec_traj = limite_combi_traj_blk(vec_traj, t) ;
    <span class="comment">%%vec_traj = limite_combi_traj_dst(vec_traj, t) ;</span>
    nb_traj = Nb_combi ;
  <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>prise en compte des particules<a name="168"></a></h2><h2>qui seraient dans les boules de recherche<a name="169"></a></h2><h2>des trajectoires en competition<a name="170"></a></h2><h2>"On travail ici a l'ordre 1"<a name="171"></a></h2><pre class="codeinput">  ind_boule_O1 = ind_boule ;
  <span class="keyword">for</span> ntraj = 2:nb_traj
    traj_inter = vec_traj(ntraj) ;
    ind_boule_O1 =  liste_part_boule(ind_boule_O1, traj_inter, lest, t) ;
  <span class="keyword">end</span> <span class="comment">%for</span>
  nb_part_boule_O1 = size(ind_boule_O1, 1) ;
</pre><h2>passage a l_ordre 1<a name="172"></a></h2><pre class="codeinput">  ind_boule = ind_boule_O1 ;
  nb_part_boule = nb_part_boule_O1 ;
</pre><h2>limite du nb de particules<a name="173"></a></h2><h2>en competition<a name="174"></a></h2><pre class="codeinput">  <span class="keyword">if</span> (nb_part_boule &gt; Nb_combi)
<span class="comment">%     fprintf('--&gt; limitation combi for part : traj %d\n', traj) ;</span>
     ind_boule = limite_combi_part_dst(traj,ind_boule,lest,t) ;
     nb_part_boule = Nb_combi ;
  <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>recherche de la meilleur config par<a name="175"></a></h2><h2>maximum de vraisemblance<a name="176"></a></h2><pre class="codeinput">  <span class="keyword">if</span> nb_traj &lt;= nb_part_boule
</pre><h2>pas le blink<a name="177"></a></h2><h2>mais possiblilite de nouvelle particule (&lt;)<a name="178"></a></h2><pre class="codeinput">    vec_part = ind_boule ;
</pre><pre class="codeinput">  <span class="keyword">else</span>
</pre><h2>nb_traj &gt; nb_part_boule<a name="180"></a></h2><h2>des particules ont blinkees<a name="181"></a></h2><pre class="codeinput">    vec_part = [ind_boule; zeros(nb_traj-nb_part_boule,1)] ;
</pre><pre class="codeinput">  <span class="keyword">end</span> <span class="comment">%if</span>

  part = best_config_reconnex(vec_traj, vec_part, t, lest, wn);
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> [indice, dist2] = N_plus_proche(ic, jc, liste_i, liste_j, N)
</pre><pre class="codeinput"><span class="comment">% renvoie les indices des N point les plus proche</span>
<span class="comment">% de C(ic,jc)</span>
<span class="comment">% dans l'ordre d'eloignement</span>

dim_liste = size(liste_i(:),1) ;
</pre><h2>distances au point C<a name="186"></a></h2><pre class="codeinput">  sq_dist = (liste_i-ic).^2 + (liste_j-jc).^2 ;
</pre><h2>classement<a name="187"></a></h2><pre class="codeinput">  [sq_dist_classe, ind_classe] = sort(sq_dist) ;
  <span class="keyword">if</span> (dim_liste &gt; N)
    indice = ind_classe(1:N) ;
    dist2 = sq_dist_classe(1:N) ;
  <span class="keyword">else</span>
    indice = ind_classe ;
    dist2 = sq_dist_classe ;
  <span class="keyword">end</span><span class="comment">%if</span>
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> vec_part_out = limite_combi_part_dst(traj, vec_part_in, lest, t)
<span class="comment">% limite le nombre de part</span>
<span class="comment">% a celle les plus proche de la ref traj</span>
<span class="comment">% au nombre Nb_combi (global)</span>

<span class="keyword">global</span> tab_param ;
  Nb_combi = evalin(<span class="string">'base'</span>, <span class="string">'Nb_combi'</span>);

  ic = tab_param(traj, 7*t+3) ;
  jc = tab_param(traj, 7*t+4) ;
  tabi = lest(vec_part_in, 2) ;
  tabj = lest(vec_part_in, 3) ;
  indice = N_plus_proche(ic, jc, tabi, tabj, Nb_combi) ;
  vec_part_out = vec_part_in(indice) ;
<span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> vec_traj_out = limite_combi_traj_blk(vec_traj_in, t)
<span class="comment">% limite le nombre de traj</span>
<span class="comment">% a celle les plus anciennes (en blink)</span>
<span class="comment">% au nombre Nb_combi (global)</span>
<span class="comment">% la premiere reste : ref</span>

<span class="keyword">global</span> tab_param ;
  Nb_combi = evalin(<span class="string">'base'</span>, <span class="string">'Nb_combi'</span>);

  tab_blk = tab_param(vec_traj_in(2:end), 7*t+8) ;
  [blk,indice] = sort(tab_blk, <span class="string">'descend'</span>) ;
  vec_traj_out = [vec_traj_in(1); vec_traj_in(indice(1:(Nb_combi-1))+1)] ;
<span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> liste_traj = liste_traj_inter(liste_part, traj_ref, lest, t)
</pre><pre class="codeinput"><span class="comment">% function qui renvoie les trajectoires (non reconnectees)</span>
<span class="comment">% dont les boules (espace libre) de recherche intersecte</span>
<span class="comment">% au moins une des particules de la liste</span>

<span class="keyword">global</span> tab_param ;
Boule_free = evalin(<span class="string">'base'</span>, <span class="string">'Boule_free'</span>);
</pre><h2>init des trajectoires a tester<a name="190"></a></h2><pre class="codeinput">traj_boule = zeros(size(tab_param,1), 1) ;

nb_traj = size(tab_param, 1) ;
boules = Boule_free * sigij_free_blink(1:nb_traj, t) ;


<span class="keyword">for</span> p = liste_part'
</pre><pre class="codeinput">  ic = lest(p,2) ;
  jc = lest(p,3) ;
</pre><h2>fenetre de recherche des trajectoires<a name="192"></a></h2><h2>boule de recherche en ecartype<a name="193"></a></h2><pre class="codeinput">  icm = max(ic - boules, 0) ;
  icM = ic + boules ;
  jcm = max(jc - boules, 0) ;
  jcM = jc + boules ;

  traj_boule = traj_boule | <span class="keyword">...</span>
      ((tab_param(:, 7*t+3) &lt; icM) &amp; (tab_param(:, 7*t+3) &gt; icm) &amp; <span class="keyword">...</span>
      (tab_param(:, 7*t+4) &lt; jcM) &amp; (tab_param(:, 7*t+4) &gt; jcm)) ;

<span class="comment">%    traj_boule = traj_boule | ...</span>
<span class="comment">%        (sqrt((tab_param(:, 7*t+3)-ic).^2+...</span>
<span class="comment">%        (tab_param(:, 7*t+4)-jc).^2)-boules) &lt;= 0; %CPR</span>
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%for</span>
</pre><h2>trajectoires a tester<a name="195"></a></h2><h2>celles non encore reconnectees<a name="196"></a></h2><pre class="codeinput">traj_boule = traj_boule &amp; (tab_param(:, 7*(t+1)+8) == 0)  ;
</pre><h2>test 22 11 07 : celles qui ne sont pas blinkee<a name="197"></a></h2><pre class="codeinput">traj_boule = traj_boule &amp; (tab_param(:, 7*t+8) &gt; 0)  ;
</pre><h2>on enleve la ref<a name="198"></a></h2><pre class="codeinput">traj_boule(traj_ref) = 0 ;
</pre><h2>les trajectoires en question<a name="199"></a></h2><pre class="codeinput">liste_traj = find(traj_boule) ;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> liste_part = liste_part_boule(liste_part_ref, traj, lest, t)
</pre><pre class="codeinput"><span class="comment">%finds particles inside search radius of trajectory</span>
<span class="comment">% si liste_par_ref == [] alors pas de ref</span>
</pre><h2>evite les allocations sur des constantes<a name="202"></a></h2><pre class="codeinput"><span class="keyword">global</span> tab_param ;
Boule_free = evalin(<span class="string">'base'</span>, <span class="string">'Boule_free'</span>);
<span class="comment">% global tab_var ;</span>

nb_part = size(lest, 1) ;
dim_liste = size(liste_part_ref,1) ;

<span class="keyword">if</span> (dim_liste ~= 0)
</pre><h2>generation d_un masque<a name="203"></a></h2><pre class="codeinput">  masque_part_ref = ones(nb_part, 1) ;
  masque_part_ref(liste_part_ref) = 0 ;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%last spacecoordinates for trajectory</span>
ic = tab_param(traj, 7*t+3) ;
jc = tab_param(traj, 7*t+4) ;
<span class="comment">%calc search radius</span>
boule = Boule_free * sigij_free_blink(traj, t) ;

icm = max(ic - boule, 0) ; <span class="comment">% en ecart type sur i</span>
icM = ic + boule ; <span class="comment">% en ecart type</span>
jcm = max(jc - boule, 0) ; <span class="comment">% en ecart type sur j</span>
jcM = jc + boule ; <span class="comment">% en ecart type</span>
<span class="comment">%</span>
<span class="comment">% %% liste locale a la boule (carree!!) &lt;&lt;&lt;====================================!!!</span>
part_boule = <span class="keyword">...</span>
    (lest(:,2) &lt; icM) &amp; (lest(:,2) &gt; icm) &amp; <span class="keyword">...</span>
    (lest(:,3) &lt; jcM) &amp; (lest(:,3) &gt; jcm) ;

<span class="comment">% part_boule = sqrt((lest(:,2)-ic).^2+(lest(:,3)-jc).^2) &lt;= boule; %CPR</span>

<span class="comment">%remove the ones already in ref list</span>
<span class="keyword">if</span> (dim_liste ~= 0)
  part_boule = part_boule &amp; masque_part_ref ;
<span class="keyword">end</span> <span class="comment">%if</span>

liste_new_part = find(part_boule) ;
liste_part = [liste_part_ref; liste_new_part] ;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> [out, flag_full_alpha] = rapport_detection(traj, t, lest, part, wn)<span class="comment">%, T)</span>
</pre><pre class="codeinput"><span class="comment">% EN/ returns the likelihood for reconnection between</span>
<span class="comment">% the particle num_test (in list lest) and the trajectory traj</span>
<span class="comment">%</span>
<span class="comment">% flag_full_alpha indicates if the particle</span>
<span class="comment">% is ON (FULL, belongs to the Gaussian)</span>
</pre><h2>evite les allocations sur des constantes<a name="207"></a></h2><pre class="codeinput"><span class="keyword">global</span> tab_param ;
<span class="keyword">global</span> tab_moy ;
<span class="keyword">global</span> tab_var ;
Poids_melange_aplha = evalin(<span class="string">'base'</span>, <span class="string">'Poids_melange_aplha'</span>);
Poids_melange_diff = evalin(<span class="string">'base'</span>, <span class="string">'Poids_melange_diff'</span>);
T_off = evalin(<span class="string">'base'</span>, <span class="string">'T_off'</span>);
im_t = evalin(<span class="string">'base'</span>, <span class="string">'im_t'</span>);

N = wn*wn ;<span class="comment">% carree</span>
</pre><h2>==============================================<a name="208"></a></h2><h2>test glrt avec parametre estime pour new traj<a name="209"></a></h2><h2>==============================================<a name="210"></a></h2><h2>glrt_1vue : le meme que dans carte_H0H1<a name="212"></a></h2><h2>mais ici calcule pour les parametres estimes<a name="213"></a></h2><h2>pour les particules nouvelles<a name="214"></a></h2><pre class="codeinput"><span class="keyword">if</span> (traj&lt;=0)
</pre><h2>P(x|H1)<a name="216"></a></h2><h2>deja calcule lors de l'estimation 1 vue<a name="217"></a></h2><pre class="codeinput">  sig2_H1 = lest(part, 5 ) ;
  LxH1 = -N/2*log(sig2_H1) ; <span class="comment">% -N/2</span>
</pre><h2>P(x|H0)<a name="218"></a></h2><h2>probleme lors des deflations!!!<a name="219"></a></h2><pre class="codeinput">  Pi = round(lest(part, 2)) ;
  Pj = round(lest(part, 3)) ;
  di = (1:wn)+Pi-floor(wn/2) ;
  dj = (1:wn)+Pj-floor(wn/2) ;
  im_part = im_t(di, dj) ;
<span class="comment">%   im_part = im_t(dj, di) ;</span>
  sig2_H0 = var(im_part(:)) ;
  LxH0 = -N/2*log(sig2_H0) ; <span class="comment">% -N/2</span>

  <span class="comment">% glrt = -2*( LxH0 - LxH1 ) ;</span>
  out = -2*( LxH0 - LxH1 ) ;
  <span class="keyword">return</span> ;
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>==============================================<a name="221"></a></h2><h2>vraisemblance de la reconnexion traj <a href="-">-</a> part<a name="222"></a></h2><h2>==============================================<a name="223"></a></h2><pre class="codeinput"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2>proba de reapparition pendant un blink (blinch)<a name="224"></a></h2><h2>gaussienne &gt; 0<a name="225"></a></h2><h2>nb_blink<a name="226"></a></h2><pre class="codeinput"><span class="keyword">if</span> (tab_param(traj, 7*t+8) &lt; 0)
  nb_blink = -tab_param(traj, 7*t+8)  ;
  sig_blink = -T_off/3 ;
  Pblink = 2*inv(sqrt(2*pi)*sig_blink) * exp(-inv(2*sig_blink^2)*nb_blink^2) ;
  Lblink = log(Pblink) ;
<span class="keyword">else</span>
  <span class="comment">% nb_blink = 0 ;</span>
  Lblink = 0 ;
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2>intensite des pics<a name="227"></a></h2><h2>P(alpha|H1)<a name="228"></a></h2><h2>c'est un melange de loi uniforme et gaussienne<a name="229"></a></h2><h2>on travail a tres faible nombre d'echantillons<a name="230"></a></h2><h2>estimer la proportion uni/gauss est tres difficile<a name="231"></a></h2><h2>ancienne version _old<a name="232"></a></h2><h2>on fait plutot un test de vraisemblance uni/gauss<a name="233"></a></h2><h2>on est don, soit gaussienne, soit uniforme<a name="234"></a></h2><h2>nouvelle version : la loi est une combinaison<a name="235"></a></h2><h2>d'une loi uniforme et gaussienne<a name="236"></a></h2><h2>en effet, l'estimation conjointe des parametres<a name="237"></a></h2><h2>avec melange n'est possible qu'a grand nombre d echantillons<a name="238"></a></h2><h2>ici : a nombre d echantillons reduits on test si<a name="239"></a></h2><h2>le comportement et plutot gaussien ou uniforme (MV)<a name="240"></a></h2><h2>si uniforme, on garde les anciens parametres<a name="241"></a></h2><h2>si gaussien, on met a jour moyenne et variance<a name="242"></a></h2><h2>Attention, les para metres des lois (les stats m, var)<a name="244"></a></h2><h2>sont mis a jour par la fonction mise_a_jour_tab.m<a name="245"></a></h2><h2>dans les tableaux tab_moy et tab_var<a name="246"></a></h2><h2>si modif verifer mise_a_jour_tab.m<a name="248"></a></h2><pre class="codeinput">alpha =  lest(part, 4 ) ;
alpha_moy = real(tab_moy(traj, 7*t+5)) ; <span class="comment">%% sur tout l'echantillon</span>
sig_alpha = tab_var(traj, 7*t+5) ; <span class="comment">%% sur tout l'echantillon</span>
<span class="comment">%%alpha_max = imag(tab_moy(traj, 7*t+5)) ;</span>
alpha_max = alpha_moy ;
</pre><h2>gaussienne (1)<a name="249"></a></h2><pre class="codeinput">Palpha_gaus = inv(sqrt(2*pi)*sig_alpha) * exp(-inv(2*sig_alpha^2)*(alpha-alpha_moy)^2) ;
</pre><h2>uniforme (2)<a name="250"></a></h2><pre class="codeinput"><span class="keyword">if</span> (alpha &lt; alpha_max)
  Palpha_univ = 1/alpha_max ;
<span class="keyword">else</span>
  Palpha_univ = 0.0 ;
<span class="keyword">end</span><span class="comment">%if</span>

poids = Poids_melange_aplha ;
Lalpha = log(poids*Palpha_gaus + (1-poids)*Palpha_univ) ;

<span class="keyword">if</span> (Palpha_gaus &gt; Palpha_univ)
  flag_full_alpha = 1 ;
<span class="keyword">else</span>
  flag_full_alpha = 0 ;
<span class="keyword">end</span><span class="comment">%if</span>


<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2>vraisemblance de traj a intensitee full<a name="251"></a></h2><h2>nb_alpha_full = mod(tab_param(traj,7*t+8), Nb_STK);<a name="252"></a></h2><pre class="codeinput"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><h2>vraisemblance position / mvt brownien (libre/confine)<a name="253"></a></h2><h2>P(n0|H1)<a name="254"></a></h2><pre class="codeinput">i0 = lest(part, 2) ;
j0 = lest(part, 3) ;
ic = tab_param(traj, 7*t+3) ; <span class="comment">% derniere position</span>
jc = tab_param(traj, 7*t+4) ;
<span class="comment">% sig_ij_ref = tab_var(traj, 7*t+3);</span>
sig_ij_ref = sigij_blink(traj, t) ;<span class="comment">%% avec blk</span>
sig_free_blk = sigij_free_blink(traj, t) ;<span class="comment">%% avec blk  !!!</span>

poids = Poids_melange_diff ; <span class="comment">%% entre gaussienne ref et gaussienne libre</span>
Pn_ref =  inv(2*pi*sig_ij_ref^2) * exp(- inv(2*sig_ij_ref^2) * ((i0-ic)^2 + (j0-jc)^2)) ;
Pn_free = inv(2*pi*sig_free_blk^2) * exp(- inv(2*sig_free_blk^2) * ((i0-ic)^2 + (j0-jc)^2)) ;
Ln0 = log(poids*Pn_ref + (1-poids)*Pn_free);

<span class="comment">%%%%%%%%%%</span>
</pre><h2>P(r|H1)<a name="255"></a></h2><pre class="codeinput">r =  lest(part, 6) ;
r_ref = tab_moy(traj, 7*t+6) ;
sig_r_ref = tab_var(traj, 7*t+6) ;
<span class="keyword">if</span> (sig_r_ref ~= 0)
  Lr = -0.5*log(sig_r_ref) - inv(2*sig_r_ref^2) * (r-r_ref)^2;
<span class="keyword">else</span>
  Lr = 0 ;
<span class="keyword">end</span><span class="comment">%if</span>
</pre><h2>vraisemblance<a name="256"></a></h2><pre class="codeinput">out = Lalpha + Ln0 + Lblink + 0*Lr;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> sig_blk = sigij_blink(traj, t)
</pre><pre class="codeinput"><span class="comment">% EN/ if blink, increase of the std</span>

<span class="keyword">global</span> tab_param ;
<span class="keyword">global</span> tab_var ;
</pre><h2>offset de zone de blink nb_blink==(-offset)<a name="259"></a></h2><pre class="codeinput"><span class="keyword">if</span> (tab_param(traj, 7*t+8) &lt; 0)
  offset = tab_param(traj, 7*t+8)  ;
<span class="keyword">else</span>
  offset = 0 ;
<span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>sigi = sigj<a name="260"></a></h2><pre class="codeinput">sig_blk = tab_var(traj, 7*t+3)  ;  <span class="comment">%% sur i</span>
</pre><h2>prise en compte du blink pour sig_i/j<a name="261"></a></h2><pre class="codeinput"><span class="keyword">if</span> (offset &lt; 0)
    sig_blk = sig_blk * sqrt(1-offset) ;
<span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> sig_free_blk = sigij_free_blink(traj, t, sig_free)
</pre><pre class="codeinput"><span class="comment">% EN/ if blink, increase of the std</span>
<span class="comment">% traj scalar or vector of trajectories</span>

<span class="keyword">global</span> tab_param ;
sig_free = evalin(<span class="string">'base'</span>, <span class="string">'sig_free'</span>);

traj = traj(:) ;
nb_traj = size(traj, 1) ;
</pre><h2>offset<a name="264"></a></h2><pre class="codeinput">offset = tab_param(traj, 7*t+8) ;
</pre><h2>offset de zone de blink nb_blink==(-offset)<a name="265"></a></h2><h2>offset = 0 si non_blink (&gt;0)<a name="266"></a></h2><h2>idem sinon ;<a name="267"></a></h2><pre class="codeinput">nb_blink = - (offset .* (offset &lt; 0))  ;
</pre><h2>sigi = sigj<a name="268"></a></h2><pre class="codeinput">sig_free_blk = sig_free*ones(nb_traj, 1) ;
</pre><h2>prise en compte du blink pour sig_i/j<a name="269"></a></h2><pre class="codeinput">sig_free_blk = sig_free_blk .* sqrt(1+nb_blink) ;
</pre><pre class="codeinput"><span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> part = best_config_reconnex(vec_traj, vec_part, t, lest, wn)<span class="comment">%,T)</span>
</pre><pre class="codeinput"><span class="comment">% EN/ This function looks for the best config</span>
<span class="comment">% according to the ML and sends back</span>
<span class="comment">% the most probable particle (O if blinked)</span>
<span class="comment">% The refering trace IS the first one</span>
<span class="comment">% of the list in vect_traj</span>
<span class="comment">%</span>
<span class="comment">% Caution with combinatory tests beyond nb_part = 4</span>

<span class="comment">% Exemple de calcul de Log-vraisemblance</span>
<span class="comment">% de reconnexion a 3 trajectoires/Particules</span>
<span class="comment">% reprenant les notations de la figure 3</span>
<span class="comment">%</span>
<span class="comment">%</span>
<span class="comment">% - T_domain = P_domain</span>
<span class="comment">% 3 trajectoires (a,k,b) pour 3 particules (1,2,3)</span>
<span class="comment">% on cherche la meilleure combinaison en comparant leur vraisemblance</span>
<span class="comment">% respective :</span>
<span class="comment">% L(a,1)  +  L(k,2)  +  L(b,3)  &lt;&gt;</span>
<span class="comment">% L(a,1)  +  L(k,3)  +  L(b,2)  &lt;&gt;</span>
<span class="comment">% L(a,2)  +  L(k,1)  +  L(b,3)  &lt;&gt;</span>
<span class="comment">%   etc.</span>
<span class="comment">%</span>
<span class="comment">% - T_domain &gt; P_domain</span>
<span class="comment">% 3 trajectoires (a,k,b) pour 2 particules : On en cree une 3eme OFF</span>
<span class="comment">% (1,2,OFF).</span>
<span class="comment">% Alors les tests deviennent :</span>
<span class="comment">% L(a,1) + L(k,2)   + L(b,OFF)  &lt;&gt;</span>
<span class="comment">% L(a,1) + L(k,OFF) + L(b,2)    &lt;&gt;</span>
<span class="comment">% L(a,2) + L(k,1)   + L(b,OFF)  &lt;&gt;</span>
<span class="comment">%   etc.</span>
<span class="comment">% Dans ce cas, seulement 2 termes de vraisemblance sont</span>
<span class="comment">% presents car le troisieme L(T,OFF), probabilite de disparition d'une</span>
<span class="comment">% trajectoire, est identique pour toute trajectoires T.</span>
<span class="comment">%</span>
<span class="comment">% - T_domain &lt; P_domain</span>
<span class="comment">% 2 trajectoires (a,k) pour 3 particules (1,2,3) : On cree une nouvelle</span>
<span class="comment">% trajectoire (a,k,NEW)</span>
<span class="comment">% Alors les tests deviennent :</span>
<span class="comment">% L(a,1) + L(k,2)  + L(NEW,3)  &lt;&gt;</span>
<span class="comment">% L(a,1) + L(k,3)  + L(NEW,2)  &lt;&gt;</span>
<span class="comment">% L(a,2) + L(k,1)  + L(NEW,3)  &lt;&gt;</span>
<span class="comment">%   etc.</span>
<span class="comment">% La encore, dans ce cas, seulement 2 termes de vraisemblance sont</span>
<span class="comment">% presents car le troisieme terme L(NEW,P), probabilite d'apparition</span>
<span class="comment">% d'une nouvelle trajectoire dans l'image, est suppose constant.</span>
<span class="comment">% Elle ne depend ni de la position, ni de l'intensite.</span>
</pre><h2>permutation circulaire sur vec_part<a name="272"></a></h2><h2>limite a la taille nb_traj<a name="273"></a></h2><p>nb_part = size(vec_part(:), 1) ;</p><pre class="codeinput">  nb_traj = size(vec_traj(:), 1) ;
  best_part = vec_part(1) ;
  vec_part_ref = vec_part(1:nb_traj) ;
  vrais =  vrais_config_reconnex(vec_traj, vec_part_ref, t, lest, wn);<span class="comment">%,T)</span>


  tab_perms_vec_part = perms(vec_part)' ;
  nb_perms = size(tab_perms_vec_part, 2) ;

  <span class="keyword">for</span> p=2:nb_perms
</pre><pre class="codeinput">    vec_part_perm = tab_perms_vec_part(:,p) ;
</pre><h2>si plus de particules que de traj<a name="275"></a></h2><h2>cas de nouvelle traj<a name="276"></a></h2><h2>on test les nb_traj premiere<a name="277"></a></h2><pre class="codeinput">    vec_part_perm = vec_part_perm(1:nb_traj) ;
    vrais_tmp =  vrais_config_reconnex(vec_traj, vec_part_perm, t, <span class="keyword">...</span>
				       lest, wn);<span class="comment">%, T) ;</span>

    <span class="keyword">if</span> (vrais_tmp &gt; vrais)
      vrais = vrais_tmp ;
      best_part = vec_part_perm(1) ;
    <span class="keyword">end</span> <span class="comment">%if</span>
</pre><pre class="codeinput">  <span class="keyword">end</span> <span class="comment">%for</span>

part = best_part ;
</pre><pre class="codeinput"><span class="keyword">end</span> <span class="comment">%function</span>
<span class="keyword">function</span> vrais = vrais_config_reconnex(vec_traj, vec_part, t, lest, wn)<span class="comment">%,T)</span>
<span class="comment">% function qui renvoie la vraisemblance</span>
<span class="comment">% d'une configuration de reconnexion/blink</span>
<span class="comment">% pour plusieurs trajectoires et particules</span>
<span class="comment">%</span>
<span class="comment">% les cardinaux des deux vecteurs d'entrees</span>
<span class="comment">% sont forcement egaux</span>

  <span class="comment">% vec_part peut avoir des valeurs nulles</span>
  <span class="comment">% correspondant aux particules blinkees</span>
  <span class="comment">% la proba de blink est sans a priori</span>
  <span class="comment">% et c'est la meme pour tout traj</span>
  <span class="comment">% toute comparaison ce fera a nombre de</span>
  <span class="comment">% blink egal, donc on fait rien</span>

  vrais = 0 ;
  nb_part = size(vec_part(:), 1) ;
  <span class="keyword">for</span> p = 1:nb_part
    part = vec_part(p) ;
    traj = vec_traj(p) ;
    <span class="keyword">if</span> part ~= 0
      vrais_p = rapport_detection(traj, t, lest, part, wn) ;
      vrais = vrais + vrais_p ;
    <span class="keyword">end</span> <span class="comment">%if</span>
  <span class="keyword">end</span> <span class="comment">%for</span>

<span class="keyword">end</span> <span class="comment">%function</span>
</pre><h2>EXTRAS<a name="280"></a></h2><pre class="codeinput"><span class="keyword">function</span> setOptions(src, event)
fig = gcbf;

<span class="keyword">switch</span> get(src,<span class="string">'State'</span>)
    <span class="keyword">case</span> <span class="string">'on'</span>
</pre><pre class="codeinput">        ss = get(0,<span class="string">'ScreenSize'</span>);

        <span class="keyword">switch</span> getappdata(fig, <span class="string">'viewMode'</span>)
            <span class="keyword">case</span> <span class="string">'monoView'</span>

                <span class="keyword">if</span> getappdata(fig, <span class="string">'isTrack'</span>)
                    nImCh = 0;
                    nTrackCh = 1;
                    trackSrcFig = fig;
                <span class="keyword">else</span>
                    nImCh = 1;
                    imCh = 1;
                    nTrackCh = 0;
                    srcFig = fig;
                <span class="keyword">end</span> <span class="comment">%if</span>

            <span class="keyword">otherwise</span>

                srcFig = getappdata(fig,<span class="string">'imSrcFig'</span>);
                imCh = getappdata(fig,<span class="string">'imCh'</span>);
                srcFig = srcFig(imCh);
                nImCh = getappdata(fig,<span class="string">'nImCh'</span>);

                trackSrcFig = getappdata(fig,<span class="string">'trackSrcFig'</span>);
                nTrackCh = getappdata(fig,<span class="string">'nTrackCh'</span>);

        <span class="keyword">end</span> <span class="comment">%switch</span>

        figOpt =<span class="keyword">...</span>
            figure(<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [50 150 <span class="keyword">...</span>
            202+98*(nImCh+nTrackCh) ss(4)-300],<span class="keyword">...</span>
            <span class="string">'Color'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
            <span class="string">'Name'</span>, <span class="string">'Options'</span>,<span class="keyword">...</span>
            <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
            <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
            <span class="string">'Resize'</span>, <span class="string">'off'</span>);

        <span class="comment">%save settings profile</span>
        hMenu = uicontextmenu;
        uimenu(hMenu, <span class="string">'Label'</span>, <span class="string">'save settings'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @saveSet);
        uimenu(hMenu, <span class="string">'Label'</span>, <span class="string">'load settings'</span>,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @loadSet);
        set(figOpt, <span class="string">'UIContextMenu'</span>, hMenu)

        inputPosY = ss(4)-(370:30:1010);
        x = [176 274 372 470];
        <span class="keyword">if</span> nImCh &gt; 0
</pre><h2>localization<a name="282"></a></h2><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Framerange:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Error Rate [10^]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Detection Box [px]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Deflation Loops:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(6) 161 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Intensity Thresh [cnts]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(7) 161 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'use multiple cores:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'If this option is checked the programm will perform \n'</span><span class="keyword">...</span>
                <span class="string">'the particle localization process using the specefied \n'</span><span class="keyword">...</span>
                <span class="string">'number of processor cores. \n'</span><span class="keyword">...</span>
                <span class="string">'The maximum of available cores will be used by default.'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(8) 161 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'apply spatial correction:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'If this option is checked the programm will perform \n'</span><span class="keyword">...</span>
                <span class="string">'a spatial transformation on the particle coordinates\n'</span><span class="keyword">...</span>
                <span class="string">'when the localization process is finished. \n'</span><span class="keyword">...</span>
                <span class="string">'The spatial transformation corrects for rotation and transition \n'</span><span class="keyword">...</span>
                <span class="string">'between image channels'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(9) 161 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'live localization:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'If this option is checked the programm will directly \n'</span><span class="keyword">...</span>
                <span class="string">'stream the localization process into a preview window.'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(11) 167 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Optimization Settings'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(12) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'max. # iterations:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(13) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'term. tol. [10^]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(14) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'r0 tolerance [%]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'If this option is checked the programm will optimize for \n'</span><span class="keyword">...</span>
                <span class="string">'the gaussian radius approximating the point spreads function std. \n'</span><span class="keyword">...</span><span class="comment">.</span>
                <span class="string">'If the tolerancelevel set is exceeded the particle will be discarded.'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(15) 155 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'max. pos. refinement [px]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><h2>render<a name="283"></a></h2><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Framerange:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Expansion Factor:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(3) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'exfNew'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'exfNew'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Convolution Mode:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Int. Weight:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(6) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Size Factor:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(8) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Movie Settings'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(9) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Windowsize:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(10) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Stepsize:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(10) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'rStep'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig, <span class="string">'rStep'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(11) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'fps:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(11) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'fps'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'fps'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(12) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Compression:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(12) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, {<span class="string">'RLE'</span> <span class="string">'MSVC'</span> <span class="string">'none'</span>},<span class="keyword">...</span>
                <span class="string">'Value'</span>, getappdata(fig,<span class="string">'movCompression'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'movCompression'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(13) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'accumultative movie:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><h2>filters<a name="284"></a></h2><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Loc.Prec. [nm]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Signal to Noise:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Detection Density:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><h2>scalebar<a name="285"></a></h2><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Colormap [px]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'Value'</span>, getappdata(fig,<span class="string">'isColormap'</span>),<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'isColormap'</span>},<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(2) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'colormapWidth'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'colormapWidth'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Scalebar [nm]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'Value'</span>, getappdata(fig,<span class="string">'isScalebar'</span>),<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'isScalebar'</span>},<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(3) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'micronBarLength'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'micronBarLength'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Timestamp [sec]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'Value'</span>, getappdata(fig,<span class="string">'isTimestamp'</span>),<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'isTimestamp'</span>},<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(4) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'timestampInkrement'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'timestampInkrement'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Charactersize:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'barButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(5) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, getappdata(fig,<span class="string">'timestampSize'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'timestampSize'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);
</pre><h2>optics<a name="286"></a></h2><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Pixel Size [?m]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(2) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>,getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>, {@calcPSF, fig, <span class="string">'pxSize'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'This Value is used to estimate the pixel to micron conversion factor. \n'</span><span class="keyword">...</span>
                <span class="string">'In Theory: pixel size = phys. pixel size / total magnification(objectiv*ocular)\n'</span><span class="keyword">...</span>
                <span class="string">'60, 1x = 0.267?m per pixel \n 60, 1.6x = 0.167?m per pixel \n'</span><span class="keyword">...</span>
                <span class="string">'150, 1x = 0.107?m per pixel \n 150, 1.6x = 0.067?m per pixel'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 156 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Emission [nm]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'N.A.:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'PSF Scaling:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(6) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'PSF Std [px]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
                <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                <span class="string">'Standard deviation of the Gaussian modelling the \n'</span><span class="keyword">...</span>
                <span class="string">'Microscope associated Point Spread Function.'</span>]));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(8) 156 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Counts/Photon:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                        uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(9) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Lag Time [ms]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [176 inputPosY(9) 84 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>,getappdata(fig,<span class="string">'frameSize'</span>),<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                <span class="string">'Callback'</span>, {@calcPSF, fig, <span class="string">'frameSize'</span>},<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>);
</pre><h2>tracking<a name="287"></a></h2><pre class="codeinput">              uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2)-20 147 40],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Max. expected Diffusion Coefficient [?m^2/s]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3)-20 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Searchexp. Factor:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4)-20 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Statistics Win. [frames]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5)-20 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Max. # Competitors:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(6)-20 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Max. OFF-Time [frames]:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(7)-20 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Int. Fluc. Weight:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                          uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(8)-40 147 40],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Local vs. Max. expected Diffusion Weight:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><pre class="codeinput">            <span class="keyword">for</span> ch = 1:nImCh
</pre><h2>channel<a name="289"></a></h2><pre class="codeinput">                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+10 inputPosY(1) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, [<span class="string">'Channel '</span> num2str(imCh(ch)) <span class="string">':'</span>],<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><h2>localization<a name="290"></a></h2><pre class="codeinput">                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'locStart'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'locStart'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+43 inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'locEnd'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'locEnd'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(3) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'errorRate'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, srcFig(ch), <span class="string">'errorRate'</span>},<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'This Value limits the Probability for Type One Error (False H0 Rejection), \n'</span><span class="keyword">...</span>
                    <span class="string">'while estimation of the generalized likelihood ratio test. \n'</span><span class="keyword">...</span>
                    <span class="string">'These Ratios follow aproximated a chi^2 distribution\n'</span><span class="keyword">...</span>
                    <span class="string">'with degree of freedom (3 [signal, offset, noise]-2[offset, noise]) = 1'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'w2d'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'w2d'</span>},<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'Size of 2 dimensional sliding box inside whom a \n'</span><span class="keyword">...</span>
                    <span class="string">'generalized likelihood ratio test (H0/H1) is performed with: \n'</span><span class="keyword">...</span>
                    <span class="string">'H0 = no target (offset and noise) \n'</span><span class="keyword">...</span>
                    <span class="string">'H1 = presence of target (signal, offset and noise) \n'</span><span class="keyword">...</span>
                    <span class="string">'followed by subpixel estimation via Gauss-Newton Approximation. \n'</span><span class="keyword">...</span>
                    <span class="string">'By rule of thumb this value should be set to 6*PSFstd+1. \n'</span><span class="keyword">...</span>
                    <span class="string">'Strictly avoid an even number!!!'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(5) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'dfltnLoops'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'dfltnLoops'</span>},<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'This Value determines how often the detection process will be iterated. \n'</span><span class="keyword">...</span>
                    <span class="string">'After each Iteration the detected Particles represented by their \n'</span><span class="keyword">...</span>
                    <span class="string">'gaussian Intensity Profile will be subtracted from the Image. \n'</span><span class="keyword">...</span>
                    <span class="string">'In this way small peaks initially covered can be detected.'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(6) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'minInt'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'minInt'</span>},<span class="keyword">...</span>
                    <span class="string">'ToolTipString'</span>, sprintf([<span class="string">'\n'</span><span class="keyword">...</span>
                    <span class="string">'Defines the min. Signal Intensity expressed as offset-corrected amplitude of the Gaussian.'</span>]));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(7) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'locParallel'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, srcFig(ch), <span class="string">'locParallel'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(7) 64 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, {<span class="string">'max'</span> <span class="string">'2'</span> <span class="string">'3'</span>},<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'nCores'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'nCores'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(8) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'spatialCorrection'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@setSpatialCorrPath,srcFig(ch)},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(9) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'rLive'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue,srcFig(ch),<span class="string">'rLive'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(12) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'maxOptimIter'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'maxOptimIter'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(13) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'termTol'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'termTol'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(14) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'isRadiusTol'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, srcFig(ch),<span class="string">'isRadiusTol'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(14) 64 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'radiusTol'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'radiusTol'</span>});

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'locButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(15) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'posTol'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'posTol'</span>});
</pre><h2>rendering<a name="291"></a></h2><pre class="codeinput">                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'rStart'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'rStart'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);


                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+43 inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'rEnd'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'rEnd'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
                    <span class="string">'Parent'</span>, gcf,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, {<span class="string">'fixed'</span>, <span class="string">'dynamic'</span>, <span class="string">'none'</span>},<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'convMode'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'convMode'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(5) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'intWeight'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'intWeight'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(6) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'sizeFac'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'sizeFac'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(9) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'rW'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'rW'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'renderButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(13) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'isCumsum'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, srcFig(ch),<span class="string">'isCumsum'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><h2>filters<a name="292"></a></h2><pre class="codeinput">                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(2) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">':'</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'isThreshLocPrec'</span>),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'isThreshLocPrec'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(2) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'minLoc'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'minLoc'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+52 inputPosY(2) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'maxLoc'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'maxLoc'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(3) 147 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'isThreshSNR'</span>),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'isThreshSNR'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(3) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'minSNR'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'minSNR'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+52 inputPosY(3) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'maxSNR'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'maxSNR'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'isThreshDensity'</span>),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, fig,<span class="string">'isThreshDensity'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'threshButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(4) 64 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, {<span class="string">'inclusive'</span>, <span class="string">'exclusiv'</span>},<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(srcFig(ch),<span class="string">'clusterMode'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'clusterMode'</span>});
</pre><h2>optics<a name="293"></a></h2><pre class="codeinput">                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(3) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'emWvlnth'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@calcPSF, srcFig(ch), <span class="string">'emWvlnth'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'NA'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@calcPSF, srcFig(ch), <span class="string">'NA'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(5) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'psfScale'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@calcPSF, srcFig(ch), <span class="string">'psfScale'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(6) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, num2str(getappdata(srcFig(ch),<span class="string">'psfStd'</span>),<span class="string">'%.2f'</span>),<span class="keyword">...</span>
                    <span class="string">'Enable'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'opticsButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [176 inputPosY(8) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'cntsPerPhoton'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch),<span class="string">'cntsPerPhoton'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);
</pre><h2>tracking<a name="294"></a></h2><pre class="codeinput">                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(2)-10 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'Dmax'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'Dmax'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(3)-20 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'searchExpFac'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'searchExpFac'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4)-20 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'statWin'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'statWin'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(5)-20 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'maxComp'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'maxComp'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);
                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(6)-20 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'maxOffTime'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'maxOffTime'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(7)-20 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'intLawWeight'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'intLawWeight'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackingButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(8)-30 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(srcFig(ch),<span class="string">'diffLawWeight'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, srcFig(ch), <span class="string">'diffLawWeight'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);
</pre><pre class="codeinput">            <span class="keyword">end</span>
</pre><pre class="codeinput">        <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="keyword">if</span> nTrackCh &gt; 0
</pre><pre class="codeinput">            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(2) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Framerange:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(3) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Colorcoding:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(4) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Track Thickness:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(5) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Track Length:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(7) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Movie Settings'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(8) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'Windowsize:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(9) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'accumultative track:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            uicontrol(<span class="keyword">...</span>
                <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                <span class="string">'Position'</span>, [22 inputPosY(10) 147 20],<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'String'</span>, <span class="string">'track always visible:'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));
</pre><pre class="codeinput">            x = x+98*nImCh;
            <span class="keyword">for</span> ch = 1:nTrackCh
                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+10 inputPosY(1) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, [<span class="string">'Track '</span> num2str(ch) <span class="string">':'</span>],<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'rStart'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, trackSrcFig(ch), <span class="string">'rStart'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+42 inputPosY(2) 42 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'rEnd'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, trackSrcFig(ch), <span class="string">'rEnd'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(3) 64 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 7,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, {<span class="string">'ensemble'</span>, <span class="string">'individual'</span>},<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackColorMode'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeTrackColorcode,trackSrcFig(ch)});

                color = getappdata(trackSrcFig(ch),<span class="string">'trackColor'</span>);
                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+64 inputPosY(3) 20 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, color{1},<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeTrackColor, trackSrcFig(ch)},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(4) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackWidth'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeTrackLinewidth, trackSrcFig(ch)},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(5) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(trackSrcFig(ch),<span class="string">'isTracksizeThresh'</span>),<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeValue, trackSrcFig(ch),<span class="string">'isTracksizeThresh'</span>},<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+20 inputPosY(5) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'minTracksize'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeTracksize,trackSrcFig(ch),<span class="string">'minTracksize'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch)+52 inputPosY(5) 32 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'maxTracksize'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>,{@changeTracksize,trackSrcFig(ch),<span class="string">'maxTracksize'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(8) 84 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, getappdata(trackSrcFig(ch),<span class="string">'rW'</span>),<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, trackSrcFig(ch), <span class="string">'rW'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>);

                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(9) 161 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(trackSrcFig(ch),<span class="string">'isCumsum'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, trackSrcFig(ch), <span class="string">'isCumsum'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

                                uicontrol(<span class="keyword">...</span>
                    <span class="string">'Tag'</span>, <span class="string">'trackButton'</span>,<span class="keyword">...</span>
                    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
                    <span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="keyword">...</span>
                    <span class="string">'Position'</span>, [x(ch) inputPosY(10) 161 20],<span class="keyword">...</span>
                    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
                    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                    <span class="string">'String'</span>, <span class="string">''</span>,<span class="keyword">...</span>
                    <span class="string">'Value'</span>, getappdata(trackSrcFig(ch),<span class="string">'trackVisibility'</span>),<span class="keyword">...</span>
                    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>,<span class="keyword">...</span>
                    <span class="string">'Callback'</span>, {@changeValue, trackSrcFig(ch), <span class="string">'trackVisibility'</span>},<span class="keyword">...</span>
                    <span class="string">'Visible'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
                    <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

            <span class="keyword">end</span>
</pre><pre class="codeinput">        <span class="keyword">end</span> <span class="comment">%if</span>
</pre><h2>switch tabs<a name="300"></a></h2><pre class="codeinput">        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0 0.95 0.3 0.05],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 19,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, <span class="string">'Sheet:'</span>,<span class="keyword">...</span>
            <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>));

        hToggle =<span class="keyword">...</span>
            uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.3 0.95 0.7 0.05],<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
            <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'HorizontalAlignment'</span>,<span class="string">'right'</span>,<span class="keyword">...</span>
            <span class="string">'String'</span>, {<span class="keyword">...</span>
            <span class="string">'Localization'</span>,<span class="keyword">...</span>
            <span class="string">'Tracking'</span>,<span class="keyword">...</span>
            <span class="string">'Render'</span>,<span class="keyword">...</span>
            <span class="string">'Trajectories'</span>,<span class="keyword">...</span>
            <span class="string">'Acquisition'</span>,<span class="keyword">...</span>
            <span class="string">'Bars'</span>,<span class="keyword">...</span>
            <span class="string">'Filters'</span>},<span class="keyword">...</span>
            <span class="string">'Value'</span>, 3,<span class="keyword">...</span>
            <span class="string">'BackgroundColor'</span>, get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
            <span class="string">'CreateFcn'</span>, @changeTab,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @changeTab);

        sliderPos = 1;
        uicontrol(<span class="keyword">...</span>
            <span class="string">'Style'</span>, <span class="string">'slider'</span>,<span class="keyword">...</span>
            <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
            <span class="string">'Position'</span>, [0.942 0 0.05 0.9],<span class="keyword">...</span>
            <span class="string">'SliderStep'</span>, [0.01 0.01],<span class="keyword">...</span>
            <span class="string">'Value'</span>,sliderPos,<span class="keyword">...</span>
            <span class="string">'Callback'</span>, @adjustInputs);
</pre><pre class="codeinput">    <span class="keyword">case</span> <span class="string">'off'</span>
        delete(findobj(allchild(0),<span class="string">'Color'</span>,get(fig,<span class="string">'Color'</span>),<span class="keyword">...</span>
            <span class="string">'-and'</span>, <span class="string">'Name'</span>, <span class="string">'Options'</span>))
<span class="keyword">end</span> <span class="comment">%switch</span>

    <span class="keyword">function</span> changeTab(src, event)
        selection = get(src, {<span class="string">'String'</span>,<span class="string">'Value'</span>});
        <span class="keyword">switch</span> char(selection{1}(selection{2}))
            <span class="keyword">case</span> <span class="string">'Localization'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Render'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Bars'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Acquisition'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Filters'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Trajectories'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
            <span class="keyword">case</span> <span class="string">'Tracking'</span>
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackingButton'</span>), <span class="string">'Visible'</span>, <span class="string">'on'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'trackButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'threshButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'locButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'renderButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'barButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
                set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>), <span class="string">'Visible'</span>, <span class="string">'off'</span>)
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> changeValue(src, event, channel, fieldname)
        <span class="keyword">switch</span> get(src, <span class="string">'Style'</span>)
            <span class="keyword">case</span> <span class="string">'edit'</span>
                <span class="keyword">for</span> h = channel
                    setappdata(h,fieldname,str2double(get(src,<span class="string">'String'</span>)))
                <span class="keyword">end</span> <span class="comment">%for</span>
            <span class="keyword">case</span> <span class="string">'checkbox'</span>
                <span class="keyword">for</span> h = channel
                    setappdata(h,fieldname,get(src,<span class="string">'Value'</span>))
                <span class="keyword">end</span> <span class="comment">%for</span>
            <span class="keyword">case</span> <span class="string">'popupmenu'</span>
                <span class="keyword">for</span> h = channel
                    setappdata(h,fieldname,get(src,<span class="string">'Value'</span>))
                <span class="keyword">end</span> <span class="comment">%for</span>
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> calcPSF(src, event, channel, fieldname)
        setappdata(channel,fieldname,str2double(get(src,<span class="string">'String'</span>)));

        psfStd = getappdata(channel,<span class="string">'psfScale'</span>)*0.55*<span class="keyword">...</span>
            getappdata(channel,<span class="string">'emWvlnth'</span>)/1000/<span class="keyword">...</span>
            getappdata(channel,<span class="string">'NA'</span>)/1.17/2/<span class="keyword">...</span>
            getappdata(channel,<span class="string">'pxSize'</span>);

        set(findobj(figOpt,<span class="string">'Tag'</span>,<span class="string">'opticsButton'</span>, <span class="string">'-and'</span>, <span class="string">'Enable'</span>, <span class="string">'off'</span>),<span class="keyword">...</span>
            <span class="string">'String'</span>, num2str(psfStd,<span class="string">'%.2f'</span>));
        setappdata(channel, <span class="string">'psfStd'</span>, psfStd)
    <span class="keyword">end</span>

    <span class="keyword">function</span> changeTrackLinewidth(src, event, fig)
        setappdata(fig,<span class="string">'trackWidth'</span>, str2double(get(src,<span class="string">'String'</span>)));
        set(findobj(fig,<span class="string">'Type'</span>,<span class="string">'Line'</span>),<span class="string">'LineWidth'</span>, getappdata(fig,<span class="string">'trackWidth'</span>))
    <span class="keyword">end</span>
    <span class="keyword">function</span> changeTrackColorcode(src,event,fig)
        <span class="keyword">switch</span> get(src,<span class="string">'value'</span>)
            <span class="keyword">case</span> 1
                setappdata(fig,<span class="string">'trackColorMode'</span>,1)
                color = getappdata(fig,<span class="string">'trackColor'</span>);
                set(findobj(fig,<span class="string">'Type'</span>,<span class="string">'Line'</span>),<span class="string">'Color'</span>,<span class="keyword">...</span>
                    color{1});
            <span class="keyword">case</span> 2
                setappdata(fig,<span class="string">'trackColorMode'</span>,2)
                color = getappdata(fig,<span class="string">'trackColor'</span>);
                set(findobj(fig,<span class="string">'Type'</span>,<span class="string">'Line'</span>),{<span class="string">'Color'</span>},<span class="keyword">...</span>
                    mat2cell(color{2},<span class="keyword">...</span>
                    ones(getappdata(fig,<span class="string">'nTracks'</span>),1),3));
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> changeTrackColor(src, event, fig)
        <span class="keyword">if</span> getappdata(fig,<span class="string">'trackColorMode'</span>) == 1
            color = getappdata(fig,<span class="string">'trackColor'</span>);
            colorNew = colorui(color{1}, <span class="string">'Track Color'</span>);
            <span class="keyword">if</span> numel(colorNew) &gt; 1
                color{1} = colorNew;
                setappdata(fig,<span class="string">'trackColor'</span>,color);
                set(src, <span class="string">'BackgroundColor'</span>, colorNew);
                set(findobj(fig,<span class="string">'Type'</span>,<span class="string">'Line'</span>),<span class="string">'Color'</span>, colorNew)
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> changeTracksize(src,event,fig,field)
        tracks = getappdata(fig,<span class="string">'tracks'</span>);
        tracksize = cellfun(<span class="string">'size'</span>,tracks,1);

        <span class="keyword">if</span> strcmp(field,<span class="string">'minTracksize'</span>)
            minTracksize = str2double(get(src,<span class="string">'String'</span>));
            setappdata(fig,field,minTracksize)
            maxTracksize = getappdata(fig,<span class="string">'maxTracksize'</span>);
        <span class="keyword">else</span>
            minTracksize = getappdata(fig,<span class="string">'minTracksize'</span>);
            maxTracksize = str2double(get(src,<span class="string">'String'</span>));
            setappdata(fig,field,maxTracksize)
        <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="keyword">if</span> isinf(maxTracksize)
            hasSize = tracksize &gt;= minTracksize;
        <span class="keyword">else</span>
            hasSize = tracksize &gt;= minTracksize &amp;<span class="keyword">...</span>
                tracksize &lt;= maxTracksize;
        <span class="keyword">end</span> <span class="comment">%if</span>
        hTracks = getappdata(fig,<span class="string">'hTracks'</span>);
        set(hTracks,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
        set(hTracks(hasSize),<span class="string">'Visible'</span>,<span class="string">'on'</span>)

    <span class="keyword">end</span>

    <span class="keyword">function</span> saveSet(src, event)
        [optName,optPath,isOK] = uiputfile(<span class="keyword">...</span>
            <span class="string">'.mat'</span> ,<span class="string">'Save Profile to'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(0,<span class="string">'searchPath'</span>, optPath)
            hEdit = get(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'edit'</span>), <span class="string">'String'</span>);
            hCheck = get(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'checkbox'</span>), <span class="string">'Value'</span>);
            hPopup = get(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'popupmenu'</span>), <span class="string">'Value'</span>);
            save ([optPath optName], <span class="string">'hEdit'</span>, <span class="string">'hCheck'</span>, <span class="string">'hPopup'</span>)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> loadSet(src, event)
        [optName, optPath, isOK] = uigetfile(<span class="keyword">...</span>
            <span class="string">'*.mat'</span>, <span class="string">'Select Profile'</span>, getappdata(0,<span class="string">'searchPath'</span>));
        <span class="keyword">if</span> isOK
            setappdata(0,<span class="string">'searchPath'</span>, optPath)
            hEdit = []; hCheck = []; hPopup = [];
            load([optPath optName])
            set(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'edit'</span>), {<span class="string">'String'</span>},hEdit)
            set(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'checkbox'</span>), {<span class="string">'Value'</span>},hCheck)
            set(findobj(figOpt,<span class="string">'Style'</span>, <span class="string">'popupmenu'</span>), {<span class="string">'Value'</span>}, hPopup)
        <span class="keyword">else</span>
            <span class="keyword">return</span>
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> adjustInputs(src,event)
        <span class="keyword">if</span> get(src,<span class="string">'Value'</span>) &lt; sliderPos
            slideVal = [0 5 0 0];
        <span class="keyword">else</span>
            slideVal = [0 -6 0 0];
        <span class="keyword">end</span> <span class="comment">%if</span>
        sliderPos = get(src,<span class="string">'Value'</span>);
        hList = findobj(figOpt,<span class="keyword">...</span>
            <span class="string">'Style'</span>,<span class="string">'Edit'</span>,<span class="keyword">...</span>
            <span class="string">'-or'</span>,<span class="string">'Style'</span>,<span class="string">'Text'</span>,<span class="keyword">...</span>
            <span class="string">'-or'</span>,<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
            <span class="string">'-or'</span>,<span class="string">'Style'</span>,<span class="string">'checkbox'</span>);
        oldPos = get(hList,<span class="string">'Position'</span>);
        newPos = cellfun(@(x) x+slideVal, oldPos, <span class="string">'Un'</span>, 0);
        set(hList,{<span class="string">'Position'</span>},newPos)
    <span class="keyword">end</span>
    <span class="keyword">function</span> setSpatialCorrPath(src,event,fig)
        <span class="keyword">if</span> get(src,<span class="string">'Value'</span>)
            [tMatName, tMatPath, isOK] = uigetfile(<span class="keyword">...</span>
                <span class="string">'*.mat'</span>, <span class="string">'Select spatial Transformationmatrix'</span>,<span class="keyword">...</span>
                getappdata(0,<span class="string">'searchPath'</span>));
            <span class="keyword">if</span> isOK
                tMat = [];
                load([tMatPath tMatName])
                setappdata(fig,<span class="string">'spatialCorrection'</span>,1)
                setappdata(fig,<span class="string">'tMat'</span>,tMat);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">else</span>
            setappdata(fig,<span class="string">'spatialCorrection'</span>,0)
            rmappdata(fig,<span class="string">'tMat'</span>);
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> showCredits(src, event)
figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.2 0.2 0.3 0.5],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Credits'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'off'</span>);

text(0.5,0.8,<span class="keyword">...</span>
    {<span class="string">'{\fontsize{12} Particle Localization:}'</span>,<span class="keyword">...</span>
    <span class="string">'\copyright A. Serge, N. Bertaux,'</span>, <span class="string">'H. Rigneault &amp; D. Marguet'</span>,<span class="keyword">...</span>
    <span class="string">'\bf Dynamic multiple-target tracing'</span>, <span class="string">'to probe spatiotemporal'</span>,<span class="keyword">...</span>
    <span class="string">'cartography of cell membranes'</span>, <span class="string">'\rm Nature Methods, Aug. 08'</span>},<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>);

text(0.5,0.5,<span class="keyword">...</span>
    {<span class="string">'{\fontsize{12} Dynamic Convolution:}'</span>,<span class="keyword">...</span>
    <span class="string">'M. Parent, T. Gould,'</span>, <span class="string">'S.T. Hess'</span>},<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>);

text(0.5,0.35,<span class="keyword">...</span>
    {<span class="string">'{\fontsize{12} kd-Tree &amp; k-NN Search:}'</span>,<span class="keyword">...</span>
    <span class="string">'A. Tagliasacchi'</span>},<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>);

text(0.5,0.1, {<span class="string">'{\fontsize{12} written by C.P.Richter}'</span>,<span class="keyword">...</span>
    <span class="string">'Division of Biophysics / Group Piehler'</span>, <span class="string">'University of Osnabrueck'</span>},<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>);

axis <span class="string">off</span>
<span class="keyword">end</span>
<span class="keyword">function</span> showChangeLog(src, event)
fig =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.2 0.2 0.5 0.5],<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>),<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Changelog'</span>,<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'off'</span>);
hList =<span class="keyword">...</span>
    uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'listbox'</span>,<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.1 0.1 0.8 0.8],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 10,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>, <span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);

set(hList, <span class="string">'String'</span>,<span class="keyword">...</span>
    {<span class="string">'1.101b'</span>,<span class="keyword">...</span>
    <span class="string">'-batch processing of stacks'</span>,<span class="keyword">...</span>
    <span class="string">'-2D and 3D scatterplot'</span>,<span class="keyword">...</span>
    <span class="string">'-fixed calculation of loc. Prec.'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.012b'</span>,<span class="keyword">...</span>
    <span class="string">'-improved trajectory integration'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.012a'</span>,<span class="keyword">...</span>
    <span class="string">'-support for Hess FPALM restored'</span>,<span class="keyword">...</span>
    <span class="string">'-added spatial correction after localization'</span>,<span class="keyword">...</span>
    <span class="string">'-added compatibility mode for older SLIMfast builds'</span>,<span class="keyword">...</span>
    <span class="string">'-counts2photon conversion factor fixed'</span>,<span class="keyword">...</span>
    <span class="string">'-bugfix roi+expansion factor'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.011c'</span>,<span class="keyword">...</span>
    <span class="string">'-adjustable multicore mode'</span>,<span class="keyword">...</span>
    <span class="string">'-z-Projection (max. &amp; mean Intensity)'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.011b'</span>,<span class="keyword">...</span>
    <span class="string">'-localization parallelized'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.011a'</span>,<span class="keyword">...</span>
    <span class="string">'-improved colorID (gradually shading childs)'</span>,<span class="keyword">...</span>
    <span class="string">'-lenghtstring added to scalebar'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010g'</span>,<span class="keyword">...</span>
    <span class="string">'-density threshold by data clustering'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010f'</span>,<span class="keyword">...</span>
    <span class="string">'-dualView mode enabled (movie)'</span>,<span class="keyword">...</span>
    <span class="string">'-tripleView mode enabled (movie)'</span>,<span class="keyword">...</span>
    <span class="string">'-colormaps for polyview improved'</span>,<span class="keyword">...</span>
    <span class="string">'-scalebar moved to north-east'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010e'</span>,<span class="keyword">...</span>
    <span class="string">'-sync ROI between channels'</span>,<span class="keyword">...</span>
    <span class="string">'-tripleView mode enabled (image)'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010d'</span>,<span class="keyword">...</span>
    <span class="string">'-load/save options profile (contextmenu on window)'</span>,<span class="keyword">...</span>
    <span class="string">'-multiple fractions to intensity fit'</span>,<span class="keyword">...</span>
    <span class="string">'(allows constraint mean intensities)'</span>,<span class="keyword">...</span>
    <span class="string">'-options window on/off togglebutton'</span>,<span class="keyword">...</span>
    <span class="string">'-changelog added'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010c'</span>,<span class="keyword">...</span>
    <span class="string">'-colorcode for associated windows'</span>,<span class="keyword">...</span>
    <span class="string">'-buttons to manipulate roi (contextmenu on roi)'</span>,<span class="keyword">...</span>
    <span class="string">'-accumulative movie option'</span>,<span class="keyword">...</span>
    <span class="string">'-fixed convolutionkernel effected by Int.Weight and SizeFactor'</span>,<span class="keyword">...</span>
    <span class="string">'-imagestack locking into free channel (fixed)'</span>,<span class="keyword">...</span>
    <span class="string">'-dualView mode enabled (image)'</span>,<span class="keyword">...</span>
    <span class="string">''</span>,<span class="keyword">...</span>
    <span class="string">'1.010b'</span>,<span class="keyword">...</span>
    <span class="string">'-next/previous frame on superstack (fixed)'</span>,<span class="keyword">...</span>
    <span class="string">'-analysis histograms relate to roi and framerange'</span>,<span class="keyword">...</span>
    <span class="string">'-Signal to noise ratio thresholds for rendering'</span>,<span class="keyword">...</span>
    <span class="string">'-abort localization at any time (Strg-Alt-S)'</span>,<span class="keyword">...</span>
    <span class="string">'-ascii-export of current used options (Opt2Txt-Pushbutton)'</span>,<span class="keyword">...</span>
    <span class="string">'-actual searchpath is set to last used directory'</span>,<span class="keyword">...</span>
    <span class="string">'-check on loc.data name and possibility to overwrite'</span>,<span class="keyword">...</span>
    <span class="string">'-save button if imagestack loaded (fixed)'</span>,<span class="keyword">...</span>
    <span class="string">'-# rendered particles / total # particles added to windowtitles'</span>,<span class="keyword">...</span>
    <span class="string">'(analysis histograms &amp; rendered images)'</span>})
<span class="keyword">end</span>

<span class="keyword">function</span> [imFig trackFig] = getSelectedFigHandles
varList = {<span class="keyword">...</span>
    <span class="string">'menuRedChannel'</span>,<span class="keyword">...</span>
    <span class="string">'menuGreenChannel'</span>,<span class="keyword">...</span>
    <span class="string">'menuBlueChannel'</span>,<span class="keyword">...</span>
    <span class="string">'menuGrayChannel'</span>,<span class="keyword">...</span>
    <span class="string">'menuTrackChannel'</span>};

rootFig = findobj(0,<span class="string">'Tag'</span>,<span class="string">'root'</span>);

imFig = nan(4,1);
<span class="keyword">for</span> ch = 1:4
    hList = allchild(findobj(rootFig,<span class="string">'Tag'</span>,varList{ch}));
    isChecked = strcmp(get(hList,<span class="string">'Checked'</span>),<span class="string">'on'</span>);
    <span class="keyword">if</span> any(isChecked)
        imFig(ch) = get(hList(isChecked),<span class="string">'UserData'</span>);
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%for</span>

hList = allchild(findobj(rootFig,<span class="string">'Tag'</span>,varList{5}));
isChecked = strcmp(get(hList,<span class="string">'Checked'</span>),<span class="string">'on'</span>);
<span class="keyword">if</span> any(isChecked)
    trackFig = get(hList(isChecked),<span class="string">'UserData'</span>);
    <span class="keyword">if</span> iscell(trackFig)
        trackFig = cell2mat(trackFig);
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">else</span>
    trackFig = [];
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> transferVarList(targetFig,srcFig,mode)
<span class="keyword">switch</span> mode
    <span class="keyword">case</span> <span class="string">'render-mono'</span>
        varList = {<span class="keyword">...</span>
            <span class="string">'isOwn'</span>,<span class="keyword">...</span>
            <span class="string">'isLoaded'</span>,<span class="keyword">...</span>
            <span class="string">'isSuperstack'</span>,<span class="keyword">...</span>
            <span class="string">'isTrack'</span>,<span class="keyword">...</span>
            <span class="string">'frame'</span>,<span class="keyword">...</span>
            <span class="string">'viewMode'</span>,<span class="keyword">...</span>
            <span class="string">'locStart'</span>,<span class="keyword">...</span>
            <span class="string">'locEnd'</span>,<span class="keyword">...</span>
            <span class="string">'errorRate'</span>,<span class="keyword">...</span>
            <span class="string">'w2d'</span>,<span class="keyword">...</span>
            <span class="string">'dfltnLoops'</span>,<span class="keyword">...</span>
            <span class="string">'minInt'</span>,<span class="keyword">...</span>
            <span class="string">'locParallel'</span>,<span class="keyword">...</span>
            <span class="string">'nCores'</span>,<span class="keyword">...</span>
            <span class="string">'spatialCorrection'</span>,<span class="keyword">...</span>
            <span class="string">'isRadiusTol'</span>,<span class="keyword">...</span>
            <span class="string">'radiusTol'</span>,<span class="keyword">...</span>
            <span class="string">'posTol'</span>,<span class="keyword">...</span>
            <span class="string">'maxOptimIter'</span>,<span class="keyword">...</span>
            <span class="string">'termTol'</span>,<span class="keyword">...</span>
            <span class="string">'isScalebar'</span>,<span class="keyword">...</span>
            <span class="string">'micronBarLength'</span>,<span class="keyword">...</span>
            <span class="string">'isColormap'</span>,<span class="keyword">...</span>
            <span class="string">'colormapWidth'</span>,<span class="keyword">...</span>
            <span class="string">'isTimestamp'</span>,<span class="keyword">...</span>
            <span class="string">'timestampSize'</span>,<span class="keyword">...</span>
            <span class="string">'timestampInkrement'</span>,<span class="keyword">...</span>
            <span class="string">'clusterMode'</span>,<span class="keyword">...</span>
            <span class="string">'exfOld'</span>,<span class="keyword">...</span>
            <span class="string">'exfNew'</span>,<span class="keyword">...</span>
            <span class="string">'rW'</span>,<span class="keyword">...</span>
            <span class="string">'rStep'</span>,<span class="keyword">...</span>
            <span class="string">'rStart'</span>,<span class="keyword">...</span>
            <span class="string">'rEnd'</span>,<span class="keyword">...</span>
            <span class="string">'rLive'</span>,<span class="keyword">...</span>
            <span class="string">'fps'</span>,<span class="keyword">...</span>
            <span class="string">'movCompression'</span>,<span class="keyword">...</span>
            <span class="string">'convMode'</span>,<span class="keyword">...</span>
            <span class="string">'intWeight'</span>,<span class="keyword">...</span>
            <span class="string">'sizeFac'</span>,<span class="keyword">...</span>
            <span class="string">'isCumsum'</span>,<span class="keyword">...</span>
            <span class="string">'isThreshLocPrec'</span>,<span class="keyword">...</span>
            <span class="string">'minLoc'</span>,<span class="keyword">...</span>
            <span class="string">'maxLoc'</span>,<span class="keyword">...</span>
            <span class="string">'isThreshSNR'</span>,<span class="keyword">...</span>
            <span class="string">'minSNR'</span>,<span class="keyword">...</span>
            <span class="string">'maxSNR'</span>,<span class="keyword">...</span>
            <span class="string">'isThreshDensity'</span>,<span class="keyword">...</span>
            <span class="string">'pxSize'</span>,<span class="keyword">...</span>
            <span class="string">'cntsPerPhoton'</span>,<span class="keyword">...</span>
            <span class="string">'emWvlnth'</span>,<span class="keyword">...</span>
            <span class="string">'NA'</span>,<span class="keyword">...</span>
            <span class="string">'psfScale'</span>,<span class="keyword">...</span>
            <span class="string">'psfStd'</span>,<span class="keyword">...</span>
            <span class="string">'imageName'</span>,<span class="keyword">...</span>
            <span class="string">'pathname'</span>,<span class="keyword">...</span>
            <span class="string">'filename'</span>,<span class="keyword">...</span>
            <span class="string">'width'</span>,<span class="keyword">...</span>
            <span class="string">'height'</span>,<span class="keyword">...</span>
            <span class="string">'roiX0'</span>,<span class="keyword">...</span>
            <span class="string">'roiY0'</span>,<span class="keyword">...</span>
            <span class="string">'roi'</span>,<span class="keyword">...</span>
            <span class="string">'hROI'</span>,<span class="keyword">...</span>
            <span class="string">'intensityRange'</span>,<span class="keyword">...</span>
            <span class="string">'ctrsN'</span>};
        <span class="keyword">for</span> var = 1:numel(varList)
            setappdata(targetFig,varList{var},<span class="keyword">...</span>
                getappdata(srcFig,varList{var}))
        <span class="keyword">end</span> <span class="comment">%for</span>

    <span class="keyword">case</span> <span class="string">'merge'</span>
        varList = {<span class="keyword">...</span>
            <span class="string">'pxSize'</span>,<span class="keyword">...</span>
            <span class="string">'isScalebar'</span>,<span class="keyword">...</span>
            <span class="string">'micronBarLength'</span>,<span class="keyword">...</span>
            <span class="string">'isColormap'</span>,<span class="keyword">...</span>
            <span class="string">'colormapWidth'</span>,<span class="keyword">...</span>
            <span class="string">'isTimestamp'</span>,<span class="keyword">...</span>
            <span class="string">'timestampSize'</span>,<span class="keyword">...</span>
            <span class="string">'timestampInkrement'</span>,<span class="keyword">...</span>
            <span class="string">'exfNew'</span>,<span class="keyword">...</span>
            <span class="string">'rStep'</span>,<span class="keyword">...</span>
            <span class="string">'fps'</span>,<span class="keyword">...</span>
            <span class="string">'movCompression'</span>};
        <span class="keyword">for</span> var = 1:numel(varList)
            val = [];
            <span class="keyword">for</span> ch = 1:numel(srcFig)
                val(ch) =<span class="keyword">...</span>
                    getappdata(srcFig(ch),varList{var});
            <span class="keyword">end</span> <span class="comment">%for</span>
            <span class="keyword">if</span> isequal(val,circshift(val,[0 1]))
                setappdata(targetFig,varList{var},val(1))
            <span class="keyword">else</span>
                answer = inputdlg(<span class="keyword">...</span>
                    {sprintf(<span class="string">'%s not equal between Channels'</span>,varList{var})},<span class="keyword">...</span>
                    <span class="string">'set new Value'</span>);
                setappdata(targetFig,varList{var},str2double(answer{1}))
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%for</span>
<span class="keyword">end</span> <span class="comment">%switch</span>
<span class="keyword">end</span>
<span class="keyword">function</span> data = preprocessData(fig,returnValue,roi)
varNames = {<span class="string">'ctrsX'</span>, <span class="string">'ctrsY'</span>, <span class="string">'signal'</span>, <span class="string">'noise'</span>, <span class="string">'offset'</span>, <span class="string">'radius'</span>, <span class="string">'frame'</span>,<span class="keyword">...</span>
    <span class="string">'photons'</span>, <span class="string">'precision'</span>, <span class="string">'snr'</span>, <span class="string">'sbr'</span>, <span class="string">'cluster'</span>};

<span class="comment">%define data to load</span>
loadValue = returnValue(1:7);
<span class="keyword">if</span> returnValue(3); loadValue(6) = true; <span class="keyword">end</span>
<span class="keyword">if</span> returnValue(8); loadValue([3 6]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> returnValue(9); loadValue([3 4 6]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> returnValue(10); loadValue([3 4 6]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> returnValue(11); loadValue([3 5]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> returnValue(12) || getappdata(fig,<span class="string">'isThreshDensity'</span>);<span class="keyword">...</span>
        loadValue([1 2 6 7]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> getappdata(fig,<span class="string">'isThreshSNR'</span>) || getappdata(fig,<span class="string">'isThreshLocPrec'</span>);<span class="keyword">...</span>
        loadValue([3 4 6]) = true; <span class="keyword">end</span>
<span class="keyword">if</span> ~isempty(getappdata(fig,<span class="string">'hROI'</span>)); loadValue([1 2]) = true; <span class="keyword">end</span>

<span class="comment">%load data from disk</span>
<span class="keyword">for</span> value = find(loadValue(1,:))
    <span class="keyword">if</span> loadValue(1,value)
        fid = fopen([getappdata(fig,<span class="string">'pathname'</span>) getappdata(fig,<span class="string">'filename'</span>) <span class="string">'.'</span> varNames{value}], <span class="string">'r'</span>);
        <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'elements'</span>)) <span class="comment">%load complete list</span>
            data.(varNames{value}) = fread(fid,inf,<span class="string">'real*8'</span>);
        <span class="keyword">else</span>
            fseek(fid, getappdata(fig,<span class="string">'startPnt'</span>)*8, <span class="string">'bof'</span>);
            data.(varNames{value}) = fread(fid,getappdata(fig,<span class="string">'elements'</span>),<span class="string">'real*8'</span>);
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
    fclose(fid);
<span class="keyword">end</span> <span class="comment">%for</span>

<span class="comment">%remove points outside of ROI</span>
<span class="keyword">if</span> loadValue(1) &amp;&amp; loadValue(2)
    good =<span class="keyword">...</span>
        data.(varNames{1}) &gt; roi(1) &amp;<span class="keyword">...</span>
        data.(varNames{1}) &lt; roi(1)+roi(3) &amp;<span class="keyword">...</span>
        data.(varNames{2}) &gt; roi(2) &amp;<span class="keyword">...</span>
        data.(varNames{2}) &lt; roi(2)+roi(4);

    <span class="keyword">for</span> value = find(loadValue)
        data.(varNames{value}) = data.(varNames{value})(good);
    <span class="keyword">end</span> <span class="comment">%for</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="keyword">if</span> loadValue(3)
    <span class="comment">%volume [photons]</span>
    data.photons = data.(varNames{3})*2*pi.*data.(varNames{6}).^2/<span class="keyword">...</span>
        getappdata(fig,<span class="string">'cntsPerPhoton'</span>); <span class="comment">%[photons]</span>

    <span class="comment">%calculate loc. prec.</span>
    <span class="keyword">if</span> returnValue(9) || getappdata(fig,<span class="string">'isThreshLocPrec'</span>)
        data.precision = calcLocPrecision(<span class="keyword">...</span>
            data.radius, getappdata(fig,<span class="string">'pxSize'</span>),<span class="keyword">...</span>
            data.photons, data.(varNames{4})/getappdata(fig,<span class="string">'cntsPerPhoton'</span>)); <span class="comment">%[?m]</span>
    <span class="keyword">end</span> <span class="comment">%if</span>

    <span class="comment">%calculate snr</span>
    <span class="keyword">if</span> returnValue(10) || getappdata(fig,<span class="string">'isThreshSNR'</span>)
        data.snr = data.signal./data.noise;
    <span class="keyword">end</span> <span class="comment">%if</span>

    <span class="comment">%calculate sbr</span>
    <span class="keyword">if</span> returnValue(11)
        data.sbr = data.signal./data.offset;
    <span class="keyword">end</span> <span class="comment">%if</span>

    <span class="comment">%apply loc. prec. or snr threshold if selected</span>
    <span class="keyword">if</span> getappdata(fig,<span class="string">'isThreshLocPrec'</span>) || getappdata(fig,<span class="string">'isThreshSNR'</span>)
        <span class="keyword">if</span> getappdata(fig,<span class="string">'isThreshLocPrec'</span>) &amp;&amp; getappdata(fig,<span class="string">'isThreshSNR'</span>)
            good = data.precision &gt; getappdata(fig,<span class="string">'minLoc'</span>)/1000 &amp;<span class="keyword">...</span>
                data.precision &lt; getappdata(fig,<span class="string">'maxLoc'</span>)/1000 &amp;<span class="keyword">...</span>
                data.snr &gt; getappdata(fig,<span class="string">'minSNR'</span>) &amp;<span class="keyword">...</span>
                data.snr &lt; getappdata(fig,<span class="string">'maxSNR'</span>);
        <span class="keyword">elseif</span> getappdata(fig,<span class="string">'isThreshLocPrec'</span>) &amp;&amp; ~getappdata(fig,<span class="string">'isThreshSNR'</span>)
            good = data.precision &gt; getappdata(fig,<span class="string">'minLoc'</span>)/1000 &amp;<span class="keyword">...</span>
                data.precision &lt; getappdata(fig,<span class="string">'maxLoc'</span>)/1000;
        <span class="keyword">elseif</span> ~getappdata(fig,<span class="string">'isThreshLocPrec'</span>) &amp;&amp; getappdata(fig,<span class="string">'isThreshSNR'</span>)
            good = data.snr &gt; getappdata(fig,<span class="string">'minSNR'</span>) &amp;<span class="keyword">...</span>
                data.snr &lt; getappdata(fig,<span class="string">'maxSNR'</span>);
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">for</span> value = find([loadValue 0 0 0 0 0] | returnValue)
            <span class="keyword">if</span> isfield(data,(varNames{value}))
                data.(varNames{value}) = data.(varNames{value})(good);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%apply density threshold if selected</span>
<span class="keyword">if</span> getappdata(fig,<span class="string">'isThreshDensity'</span>) || returnValue(12)
    <span class="keyword">if</span> ~all([isappdata(fig,<span class="string">'clusterScore'</span>),<span class="keyword">...</span>
            isappdata(fig,<span class="string">'clusterRadius'</span>),<span class="keyword">...</span>
            isappdata(fig,<span class="string">'clusterWeights'</span>)])
        [data,tree,clusterScore,<span class="keyword">...</span>
            clusterRadius,clusterWeights] =<span class="keyword">...</span>
            densitybasedClustering(data);
        kdtree_delete(tree)

        setappdata(fig,<span class="string">'clusterScore'</span>,clusterScore)
        setappdata(fig,<span class="string">'clusterRadius'</span>,clusterRadius)
        setappdata(fig,<span class="string">'clusterWeights'</span>,clusterWeights)
        setappdata(fig,<span class="string">'cluster'</span>,data.cluster)

        <span class="keyword">for</span> value = find([loadValue 0 0 0 0 0] | returnValue)
            <span class="keyword">if</span> getappdata(fig,<span class="string">'clusterMode'</span>) == 1
                data.(varNames{value}) = data.(varNames{value})(data.cluster &gt; 0);
            <span class="keyword">else</span>
                data.(varNames{value}) = data.(varNames{value})(data.cluster == 0);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%for</span>
    <span class="keyword">else</span>
        cluster = getappdata(fig,<span class="string">'cluster'</span>);
        <span class="keyword">if</span> getappdata(fig,<span class="string">'startPnt'</span>) == 0
            startPnt = 1;
        <span class="keyword">else</span>
            startPnt = getappdata(fig,<span class="string">'startPnt'</span>);
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">if</span> isinf(getappdata(fig,<span class="string">'elements'</span>))
            good = startPnt:numel(cluster);
        <span class="keyword">else</span>
            good = startPnt:startPnt+getappdata(fig,<span class="string">'elements'</span>)-1;
        <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">for</span> value = find([loadValue 0 0 0 0 0] | returnValue)
            <span class="keyword">if</span> getappdata(fig,<span class="string">'clusterMode'</span>) == 1
                data.(varNames{value}) = data.(varNames{value})<span class="keyword">...</span>
                    (cluster(good) &gt; 0);
            <span class="keyword">else</span>
                data.(varNames{value}) = data.(varNames{value})<span class="keyword">...</span>
                    (cluster(good) == 0);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span> <span class="comment">%for</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%if</span>

<span class="comment">%remove unnecessary variables</span>
<span class="keyword">for</span> value = find(~returnValue);
    <span class="keyword">if</span> isfield(data,varNames{value})
        data = rmfield(data,varNames{value});
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%for</span>

    <span class="keyword">function</span> precision =<span class="keyword">...</span>
            calcLocPrecision(psfStd, pxSize, photons, noise)
        <span class="comment">%calculates the localization uncertainty based on</span>
        <span class="comment">%   psfStd, pxSize, photons, noise. (Thompson and Webb)</span>

        psfStd = psfStd*pxSize; <span class="comment">% px -&gt; ?m</span>
        precision = sqrt((psfStd.^2+pxSize^2/12)./photons+<span class="keyword">...</span>
            8*pi.*psfStd.^4.*noise.^2/pxSize^2./photons.^2); <span class="comment">%[?m]</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> exportSettings(src, event, visMode)
fig = gcbf;

[filename,pathname,isOK] =<span class="keyword">...</span>
    uiputfile(<span class="string">'.txt'</span> ,<span class="string">'Save to'</span>, getappdata(0,<span class="string">'searchPath'</span>));
<span class="keyword">if</span> isOK
    setappdata(0,<span class="string">'searchPath'</span>,pathname)
    fid = fopen([pathname filename], <span class="string">'wt'</span>);

    fprintf(fid, <span class="string">'Filename: %s \n'</span>,<span class="keyword">...</span>
        [getappdata(fig,<span class="string">'pathname'</span>) getappdata(fig,<span class="string">'filename'</span>) <span class="string">'.mat'</span>]);
    <span class="keyword">if</span> getappdata(fig,<span class="string">'isSuperstack'</span>)
        <span class="keyword">for</span> idx = 1:numel(getappdata(fig,<span class="string">'imageName'</span>))
            imageName = getappdata(fig,<span class="string">'imageName'</span>);
            fprintf(fid, <span class="string">'Imagename: %s \n'</span>, imageName{idx});
        <span class="keyword">end</span> <span class="comment">%for</span>
    <span class="keyword">else</span>
        fprintf(fid, <span class="string">'Imagename: %s \n'</span>, getappdata(fig,<span class="string">'imageName'</span>));
    <span class="keyword">end</span>
    fprintf(fid, <span class="string">'Created: %s \n'</span>, datestr(clock));

    fprintf(fid, <span class="string">'\n Optics Options: \n'</span>);
    fprintf(fid,<span class="string">'Pixelsize [?m] = %g \n'</span>, getappdata(fig,<span class="string">'pxSize'</span>));
    fprintf(fid,<span class="string">'Numerical Aperture = %g \n'</span>, getappdata(fig,<span class="string">'NA'</span>));
    fprintf(fid,<span class="string">'Emission Wavelength [nm] = %g \n'</span>, getappdata(fig,<span class="string">'emWvlnth'</span>));
    fprintf(fid,<span class="string">'PSF Scaling Factor = %g \n'</span>, getappdata(fig,<span class="string">'psfScale'</span>));
    fprintf(fid,<span class="string">'PSF [px] = %g \n'</span>, getappdata(fig,<span class="string">'psfStd'</span>));
    fprintf(fid,<span class="string">'Counts/Photon = %g \n'</span>, getappdata(fig,<span class="string">'cntsPerPhoton'</span>));

    fprintf(fid, <span class="string">'\n Localization Options: \n'</span>);
    fprintf(fid,<span class="string">'Framerange = %g to %g \n'</span>, getappdata(fig,<span class="string">'locStart'</span>), getappdata(fig,<span class="string">'locEnd'</span>));
    fprintf(fid,<span class="string">'ErrorRate [10^] = %g \n'</span>, getappdata(fig,<span class="string">'errorRate'</span>));
    fprintf(fid,<span class="string">'Detectionbox [px] = %g \n'</span>, getappdata(fig,<span class="string">'w2d'</span>));
    fprintf(fid,<span class="string">'# of Deflationloops = %g \n'</span>, getappdata(fig,<span class="string">'dfltnLoops'</span>));
    fprintf(fid,<span class="string">'Intensity Threshold [Photons] = %g \n'</span>, getappdata(fig,<span class="string">'minInt'</span>));

    fprintf(fid, <span class="string">'\n Rendering Options: \n'</span>);
    fprintf(fid,<span class="string">'Framerange = %g to %g \n'</span>, getappdata(fig,<span class="string">'rStart'</span>), getappdata(fig,<span class="string">'rEnd'</span>));
    fprintf(fid,<span class="string">'Expansion Factor = %g \n'</span>, getappdata(fig,<span class="string">'exfNew'</span>));
    <span class="keyword">switch</span> getappdata(fig,<span class="string">'convMode'</span>)
        <span class="keyword">case</span> 2
            fprintf(fid,<span class="string">'Rendering Method = dynamic convolution \n'</span>);
        <span class="keyword">case</span> 1
            fprintf(fid,<span class="string">'Rendering Method = fixed convolution \n'</span>);
    <span class="keyword">end</span> <span class="comment">%if</span>
    fprintf(fid,<span class="string">'Intensity Weighting Factor = %g \n'</span>, getappdata(fig,<span class="string">'intWeight'</span>));
    fprintf(fid,<span class="string">'Size Factor (times Loc. Prec.) = %g \n'</span>, getappdata(fig,<span class="string">'sizeFac'</span>));

    <span class="keyword">switch</span> visMode
        <span class="keyword">case</span> <span class="string">'Image'</span>
            fprintf(fid,<span class="string">'Visualization Method = Image \n'</span>);
        <span class="keyword">case</span> <span class="string">'Movie'</span>
            fprintf(fid,<span class="string">'Visualization Method = Movie \n'</span>);
            fprintf(fid,<span class="string">'Windowsize = %g \n'</span>, getappdata(fig,<span class="string">'rW'</span>));
            fprintf(fid,<span class="string">'Stepsize = %g \n'</span>, getappdata(fig,<span class="string">'rStep'</span>));
            fprintf(fid,<span class="string">'Frames/Second = %g \n'</span>, getappdata(fig,<span class="string">'fps'</span>));
            <span class="keyword">switch</span> getappdata(fig,<span class="string">'movCompression'</span>)
                <span class="keyword">case</span> 1
                    fprintf(fid,<span class="string">'Compression Algorithm = RLE \n'</span>);
                <span class="keyword">case</span> 2
                    fprintf(fid,<span class="string">'Compression Algorithm = MSVL \n'</span>);
                <span class="keyword">case</span> 3
                    fprintf(fid,<span class="string">'Compression Algorithm = no Compression \n'</span>);
            <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span> <span class="comment">%switch</span>

    fprintf(fid, <span class="string">'\n Filter Options: \n'</span>);
    fprintf(fid,<span class="string">'Localization Precision = %g \n'</span>,<span class="keyword">...</span>
        getappdata(fig,<span class="string">'isThreshLocPrec'</span>))
    fprintf(fid,<span class="string">'Filter Range = %g to %g \n'</span>,<span class="keyword">...</span>
        getappdata(fig,<span class="string">'minLoc'</span>), getappdata(fig,<span class="string">'maxLoc'</span>));

    fprintf(fid,<span class="string">'Signal to Noise Ratio = %g \n'</span>,<span class="keyword">...</span>
        getappdata(fig,<span class="string">'isThreshSNR'</span>))
    fprintf(fid,<span class="string">'Filter Range = %g to %g \n'</span>,<span class="keyword">...</span>
        getappdata(fig,<span class="string">'minSNR'</span>), getappdata(fig,<span class="string">'maxSNR'</span>));

    fclose(fid);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [data,tree,score,radius,sigma] = densitybasedClustering(data)
fig =<span class="keyword">...</span>
    figure(<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.1 0.2 0.8 0.6],<span class="keyword">...</span>
    <span class="string">'NumberTitle'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'MenuBar'</span>, <span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'ToolBar'</span>, <span class="string">'figure'</span>,<span class="keyword">...</span>
    <span class="string">'Resize'</span>, <span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'DockControls'</span>, <span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'Name'</span>, <span class="string">'Densitybased Clustering'</span>,<span class="keyword">...</span>
    <span class="string">'Renderer'</span>,<span class="string">'zbuffer'</span>,<span class="keyword">...</span>
    <span class="string">'Color'</span>, get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>));

<span class="comment">%customize toolbar</span>
hToolBar = findall(fig,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 10 13 14 15 16 17 18]))

ax(1) =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'OuterPosition'</span>, [0 0 0.7 1],<span class="keyword">...</span>
    <span class="string">'Box'</span>,<span class="string">'on'</span>);
ax(2) =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.69 0.84 0.3 0.08]);

ax(3) =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.69 0.7 0.3 0.08]);

ax(4) =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.69 0.56 0.3 0.08]);

ax(5) =<span class="keyword">...</span>
    axes(<span class="keyword">...</span>
    <span class="string">'Parent'</span>, fig,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.69 0.42 0.3 0.08]);


<span class="comment">% ax(4) =...</span>
<span class="comment">%     axes(...</span>
<span class="comment">%     'Parent', fig,...</span>
<span class="comment">%     'Units','normalized',...</span>
<span class="comment">%     'Position', [0.7 0.41 0.29 0.15],...</span>
<span class="comment">%     'XTickLabel','',...</span>
<span class="comment">%     'YTickLabel','');</span>


uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.7 0.26 0.1 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 13,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Scale(x,y,z):'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN scalex'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0.26 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN scaley'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.26 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN scalez'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.9 0.26 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'0.01'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'togglebutton'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.95 0.26 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'lock'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @lockScale);


uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'checkbox'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN isWeighted'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.7 0.21 0.3 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Value'</span>, 1,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">' Set 3D-Gaussian Weights:'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @activateWeights);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.7 0.16 0.15 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Sigma(x,y,z):'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN sigx'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.16 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN sigy'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.9 0.16 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN sigz'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.95 0.16 0.05 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);


uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.7 0.11 0.15 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'min Score:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN score'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.11 0.08 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1]);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.93 0.11 0.07 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'critical'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @evalCriticalScore);


uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.7 0.06 0.15 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'Search Radius:'</span>,<span class="keyword">...</span>
    <span class="string">'HorizontalAlignment'</span>, <span class="string">'left'</span>);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'edit'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN radius'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.85 0.06 0.08 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'1'</span>,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>);
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'popupmenu'</span>,<span class="keyword">...</span>
    <span class="string">'Tag'</span>, <span class="string">'DBSCAN units'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.93 0.06 0.07 0.05],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, {<span class="string">'px'</span>, <span class="string">'nm'</span>},<span class="keyword">...</span>
    <span class="string">'Value'</span>, 1,<span class="keyword">...</span>
    <span class="string">'BackgroundColor'</span>, [1 1 1],<span class="keyword">...</span>
    <span class="string">'Enable'</span>, <span class="string">'off'</span>);

uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.8 0 0.1 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'evaluate'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @evalDensity);
<span class="comment">% uicontrol(...</span>
<span class="comment">%     'Style', 'pushbutton',...</span>
<span class="comment">%     'Units','normalized',...</span>
<span class="comment">%     'Position', [0.8 0 0.1 0.06],...</span>
<span class="comment">%     'FontSize', 15,...</span>
<span class="comment">%     'FontUnits', 'normalized',...</span>
<span class="comment">%     'String', 'preview',...</span>
<span class="comment">%     'Callback', @showClusterPreview);</span>
uicontrol(<span class="keyword">...</span>
    <span class="string">'Style'</span>, <span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'Position'</span>, [0.9 0 0.1 0.06],<span class="keyword">...</span>
    <span class="string">'FontSize'</span>, 15,<span class="keyword">...</span>
    <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'String'</span>, <span class="string">'accept'</span>,<span class="keyword">...</span>
    <span class="string">'Callback'</span>, @accept);

pnts = numel(data.ctrsX);
rescaled = struct(<span class="string">'ctrsX'</span>,[],<span class="string">'ctrsY'</span>,[],<span class="string">'frame'</span>,[]);
drawnow
uiwait(fig)

    <span class="keyword">function</span> activateWeights(src,event)
        <span class="keyword">switch</span> get(src,<span class="string">'Value'</span>)
            <span class="keyword">case</span> 1
                set(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigx'</span>,<span class="keyword">...</span>
                    <span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigy'</span>,<span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigz'</span>),<span class="keyword">...</span>
                    <span class="string">'Enable'</span>,<span class="string">'on'</span>)
                set(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN radius'</span>,<span class="keyword">...</span>
                    <span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN units'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>)
            <span class="keyword">case</span> 0
                set(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigx'</span>,<span class="keyword">...</span>
                    <span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigy'</span>,<span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigz'</span>),<span class="keyword">...</span>
                    <span class="string">'Enable'</span>,<span class="string">'off'</span>)
                set(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN radius'</span>,<span class="keyword">...</span>
                    <span class="string">'-or'</span>,<span class="string">'Tag'</span>,<span class="string">'DBSCAN units'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>)
        <span class="keyword">end</span> <span class="comment">%switch</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> lockScale(src,event)
        hScaleX = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scalex'</span>);
        hScaleY = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scaley'</span>);
        hScaleZ = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scalez'</span>);

        <span class="keyword">if</span> get(src,<span class="string">'Value'</span>)
            cla(ax(1),<span class="string">'reset'</span>); set(ax(1),<span class="string">'UserData'</span>,[],<span class="string">'Box'</span>,<span class="string">'on'</span>)
            hMsg =<span class="keyword">...</span>
                text(0.5,0.5,<span class="keyword">...</span>
                {<span class="string">'Please wait...'</span>,<span class="keyword">...</span>
                <span class="string">'this may take approximatly'</span>,<span class="keyword">...</span>
                [num2str(2e-10*pnts^2.14,<span class="string">'%.0f'</span>) <span class="string">' seconds to finish'</span>],<span class="keyword">...</span>
                <span class="string">'(building kd-tree)'</span>},<span class="keyword">...</span>
                <span class="string">'Parent'</span>, ax(1),<span class="keyword">...</span>
                <span class="string">'Units'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'FontSize'</span>, 25,<span class="keyword">...</span>
                <span class="string">'FontUnits'</span>, <span class="string">'normalized'</span>,<span class="keyword">...</span>
                <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>);
            drawnow

            <span class="comment">%rescale data dimensions</span>
            rescaled.ctrsX = str2double(get(hScaleX,<span class="string">'String'</span>))*data.ctrsX;
            rescaled.ctrsY = str2double(get(hScaleY,<span class="string">'String'</span>))*data.ctrsY;
            rescaled.frame = str2double(get(hScaleZ,<span class="string">'String'</span>))*data.frame;

            set([hScaleX hScaleY hScaleZ],<span class="string">'Enable'</span>,<span class="string">'off'</span>)

            <span class="keyword">if</span> isappdata(fig,<span class="string">'tree'</span>)
                kdtree_delete(tree) <span class="comment">%free memory from old tree</span>
                rmappdata(fig,<span class="string">'tree'</span>)
            <span class="keyword">end</span> <span class="comment">%if</span>
            tree = kdtree_build([rescaled.ctrsX rescaled.ctrsY rescaled.frame]);
            setappdata(fig,<span class="string">'tree'</span>,tree)

            <span class="keyword">if</span> get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN isWeighted'</span>),<span class="string">'Value'</span>)
                sigma = [str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigx'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                    str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigy'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                    str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigz'</span>),<span class="string">'String'</span>))];
                radius = 3*max(sigma);
            <span class="keyword">else</span>
                sigma = [];
                radius = str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN radius'</span>),<span class="string">'String'</span>));
            <span class="keyword">end</span> <span class="comment">%if</span>

            delete(hMsg)
        <span class="keyword">else</span>
            set([hScaleX hScaleY hScaleZ],<span class="string">'Enable'</span>,<span class="string">'on'</span>)
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> evalDensity(src,event)
        <span class="keyword">if</span> get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN isWeighted'</span>),<span class="string">'Value'</span>)
            sigma = [str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigx'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigy'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigz'</span>),<span class="string">'String'</span>))];
            radius = 3*max(sigma);
        <span class="keyword">else</span>
            sigma = [];
            radius = str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN radius'</span>),<span class="string">'String'</span>));
        <span class="keyword">end</span> <span class="comment">%if</span>
        score = str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN score'</span>),<span class="string">'String'</span>));

        <span class="comment">%perform cluster analysis</span>
        tree = getappdata(fig,<span class="string">'tree'</span>);
        [data.cluster data.clusterClass data.densityScore] =<span class="keyword">...</span>
            dbscan(tree,rescaled.ctrsX,rescaled.ctrsY,<span class="keyword">...</span>
            rescaled.frame,score,radius,sigma);
        nBins = calcnbins(data.densityScore,<span class="string">'fd'</span>);

        clusterSize = accumarray(data.cluster+1,1);
        clusterScore = accumarray(data.cluster+1,data.densityScore);
        meanClusterScore = clusterScore./clusterSize;

        cla(ax(2))
        set(ax(2),<span class="string">'NextPlot'</span>,<span class="string">'add'</span>)
        [freq bin] = hist(clusterSize(2:end),nBins);
        bar(ax(2),bin,freq,<span class="string">'hist'</span>)
        <span class="keyword">try</span>
            fitHalfLife = fit(bin',freq',<span class="string">'exp1'</span>);
            y = feval(fitHalfLife,bin);
            hold <span class="string">on</span>
            plot(ax(2),bin,y,<span class="string">'Color'</span>,[1 0 0],<span class="string">'Linewidth'</span>,2)
            legend(ax(2),<span class="string">'Cluster Size'</span>,<span class="keyword">...</span>
                sprintf(<span class="string">'Average Life Time ~ %.0f'</span>,-1/fitHalfLife.b))
        <span class="keyword">catch</span>
            legend(ax(2),<span class="string">'Cluster Size'</span>)
        <span class="keyword">end</span>

        cla(ax(3))
        [freq bin] = hist(clusterScore,nBins);
        bar(ax(3),bin,freq,<span class="string">'hist'</span>)
        legend(ax(3),<span class="string">'Cluster Score'</span>)

        cla(ax(4))
        [freq bin] = hist(meanClusterScore,nBins);
        bar(ax(4),bin,freq,<span class="string">'hist'</span>)
        legend(ax(4),<span class="string">'Average Cluster Score'</span>)

        cla(ax(5))
        [freq bin] = hist(data.densityScore,nBins);
        bar(ax(5),bin,freq,<span class="string">'hist'</span>)
        legend(ax(5),<span class="string">'Point Score'</span>)


        title(ax(1),sprintf(<span class="string">'%d clusters (%.2f %%noise)'</span>,<span class="keyword">...</span>
            max(data.cluster),clusterSize(1)/pnts*100))

        <span class="comment">%plot result</span>
        <span class="keyword">if</span> isempty(get(ax(1),<span class="string">'UserData'</span>))
            hPatch = presentResult([]);
            set(ax(1),<span class="string">'UserData'</span>,hPatch)
        <span class="keyword">else</span>
            presentResult(get(ax(1),<span class="string">'UserData'</span>));
        <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="keyword">function</span> hPatch = presentResult(hPatch)
            <span class="keyword">if</span> isempty(hPatch)
                hScaleX = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scalex'</span>);
                hScaleY = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scaley'</span>);
                hScaleZ = findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN scalez'</span>);

                x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*<span class="keyword">...</span>
                    [rescaled.ctrsX,str2double(get(hScaleX,<span class="string">'String'</span>))*data.radius]';
                y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*<span class="keyword">...</span>
                    [rescaled.ctrsY,str2double(get(hScaleY,<span class="string">'String'</span>))*data.radius]';
                z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*<span class="keyword">...</span>
                    [rescaled.frame,str2double(get(hScaleZ,<span class="string">'String'</span>))*data.radius]';
                vertices = [x(:) y(:) z(:)];

                faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;<span class="keyword">...</span>
                    6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                face = faceIdx+face';

                color = [[1 1 1]; rand(max(data.cluster),3)];
                cIdx = reshape(repmat((data.cluster+1)',8,1),[1 8*pnts]);

                <span class="keyword">if</span> 1
                    hPatch = patch(<span class="string">'Faces'</span>,face(cIdx&gt;1,:),<span class="string">'Vertices'</span>,vertices,<span class="keyword">...</span>
                        <span class="string">'FaceVertexCData'</span>, color(cIdx(cIdx&gt;1),:),<span class="keyword">...</span>
                        <span class="string">'FaceColor'</span>, <span class="string">'flat'</span>,<span class="string">'UserData'</span>,face,<span class="string">'Parent'</span>,ax(1));
                <span class="keyword">else</span>
                    hPatch = patch(<span class="string">'Faces'</span>,face,<span class="string">'Vertices'</span>,vertices,<span class="keyword">...</span>
                        <span class="string">'FaceVertexCData'</span>, color(cIdx,:),<span class="keyword">...</span>
                        <span class="string">'FaceColor'</span>, <span class="string">'flat'</span>,<span class="string">'Parent'</span>, ax(1));
                <span class="keyword">end</span>

                view(ax(1),-37.5,30)
                axis (ax(1),<span class="string">'vis3d'</span>,<span class="string">'tight'</span>)
            <span class="keyword">else</span>
                color = [[1 1 1]; rand(max(data.cluster),3)];
                cIdx = reshape(repmat((data.cluster+1)',8,1),[1 8*pnts]);
                <span class="keyword">if</span> 1
                    face = get(hPatch,<span class="string">'UserData'</span>);
                    set(hPatch,<span class="string">'Faces'</span>,face(cIdx&gt;1,:),<span class="keyword">...</span>
                        <span class="string">'FaceVertexCData'</span>, color(cIdx(cIdx&gt;1),:));
                <span class="keyword">else</span>
                    set(hPatch,<span class="string">'FaceVertexCData'</span>, color(cIdx,:))
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">function</span> accept(src, event)
        <span class="keyword">if</span> isappdata(fig,<span class="string">'tree'</span>)
            kdtree_delete(tree) <span class="comment">%free memory from tree</span>
            rmappdata(fig,<span class="string">'tree'</span>)
        <span class="keyword">end</span> <span class="comment">%if</span>

        delete(gcbf)
    <span class="keyword">end</span>
    <span class="keyword">function</span> evalCriticalScore(src,event)
        samplesize = pnts;
        range = [min(data.ctrsX) max(data.ctrsX)<span class="keyword">...</span>
            min(data.ctrsY) max(data.ctrsY)<span class="keyword">...</span>
            min(data.frame) max(data.frame)];

        vals = inputdlg(<span class="keyword">...</span>
            {<span class="string">'# Monte Carlo Simulations'</span>,<span class="keyword">...</span>
            <span class="string">'Significance Level (alpha)'</span>},<span class="keyword">...</span>
            <span class="string">'Settings'</span>,<span class="keyword">...</span>
            1,<span class="keyword">...</span>
            {<span class="string">'10'</span>,<span class="string">'0.001'</span>});

        <span class="keyword">if</span> get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN isWeighted'</span>),<span class="string">'Value'</span>)
            sigma = [str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigx'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigy'</span>),<span class="string">'String'</span>)),<span class="keyword">...</span>
                str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN sigz'</span>),<span class="string">'String'</span>))];
            radius = 3*max(sigma);
        <span class="keyword">else</span>
            sigma = [];
            radius = str2double(get(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN radius'</span>),<span class="string">'String'</span>));
        <span class="keyword">end</span> <span class="comment">%if</span>


        estimateCriticalScore(<span class="keyword">...</span>
            [],[],str2double(vals{2}),samplesize,<span class="keyword">...</span>
            range,str2double(vals{1}),sigma,radius);

        <span class="keyword">function</span> criticalScore =<span class="keyword">...</span>
                estimateCriticalScore(<span class="keyword">...</span>
                tree,data,alpha,samplesize,range,iter,sigma,radius)
            <span class="keyword">if</span> isempty(tree)
                auto = 1;
            <span class="keyword">end</span> <span class="comment">%if</span>

            criticalScore = nan(iter,1);
            <span class="keyword">for</span> test = 1:iter
                testpoints = [unifrnd(range(1),range(2),[samplesize 1])<span class="keyword">...</span>
                    unifrnd(range(3),range(4),[samplesize 1])<span class="keyword">...</span>
                    round(unifrnd(range(5),range(6),[samplesize,1]))];
                <span class="keyword">if</span> auto
                    tree = kdtree_build(testpoints);
                    data.ctrsX = testpoints(:,1);
                    data.ctrsY = testpoints(:,2);
                    data.frame = testpoints(:,3);
                <span class="keyword">end</span> <span class="comment">%if</span>

                <span class="keyword">if</span> isempty(sigma)
                    applyWeight = false;
                <span class="keyword">else</span>
                    applyWeight = true;
                <span class="keyword">end</span> <span class="comment">%if</span>

                <span class="keyword">for</span> p = 1:samplesize
                    ref = testpoints(p,:);
                    iNN = kdtree_ball_query(tree, ref, radius);
                    iNN(iNN == p) = [];
                    <span class="keyword">if</span> applyWeight
                        score(p) = nansum(<span class="keyword">...</span>
                            exp(-((data.ctrsX(iNN)-ref(1)).^2/2/sigma(1)+<span class="keyword">...</span>
                            (data.ctrsY(iNN)-ref(2)).^2/2/sigma(2)+<span class="keyword">...</span>
                            (data.frame(iNN)-ref(3)).^2/2/sigma(3))));
                    <span class="keyword">else</span>
                        score(p) = numel(iNN);
                    <span class="keyword">end</span> <span class="comment">%if</span>
                <span class="keyword">end</span> <span class="comment">%for</span>
                [pScore score] = ecdf(score);
                criticalScore(test) = score(find(pScore &gt;= 1-alpha, 1, <span class="string">'first'</span>));
            <span class="keyword">end</span> <span class="comment">%for</span>
            criticalScore = mean(criticalScore);
            set(findobj(fig,<span class="string">'Tag'</span>,<span class="string">'DBSCAN score'</span>),<span class="string">'String'</span>, criticalScore)
        <span class="keyword">end</span>
    <span class="keyword">end</span>

<span class="keyword">end</span>
<span class="keyword">function</span> [clusterID pntClass pntScore] = dbscan(tree,x,y,t,criticalScore,radius,sigma)
<span class="comment">%DBSCAN (Density-Based Spatial Clustering of Applications with Noise)</span>
<span class="comment">%is a data clustering algorithm proposed by Martin Ester, Hans-Peter Kriegel,</span>
<span class="comment">%J?rg Sander and Xiaowei Xu in 1996.</span>

<span class="comment">%written by C.P.Richter, 2010.10.25</span>
<span class="keyword">if</span> isempty(sigma)
    applyWeight = false;
<span class="keyword">else</span>
    applyWeight = true;
<span class="keyword">end</span> <span class="comment">%if</span>

pnts = sum(isfinite(x));
clusterID = nan(pnts,1); <span class="comment">%unclassified</span>
pntClass = zeros(pnts,1);
pntScore = clusterID;

cluster = 1;
<span class="keyword">for</span> idx = 1:pnts
    pnt = [x(idx,:) y(idx,:) t(idx,:)];
    <span class="keyword">if</span> isnan(clusterID(idx))
        output = expandCluster;
        <span class="keyword">if</span> output
            cluster = cluster+1;
        <span class="keyword">end</span> <span class="comment">%if</span>
    <span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span> <span class="comment">%for</span>

pntClass(pntClass &lt; 0 &amp; clusterID &gt; 0) = 0;

    <span class="keyword">function</span> output = expandCluster
        [iNN score] = findNeighbors(pnt);
        pntScore(idx) = score;

        <span class="keyword">if</span> score &lt; criticalScore
            output = false;
            clusterID(idx) = 0;
            pntClass(idx) = -1; <span class="comment">%noise</span>

            <span class="keyword">return</span>
        <span class="keyword">else</span>
            output = true;
            clusterID(iNN) = cluster;
            pntClass(idx) = 1; <span class="comment">%core point</span>

            iNN(iNN == idx) = [];
            seeds = [x(iNN) y(iNN) t(iNN) iNN];
            <span class="keyword">while</span> ~isempty(seeds)
                [iNN score] = findNeighbors(seeds(1,1:3));
                pntScore(seeds(1,4)) = score;
                <span class="keyword">if</span> score &gt;= criticalScore <span class="comment">%core point</span>
                    pntClass(seeds(1,4)) = 1; <span class="comment">%core point</span>

                    iNN(iNN == seeds(1,4)) = [];
                    result = [x(iNN) y(iNN) t(iNN) iNN];
                    <span class="comment">%check if points are already assigned to a cluster</span>
                    <span class="comment">%                     good = isnan(clusterID(iNN));</span>
                    <span class="comment">%                     seeds = [seeds; result(good,:)];</span>
                    <span class="comment">%                     clusterID(good) = cluster;</span>
                    <span class="keyword">for</span> N = 1:numel(iNN)
                        <span class="keyword">if</span> isnan(clusterID(iNN(N)))
                            seeds(end+1,:) = result(N,:);
                            clusterID(iNN(N)) = cluster;
                        <span class="keyword">end</span> <span class="comment">%if</span>
                    <span class="keyword">end</span> <span class="comment">%for</span>
                <span class="keyword">end</span> <span class="comment">%if</span>
                seeds(1,:) = [];
            <span class="keyword">end</span> <span class="comment">%while</span>
        <span class="keyword">end</span> <span class="comment">%if</span>

        <span class="keyword">function</span> [iNN score] = findNeighbors(ref)

            iNN = kdtree_ball_query(tree, ref, radius);
            <span class="keyword">if</span> applyWeight
                score = nansum(<span class="keyword">...</span>
                    exp(-((x(iNN)-ref(1)).^2/2/sigma(1)+<span class="keyword">...</span>
                    (y(iNN)-ref(2)).^2/2/sigma(2)+<span class="keyword">...</span>
                    (t(iNN)-ref(3)).^2/2/sigma(3))))-1;
            <span class="keyword">else</span>
                score = numel(iNN);
            <span class="keyword">end</span> <span class="comment">%if</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> changeCheckMode(src, event)
<span class="keyword">if</span> strcmp(get(src, <span class="string">'Checked'</span>),<span class="string">'on'</span>)
    set(src, <span class="string">'Checked'</span>, <span class="string">'off'</span>)
<span class="keyword">else</span>
    hList = allchild(get(src, <span class="string">'Parent'</span>));
    set(hList, <span class="string">'Checked'</span>, <span class="string">'off'</span>)
    set(src, <span class="string">'Checked'</span>, <span class="string">'on'</span>)
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> psf = buildPSF(sig, xw, yw)
psf = zeros(yw,xw);
w = ceil(6*sig); <span class="comment">% 99% of gaussian</span>
x = floor(xw/2-w/2);
y = floor(yw/2-w/2);
[X Y] = meshgrid(-w/2:w/2);
psf(y:y+w,x:x+w) = 1/(2*pi*sig^2)*<span class="keyword">...</span>
    exp(-(X.^2+Y.^2)/(2*sig^2));
psf = fft2(psf); <span class="comment">%translate to frequency space</span>
<span class="keyword">end</span>
<span class="keyword">function</span> [ax, h] = buildHistogram(ax,data,unit)
[freq(:,1), ctrs] = ksdensity(data,<span class="keyword">...</span>
    <span class="string">'npoints'</span>,calcnbins(data,<span class="string">'fd'</span>),<span class="keyword">...</span>
    <span class="string">'function'</span>, <span class="string">'cdf'</span>);
freq(:,2) = hist(data,ctrs);

[ax, h(1) h(2)] = <span class="keyword">...</span>
    plotyy(ax,ctrs,freq(:,2),ctrs,freq(:,1),<span class="string">'bar'</span>,<span class="string">'plot'</span>);
set(ax,<span class="string">'FontSize'</span>,20)
ylabel(ax(1),<span class="string">'Frequency'</span>)
ylabel(ax(2),<span class="string">'Cumulative Probability'</span>)
set(h(2),<span class="string">'color'</span>,<span class="string">'r'</span>,<span class="string">'linewidth'</span>, 3)

legend({sprintf([<span class="string">'\t min = %.0f '</span> unit<span class="keyword">...</span>
    <span class="string">' \n max = %.0f '</span> unit<span class="keyword">...</span>
    <span class="string">'\n mean = %.0f '</span> unit<span class="keyword">...</span>
    <span class="string">' \n std = %.0f'</span> unit],<span class="keyword">...</span>
    min(ctrs),max(ctrs),mean(ctrs),std(ctrs)),<span class="string">'CDF'</span>})

axis(ax(1), [min(ctrs) max(ctrs) min(freq(:,2)) max(freq(:,2))])
axis(ax(2), [min(ctrs) max(ctrs) min(freq(:,1)) max(freq(:,1))])
<span class="keyword">end</span>
<span class="keyword">function</span> string = pxChars(N,M,num,scaleFactor) <span class="comment">%#ok</span>
n_ = [<span class="keyword">...</span>
    0 0;<span class="keyword">...</span>
    0 0;<span class="keyword">...</span>
    0 0;<span class="keyword">...</span>
    0 0;<span class="keyword">...</span>
    0 0] ;<span class="comment">%#ok</span>

np = [<span class="keyword">...</span>
    0;<span class="keyword">...</span>
    0;<span class="keyword">...</span>
    0;<span class="keyword">...</span>
    0;<span class="keyword">...</span>
    1] ;<span class="comment">%#ok</span>

n0 = [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n1 = [<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0] ;<span class="comment">%#ok</span>
n2= [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1 ;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 0;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n3= [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1 ;<span class="keyword">...</span>
    0 1 1;<span class="keyword">...</span>
    0 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n4= [<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 0 1 ;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1;<span class="keyword">...</span>
    0 0 1] ;<span class="comment">%#ok</span>
n5 = [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 0;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n6= [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 0 ;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n7 = [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    0 1 0] ;<span class="comment">%#ok</span>
n8 = [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>
n9 = [<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 1 1;<span class="keyword">...</span>
    0 0 1;<span class="keyword">...</span>
    1 1 1] ;<span class="comment">%#ok</span>

nA = [<span class="keyword">...</span>
    0 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nB = [<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 0] ;<span class="comment">%#ok</span>

nC = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nD = [<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 0] ;<span class="comment">%#ok</span>

nE = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nF = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0] ;<span class="comment">%#ok</span>

nG = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 1 1 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nH = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nI = [<span class="keyword">...</span>
    0 1 1 1 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 1 1 1 0] ;<span class="comment">%#ok</span>

nJ = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    0 0 0 0 1;<span class="keyword">...</span>
    0 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 1 1 0] ;<span class="comment">%#ok</span>

nK = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 1 0;<span class="keyword">...</span>
    1 1 1 0 0;<span class="keyword">...</span>
    1 0 0 1 0;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nL = [<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nM = [<span class="keyword">...</span>
    1 1 0 1 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nN = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 0 0 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 0 1 1;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nO = [<span class="keyword">...</span>
    0 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 1 1 0] ;<span class="comment">%#ok</span>

nP = [<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 0 0 0 0] ;<span class="comment">%#ok</span>

nQ = [<span class="keyword">...</span>
    0 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 0 1 0;<span class="keyword">...</span>
    0 1 1 0 1] ;<span class="comment">%#ok</span>

nR = [<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 0;<span class="keyword">...</span>
    1 0 0 1 0;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nS = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    1 0 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    0 0 0 0 1;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nT = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0] ;<span class="comment">%#ok</span>

nU = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 1 1 0] ;<span class="comment">%#ok</span>

nV = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 0 1 0;<span class="keyword">...</span>
    0 0 1 0 0] ;<span class="comment">%#ok</span>

nW = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    0 1 0 1 0] ;<span class="comment">%#ok</span>

nX = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 0 1 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 1 0 1 0;<span class="keyword">...</span>
    1 0 0 0 1] ;<span class="comment">%#ok</span>

nY = [<span class="keyword">...</span>
    1 0 0 0 1;<span class="keyword">...</span>
    0 1 0 1 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 0 1 0 0] ;<span class="comment">%#ok</span>

nZ = [<span class="keyword">...</span>
    1 1 1 1 1;<span class="keyword">...</span>
    0 0 0 1 0;<span class="keyword">...</span>
    0 0 1 0 0;<span class="keyword">...</span>
    0 1 0 0 0;<span class="keyword">...</span>
    1 1 1 1 1] ;<span class="comment">%#ok</span>

nm = [<span class="keyword">...</span>
    0 0 0 0 0;<span class="keyword">...</span>
    0 0 0 0 0;<span class="keyword">...</span>
    0 1 0 1 0;<span class="keyword">...</span>
    1 0 1 0 1;<span class="keyword">...</span>
    1 0 1 0 1] ;<span class="comment">%#ok</span>

nn = [<span class="keyword">...</span>
    0 0 0;<span class="keyword">...</span>
    0 0 0;<span class="keyword">...</span>
    0 1 0;<span class="keyword">...</span>
    1 0 1;<span class="keyword">...</span>
    1 0 1] ;<span class="comment">%#ok</span>

strnum = num2str(num) ;


string = eval(sprintf(<span class="string">'imresize(n%s,scaleFactor)&gt;0.5;'</span>, strnum(1)));
<span class="keyword">for</span> c=2:size(strnum, 2)
    string = [string, zeros(5*scaleFactor,1),<span class="keyword">...</span>
        eval(sprintf(<span class="string">'imresize(n%s,scaleFactor)&gt;0.5;'</span>, strnum(c)))];
<span class="keyword">end</span><span class="comment">%for</span>
<span class="keyword">end</span><span class="comment">%function</span>
<span class="keyword">function</span> pos = figPos(ratio)
scrSize = get(0, <span class="string">'ScreenSize'</span>);
<span class="keyword">if</span> ratio &gt; 1
    pos = [0.3 0.09<span class="keyword">...</span>
        0.65*scrSize(4)/scrSize(3) 0.65/ratio];
<span class="keyword">elseif</span> ratio &lt; 1
    pos = [0.3 0.09<span class="keyword">...</span>
        0.65*scrSize(4)/scrSize(3)*ratio 0.65];
<span class="keyword">else</span>
    pos = [0.3 0.09<span class="keyword">...</span>
        0.65*scrSize(4)/scrSize(3) 0.65];
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
<span class="keyword">function</span> nbins = calcnbins(x, method, minimum, maximum)
<span class="comment">% Calculate the "ideal" number of bins to use in a histogram, using a</span>
<span class="comment">% choice of methods.</span>
<span class="comment">%</span>
<span class="comment">% NBINS = CALCNBINS(X, METHOD) calculates the "ideal" number of bins to use</span>
<span class="comment">% in a histogram, using a choice of methods.  The type of return value</span>
<span class="comment">% depends upon the method chosen.  Possible values for METHOD are:</span>
<span class="comment">% 'fd': A single integer is returned, and CALCNBINS uses the</span>
<span class="comment">% Freedman-Diaconis method,</span>
<span class="comment">% based upon the inter-quartile range and number of data.</span>
<span class="comment">% See Freedman, David; Diaconis, P. (1981). "On the histogram as a density</span>
<span class="comment">% estimator: L2 theory". Zeitschrift f?r Wahrscheinlichkeitstheorie und</span>
<span class="comment">% verwandte Gebiete 57 (4): 453-476.</span>

<span class="comment">% 'scott': A single integer is returned, and CALCNBINS uses Scott's method,</span>
<span class="comment">% based upon the sample standard deviation and number of data.</span>
<span class="comment">% See Scott, David W. (1979). "On optimal and data-based histograms".</span>
<span class="comment">% Biometrika 66 (3): 605-610.</span>
<span class="comment">%</span>
<span class="comment">% 'sturges': A single integer is returned, and CALCNBINS uses Sturges'</span>
<span class="comment">% method, based upon the number of data.</span>
<span class="comment">% See Sturges, H. A. (1926). "The choice of a class interval". J. American</span>
<span class="comment">% Statistical Association: 65-66.</span>
<span class="comment">%</span>
<span class="comment">% 'middle': A single integer is returned.  CALCNBINS uses all three</span>
<span class="comment">% methods, then picks the middle (median) value.</span>
<span class="comment">%</span>
<span class="comment">% 'all': A structure is returned with fields 'fd', 'scott' and 'sturges',</span>
<span class="comment">% each containing the calculation from the respective method.</span>
<span class="comment">%</span>
<span class="comment">% NBINS = CALCNBINS(X) works as NBINS = CALCNBINS(X, 'MIDDLE').</span>
<span class="comment">%</span>
<span class="comment">% NBINS = CALCNBINS(X, [], MINIMUM), where MINIMUM is a numeric scalar,</span>
<span class="comment">% defines the smallest acceptable number of bins.</span>
<span class="comment">%</span>
<span class="comment">% NBINS = CALCNBINS(X, [], MAXIMUM), where MAXIMUM is a numeric scalar,</span>
<span class="comment">% defines the largest acceptable number of bins.</span>
<span class="comment">%</span>
<span class="comment">% Notes:</span>
<span class="comment">% 1. If X is complex, any imaginary components will be ignored, with a</span>
<span class="comment">% warning.</span>
<span class="comment">%</span>
<span class="comment">% 2. If X is an matrix or multidimensional array, it will be coerced to a</span>
<span class="comment">% vector, with a warning.</span>
<span class="comment">%</span>
<span class="comment">% 3. Partial name matching is used on the method name, so 'st' matches</span>
<span class="comment">% sturges, etc.</span>
<span class="comment">%</span>
<span class="comment">% 4. This function is inspired by code from the free software package R</span>
<span class="comment">% (http://www.r-project.org).  See 'Modern Applied Statistics with S' by</span>
<span class="comment">% Venables &amp; Ripley (Springer, 2002, p112) for more information.</span>
<span class="comment">%</span>
<span class="comment">% 5. The "ideal" number of depends on what you want to show, and none of</span>
<span class="comment">% the methods included are as good as the human eye.  It is recommended</span>
<span class="comment">% that you use this function as a starting point rather than a definitive</span>
<span class="comment">% guide.</span>
<span class="comment">%</span>
<span class="comment">% 6. The wikipedia page on histograms currently gives a reasonable</span>
<span class="comment">% description of the algorithms used.</span>
<span class="comment">% See http://en.wikipedia.org/w/index.php?title=Histogram&amp;oldid=232222820</span>
<span class="comment">%</span>
<span class="comment">% Examples:</span>
<span class="comment">% y = randn(10000,1);</span>
<span class="comment">% nb = calcnbins(y, 'all')</span>
<span class="comment">%    nb =</span>
<span class="comment">%             fd: 66</span>
<span class="comment">%          scott: 51</span>
<span class="comment">%        sturges: 15</span>
<span class="comment">% calcnbins(y)</span>
<span class="comment">%    ans =</span>
<span class="comment">%        51</span>
<span class="comment">% subplot(3, 1, 1); hist(y, nb.fd);</span>
<span class="comment">% subplot(3, 1, 2); hist(y, nb.scott);</span>
<span class="comment">% subplot(3, 1, 3); hist(y, nb.sturges);</span>
<span class="comment">% y2 = rand(100,1);</span>
<span class="comment">% nb2 = calcnbins(y2, 'all')</span>
<span class="comment">%    nb2 =</span>
<span class="comment">%             fd: 5</span>
<span class="comment">%          scott: 5</span>
<span class="comment">%        sturges: 8</span>
<span class="comment">% hist(y2, calcnbins(y2))</span>
<span class="comment">%</span>
<span class="comment">% See also: HIST, HISTX</span>
<span class="comment">%</span>
<span class="comment">% $ Author: Richard Cotton $		$ Date: 2008/10/24 $    $ Version 1.5 $</span>

<span class="comment">% Input checking</span>
error(nargchk(1, 4, nargin));

<span class="keyword">if</span> ~isnumeric(x) &amp;&amp; ~islogical(x)
    error(<span class="string">'calcnbins:invalidX'</span>, <span class="string">'The X argument must be numeric or logical.'</span>)
<span class="keyword">end</span>

<span class="keyword">if</span> ~isreal(x)
    x = real(x);
    warning(<span class="string">'calcnbins:complexX'</span>, <span class="string">'Imaginary parts of X will be ignored.'</span>);
<span class="keyword">end</span>

<span class="comment">% Ignore dimensions of x.</span>
<span class="keyword">if</span> ~isvector(x)
    x = x(:);
    warning(<span class="string">'calcnbins:nonvectorX'</span>, <span class="string">'X will be coerced to a vector.'</span>);
<span class="keyword">end</span>

nanx = isnan(x);
<span class="keyword">if</span> any(nanx)
    x = x(~nanx);
    warning(<span class="string">'calcnbins:nanX'</span>, <span class="string">'Values of X equal to NaN will be ignored.'</span>);
<span class="keyword">end</span>

<span class="keyword">if</span> nargin &lt; 2 || isempty(method)
    method = <span class="string">'middle'</span>;
<span class="keyword">end</span>

<span class="keyword">if</span> ~ischar(method)
    error(<span class="string">'calcnbins:invalidMethod'</span>, <span class="string">'The method argument must be a char array.'</span>);
<span class="keyword">end</span>

validmethods = {<span class="string">'fd'</span>; <span class="string">'scott'</span>; <span class="string">'sturges'</span>; <span class="string">'all'</span>; <span class="string">'middle'</span>};
methodmatches = strmatch(lower(method), validmethods);
nmatches = length(methodmatches);
<span class="keyword">if</span> nmatches~=1
    error(<span class="string">'calnbins:unknownMethod'</span>, <span class="string">'The method specified is unknown or ambiguous.'</span>);
<span class="keyword">end</span>
method = validmethods{methodmatches};

<span class="keyword">if</span> nargin &lt; 3 || isempty(minimum)
    minimum = 1;
<span class="keyword">end</span>

<span class="keyword">if</span> nargin &lt; 4 || isempty(maximum)
    maximum = Inf;
<span class="keyword">end</span>

<span class="comment">% Perform the calculation</span>
<span class="keyword">switch</span>(method)
    <span class="keyword">case</span> <span class="string">'fd'</span>
        nbins = calcfd(x);
    <span class="keyword">case</span> <span class="string">'scott'</span>
        nbins = calcscott(x);
    <span class="keyword">case</span> <span class="string">'sturges'</span>
        nbins = calcsturges(x);
    <span class="keyword">case</span> <span class="string">'all'</span>
        nbins.fd = calcfd(x);
        nbins.scott = calcscott(x);
        nbins.sturges = calcsturges(x);
    <span class="keyword">case</span> <span class="string">'middle'</span>
        nbins = median([calcfd(x) calcscott(x) calcsturges(x)]);
<span class="keyword">end</span>

<span class="comment">% Calculation details</span>
    <span class="keyword">function</span> nbins = calcfd(x)
        h = diff(prctile0(x, [25; 75])); <span class="comment">%inter-quartile range</span>
        <span class="keyword">if</span> h == 0
            h = 2*median(abs(x-median(x))); <span class="comment">%twice median absolute deviation</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> h &gt; 0
            nbins = ceil((max(x)-min(x))/(2*h*length(x)^(-1/3)));
        <span class="keyword">else</span>
            nbins = 1;
        <span class="keyword">end</span>
        nbins = confine2range(nbins, minimum, maximum);
    <span class="keyword">end</span>

    <span class="keyword">function</span> nbins = calcscott(x)
        h = 3.5*std(x)*length(x)^(-1/3);
        <span class="keyword">if</span> h &gt; 0
            nbins = ceil((max(x)-min(x))/h);
        <span class="keyword">else</span>
            nbins = 1;
        <span class="keyword">end</span>
        nbins = confine2range(nbins, minimum, maximum);
    <span class="keyword">end</span>

    <span class="keyword">function</span> nbins = calcsturges(x)
        nbins = ceil(log2(length(x)) + 1);
        nbins = confine2range(nbins, minimum, maximum);
    <span class="keyword">end</span>

    <span class="keyword">function</span> y = confine2range(x, lower, upper)
        y = ceil(max(x, lower));
        y = floor(min(y, upper));
    <span class="keyword">end</span>


    <span class="keyword">function</span> y = prctile0(x, prc)
        <span class="comment">% Simple version of prctile that only operates on vectors, and skips</span>
        <span class="comment">% the input checking (In particluar, NaN values are now assumed to</span>
        <span class="comment">% have been removed.)</span>
        lenx = length(x);
        <span class="keyword">if</span> lenx == 0
            y = [];
            <span class="keyword">return</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> lenx == 1
            y = x;
            <span class="keyword">return</span>
        <span class="keyword">end</span>

        <span class="keyword">function</span> foo = makecolumnvector(foo)
            <span class="keyword">if</span> size(foo, 2) &gt; 1
                foo = foo';
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        sortx = makecolumnvector(sort(x));
        posn = prc.*lenx/100 + 0.5;
        posn = makecolumnvector(posn);
        posn = confine2range(posn, 1, lenx);
        y = interp1q((1:lenx)', sortx, posn);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">function</span> [filenameNew, pathnameNew, flag] =<span class="keyword">...</span>
    checkNameExistance(filename, pathname)
<span class="keyword">if</span> exist([pathname filename],<span class="string">'file'</span>)
    answer = questdlg(<span class="keyword">...</span>
        <span class="string">'Do you want to override existing File?'</span>, <span class="keyword">...</span>
        <span class="string">'Warning'</span>, <span class="keyword">...</span>
        <span class="string">'Yes'</span>, <span class="string">'No'</span>, <span class="string">'No'</span>);
    <span class="keyword">switch</span> answer
        <span class="keyword">case</span> <span class="string">'Yes'</span> <span class="comment">%data will be replaced</span>
            setappdata(0, <span class="string">'searchPath'</span>, pathname)
            delete([pathname filename <span class="string">'.*'</span>])

            pathnameNew = pathname;
            filenameNew = filename;
            flag = 0;
        <span class="keyword">case</span> <span class="string">'No'</span>
            <span class="comment">%loop until unoccupied filename is selected</span>
            <span class="keyword">while</span> 1
                [filename,pathname,isOK] =<span class="keyword">...</span>
                    uiputfile(<span class="string">''</span>,<span class="string">'Save to'</span>,<span class="keyword">...</span>
                    [getappdata(0,<span class="string">'searchPath'</span>) filename]);
                <span class="keyword">if</span> isOK &amp;&amp; ~exist([pathname filename],<span class="string">'file'</span>)
                    setappdata(0, <span class="string">'searchPath'</span>, pathname)

                    pathnameNew = pathname;
                    filenameNew = filename;
                    flag = 0;
                    <span class="keyword">break</span>
                <span class="keyword">elseif</span> ~isOK
                    <span class="comment">%abort file saving</span>
                    flag = 1;
                <span class="keyword">end</span> <span class="comment">%if</span>
            <span class="keyword">end</span> <span class="comment">%while</span>
    <span class="keyword">end</span> <span class="comment">%switch</span>
<span class="keyword">else</span>
    pathnameNew = pathname;
    filenameNew = filename;
    flag = 0;
<span class="keyword">end</span> <span class="comment">%if</span>
<span class="keyword">end</span>
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.12<br></p></div><!--
##### SOURCE BEGIN #####
function SLIMfast
dbstop if error
%FRONTPAGE
figure(...
    'Tag', 'root',...
    'Units','normalized',...
    'Position', [0.4 0.9 0.2 eps],...
    'Color', get(0,'defaultUicontrolBackgroundColor'),...
    'Name', 'SLIMfast Build 1.103e',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'none',...
    'Resize', 'off');

h.menuDataLoad =...
    uimenu(...
    'Label', 'Load');
uimenu(...
    'Parent', h.menuDataLoad,...
    'Label', 'Imagestack',...
    'Callback', @loadData);
uimenu(...
    'Parent', h.menuDataLoad,...
    'Label', 'Superstack',...
    'Callback', @loadData);
uimenu(...
    'Parent', h.menuDataLoad,...
    'Label', 'Batch',...
    'Callback', @batchLocalization);

h.menuDataLoadParCoords =...
    uimenu(...
    'Parent', h.menuDataLoad,...
    'Label', 'Particle Data',...
    'Separator', 'on');
uimenu(...
    'Parent', h.menuDataLoadParCoords,...
    'Label', 'SLIMfast',...
    'Callback', @loadData);
uimenu(...
    'Parent', h.menuDataLoadParCoords,...
    'Label', 'FPALM',...
    'Callback', @loadData,...
    'Enable', 'off');
uimenu(...
    'Parent', h.menuDataLoad,...
    'Label', 'Tracking Data',...
    'Callback', @loadData);

h.menuImageChannels =...
    uimenu(...
    'Label', 'Channels');
h.menuDataMode =...
    uimenu(...
    'Parent', h.menuImageChannels,...
    'Label', 'Mode');
uimenu(...
    'Parent', h.menuDataMode,...
    'Label', 'monoView',...
    'Checked', 'on',...
    'Callback', @mergeChannels);
uimenu(...
    'Parent', h.menuDataMode,...
    'Label', 'dualView',...
    'Callback', @mergeChannels);
uimenu(...
    'Parent', h.menuDataMode,...
    'Label', 'tripleView',...
    'Callback', @mergeChannels);

h.menuImageChannel(1) =...
    uimenu(...
    'Tag', 'menuRedChannel',...
    'Parent', h.menuImageChannels,...
    'Label', 'Red Channel',...
    'Separator', 'on');
h.menuImageChannel(2) =...
    uimenu(...
    'Tag', 'menuGreenChannel',...
    'Parent', h.menuImageChannels,...
    'Label', 'Green Channel');
h.menuImageChannel(3) =...
    uimenu(...
    'Tag', 'menuBlueChannel',...
    'Parent', h.menuImageChannels,...
    'Label', 'Blue Channel');
h.menuImageChannel(4) =...
    uimenu(...
    'Tag', 'menuGrayChannel',...
    'Parent', h.menuImageChannels,...
    'Label', 'Gray Channel',...
    'Enable', 'off');
h.menuTrackChannel =...
    uimenu(...
    'Tag', 'menuTrackChannel',...
    'Parent', h.menuImageChannels,...
    'Label', 'Track Channel');

% h.menuAnalyse =...
%     uimenu(...
%     'Label', 'Analysis');
%
% h.menuAnalyseKinetics =...
%     uimenu(...
%     'Parent', h.menuAnalyse,...
%     'Label', 'Kinetics');
% uimenu(...
%     'Parent', h.menuAnalyseKinetics,...
%     'Label', 'Build Trajectories',...
%     'Callback', @buildTracks,...
%     'Enable', 'off')
% uimenu(...
%     'Parent', h.menuAnalyseKinetics,...
%     'Label', 'PICS',...
%     'Callback', @particleImageCorrelation)
%
% h.menuAnalyseFilters =...
%     uimenu(...
%     'Parent', h.menuAnalyse,...
%     'Label', 'Filters');
% uimenu(...
%     'Parent', h.menuAnalyseFilters,...
%     'Label', 'Co-Localization',...
%     'Callback', @colocFilter)

% h.menuAnalyseFilters =...
%     uimenu(...
%     'Parent', h.menuAnalyse,...
%     'Label', 'Particle Filters');
% uimenu(...
%     'Parent', h.menuAnalyseFilters,...
%     'Label', 'Clustering')
% uimenu(...
%     'Parent', h.menuAnalyseFilters,...
%     'Label', 'Cross-Clustering')
% uimenu(...
%     'Parent', h.menuAnalyseFilters,...
%     'Label', 'Co-Localization')

% h.menuVisualize =...
%     uimenu(...
%     'Label', 'Visualization');
% 
% %% scatter plot
% h.menuVisualizeScatter =...
%     uimenu(...
%     'Parent', h.menuVisualize,...
%     'Label', 'Scatter Plot');
% h.menuVisualizeScatter2D =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter,...
%     'Label', '2-D');
% h.menuVisualizeScatter2DFrame =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter2D,...
%     'Label', 'Image',...
%     'Callback', @scatterPlot);
% h.menuVisualizeScatter2DMovie =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter2D,...
%     'Label', 'Movie',...
%     'Callback', @scatterPlot,...
%     'Enable', 'off');
% h.menuVisualizeScatter3D =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter,...
%     'Label', '3-D');
% h.menuVisualizeScatter3DFrame =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter3D,...
%     'Label', 'Image',...
%     'Callback', @scatterPlot);
% h.menuVisualizeScatter3DMovie =...
%     uimenu(...
%     'Parent', h.menuVisualizeScatter3D,...
%     'Label', 'Movie',...
%     'Callback', @scatterPlot,...
%     'Enable', 'off');

h.extras =...
    uimenu(...
    'Label', 'Extras');
uimenu(...
    'Parent', h.extras,...
    'Label', 'Help',...
    'Callback', @showHelp,...
    'Enable', 'off');
uimenu(...
    'Parent', h.extras,...
    'Label', 'Credits',...
    'Callback', @showCredits);
uimenu(...
    'Parent', h.extras,...
    'Label', 'Changelog',...
    'Callback', @showChangeLog);

%icon grafics
icon.Arrow =...
    [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 0, 0, NaN, NaN, NaN, NaN; ...
    NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 1 NaN, NaN, NaN, NaN];

icon.roi =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.colormap =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;...
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;...
    0, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0, 0, 0, NaN, 0, 0, NaN;...
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0,; ...
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, 0, 0; ...
    0, NaN, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, NaN, 0, 0, NaN,; ...
    0, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0, 0, 0, NaN, 0, NaN, 0,; ...
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;...
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;...
    0, 0, NaN, 0, 0, NaN, NaN, 0, 0, NaN, NaN, 0, 0, 0, NaN, NaN,; ...
    0, NaN, 0, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN,; ...
    0, NaN, 0, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN; ...
    0, NaN, NaN, NaN, 0, NaN, 0, 0, 0, 0, NaN, 0, 0, 0, NaN, NaN,; ...
    0, NaN, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, NaN, NaN; ...
    0, NaN, NaN, NaN, 0, NaN, 0, NaN, NaN, 0, NaN, 0, NaN, NaN, NaN, NaN; ...
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.fit =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,0,0,0,0,0,0;
    NaN,0,0,0,0,0,NaN,0,0,NaN,0,0,0,0,0,0;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,0,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,0,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.options =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.opt2txt =...
    [NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,0,0,0,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,0,0,NaN,0,NaN,NaN,0,NaN,0,0,0,0,0;
    NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;];

icon.save =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,NaN,0,NaN,0,0,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,NaN,0,NaN,0,0,0,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN;
    0,0,0,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,NaN;
        NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.testLoc =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.locAll =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,0,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.intDist =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,NaN,0,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,NaN;
    NaN,0,0,0,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.s2nDist =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,0,NaN,NaN,NaN,NaN,0,NaN,0,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,NaN,NaN,NaN,0,0,NaN,0,NaN,0,NaN,NaN,0;
    0,0,0,0,NaN,NaN,0,0,NaN,NaN,0,NaN,NaN,0,NaN,0;
    NaN,NaN,NaN,0,NaN,0,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0;
    0,0,0,0,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.precDist =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,0,0,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.locDist =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,0,NaN,0,0,0,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,0,0,0,0,NaN,NaN,0,NaN;
    0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN;
    0,0,NaN,NaN,0,0,0,NaN,0,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.maxProj =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,0,0,NaN,0,0,0,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.aveProj =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,0,NaN,NaN;
    NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,0,0,NaN,0,0,0,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genMov =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genIm =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,0,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,0,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,0,0,0,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.genTraj =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN;
    NaN,0,NaN,NaN,NaN,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0,NaN;
    NaN,0,NaN,0,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,0,NaN;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,0,0,0,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,0,0,0,NaN,0,0,0,NaN,0,0,0;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0;
    NaN,0,NaN,NaN,0,0,0,0,NaN,0,0,0,NaN,NaN,NaN,0;
    NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,0;
    NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.scatter3D = ...
[NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,0,NaN,0,NaN,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,0,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,0,NaN,0,NaN,0,0,NaN,NaN,0,NaN,0,NaN,0;
    0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,0,NaN,0;
    NaN,0,NaN,NaN,NaN,0,NaN,0,0,0,NaN,NaN,0,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,0,0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,NaN,NaN;
    NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,0,0,0,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

icon.playMov =...
    [NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,0,0,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,NaN,0;
    0,NaN,0,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN,0;
    0,0,0,NaN,0,NaN,NaN,NaN,0,0,0,0,NaN,0,0,0;
    0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,NaN,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    0,NaN,NaN,NaN,0,0,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,0,NaN,NaN,NaN,0;
    0,0,NaN,0,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,0,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,0,NaN,NaN,NaN,0;
    0,NaN,NaN,NaN,0,NaN,0,NaN,NaN,0,NaN,NaN,0,NaN,0,NaN;
    0,NaN,NaN,NaN,0,NaN,0,0,0,0,NaN,NaN,NaN,0,NaN,NaN;
    NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;];

setappdata(1, 'handles', h)
setappdata(1, 'icons', icon)
setappdata(0, 'searchPath', pwd)
end

%% DATA
function loadData(src, event)
icon = getappdata(1, 'icons');

%initialize figure
fig = figure('Visible','off');

switch get(src, 'Label')
    case 'Imagestack'
        %initialize variables
        setappdata(fig,'isOwn',1)
        setappdata(fig,'isLoaded',0)
        setappdata(fig,'isSuperstack',0)
        setappdata(fig,'isTrack',0)
        setappdata(fig,'frame',1)
        setappdata(fig,'viewMode','monoView')
        
        %Loc Options
        setappdata(fig,'locStart',1)
        setappdata(fig,'locEnd',inf)
        setappdata(fig,'errorRate',-6)
        setappdata(fig,'w2d',9)
        setappdata(fig,'dfltnLoops',0)
        setappdata(fig,'minInt',0)
        setappdata(fig,'locParallel',0)
        setappdata(fig,'nCores',1)
        setappdata(fig,'spatialCorrection',0)
        setappdata(fig,'isRadiusTol',0)
        setappdata(fig,'radiusTol',50)
        setappdata(fig,'posTol',1.5)
        setappdata(fig,'maxOptimIter',50)
        setappdata(fig,'termTol',-2)
        
        %Bar Options
        setappdata(fig,'isScalebar',0)
        setappdata(fig,'micronBarLength',1000)
        setappdata(fig,'isColormap',0)
        setappdata(fig,'isTimestamp',0)
        setappdata(fig,'timestampSize',2)
        setappdata(fig,'timestampInkrement',0.032)
        setappdata(fig,'colormapWidth',10)
        
        %Render Options
        setappdata(fig,'exfOld',1)
        setappdata(fig,'exfNew',5)
        setappdata(fig,'rW',50)
        setappdata(fig,'rStep',10)
        setappdata(fig,'rStart',1)
        setappdata(fig,'rEnd',inf)
        setappdata(fig,'rLive',0)
        setappdata(fig,'fps',25)
        setappdata(fig,'movCompression',1)
        setappdata(fig,'convMode',1)
        setappdata(fig,'intWeight',0.01)
        setappdata(fig,'sizeFac',1)
        setappdata(fig,'isCumsum',0)
        
        %Filter Options
        setappdata(fig,'isThreshLocPrec',0)
        setappdata(fig,'minLoc',0)
        setappdata(fig,'maxLoc',inf)
        setappdata(fig,'isThreshSNR',0)
        setappdata(fig,'minSNR',0)
        setappdata(fig,'maxSNR',inf)
        setappdata(fig,'isThreshDensity',0)
        setappdata(fig,'clusterMode',1)
        
        %Optics Options
        setappdata(fig,'pxSize',0.107)
        setappdata(fig,'cntsPerPhoton',20.2)
        setappdata(fig,'emWvlnth',571)
        setappdata(fig,'NA',1.35)
        setappdata(fig,'psfScale',1.35)
        setappdata(fig,'psfStd',1.03)
        
        [filename, pathname, isOK] = uigetfile(...
            '*.tif', 'Select Imagestack', getappdata(0,'searchPath'));
        if isOK
            setappdata(0, 'searchPath', pathname)
            setappdata(fig,'pathname',pathname)
            setappdata(fig,'filename',filename)
            
            I = imread([pathname filename],getappdata(fig,'frame'));
            [height width] = size(I);
            setappdata(fig,'width',width)
            setappdata(fig,'height',height)
            setappdata(fig,'roiX0',0)
            setappdata(fig,'roiY0',0)
            setappdata(fig,'roi',[0 0 width height])
            setappdata(fig,'hROI',[])
            
            setappdata(fig,'intensityRange',[])
            
            figTitle = ['Frame 1 - ' getappdata(fig,'filename')];
            tagIntHist = 'Pixel Intensity';
            badToggles = [2:8 20:36];
        else
            return
        end %if
    case 'Superstack'
        menuFig =...
            figure(...
            'Units','normalized',...
            'Position', [0.2 0.6 0.4 0.2],...
            'Color', get(0,'defaultUicontrolBackgroundColor'),...
            'Name', 'Superstack Container',...
            'NumberTitle', 'off',...
            'MenuBar', 'none',...
            'ToolBar', 'none',...
            'Resize', 'off');
        
        hList =...
            uicontrol(...
            'Style', 'listbox',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0 0 0.9 1],...
            'FontSize', 10);
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0.9 0.8 0.1 0.2],...
            'FontSize', 25,...
            'String', '+',...
            'Callback', {@addStack, hList})
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0.9 0.6 0.1 0.2],...
            'FontSize', 30,...
            'String', '-',...
            'Callback', {@delStack, hList})
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0.9 0.4 0.1 0.2],...
            'FontSize', 10,...
            'String', 'UP',...
            'Callback', {@moveUpStack, hList})
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0.9 0.2 0.1 0.2],...
            'FontSize', 10,...
            'String', 'DOWN',...
            'Callback', {@moveDownStack, hList})
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', menuFig,...
            'Units','normalized',...
            'Position', [0.9 0 0.1 0.2],...
            'FontSize', 10,...
            'String', 'OK',...
            'Callback', {@buildSuperstack, hList})
        
        isOK = false;
        uiwait(menuFig)
    case 'SLIMfast'
        [filename, pathname, isOK] = uigetfile(...
            '*.mat', 'Select Particle Data', getappdata(0,'searchPath'));
        if isOK
            setappdata(0, 'searchPath', pathname)
%             imageBin = struct([]);
            load([pathname filename])
            setappdata(fig,'pathname',pathname)
            setappdata(fig,'filename',imageBin.filename)
            
            %initialize variables
            setappdata(fig,'imageName',imageBin.imageName)
            
            setappdata(fig,'isOwn',1)
            setappdata(fig,'isLoaded',1)
            setappdata(fig,'isSuperstack',imageBin.isSuperstack)
            setappdata(fig,'isTrack',0)
            setappdata(fig,'frame',1)
            setappdata(fig,'viewMode','monoView')
            
            %Loc Options
            if all(isfield(imageBin,{'locStart','locEnd'}))
                setappdata(fig,'locStart',imageBin.locStart)
                setappdata(fig,'locEnd',imageBin.locEnd)
            else %for backward compatibility
                setappdata(fig,'locStart',imageBin.rStart)
                setappdata(fig,'locEnd',imageBin.rEnd)
            end %try
            
            setappdata(fig,'errorRate',imageBin.errorRate)
            setappdata(fig,'w2d',imageBin.w2d)
            setappdata(fig,'dfltnLoops',imageBin.dfltnLoops)
            setappdata(fig,'minInt',imageBin.minInt)
            setappdata(fig,'locParallel',imageBin.locParallel)
            setappdata(fig,'nCores',imageBin.nCores)
            setappdata(fig,'spatialCorrection',imageBin.spatialCorrection)
            setappdata(fig,'isRadiusTol',imageBin.isRadiusTol)
            setappdata(fig,'radiusTol',imageBin.radiusTol)
            setappdata(fig,'posTol',imageBin.posTol)
            setappdata(fig,'maxOptimIter',imageBin.maxOptimIter)
            setappdata(fig,'termTol',imageBin.termTol)
            
            %Bar Options
            setappdata(fig,'isScalebar',0)
            setappdata(fig,'micronBarLength',imageBin.micronBarLength)
            setappdata(fig,'isColormap',0)
            setappdata(fig,'isTimestamp',0)
            setappdata(fig,'timestampSize',imageBin.timestampSize)
            setappdata(fig,'timestampInkrement',imageBin.timestampInkrement)
            setappdata(fig,'colormapWidth',imageBin.colormapWidth)
            
            %Render Options
            setappdata(fig,'exfOld',imageBin.exfNew)
            setappdata(fig,'exfNew',imageBin.exfNew)
            setappdata(fig,'rW',imageBin.rW)
            setappdata(fig,'rStep',imageBin.rStep)
            setappdata(fig,'rStart',1)
            setappdata(fig,'rEnd',numel(imageBin.ctrsN))
            setappdata(fig,'rLive',imageBin.rLive)
            setappdata(fig,'fps',imageBin.fps)
            setappdata(fig,'movCompression',imageBin.movCompression)
            setappdata(fig,'convMode',1)
            setappdata(fig,'intWeight',255)
            setappdata(fig,'sizeFac',1)
            setappdata(fig,'isCumsum',imageBin.isCumsum)
            
            %Thresh Options
            setappdata(fig,'isThreshLocPrec',0)
            setappdata(fig,'minLoc',imageBin.minLoc)
            setappdata(fig,'maxLoc',imageBin.maxLoc)
            setappdata(fig,'isThreshSNR',0)
            setappdata(fig,'minSNR',imageBin.minSNR)
            setappdata(fig,'maxSNR',imageBin.maxSNR)
            setappdata(fig,'isThreshDensity',0)
            setappdata(fig,'clusterMode',1)
            
            %Optics Options
            setappdata(fig,'pxSize',imageBin.pxSize)
            if isfield(imageBin,'frameSize')
                 setappdata(fig,'frameSize',imageBin.frameSize)
            else
            setappdata(fig,'frameSize',40)
            end %if
            setappdata(fig,'cntsPerPhoton',imageBin.cntsPerPhoton)
            setappdata(fig,'emWvlnth',imageBin.emWvlnth)
            setappdata(fig,'NA',imageBin.NA)
            setappdata(fig,'psfScale',imageBin.psfScale)
            setappdata(fig,'psfStd',imageBin.psfStd)           
            
            %tracking options
            setappdata(fig,'trackStart',1)
            setappdata(fig,'trackEnd',inf)
            setappdata(fig,'Dmax',0.5)
            setappdata(fig,'searchExpFac',1.2)
            setappdata(fig,'statWin',10)
            setappdata(fig,'maxComp',1)
            setappdata(fig,'maxOffTime',2)
            setappdata(fig,'intLawWeight',0.9)
            setappdata(fig,'diffLawWeight',0.5)
            
            %ROI Options
            setappdata(fig,'width',imageBin.width)
            setappdata(fig,'height',imageBin.height)
            setappdata(fig,'roiX0',0)
            setappdata(fig,'roiY0',0)
            setappdata(fig,'roi',[0 0 imageBin.width imageBin.height])
            setappdata(fig,'hROI',[])
            
            setappdata(fig,'intensityRange',[0 255])
            setappdata(fig,'ctrsN',imageBin.ctrsN)
            
            %rendering
            roi = [0 0 imageBin.width imageBin.height];
            setappdata(fig,'startPnt',0)
            setappdata(fig,'elements',inf)
            data = preprocessData(fig, [1 1 0 0 0 0 0 1 0 0 0 0],roi);
            [I,width,height,N] = renderImage(data,roi,...
                getappdata(fig,'exfNew'),...
                getappdata(fig,'width'),...
                getappdata(fig,'height'),...
                getappdata(fig,'intWeight'),...
                getappdata(fig,'sizeFac'),...
                getappdata(fig,'pxSize'),...
                getappdata(fig,'convMode'));
            
            figTitle = [getappdata(fig,'filename') ': ' num2str(N) ' rendered'];
            tagIntHist = 'Particle Intensity';
            badToggles = [9:10 13:14 17:19 21:36];
        else
            return
        end %if
    case 'FPALM'
        [filename, pathname,isOK] = uigetfile(...
            '*.mat', 'Select Particle Coordinates', getappdata(0,'searchPath'));
        if isOK
            setappdata(1, 'searchPath', pathname)
            
            load([pathname filename],...
                'a0_all','xf_all', 'yf_all','r0_all',...
                'framenum_all', 'file_info','exf','NA',...
                'wvlnth','pix_to_pho','psf_scale','q',...
                'nmol_all','total_molecules','x_offset',...
                'x_size', 'y_offset', 'y_size',...
                'iprod_thresh','bkgn' )
            
            %format conversion
            [imageBin.filename,imageBin.pathname,isOK] =...
                uiputfile('' ,'Save converted Data to', pathname);
            if isOK
                
                %Predefined Variables
                imageBin.isOwn = true;
                imageBin.isLoaded = true;
                imageBin.isSuperstack = false;
                imageBin.isTrack = false;
                imageBin.frame = 1;
                
                %Loc Options
                imageBin.errorRate = -6;
                imageBin.w2d = 9;
                imageBin.dfltnLoops = 0;
                imageBin.minInt = iprod_thresh;
                imageBin.locParallel = false;
                imageBin.nCores = 1;
                imageBin.spatialCorrection = false;
                imageBin.isRadiusTol = false;
                imageBin.radiusTol = 50;
                imageBin.posTol = 1.5;
                imageBin.maxOptimIter = 50;
                imageBin.termTol = -2;
                
                %Bar Options
                imageBin.isScalebar = 0;
                imageBin.micronBarLength = 1000;
                imageBin.isColormap = 0;
                imageBin.colormapWidth = 20;
                imageBin.isTimestamp = 0;
                imageBin.timestampSize = 2;
                imageBin.timestampInkrement = 0.032;
                
                %Render Options
                imageBin.exfOld = exf;
                imageBin.exfNew = exf;
                imageBin.rW = 50;
                imageBin.rStep = 10;
                imageBin.rStart = nan;
                imageBin.rEnd = nan;
                imageBin.rLive = false;
                imageBin.fps = 25;
                imageBin.movCompression = 1;
                imageBin.convMode = 1;
                imageBin.intWeight = 0.01;
                imageBin.sizeFac = 1;
                imageBin.isCumsum = false;
                
                %Thresh Options
                imageBin.isThreshLocPrec = false;
                imageBin.minLoc = 0;
                imageBin.maxLoc = inf;
                imageBin.isThreshSNR = false;
                imageBin.minSNR = 0;
                imageBin.maxSNR = inf;
                imageBin.isThreshDensity = false;
                
                %Optics Options
                imageBin.pxSize = q;
                imageBin.cntsPerPhoton = pix_to_pho;
                imageBin.emWvlnth = wvlnth*1000;
                imageBin.NA = NA;
                imageBin.psfScale = psf_scale;
                imageBin.psfStd = psf_scale*0.55*(wvlnth)/NA/1.17/q/2;
                
                imageBin.ctrsN = nmol_all';
                imageBin.nrI = file_info.stop-file_info.startPnt+1;
                
                imageBin.height = y_size;
                imageBin.width = x_size;
                imageBin.roi = [x_offset y_offset x_size y_size];
                
                fidY = fopen([imageBin.pathname imageBin.filename '.ctrsY'], 'a+');
                fidX = fopen([imageBin.pathname imageBin.filename '.ctrsX'], 'a+');
                fidSignal = fopen([imageBin.pathname imageBin.filename '.signal'], 'a+');
                fidNoise = fopen([imageBin.pathname imageBin.filename '.noise'], 'a+');
                fidRadius = fopen([imageBin.pathname imageBin.filename '.radius'], 'a+');
                fidFrame = fopen([imageBin.pathname imageBin.filename '.frame'], 'a+');
                
                fwrite(fidY,yf_all,'real*8');
                fwrite(fidX,xf_all,'real*8');
                fwrite(fidSignal,a0_all,'real*8');
                fwrite(fidNoise,ones(total_molecules,1)*bkgn,'real*8');
                fwrite(fidRadius,r0_all/2,'real*8'); % 1/e^2 -> std
                fwrite(fidFrame,framenum_all,'real*8');
                fclose('all');
                
                %preallocate frame
                I = zeros(imageBin.roi(4)*imageBin.exfNew,...
                    imageBin.roi(3)*imageBin.exfNew);
                
                ctrsXY = imageBin.roi(4)*imageBin.exfNew*...
                    uint32((xf_all'-imageBin.roi(1)+1)*imageBin.exfNew)+...
                    uint32((yf_all'-imageBin.roi(2)+1)*imageBin.exfNew);
                [ctrsXY unused take] = unique(ctrsXY);
                signal = accumarray(take,a0_all*imageBin.cntsPerPhoton);
                I(ctrsXY) = signal*imageBin.intWeight;
                
                psf = buildPSF(imageBin.sizeFac,...
                    ceil(imageBin.roi(3)*imageBin.exfNew),...
                    ceil(imageBin.roi(4)*imageBin.exfNew));
                
                I = fftshift(ifft2(fft2(I).*psf));
                pxRange = [0 255];
                figTitle = [imageBin.filename ': ' num2str(total_molecules) ' rendered'];
                badToggles = [5 6 8 9 10 11 12 13 14 15 16 19 20 21 22 23];
            else
                return
            end %if
        else
            return
        end %if
    case 'Tracking Data'
        [filename, pathname,isOK] = uigetfile(...
            '*.mat', 'Select Tracking Data', getappdata(0,'searchPath'));
        if isOK
            setappdata(0, 'searchPath', pathname)
            
            [data,settings,par_per_frame] = deal([]);
            load([pathname filename])
            tracksize = cellfun('size',data.tr,1);
            data.tr(tracksize < 5) = [];
            
            setappdata(fig,'pathname',pathname)
            setappdata(fig,'tracks',data.tr)
            setappdata(fig,'nTracks',numel(data.tr))
            setappdata(fig,'ctrsN',par_per_frame)
            
            setappdata(fig,'isOwn',1)
            setappdata(fig,'isLoaded',1)
            setappdata(fig,'isSuperstack',0)
            setappdata(fig,'isTrack',1)
            setappdata(fig,'frame',1)
            setappdata(fig,'viewMode','monoView')
            
            setappdata(fig,'trackColorMode',2)
            setappdata(fig,'trackColor',{[1 1 0],...
                rand(getappdata(fig,'nTracks'),3)})
            setappdata(fig,'trackWidth',1)
            setappdata(fig,'trackVisibility',1)
            
            setappdata(fig,'rW',1)
            setappdata(fig,'rStep',1)
            setappdata(fig,'rStart',1)
            setappdata(fig,'rEnd',settings.Frames)
            setappdata(fig,'isCumsum',1)
            setappdata(fig,'isTracksizeThresh',1)
            setappdata(fig,'minTracksize',15)
            setappdata(fig,'maxTracksize',inf)
            
            setappdata(fig,'pxSize',settings.px2micron)
            setappdata(fig,'frameSize',settings.Delay*1000)
            
            %tracking options
            setappdata(fig,'trackStart',1)
            setappdata(fig,'trackEnd',inf)
            setappdata(fig,'Dmax',...
                settings.TrackingOptions.MaxDiffusionCoefficient)
            setappdata(fig,'searchExpFac',...
                settings.TrackingOptions.ResearchDiameter)
            setappdata(fig,'statWin',...
                settings.TrackingOptions.AvaragingTimeWindow)
            setappdata(fig,'maxComp',...
                settings.TrackingOptions.CombinationTresh)
            setappdata(fig,'maxOffTime',...
                settings.TrackingOptions.BlinkingProbability)
            setappdata(fig,'intLawWeight',...
                settings.TrackingOptions.WeightUniformGaussianLaw)
            setappdata(fig,'diffLawWeight',...
                settings.TrackingOptions.WeightMaxLocalDiffusion)

            %ROI Options
            width = settings.Width;
            height = settings.Height;
            setappdata(fig,'width',width)
            setappdata(fig,'height',height)
            setappdata(fig,'exfOld',1)
            setappdata(fig,'roiX0',0)
            setappdata(fig,'roiY0',0)
            setappdata(fig,'roi',[0 0 width height])
            setappdata(fig,'hROI',[])
            
            I = zeros(height,width);
            setappdata(fig,'intensityRange',[0 255])
            
            [pathname filename ext] = fileparts(settings.Filename);
            setappdata(fig,'filename',filename)
            
            figTitle = filename;
            tagIntHist = '';
            badToggles = [2:14 17:29 32:36];
        end %if
end %switch

if isOK
    logInImage(fig,[])
    set(fig,...
        'Name', figTitle,...
        'Units','normalized',...
        'Position', figPos(width/height),...
        'Color',  min(1,unifrnd(0.7,1,1,3)+...
        double(randperm(RandStream.getDefaultStream,3)==1)),...
        'NumberTitle', 'off',...
        'MenuBar', 'none',...
        'ToolBar', 'figure',...
        'DeleteFcn', @logOutImage,...
        'DockControls', 'off',...
        'Visible', 'on');
    ax = ...
        axes(...
        'Parent', fig,...
        'Units','normalized',...
        'Position', [0.05 0.05 0.9 0.9]);
    
    %draw Image
    iptsetpref('ImshowAxesVisible','off')
    hImage = imshow(I,getappdata(fig,'intensityRange'));
    setappdata(fig,'hImage',hImage)
    
    if getappdata(fig,'isTrack')
        %plot tracks 
        tracksize = cellfun('size',data.tr,1);
        if isinf(getappdata(fig,'maxTracksize'))
            hasSize = tracksize >= getappdata(fig,'minTracksize');
        else
            hasSize = tracksize >= getappdata(fig,'minTracksize') &...
                tracksize <= getappdata(fig,'maxTracksize');
        end %if
        
        cmap =getappdata(fig,'trackColor');
        hTracks = zeros(getappdata(fig,'nTracks'),1);
        for trackID = 1:getappdata(fig,'nTracks')
            hTracks(trackID) = line(data.tr{trackID}(:,1),...
                data.tr{trackID}(:,2),...
                'Parent', ax,...
                'Color', cmap{2}(trackID,:),...
                'LineWidth', getappdata(fig,'trackWidth'));
        end
        setappdata(fig,'hTracks',hTracks)
        set(hTracks(~hasSize),'Visible','off')
    end %if
    
    %personalize toolbar
    hToolBar = findall(fig,'Type','uitoolbar');
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.save, [1 1 3]),...
        'ClickedCallback', {@saveImage,I,'8bit'})
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.Arrow, [1 1 3]),...
        'ClickedCallback', @previousFrame)
    uitoggletool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.playMov, [1 1 3]),...
        'ClickedCallback', @showRawStack)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(fliplr(icon.Arrow), [1 1 3]),...
        'ClickedCallback', @nextFrame)
    uitoggletool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.roi, [1 1 3]),...
        'ClickedCallback', @setROI)
    uitoggletool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.options, [1 1 3]),...
        'ClickedCallback', @setOptions)
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', 'max. Intensity',...
        'CData', repmat(icon.maxProj, [1 1 3]),...
        'ClickedCallback', @zProject,...
        'TooltipString', sprintf(['\n' ...
        'Do a max. Intensity z-Projection. \n' ...
        'Each Pixel in the final Image gets \n' ...
        'the max. registered Pixelvalue \n' ...
        'from the Imagestack.']))
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', 'mean Intensity',...
        'CData', repmat(icon.aveProj, [1 1 3]),...
        'ClickedCallback', @zProject)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.colormap, [1 1 3]),...
        'ClickedCallback', 'colormapeditor')
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', tagIntHist,...
        'CData', repmat(icon.intDist, [1 1 3]),...
        'ClickedCallback', @intHist)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.testLoc, [1 1 3]),...
        'ClickedCallback', @showLocPreview)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.locAll, [1 1 3]),...
        'ClickedCallback', @localization)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.precDist, [1 1 3]),...
        'ClickedCallback', @locPrec)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.s2nDist, [1 1 3]),...
        'ClickedCallback', @snrHist)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.locDist, [1 1 3]),...
        'ClickedCallback', @detectionTrace)
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.genTraj, [1 1 3]),...
        'ClickedCallback', @buildTracks)
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', 'Image',...
        'CData', repmat(icon.genIm, [1 1 3]),...
        'ClickedCallback', @render)
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', 'Movie',...
        'CData', repmat(icon.genMov, [1 1 3]),...
        'ClickedCallback', @render)
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', '3D ImScatter',...
        'CData', repmat(icon.scatter3D, [1 1 3]),...
        'ClickedCallback', @scatterPlot)
    
    hToggleList = findall(hToolBar);
    delete(hToggleList(badToggles))
    
    %     jToolbar = get(get(imageBin.hToolBar,'JavaContainer'),'ComponentPeer');
    %     set(jToolbar,'Background',get(imageBin.hFig,'Color'));
    
else
    return
end %if

    function addStack(src, event, hList)
        [stackname, stackpath,isOK] = uigetfile('*.tif',...
            'Select Imagestacks', getappdata(0,'searchPath'),...
            'MultiSelect', 'on');
        if isOK
            setappdata(0, 'searchPath', stackpath)
            content = get(hList, 'String');
            contentNew = cellstr(strcat(stackpath, stackname));
            content = [content',contentNew];
            set(hList, 'String', content)
        else
            return
        end %if
    end
    function delStack(src, event, hList)
        bad = get(hList, 'Value');
        content = get(hList, 'String');
        if isempty(content)
            return
        else
            content(bad) = [];
            set(hList, 'String', content, 'Value', 1)
        end %if
    end
    function moveUpStack(src, event, hList)
        pos = get(hList, 'Value');
        if pos > 1
            content = get(hList, 'String');
            content(pos-1:pos) = [content(pos); content(pos-1)];
            set(hList, 'String', content, 'Value', pos-1)
        else
            return
        end %if
    end
    function moveDownStack(src, event, hList)
        pos = get(hList, 'Value');
        content = get(hList, 'String');
        if pos < numel(content)
            content(pos:pos+1) = [content(pos+1); content(pos)];
            set(hList, 'String', content, 'Value', pos+1)
        else
            return
        end %if
    end
    function buildSuperstack(src, event, hList)
        content = get(hList, 'String');
        if isempty(content)
            return
        else
            %initialize variables
            for idx = 1:numel(content)
                [pathname_, filename_, ext_] = fileparts(content{idx});
                pathname{1,idx} = [pathname_ '\'];
                filename{1,idx} = [filename_ ext_];
            end
            setappdata(fig,'pathname',pathname)
            setappdata(fig,'filename',filename)
            
            setappdata(fig,'isOwn',1)
            setappdata(fig,'isLoaded',0)
            setappdata(fig,'isSuperstack',1)
            setappdata(fig,'isTrack',0)
            setappdata(fig,'frame',1)
            setappdata(fig,'stack',1)
            setappdata(fig,'stackSize',[])
            setappdata(fig,'viewMode','monoView')
            
            %Loc Options
            setappdata(fig,'locStart',1)
            setappdata(fig,'locEnd',inf)
            setappdata(fig,'errorRate',-6)
            setappdata(fig,'w2d',9)
            setappdata(fig,'dfltnLoops',0)
            setappdata(fig,'minInt',0)
            setappdata(fig,'locParallel',0)
            setappdata(fig,'nCores',1)
            setappdata(fig,'spatialCorrection',0)
            setappdata(fig,'isRadiusTol',0)
            setappdata(fig,'radiusTol',50)
            setappdata(fig,'posTol',1.5)
            setappdata(fig,'maxOptimIter',50)
            setappdata(fig,'termTol',-2)
            
            %Bar Options
            setappdata(fig,'isScalebar',0)
            setappdata(fig,'micronBarLength',1000)
            setappdata(fig,'isColormap',0)
            setappdata(fig,'isTimestamp',0)
            setappdata(fig,'timestampSize',2)
            setappdata(fig,'timestampInkrement',0.032)
            setappdata(fig,'colormapWidth',10)
            
            %Render Options
            setappdata(fig,'exfOld',1)
            setappdata(fig,'exfNew',5)
            setappdata(fig,'rW',50)
            setappdata(fig,'rStep',10)
            setappdata(fig,'rStart',1)
            setappdata(fig,'rEnd',inf)
            setappdata(fig,'rLive',0)
            setappdata(fig,'fps',25)
            setappdata(fig,'movCompression',1)
            setappdata(fig,'convMode',1)
            setappdata(fig,'intWeight',0.01)
            setappdata(fig,'sizeFac',1)
            setappdata(fig,'isCumsum',0)
            
            %Filter Options
            setappdata(fig,'isThreshLocPrec',0)
            setappdata(fig,'minLoc',0)
            setappdata(fig,'maxLoc',inf)
            setappdata(fig,'isThreshSNR',0)
            setappdata(fig,'minSNR',0)
            setappdata(fig,'maxSNR',inf)
            setappdata(fig,'isThreshDensity',0)
            setappdata(fig,'clusterMode',1)
            
            %Optics Options
            setappdata(fig,'pxSize',0.107)
            setappdata(fig,'cntsPerPhoton',20.2)
            setappdata(fig,'emWvlnth',571)
            setappdata(fig,'NA',1.35)
            setappdata(fig,'psfScale',1.35)
            setappdata(fig,'psfStd',1.03)
            
            I = imread([pathname{1} filename{1}],...
                getappdata(fig,'frame'));
            [height width] = size(I);
            setappdata(fig,'width',width)
            setappdata(fig,'height',height)
            setappdata(fig,'roiX0',0)
            setappdata(fig,'roiY0',0)
            setappdata(fig,'roi',[0 0 width height])
            setappdata(fig,'hROI',[])
            
            setappdata(fig,'intensityRange',[])
            
            figTitle = ['Frame 1 - ' filename{1}];
            tagIntHist = 'Pixel Intensity';
            badToggles = [2:8 20:36];
            
            close(menuFig)
        end %if
    end
end
function saveImage(src,event,I,mode)
switch mode
    case '8bit'
        I = uint8(I);
    case '16bit'
        I = uint16(I);
    otherwise
end %switch

[filename,pathname,isOK] =...
    uiputfile('.tif' ,'Save to', getappdata(0,'searchPath'));
if isOK
    imwrite(I,[pathname filename])
end %if
end

function logInImage(src, event)
if getappdata(src,'isLoaded')
    masterBinHandles = getappdata(1, 'handles');
    if getappdata(src,'isTrack')
        uimenu(...
            'Parent', masterBinHandles.menuTrackChannel,...
            'Label', regexprep(getappdata(src,'filename'),...
            {'(',')','[',']','{','}','+'}, '_'),...
            'Callback', strcat('if strcmp(get(gcbo, ''Checked''),''on'');',...
            'set(gcbo, ''Checked'', ''off''); else;',...
            'set(gcbo, ''Checked'', ''on''); end'),...
            'UserData', src);
    else
        h1 =...
            uimenu(...
            'Parent', masterBinHandles.menuImageChannel(1),...
            'Label', regexprep(getappdata(src,'filename'),...
            {'(',')','[',']','{','}','+'}, '_'),...
            'Callback', @changeCheckMode,...
            'UserData', src);
        h2 =...
            uimenu(...
            'Parent', masterBinHandles.menuImageChannel(2),...
            'Label', regexprep(getappdata(src,'filename'),...
            {'(',')','[',']','{','}','+'}, '_'),...
            'Callback', @changeCheckMode,...
            'UserData', src);
        h3 =...
            uimenu(...
            'Parent', masterBinHandles.menuImageChannel(3),...
            'Label', regexprep(getappdata(src,'filename'),...
            {'(',')','[',']','{','}','+'}, '_'),...
            'Callback', @changeCheckMode,...
            'UserData', src);
        
        if all(strcmp('off', get(allchild(...
                masterBinHandles.menuImageChannel(1)), 'Checked')))
            set(h1, 'Checked', 'on')
        elseif all(strcmp('off', get(allchild(...
                masterBinHandles.menuImageChannel(2)), 'Checked')))
            set(h2, 'Checked', 'on')
        elseif all(strcmp('off', get(allchild(...
                masterBinHandles.menuImageChannel(3)), 'Checked')))
            set(h3, 'Checked', 'on')
        end %if
    end %if
end %if
end
function logOutImage(src, event)
rootFig = findobj(0,'Tag','root');

if ~isempty(rootFig)
masterBinHandles = getappdata(1, 'handles');
if getappdata(src,'isTrack')
    delete(findobj(masterBinHandles.menuTrackChannel,'UserData', src));
else
    delete(findobj(masterBinHandles.menuImageChannel,'UserData', src));
end %if
delete(findobj(allchild(0),'Color',get(src,'Color')))
end %if
end

function showRawStack(src, event)
endOfStack = nextFrame(src, event);
pause(0.5)
while ~endOfStack && strcmp(get(src,'state'),'on')
    endOfStack = nextFrame(src, event);
    pause(0.5)
end %while
end
function previousFrame(src, event)
% imageBin = getappdata(hFig, 'imageBin');
fig = gcbf;
frame = getappdata(fig,'frame')-1;
pathname = getappdata(fig,'pathname');
filename = getappdata(fig,'filename');

if getappdata(fig,'isSuperstack')
    if frame > 0
        I = double(imread([pathname{getappdata(fig,'stack')}...
            filename{getappdata(fig,'stack')}],frame));
        set(fig, 'Name',...
            ['Frame: ' num2str(frame)...
            ' - ' filename{getappdata(fig,'stack')}])
    else
        if getappdata(fig,'stack') > 1
            %jump to previous stack
            setappdata(fig,'stack',getappdata(fig,'stack')-1);
            stackSize = getappdata(fig,'stackSize');
            frame = stackSize(getappdata(fig,'stack'));
            I = double(imread([pathname{getappdata(fig,'stack')}...
                filename{getappdata(fig,'stack')}],frame));
            set(fig, 'Name',...
                ['Frame: ' num2str(frame)...
                ' - ' filename{getappdata(fig,'stack')}])
        else
            return
        end %if
    end %if
else
    if frame > 0
        I = imread([getappdata(fig,'pathname')...
            getappdata(fig,'filename')],frame);
        set(fig, 'Name',...
            ['Frame: ' num2str(frame) ' - ' getappdata(fig,'filename')])
    else
        return
    end %if
end %if
setappdata(fig,'frame',frame)
set(getappdata(fig,'hImage'), 'CData', I)
caxis([min(min(I)) max(max(I))])
end
function endOfStack = nextFrame(src, event)
fig = gcbf;
frame = getappdata(fig,'frame')+1;
pathname = getappdata(fig,'pathname');
filename = getappdata(fig,'filename');
endOfStack = false;

try
    if getappdata(fig,'isSuperstack')
        I = double(imread([pathname{getappdata(fig,'stack')}...
            filename{getappdata(fig,'stack')}],frame));
        set(fig, 'Name',...
            ['Frame: ' num2str(frame) ' - ' filename{getappdata(fig,'stack')}])
    else
        I = imread([pathname filename],frame);
        set(fig, 'Name',...
            ['Frame: ' num2str(frame) ' - ' filename])
    end
    setappdata(fig,'frame',frame)
catch
    if getappdata(fig,'isSuperstack')
        %jump to following imagestack
        if getappdata(fig,'stack') < numel(filename)
            stackSize = getappdata(fig,'stackSize');
            stackSize(getappdata(fig,'stack')) = frame -1;
            setappdata(fig,'stackSize',stackSize)
            setappdata(fig,'stack',getappdata(fig,'stack')+1);
            setappdata(fig,'frame',1)
            
            I = double(imread([pathname{getappdata(fig,'stack')}...
                filename{getappdata(fig,'stack')}],1));
            set(fig, 'Name',...
                ['Frame: 1 - ' filename{getappdata(fig,'stack')}])
        else
            warndlg('End of Stack reached', 'Info')
            endOfStack = true;
            return
        end %if
    else
        warndlg('End of Stack reached', 'Info')
        endOfStack = true;
        return
    end %if
end %if
set(getappdata(fig,'hImage'), 'CData', I)
caxis([min(min(I)) max(max(I))])
end

function setROI(src, event)
fig = gcbf;

switch get(src,'State')
    case 'on'
        ax = findobj(fig,'Type','axes');
        
        %draw user defined ROI
        hRoi = imrect(ax);
        setappdata(fig,'hROI',hRoi)
        
        hMenu = uicontextmenu;
        uimenu(hMenu, 'Label', 'Adjust ROI Placement',...
            'Callback', @adjustROI);
        hPatch = findobj(hRoi,'Type','patch');
        set(hPatch,'FaceColor', [1 1 1],...
            'FaceAlpha', 0.3,...
            'UIContextMenu', hMenu)
        
        pos = getPosition(hRoi);
        setappdata(fig,'roi',...
            [pos(1)-0.5 pos(2)-0.5...
            pos(3) pos(4)]/getappdata(fig,'exfOld')+...
            [getappdata(fig,'roiX0') getappdata(fig,'roiY0') 0 0])
        
        hRoiText = text(pos(1), pos(2),...
            sprintf([' x0 = ' num2str(((pos(1)-0.5)/getappdata(fig,'exfOld')+...
            getappdata(fig,'roiX0'))*getappdata(fig,'pxSize')) ' ?m \n',...
            ' y0 = ' num2str((pos(2)-0.5)/getappdata(fig,'exfOld')+...
            getappdata(fig,'roiX0')) ' ?m \n',...
            ' width = ' num2str(pos(3)/getappdata(fig,'exfOld')*...
            getappdata(fig,'pxSize')) ' ?m \n',...
            ' height = ' num2str(pos(4)/getappdata(fig,'exfOld')*...
            getappdata(fig,'pxSize')) ' ?m']),...
            'FontSize', 8,...
            'FontWeight', 'bold',...
            'Color', [0 1 0],...
            'VerticalAlignment', 'top');
        setappdata(fig,'hRoiText',hRoiText)
        
        addNewPositionCallback(hRoi,@posInfo);
        cnstrnts = get(ax,{'XLim','YLim'});
        fcn = makeConstrainToRectFcn('imrect',...
            cnstrnts{1}, cnstrnts{2});
        setPositionConstraintFcn(hRoi,fcn);
    case 'off'
        if ~isempty(getappdata(fig,'hROI'))
        delete(getappdata(fig,'hROI'))
        delete(getappdata(fig,'hRoiText'))
        setappdata(fig,'hROI',[])
        setappdata(fig,'roi',...
            [0 0 getappdata(fig,'width') getappdata(fig,'height')])
        end %if
end %switch
    function posInfo(pos)
        set(hRoiText, 'Position', [pos(1) pos(2) 0],...
            'String',sprintf([' x0 = ' num2str(((pos(1)-0.5)/getappdata(fig,'exfOld')+...
            getappdata(fig,'roiX0'))*getappdata(fig,'pxSize')) ' ?m \n',...
            ' y0 = ' num2str((pos(2)-0.5)/getappdata(fig,'exfOld')+...
            getappdata(fig,'roiX0')) ' ?m \n',...
            ' width = ' num2str(pos(3)/getappdata(fig,'exfOld')*...
            getappdata(fig,'pxSize')) ' ?m \n',...
            ' height = ' num2str(pos(4)/getappdata(fig,'exfOld')*...
            getappdata(fig,'pxSize')) ' ?m']))
        
        setappdata(fig,'roi',...
            [pos(1)-0.5 pos(2)-0.5...
            pos(3) pos(4)]/getappdata(fig,'exfOld')+...
            [+getappdata(fig,'roiX0') +getappdata(fig,'roiY0') 0 0])
    end
    function adjustROI(src, event)
        %%
        figNew =...
            figure(...
            'Tag', 'home',...
            'Units','normalized',...
            'Position', [0.8 0.5 0.15 0.15],...
            'Color', get(fig,'Color'),...
            'NumberTitle', 'off',...
            'MenuBar', 'none',...
            'ToolBar', 'none',...
            'Resize', 'off');
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.33 0.67 0.34 0.33],...
            'FontSize', 10,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', 'UP',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.33 0 0.34 0.33],...
            'FontSize', 10,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', 'DOWN',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0 0.33 0.33 0.33],...
            'FontSize', 10,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', 'LEFT',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.67 0.33 0.33 0.33],...
            'FontSize', 10,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', 'RIGHT',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0 0.67 0.33 0.33],...
            'FontSize', 8,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', '+width',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0 0 0.33 0.33],...
            'FontSize', 8,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', '-width',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.67 0.67 0.33 0.33],...
            'FontSize', 8,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', '+height',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.67 0 0.33 0.33],...
            'FontSize', 8,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', '-height',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', figNew,...
            'Units','normalized',...
            'Position', [0.33 0.33 0.34 0.33],...
            'FontSize', 10,...
            'FontWeight', 'bold',...
            'FontUnits', 'normalized',...
            'String', 'sync',...
            'Callback', @moveROI,...
            'BackgroundColor', get(fig,'Color'))
        
        function moveROI(src, event)
            pos = ceil(getPosition(hRoi));
            switch get(src, 'String')
                case 'UP'
                    if pos(2) > 1
                        setPosition(hRoi,pos-[0 1 0 0])
                    end %if
                case 'DOWN'
                    if pos(2)+pos(4) < cnstrnts{2}(2)
                        setPosition(hRoi,pos+[0 1 0 0])
                    end %if
                case 'LEFT'
                    if pos(1) > 1
                        setPosition(hRoi,pos-[1 0 0 0])
                    end %if
                case 'RIGHT'
                    if pos(1)+pos(3) < cnstrnts{1}(2)
                        setPosition(hRoi,pos+[1 0 0 0])
                    end %if
                case '+width'
                    if pos(1)+pos(3) < cnstrnts{1}(2)
                        setPosition(hRoi,pos+[0 0 1 0])
                    end %if
                case '-width'
                    if pos(3) > 1
                        setPosition(hRoi,pos-[0 0 1 0])
                    end %if
                case '+height'
                    if pos(2)+pos(4) < cnstrnts{2}(2)
                        setPosition(hRoi,pos+[0 0 0 1])
                    end %if
                case '-height'
                    if pos(4) > 1
                        setPosition(hRoi,pos-[0 0 0 1])
                    end %if
                case 'sync'
                    figs = findobj(0,'Type', 'figure',...
                        '-not', 'Color', get(fig, 'Color'),...
                        '-not', 'Name','SLIMfast Build 1.103e');
                    
                    if isempty(figs)
                        warndlg('No ROI found to sync with', 'Info')
                        return
                    else
                        if iscell(figs)
                            figs = cell2mat(figs);
                        end %if
                        [selection,isOK] = listdlg('ListString',...
                            get(figs,'Name'),'Name', 'Sync To:');
                        if isOK
                            api = iptgetapi(findobj(figs(selection),'Tag', 'imrect'));
                            setPosition(hRoi,api.getPosition())
                        end %if
                    end %if
            end %switch
        end
    end
end

%% VISUALIZATION
function showLocPreview(src, event)
fig = gcbf;

I = get(getappdata(fig,'hImage'), 'CData');

%search for ROI
if isempty(getappdata(fig,'hROI'))
    roi = ceil(getappdata(fig,'roi'));
else
    roi = ceil(getappdata(fig,'roi'));
    I = I(roi(2):roi(2)+roi(4),...
        roi(1):roi(1)+roi(3));
end

optim = [...
    getappdata(fig,'maxOptimIter')
    getappdata(fig,'termTol')
    getappdata(fig,'isRadiusTol')
    getappdata(fig,'radiusTol')
    getappdata(fig,'posTol')];

[list dfltI mask good] = ...
    detect_et_estime_part_1vue_deflt(...
    double(I),...
    getappdata(fig,'w2d'),...
    getappdata(fig,'psfStd'),...
    chi2inv(1-1/10^(getappdata(fig,'errorRate')*-1),1),...
    getappdata(fig,'dfltnLoops'),...
    roi(3),roi(4),...
    getappdata(fig,'minInt'),...
    optim);

figure(...
    'Units','normalized',...
    'Position', get(fig, 'Position'),...
    'Color', get(fig,'Color'),...
    'Name', ['Frame: ' num2str(getappdata(fig,'frame'))...
    ' (' num2str(good) ' Detections)'],...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');
hToolBar = findall(gcf,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 15 16 17]))
axes(...
    'Parent', gcf,...
    'Units','normalized',...
    'Position', [0.05 0.05 0.9 0.9]);

imshow(I, []);
rectangle(...
    'Position',roi+[0.5 0.5 0 0],...
    'EdgeColor', [1 0 0],...
    'LineWidth', 1)
rho = linspace(0,2*pi,10)';
patch(repmat(1+roi(1)+list(:,2)',10,1)+...
    cos(rho)*list(:,6)',...
    repmat(1+roi(2)+list(:,1)',10,1)+...
    sin(rho)*list(:,6)',...
    repmat(shiftdim([1 0 0],-1),1,good),...
    'EdgeColor', 'none', 'FaceAlpha', 0.5)
end

function mergeChannels(src, event)
if strcmp(get(src,'Label'),'monoView')
else
    masterBinHandles = getappdata(1,'handles');
    icon = getappdata(1, 'icons');
    
    %update work mode
    changeCheckMode(src,[])
    
    figNew = figure(...
        'MenuBar', 'none',...
        'Toolbar','figure',...
        'DockControls', 'off',...
        'NumberTitle', 'off',...
        'Color', min(1,unifrnd(0.7,1,1,3)+...
        double(randperm(RandStream.getDefaultStream,3)==1)),...
        'Visible', 'off');
    
    
    if strcmp(get(src,'Label'),'dualView')
        setappdata(figNew,'viewMode','dualView')
    elseif strcmp(get(src,'Label'),'tripleView')
        setappdata(figNew,'viewMode','tripleView')
    end %if
    
    [imScrFig trackSrcFig] = getSelectedFigHandles;
    imCh = find(~isnan(imScrFig))';
    nImCh = numel(imCh);
    
    trackCh = find(~isnan(trackSrcFig))';
    nTrackCh = numel(trackCh);
    
    setappdata(figNew,'imSrcFig',imScrFig)
    setappdata(figNew,'imCh',imCh)
    setappdata(figNew,'nImCh',nImCh)
    
    setappdata(figNew,'trackSrcFig',trackSrcFig(trackCh))
    setappdata(figNew,'nTrackCh',nTrackCh)
    
    for ch = imCh
        I(:,:,ch) = get(getappdata(imScrFig(ch),'hImage'),'CData');
    end %for
    [height width depth] = size(I);
    I = cat(3,I,zeros(height,width,3-depth));
    
    transferVarList(figNew,imScrFig(imCh),'merge')
    
    %open image window
    set([imScrFig(imCh);trackSrcFig], 'Visible', 'off')
    set(figNew,...
        'Units','normalized',...
        'Position', figPos(width/height),...
        'DeleteFcn', {@splitChannels, [imScrFig(imCh);trackSrcFig]},...
        'Visible', 'on');
    axes(...
        'Parent', figNew,...
        'Units','normalized',...
        'Position', [0.05 0.05 0.9 0.9]);
    
    %customize toolbar
    hToolBar = findall(figNew,'Type','uitoolbar');
    uipushtool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.save, [1 1 3]),...
        'ClickedCallback', {@saveImage,I,'8bit'})
    uitoggletool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.roi, [1 1 3]),...
        'ClickedCallback', @setROI)
    uitoggletool(...
        'Parent', hToolBar,...
        'CData', repmat(icon.options, [1 1 3]),...
        'ClickedCallback', @setOptions)
    uipushtool(...
                    'Parent', hToolBar,...
                    'Tag', 'Image',...
                    'CData', repmat(icon.genIm, [1 1 3]),...
                    'ClickedCallback', @render)
    uipushtool(...
        'Parent', hToolBar,...
        'Tag', 'Movie',...
        'CData', repmat(icon.genMov, [1 1 3]),...
        'ClickedCallback', @render)
    hToggleList = findall(hToolBar);
    delete(hToggleList([5 7:15 18:23]))
    
    imshow(uint8(I), []);
    for ch = 1:nTrackCh
        hTracks = copyobj(getappdata(trackSrcFig(ch),'hTracks'),gca);
        xdata = get(hTracks,'XData');
        set(hTracks,{'XData'}, cellfun(@(x) x*...
            getappdata(figNew,'exfNew')-1, xdata, 'un',0))
        ydata = get(hTracks,'YData');
        set(hTracks,{'YData'}, cellfun(@(x) x*...
            getappdata(figNew,'exfNew')-1, ydata, 'un',0))
    end %for
end %if
    function splitChannels(src, event, hFig)
        set(hFig, 'Visible', 'on')
        hList = allchild(masterBinHandles.menuDataMode);
        set(hList(1:3), 'Checked', 'off')
        set(hList(3), 'Checked', 'on')
    end
end

function render(src, event)
icon = getappdata(1, 'icons');
fig = gcbf;

figNew = figure(...
    'MenuBar', 'none',...
    'Toolbar','figure',...
    'DockControls', 'off',...
    'NumberTitle', 'off',...
    'Color', get(fig,'Color')-unifrnd(0.09,0.11,1,3),...
    'Visible', 'off');

switch getappdata(fig,'viewMode')
    case 'monoView'
        transferVarList(figNew,fig,'render-mono')
                
        switch get(src, 'Tag')
            case 'Image' %BUILD IMAGE
                
                %framerange selected
                idx = [-1; cumsum(getappdata(figNew,'ctrsN'))];
                if getappdata(fig,'rStart') == 1
                    setappdata(figNew,'startPnt',0)
                else
                    setappdata(figNew,'startPnt',...
                        idx(getappdata(fig,'rStart'))+1)
                end %if
                if isinf(getappdata(fig,'rEnd'))
                    setappdata(figNew,'rEnd',numel(getappdata(figNew,'ctrsN')))
                    setappdata(figNew,'elements',inf)
                else
                    setappdata(figNew,'elements',...
                        idx(getappdata(fig,'rEnd')+1)-...
                        max(1,getappdata(figNew,'startPnt'))+1)
                end %if
                
                %rendering
                roi = getappdata(fig,'roi');
                if getappdata(fig,'convMode') == 1
                    returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                else
                    returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                end %if
                data = preprocessData(figNew,returnVal,roi);
                
                [imRendered,width,height,N] = renderImage(data,roi,...
                    getappdata(figNew,'exfNew'),...
                    getappdata(figNew,'width'),...
                    getappdata(figNew,'height'),...
                    getappdata(figNew,'intWeight'),...
                    getappdata(figNew,'sizeFac'),...
                    getappdata(figNew,'pxSize'),...
                    getappdata(figNew,'convMode'));
                
                if getappdata(figNew,'isColormap')
                    imRendered = imprintColormap(...
                        imRendered,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        1);
                end
                if getappdata(figNew,'isScalebar')
                    imRendered = imprintScalebar(...
                        imRendered,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'), 1);
                end %if
                
                setappdata(figNew,'roiX0', roi(1))
                setappdata(figNew,'roiY0', roi(2))
                setappdata(figNew,'exfOld',getappdata(fig,'exfNew'))
                
                logInImage(figNew,[])
                set(figNew,...
                    'Name', sprintf('%s: %d/%d rendered',...
                    getappdata(figNew,'filename'),N,...
                    sum(getappdata(figNew,'ctrsN'))),...
                    'Units','normalized',...
                    'Position', figPos(width/height),...
                    'DeleteFcn', @logOutImage,...
                    'Visible', 'on')
                axes(...
                    'Parent', figNew,...
                    'Units','normalized',...
                    'Position', [0.05 0.05 0.9 0.9]);
                
                %customize toolbar
                hToolBar = findall(figNew,'Type','uitoolbar');
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.save, [1 1 3]),...
                    'ClickedCallback', {@saveImage,imRendered,'8bit'})
                uitoggletool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.roi, [1 1 3]),...
                    'ClickedCallback', @setROI)
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.colormap, [1 1 3]),...
                    'ClickedCallback', 'colormapeditor')
                uitoggletool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.options, [1 1 3]),...
                    'ClickedCallback', @setOptions)
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.opt2txt, [1 1 3]),...
                    'ClickedCallback', {@exportSettings, 'Image'})
                uipushtool(...
                    'Parent', hToolBar,...
                    'Tag', 'Particle Intensity',...
                    'CData', repmat(icon.intDist, [1 1 3]),...
                    'ClickedCallback', @intHist)
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.precDist, [1 1 3]),...
                    'ClickedCallback', @locPrec)
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.s2nDist, [1 1 3]),...
                    'ClickedCallback', @snrHist)
                uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.locDist, [1 1 3]),...
                    'ClickedCallback', @detectionTrace)
                uipushtool(...
                    'Parent', hToolBar,...
                    'Tag', 'Image',...
                    'CData', repmat(icon.genIm, [1 1 3]),...
                    'ClickedCallback', @render)
                uipushtool(...
                    'Parent', hToolBar,...
                    'Tag', 'Movie',...
                    'CData', repmat(icon.genMov, [1 1 3]),...
                    'ClickedCallback', @render)
                
                hToggleList = findall(hToolBar);
                delete(hToggleList([13:21 24:28]))
                
                %draw Image
                hImage = imshow(uint8(imRendered));
                setappdata(figNew,'hImage',hImage)
            case 'Movie' %BUILD MOVIE
                
                % create moviepreview
                roi = getappdata(fig,'roi');
                if getappdata(fig,'convMode') == 1
                    returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                else
                    returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                end %if
                
                previewFig = buildMoviePreview;
                colormapeditor
                uiwait(previewFig)
                
                % create movie
                %preallocate avi-file on harddisk
                [moviename,moviepath,isOK] =...
                    uiputfile('.avi' ,'Save Movie to',...
                    [getappdata(0,'searchPath') getappdata(fig,'filename')...
                    '_WinSize_' num2str(getappdata(fig,'rW'))...
                    '_Stepsize_' num2str(getappdata(fig,'rStep')) '_movie']);
                if isOK
                    %set movies colormap and compression method
                    comprssnMethod = {'RLE','MSVC','none'};
                    hMovie = avifile([moviepath moviename],...
                        'Colormap', cmap,...
                        'Compression', comprssnMethod{getappdata(fig,'movCompression')},...
                        'fps', getappdata(fig,'fps'));
                    
                    % create movieframes
                    hProgressbar = waitbar(0,'Generating Movie...','Color',...
                        get(0,'defaultUicontrolBackgroundColor'));
                    movieFrames = max(ceil((getappdata(fig,'rEnd')-...
                        getappdata(fig,'rStart')+1-...
                        getappdata(fig,'rW'))/getappdata(fig,'rStep')),1);
                    for movieFrame = 1:movieFrames;
                        %set datarange to load for movieframe
                        if movieFrame == 1
                            setappdata(figNew,'startPnt',...                                
                                idx(getappdata(figNew,'rStart'))+1); %check 11/03/10
                            setappdata(figNew,'elements',...
                                idx(getappdata(figNew,'rStart')+...
                                getappdata(figNew,'rW'))-...
                                max(1,getappdata(figNew,'startPnt'))+1); %check 11/03/10
                        elseif movieFrame == movieFrames
                            if getappdata(figNew,'isCumsum')
                                setappdata(figNew,'startPnt',...
                                    idx(getappdata(figNew,'rStart'))+1); %check 11/03/10
                            else
                                setappdata(figNew,'startPnt',...
                                    idx(getappdata(figNew,'rStart')+...
                                    (movieFrames-1)*getappdata(figNew,'rStep'))+1); %check 11/03/10
                            end %if
                            setappdata(figNew,'elements',...
                                idx(getappdata(figNew,'rEnd'))-...
                                getappdata(figNew,'startPnt')+1); %check 11/03/10
                        else
                            if getappdata(figNew,'isCumsum')
                                setappdata(figNew,'startPnt',...
                                    idx(getappdata(figNew,'rStart'))+1); %check 11/03/10
                            else
                                setappdata(figNew,'startPnt',...
                                    idx(getappdata(figNew,'rStart')+...
                                    (movieFrame-1)*getappdata(figNew,'rStep'))+1); %check 11/03/10
                            end %if
                            setappdata(figNew,'elements',...
                                idx(getappdata(figNew,'rStart')+...
                                (movieFrame-1)*getappdata(figNew,'rStep')+...
                                getappdata(figNew,'rW'))-...
                                getappdata(figNew,'startPnt')+1); %check 11/03/10
                        end %if
                        if getappdata(fig,'convMode') == 1
                            returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                        else
                            returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                        end %if
                        data = preprocessData(figNew,returnVal,roi);
                        [imMovie,width,height,N] = renderImage(data,roi,...
                            getappdata(fig,'exfNew'),...
                            getappdata(fig,'width'),...
                            getappdata(fig,'height'),...
                            getappdata(fig,'intWeight'),...
                            getappdata(fig,'sizeFac'),...
                            getappdata(fig,'pxSize'),...
                            getappdata(fig,'convMode'));
                        
                        if getappdata(fig,'isColormap')
                            imMovie = imprintColormap(...
                                imMovie,...
                                width,...
                                getappdata(fig,'colormapWidth'),...
                                1);
                        end
                        if getappdata(fig,'isScalebar')
                            imMovie = imprintScalebar(...
                                imMovie,...
                                width,...
                                height,...
                                getappdata(fig,'exfNew'),...
                                getappdata(fig,'micronBarLength'),...
                                getappdata(fig,'pxSize'),...
                                getappdata(fig,'timestampSize'),...
                                1);
                        end %if
                        if getappdata(fig,'isTimestamp')
                            imMovie = imprintTimestamp(...
                                imMovie,...
                                width,...
                                height,...
                                movieFrame*getappdata(fig,'timestampInkrement'),...
                                getappdata(fig,'timestampSize'),...
                                1);
                        end %if
                        
                        hMovie = addframe(hMovie, uint8(imMovie));
                        waitbar(movieFrame/movieFrames,hProgressbar,...
                            'Generating Movie...','Color',...
                            get(0,'defaultUicontrolBackgroundColor'));
                    end
                    delete(hProgressbar)
                    
                    %customize movie player
                    hMovie = close(hMovie);
                    mplay([moviepath moviename],...
                        getappdata(fig,'fps'));
                    
                    hList = allchild(gcf);
                    hChilds = allchild(hList(2));
                    hToolBar = hList(1);
                    copyobj(hChilds(1:4),hToolBar)
                    delete(hList(2))
                    uipushtool(...
                        'Parent', hToolBar,...
                        'CData', repmat(icon.opt2txt, [1 1 3]),...
                        'ClickedCallback', {@exportSettings, 'Movie'})
                    
                    set(gcf, 'Units', 'normalized',...
                        'Position', figPos(width/height),...
                        'Name', 'rendered Movie', 'DockControls', 'off')
                    set(findall(gcf, 'Type', 'uimenu'), 'Visible', 'off')
                else
                    return
                end %if
            case 'Track Image'
            case 'Track Movie'
        end %switch
    case 'dualView'
        %receive channel composition
        srcFig = getappdata(fig,'imSrcFig');
        imCh = getappdata(fig,'imCh');
        nImCh = getappdata(fig,'nImCh');
        trackSrcFig = getappdata(fig,'trackSrcFig');
        nTrackCh = getappdata(fig,'nTrackCh');
        
        switch get(src, 'Tag')
            case 'Image' %BUILD IMAGE
                for ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),'ctrsN'))];
                                                            
                    %%framerange selected
                    if getappdata(srcFig(ch),'rStart') == 1
                        setappdata(srcFig(ch),'startPnt',0)
                    else
                        setappdata(srcFig(ch),'startPnt',...
                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1)
                    end %if
                    if isinf(getappdata(srcFig(ch),'rEnd'))
                        setappdata(srcFig(ch),'elements',inf)
                    else
                        setappdata(srcFig(ch),'elements',...
                            idx{ch}(getappdata(srcFig(ch),'rEnd')+1)-...
                            max(1,getappdata(srcFig(ch),'startPnt'))+1)
                    end %if
                    
                    %rendering
                    roi = getappdata(srcFig(ch),'roi');
                    if getappdata(srcFig(ch),'convMode') == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    else
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    end %if
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    imRendered(:,:,ch) = renderImage(data,roi,...
                        getappdata(fig,'exfNew'),...
                        getappdata(srcFig(ch),'width'),...
                        getappdata(srcFig(ch),'height'),...
                        getappdata(srcFig(ch),'intWeight'),...
                        getappdata(srcFig(ch),'sizeFac'),...
                        getappdata(srcFig(ch),'pxSize'),...
                        getappdata(srcFig(ch),'convMode'));
                    
                end %for
                [height width depth] = size(imRendered);
                imRendered = cat(3,imRendered,...
                    zeros(height,width,3-depth));

                if getappdata(fig,'isColormap')
                    imRendered = imprintColormap(...
                        imRendered,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        2);
                end
                if getappdata(fig,'isScalebar')
                    imRendered = imprintScalebar(...
                        imRendered,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'),...
                        2);
                end %if
                if getappdata(fig,'isTimestamp')
                    imRendered = imprintTimestamp(...
                        imRendered,...
                        width,...
                        height,...
                        0.000,...
                        getappdata(fig,'timestampSize'),...
                        2);
                end %if

                  set(figNew,...
                    'Name', '',...
                    'Units','normalized',...
                    'Position', figPos(width/height),...
                    'Visible', 'on')
                axes(...
                    'Parent', figNew,...
                    'Units','normalized',...
                    'Position', [0.05 0.05 0.9 0.9]);

                %customize toolbar
                hToolBar = findall(figNew,'Type','uitoolbar');
                hToggleList = findall(hToolBar);
                    uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.save, [1 1 3]),...
                    'ClickedCallback', {@saveImage,imRendered,'8bit'})
                delete(hToggleList([2:10 13:17]))

                hImage = imshow(uint8(imRendered));
                setappdata(figNew,'hImage',hImage)
                
            case 'Movie' %BUILD MOVIE
                
                previewFig = buildMoviePreview;
                answer = questdlg('accept movie settings?',...
                    'Question','Yes','No','Yes');
                delete(previewFig)
                
                % create movie
                switch answer
                    case 'Yes'
                        %preallocate avi-file on harddisk
                        [moviename,moviepath,isOK] =...
                            uiputfile('.avi' ,'Save Movie to',...
                            [getappdata(0,'searchPath')...
                            moviename 'Stepsize_'...
                            num2str(getappdata(fig,'rStep')) '_movie']);
                        if isOK
                            %set movies colormap and compression method
                            hMovie = avifile([moviepath moviename],...
                                'Compression', 'none',... %no RLE MSVC for true color!
                                'fps', getappdata(fig,'fps'));
                            
                            % create movieframes
                            if nTrackCh > 0
                                set(figNew,...
                                    'Units','normalized',...
                                    'Position', [0 0 1 1],...
                                    'ToolBar', 'none',...
                                    'Resize', 'off',...
                                    'Name', 'Movie Preview',...
                                    'Visible', 'on');
                                ax =...
                                    axes(...
                                    'Parent', figNew,...
                                    'Units','normalized',...
                                    'Position', [0 0 1 1]);
                                for ch = 1:nTrackCh
                                    tracks{ch} = getappdata(trackSrcFig(ch),'tracks');
                                    
                                    movieFrames(3+ch) = ceil((getappdata(trackSrcFig(ch),'rEnd')-...
                                        getappdata(trackSrcFig(ch),'rStart')+1-...
                                        getappdata(trackSrcFig(ch),'rW'))/getappdata(fig,'rStep'));
                                end
                            else
                                delete(figNew)
                            end %if
                            
                            hProgressbar = waitbar(0,'Generating Movie...','Color',...
                                get(0,'defaultUicontrolBackgroundColor'));
                            
                            for movieFrame = 1:max(movieFrames)
                                imMovie = zeros(height,width,3);
                                for ch = imCh
                                    %set datarange to load for movieframe
                                    if movieFrame == 1
                                        setappdata(srcFig(ch),'startPnt',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart')+... 
                                            getappdata(srcFig(ch),'rW'))-...
                                            max(1,getappdata(srcFig(ch),'startPnt'))+1); %check 11/03/10
                                    elseif movieFrame >= movieFrames(ch)
                                        if getappdata(srcFig(ch),'isCumsum')
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        else
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                                (movieFrames(ch)-1)*getappdata(fig,'rStep'))+1); %check 11/03/10
                                        end %if
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rEnd'))-...
                                            getappdata(srcFig(ch),'startPnt')+1); %check 11/03/10
                                    else
                                        if getappdata(srcFig(ch),'isCumsum')
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        else
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                                (movieFrame-1)*getappdata(fig,'rStep'))+1); %check 11/03/10
                                        end %if
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                            (movieFrame-1)*getappdata(fig,'rStep')+...
                                            getappdata(srcFig(ch),'rW'))-...
                                            getappdata(srcFig(ch),'startPnt')+1); %check 11/03/10
                                    end %if

                                    roi = getappdata(srcFig(ch),'roi');
                                    if getappdata(srcFig(ch),'convMode') == 1
                                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                                    else
                                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                                    end %if
                                    data = preprocessData(srcFig(ch),returnVal,roi);
                                    imMovie(:,:,ch) = renderImage(data,roi,...
                                        getappdata(fig,'exfNew'),...
                                        getappdata(srcFig(ch),'width'),...
                                        getappdata(srcFig(ch),'height'),...
                                        getappdata(srcFig(ch),'intWeight'),...
                                        getappdata(srcFig(ch),'sizeFac'),...
                                        getappdata(srcFig(ch),'pxSize'),...
                                        getappdata(srcFig(ch),'convMode'));
                                end %for
                                
                                if getappdata(fig,'isColormap')
                                    imMovie = imprintColormap(...
                                        imMovie,...
                                        width,...
                                        getappdata(fig,'colormapWidth'),...
                                        2);
                                end
                                if getappdata(fig,'isScalebar')
                                    imMovie = imprintScalebar(...
                                        imMovie,...
                                        width,...
                                        height,...
                                        getappdata(fig,'exfNew'),...
                                        getappdata(fig,'micronBarLength'),...
                                        getappdata(fig,'pxSize'),...
                                        getappdata(fig,'timestampSize'),...
                                        2);
                                end %if
                                if getappdata(fig,'isTimestamp')
                                    imMovie = imprintTimestamp(...
                                        imMovie,...
                                        width,...
                                        height,...
                                        movieFrame*getappdata(fig,'timestampInkrement'),...
                                        getappdata(fig,'timestampSize'),...
                                        2);
                                end %if
                                
                                if nTrackCh > 0
                                    imshow(uint8(imMovie), 'Parent', ax);
                                    for ch = 1:nTrackCh
                                        if movieFrame == 1
                                            tracksize = cellfun('size',tracks{ch},1);
                                            if isinf(getappdata(trackSrcFig(ch),'maxTracksize'))
                                                hasSize = tracksize >= getappdata(trackSrcFig(ch),'minTracksize');
                                            else
                                                hasSize = tracksize >= getappdata(trackSrcFig(ch),'minTracksize') &...
                                                    tracksize <= getappdata(trackSrcFig(ch),'maxTracksize');
                                            end %if
                                            tracks{ch} = tracks{ch}(hasSize);
                                            
                                            cmap = getappdata(trackSrcFig(ch),'trackColor');
                                            switch getappdata(trackSrcFig(ch),'trackColorMode')
                                                case 2
                                                    trackList{ch} = cell2mat(cellfun(...
                                                        @(x) x(:,1:4),tracks{ch}','Un',0));
                                                    listIdxs = accumarray(trackList{ch}(:,4),...
                                                        1:size(trackList{ch},1),[], @(x) {x});
                                                case 1
                                                    
                                                    trackList{ch} = cell2mat(cellfun(...
                                                        @(x) [x(:,1:3);nan nan nan],tracks{ch}','Un',0));
                                            end %switch
                                            if 1
                                                insideRoi{ch} = true(size(trackList{ch},1),1);
                                            else
                                                insideRoi{ch} =...
                                                    trackList{ch} > roi(1) &...
                                                    trackList{ch}(:,1) < roi(1)+roi(3) &...
                                                    trackList{ch}(:,2) > roi(2) &...
                                                    trackList{ch}(:,2) < roi(2)+roi(4) |...
                                                    isnan(trackList{ch}(:,3));
                                                trackList{ch}(:,1) = trackList{ch}(:,1)-roi(1);
                                                trackList{ch}(:,2) = trackList{ch}(:,2)-roi(2);
                                            end %if
                                            good = insideRoi{ch} &...
                                                trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart')+...
                                                getappdata(trackSrcFig(ch),'rW')-1 |...
                                                isnan(trackList{ch}(:,3)) ;
                                        elseif movieFrame >= movieFrames(3+ch)
                                            if getappdata(trackSrcFig(ch),'isCumsum')
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rEnd') |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            else
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >=...
                                                    (getappdata(trackSrcFig(ch),'rStart')+...
                                                    movieFrame*getappdata(fig,'rStep')) &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rEnd') |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            end %if
                                        else
                                            if getappdata(trackSrcFig(ch),'isCumsum')
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart') +...
                                                    movieFrame*getappdata(fig,'rStep') +...
                                                    getappdata(trackSrcFig(ch),'rW')-1 |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            else
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >=...
                                                    (getappdata(trackSrcFig(ch),'rStart') +...
                                                    movieFrame*getappdata(fig,'rStep')) &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart') +...
                                                    getappdata(trackSrcFig(ch),'rW')-1 |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            end %if
                                        end %if
                                        
                                        cmap = getappdata(trackSrcFig(ch),'trackColor');
                                        switch getappdata(trackSrcFig(ch),'trackColorMode')
                                            case 2
                                                for id = unique(trackList{ch}(good,4))'
                                                    line(...
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),1)*getappdata(fig,'exfNew')-1,...
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),2)*getappdata(fig,'exfNew')-1,...
                                                        'Color', cmap{2}(id,:),...
                                                        'LineWidth', getappdata(trackSrcFig(ch),'trackWidth'),...
                                                        'Parent', ax);
                                                end
                                            case 1
                                                line(...
                                                    trackList{ch}(good,1)*getappdata(fig,'exfNew')-1,...
                                                    trackList{ch}(good,2)*getappdata(fig,'exfNew')-1,...
                                                    'Color', cmap{1},...
                                                    'LineWidth', getappdata(trackSrcFig(ch),'trackWidth'),...
                                                    'Parent', ax);
                                        end %switch
                                    end %for
                                    drawnow
                                    tmpImMovie = getframe(ax);
                                    hMovie = addframe(hMovie,uint8(tmpImMovie.cdata));
                                else
                                    hMovie = addframe(hMovie, uint8(imMovie));
                                end %if
                                
                                waitbar(movieFrame/max(movieFrames),hProgressbar,...
                                    'Generating Movie...','Color',...
                                    get(0,'defaultUicontrolBackgroundColor'));
                            end %for
                        end %if
                        delete(hProgressbar)
                        
                        %customize movie player
                        %customize movie player
                        hMovie = close(hMovie);
                        mplay([moviepath moviename],...
                            getappdata(fig,'fps'));
                        
                        hList = allchild(gcf);
                        hChilds = allchild(hList(2));
                        hToolBar = hList(1);
                        copyobj(hChilds(1:4),hToolBar)
                        delete(hList(2))
                        uipushtool(...
                            'Parent', hToolBar,...
                            'CData', repmat(icon.opt2txt, [1 1 3]),...
                            'ClickedCallback', {@exportSettings, 'Movie'})
                        
                        set(gcf, 'Units', 'normalized',...
                            'Position', figPos(width/height),...
                            'Name', 'rendered Movie', 'DockControls', 'off')
                        set(findall(gcf, 'Type', 'uimenu'), 'Visible', 'off')
                    case 'No'
                        return
                end %switch
        end %switch
    case 'tripleView'
        %receive channel composition
        srcFig = getappdata(fig,'imSrcFig');
        imCh = getappdata(fig,'imCh');
        nImCh = getappdata(fig,'nImCh');
        trackSrcFig = getappdata(fig,'trackSrcFig');
        nTrackCh = getappdata(fig,'nTrackCh');
        
        switch get(src, 'Tag')
            case 'Image' %BUILD IMAGE
                                for ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),'ctrsN'))];
                                                            
                    %%framerange selected
                    if getappdata(srcFig(ch),'rStart') == 1
                        setappdata(srcFig(ch),'startPnt',0)
                    else
                        setappdata(srcFig(ch),'startPnt',...
                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1)
                    end %if
                    if isinf(getappdata(srcFig(ch),'rEnd'))
                        setappdata(srcFig(ch),'elements',inf)
                    else
                        setappdata(srcFig(ch),'elements',...
                            idx{ch}(getappdata(srcFig(ch),'rEnd')+1)-...
                            max(1,getappdata(srcFig(ch),'startPnt'))+1)
                    end %if
                    
                    %rendering
                    roi = getappdata(srcFig(ch),'roi');
                    if getappdata(srcFig(ch),'convMode') == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    else
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    end %if
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    imRendered(:,:,ch) = renderImage(data,roi,...
                        getappdata(fig,'exfNew'),...
                        getappdata(srcFig(ch),'width'),...
                        getappdata(srcFig(ch),'height'),...
                        getappdata(srcFig(ch),'intWeight'),...
                        getappdata(srcFig(ch),'sizeFac'),...
                        getappdata(srcFig(ch),'pxSize'),...
                        getappdata(srcFig(ch),'convMode'));
                    
                end %for
                [height width depth] = size(imRendered);
                imRendered = cat(3,imRendered,...
                    zeros(height,width,3-depth));

                if getappdata(fig,'isColormap')
                    imRendered = imprintColormap(...
                        imRendered,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        3);
                end
                if getappdata(fig,'isScalebar')
                    imRendered = imprintScalebar(...
                        imRendered,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'),...
                        3);
                end %if
                if getappdata(fig,'isTimestamp')
                    imRendered = imprintTimestamp(...
                        imRendered,...
                        width,...
                        height,...
                        0.000,...
                        getappdata(fig,'timestampSize'),...
                        3);
                end %if

                  set(figNew,...
                    'Name', '',...
                    'Units','normalized',...
                    'Position', figPos(width/height),...
                    'Visible', 'on')
                axes(...
                    'Parent', figNew,...
                    'Units','normalized',...
                    'Position', [0.05 0.05 0.9 0.9]);

                %customize toolbar
                hToolBar = findall(figNew,'Type','uitoolbar');
                hToggleList = findall(hToolBar);
                    uipushtool(...
                    'Parent', hToolBar,...
                    'CData', repmat(icon.save, [1 1 3]),...
                    'ClickedCallback', {@saveImage,imRendered,'8bit'})
                delete(hToggleList(2:end))

                hImage = imshow(uint8(imRendered));
                setappdata(figNew,'hImage',hImage)

            case 'Movie' %BUILD MOVIE
                                
                previewFig = buildMoviePreview;
                answer = questdlg('accept movie settings?',...
                    'Question','Yes','No','Yes');
                delete(previewFig)
                
                % create movie
                switch answer
                    case 'Yes'
                        %preallocate avi-file on harddisk
                        %preallocate avi-file on harddisk
                        [moviename,moviepath,isOK] =...
                            uiputfile('.avi' ,'Save Movie to',...
                            [getappdata(0,'searchPath')...
                            moviename 'Stepsize_'...
                            num2str(getappdata(fig,'rStep')) '_movie']);
                        if isOK
                            %set movies colormap and compression method
                            hMovie = avifile([moviepath moviename],...
                                'Compression', 'none',... %no RLE MSVC for true color!
                                'fps', getappdata(fig,'fps'));
                            
                            % create movieframes
                            if nTrackCh > 0
                                set(figNew,...
                                    'Units','normalized',...
                                    'Position', [0 0 1 1],...
                                    'ToolBar', 'none',...
                                    'Resize', 'off',...
                                    'Name', 'Movie Preview',...
                                    'Visible', 'on');
                                ax =...
                                    axes(...
                                    'Parent', figNew,...
                                    'Units','normalized',...
                                    'Position', [0 0 1 1]);
                                for ch = 1:nTrackCh
                                    tracks{ch} = getappdata(trackSrcFig(ch),'tracks');
                                    
                                    movieFrames(3+ch) = ceil((getappdata(trackSrcFig(ch),'rEnd')-...
                                        getappdata(trackSrcFig(ch),'rStart')+1-...
                                        getappdata(trackSrcFig(ch),'rW'))/getappdata(fig,'rStep'));
                                end
                            else
                                delete(figNew)
                            end %if
                            
                            hProgressbar = waitbar(0,'Generating Movie...','Color',...
                                get(0,'defaultUicontrolBackgroundColor'));
                            for movieFrame = 1:max(movieFrames)
                                imMovie = zeros(height,width,3);
                                for ch = imCh
                                    %set datarange to load for movieframe
                                    if movieFrame == 1
                                        setappdata(srcFig(ch),'startPnt',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart')+... 
                                            getappdata(srcFig(ch),'rW'))-...
                                            max(1,getappdata(srcFig(ch),'startPnt'))+1); %check 11/03/10
                                    elseif movieFrame >= movieFrames(ch)
                                        if getappdata(srcFig(ch),'isCumsum')
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        else
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                                (movieFrames(ch)-1)*getappdata(fig,'rStep'))+1); %check 11/03/10
                                        end %if
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rEnd'))-...
                                            getappdata(srcFig(ch),'startPnt')+1); %check 11/03/10
                                    else
                                        if getappdata(srcFig(ch),'isCumsum')
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        else
                                            setappdata(srcFig(ch),'startPnt',...
                                                idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                                (movieFrame-1)*getappdata(fig,'rStep'))+1); %check 11/03/10
                                        end %if
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart')+...
                                            (movieFrame-1)*getappdata(fig,'rStep')+...
                                            getappdata(srcFig(ch),'rW'))-...
                                            getappdata(srcFig(ch),'startPnt')+1); %check 11/03/10
                                    end %if
                                    roi = getappdata(srcFig(ch),'roi');
                                    if getappdata(srcFig(ch),'convMode') == 1
                                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                                    else
                                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                                    end %if
                                    data = preprocessData(srcFig(ch),returnVal,roi);
                                    imMovie(:,:,ch) = renderImage(data,roi,...
                                        getappdata(fig,'exfNew'),...
                                        getappdata(srcFig(ch),'width'),...
                                        getappdata(srcFig(ch),'height'),...
                                        getappdata(srcFig(ch),'intWeight'),...
                                        getappdata(srcFig(ch),'sizeFac'),...
                                        getappdata(srcFig(ch),'pxSize'),...
                                        getappdata(srcFig(ch),'convMode'));
                                end %for
                                
                                if getappdata(fig,'isColormap')
                                    imMovie = imprintColormap(...
                                        imMovie,...
                                        width,...
                                        getappdata(fig,'colormapWidth'),...
                                        3);
                                end
                                if getappdata(fig,'isScalebar')
                                    imMovie = imprintScalebar(...
                                        imMovie,...
                                        width,...
                                        height,...
                                        getappdata(fig,'exfNew'),...
                                        getappdata(fig,'micronBarLength'),...
                                        getappdata(fig,'pxSize'),...
                                        getappdata(fig,'timestampSize'),...
                                        3);
                                end %if
                                if getappdata(fig,'isTimestamp')
                                    imMovie = imprintTimestamp(...
                                        imMovie,...
                                        width,...
                                        height,...
                                        movieFrame*getappdata(fig,'timestampInkrement'),...
                                        getappdata(fig,'timestampSize'),...
                                        3);
                                end %if
                                
                                if nTrackCh > 0
                                    imshow(uint8(imMovie), 'Parent', ax);
                                    for ch = 1:nTrackCh
                                        if movieFrame == 1
                                            tracksize = cellfun('size',tracks{ch},1);
                                            if isinf(getappdata(trackSrcFig(ch),'maxTracksize'))
                                                hasSize = tracksize >= getappdata(trackSrcFig(ch),'minTracksize');
                                            else
                                                hasSize = tracksize >= getappdata(trackSrcFig(ch),'minTracksize') &...
                                                    tracksize <= getappdata(trackSrcFig(ch),'maxTracksize');
                                            end %if
                                            tracks{ch} = tracks{ch}(hasSize);
                                            
                                            cmap = getappdata(trackSrcFig(ch),'trackColor');
                                            switch getappdata(trackSrcFig(ch),'trackColorMode')
                                                case 2
                                                    trackList{ch} = cell2mat(cellfun(...
                                                        @(x) x(:,1:4),tracks{ch}','Un',0));
                                                    listIdxs = accumarray(trackList{ch}(:,4),...
                                                        1:size(trackList{ch},1),[], @(x) {x});
                                                case 1
                                                    
                                                    trackList{ch} = cell2mat(cellfun(...
                                                        @(x) [x(:,1:3);nan nan nan],tracks{ch}','Un',0));
                                            end %switch
                                            if 1
                                                insideRoi{ch} = true(size(trackList{ch},1),1);
                                            else
                                                insideRoi{ch} =...
                                                    trackList{ch} > roi(1) &...
                                                    trackList{ch}(:,1) < roi(1)+roi(3) &...
                                                    trackList{ch}(:,2) > roi(2) &...
                                                    trackList{ch}(:,2) < roi(2)+roi(4) |...
                                                    isnan(trackList{ch}(:,3));
                                                trackList{ch}(:,1) = trackList{ch}(:,1)-roi(1);
                                                trackList{ch}(:,2) = trackList{ch}(:,2)-roi(2);
                                            end %if
                                            good = insideRoi{ch} &...
                                                trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart')+...
                                                getappdata(trackSrcFig(ch),'rW')-1 |...
                                                isnan(trackList{ch}(:,3)) ;
                                        elseif movieFrame >= movieFrames(3+ch)
                                            if getappdata(trackSrcFig(ch),'isCumsum')
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rEnd') |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            else
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >=...
                                                    (getappdata(trackSrcFig(ch),'rStart')+...
                                                    movieFrame*getappdata(fig,'rStep')) &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rEnd') |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            end %if
                                        else
                                            if getappdata(trackSrcFig(ch),'isCumsum')
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >= getappdata(trackSrcFig(ch),'rStart') &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart') +...
                                                    movieFrame*getappdata(fig,'rStep') +...
                                                    getappdata(trackSrcFig(ch),'rW')-1 |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            else
                                                good = insideRoi{ch} &...
                                                    trackList{ch}(:,3) >=...
                                                    (getappdata(trackSrcFig(ch),'rStart') +...
                                                    movieFrame*getappdata(fig,'rStep')) &...
                                                    trackList{ch}(:,3) <= getappdata(trackSrcFig(ch),'rStart') +...
                                                    getappdata(trackSrcFig(ch),'rW')-1 |...
                                                    isnan(trackList{ch}(:,3)) ;
                                            end %if
                                        end %if
                                        
                                        cmap = getappdata(trackSrcFig(ch),'trackColor');
                                        switch getappdata(trackSrcFig(ch),'trackColorMode')
                                            case 2
                                                for id = unique(trackList{ch}(good,4))'
                                                    line(...
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),1)*getappdata(fig,'exfNew')-1,...
                                                        trackList{ch}(listIdxs{id}(good(listIdxs{id})),2)*getappdata(fig,'exfNew')-1,...
                                                        'Color', cmap{2}(id,:),...
                                                        'LineWidth', getappdata(trackSrcFig(ch),'trackWidth'),...
                                                        'Parent', ax);
                                                end
                                            case 1
                                                line(...
                                                    trackList{ch}(good,1)*getappdata(fig,'exfNew')-1,...
                                                    trackList{ch}(good,2)*getappdata(fig,'exfNew')-1,...
                                                    'Color', cmap{1},...
                                                    'LineWidth', getappdata(trackSrcFig(ch),'trackWidth'),...
                                                    'Parent', ax);
                                        end %switch
                                    end %for
                                    drawnow
                                    tmpImMovie = getframe(ax);
                                    hMovie = addframe(hMovie,uint8(tmpImMovie.cdata));
                                else
                                    hMovie = addframe(hMovie, uint8(imMovie));
                                end %if
                                
                                waitbar(movieFrame/max(movieFrames),hProgressbar,...
                                    'Generating Movie...','Color',...
                                    get(0,'defaultUicontrolBackgroundColor'));
                            end %for
                        end %if
                        delete(hProgressbar)
                        
                        %customize movie player
                        %customize movie player
                        hMovie = close(hMovie);
                        mplay([moviepath moviename],...
                            getappdata(fig,'fps'));
                        
                        hList = allchild(gcf);
                        hChilds = allchild(hList(2));
                        hToolBar = hList(1);
                        copyobj(hChilds(1:4),hToolBar)
                        delete(hList(2))
                        uipushtool(...
                            'Parent', hToolBar,...
                            'CData', repmat(icon.opt2txt, [1 1 3]),...
                            'ClickedCallback', {@exportSettings, 'Movie'})
                        
                        set(gcf, 'Units', 'normalized',...
                            'Position', figPos(width/height),...
                            'Name', 'rendered Movie', 'DockControls', 'off')
                        set(findall(gcf, 'Type', 'uimenu'), 'Visible', 'off')
                    case 'No'
                        return
                end %switch
        end %switch
end %switch
    function passCmap(src, event)
        cmap = get(src, 'Colormap');
    end
    function previewFig = buildMoviePreview
        switch getappdata(fig,'viewMode')
            case 'monoView'
                idx = [-1; cumsum(getappdata(fig,'ctrsN'))];
                
                %first movieframe
                            setappdata(figNew,'startPnt',...                                
                                idx(getappdata(figNew,'rStart'))+1); %check 11/03/10
                            setappdata(figNew,'elements',...
                                idx(getappdata(figNew,'rStart')+...
                                getappdata(figNew,'rW'))-...
                                max(1,getappdata(figNew,'startPnt'))+1); %check 11/03/10
                
                data = preprocessData(figNew,returnVal,roi);
                [movieFrame,width,height,N] = renderImage(data,roi,...
                    getappdata(fig,'exfNew'),...
                    getappdata(fig,'width'),...
                    getappdata(fig,'height'),...
                    getappdata(fig,'intWeight'),...
                    getappdata(fig,'sizeFac'),...
                    getappdata(fig,'pxSize'),...
                    getappdata(fig,'convMode'));
                
                %movie z-Projection
                if getappdata(fig,'rStart') == 1
                    setappdata(figNew,'startPnt',0)
                else
                    setappdata(figNew,'startPnt',...
                        idx(getappdata(fig,'rStart'))+1)
                end %if
                if isinf(getappdata(fig,'rEnd'))
                    setappdata(figNew,'rEnd',numel(getappdata(fig,'ctrsN')))
                    setappdata(figNew,'elements',inf)
                else
                    setappdata(figNew,'elements',...
                        idx(getappdata(fig,'rEnd')+1)-...
                        max(1,getappdata(figNew,'startPnt'))+1)
                end %if
                data = preprocessData(figNew,returnVal,roi);
                movieProj = renderImage(data,roi,...
                    getappdata(fig,'exfNew'),...
                    getappdata(fig,'width'),...
                    getappdata(fig,'height'),...
                    getappdata(fig,'intWeight'),...
                    getappdata(fig,'sizeFac'),...
                    getappdata(fig,'pxSize'),...
                    getappdata(fig,'convMode'));
                
                mask = find(poly2mask([0 0 width],...
                    [0 height height], height, width));
                movieProj(mask) = movieFrame(mask);
                
                if getappdata(fig,'isColormap')
                    movieProj = imprintColormap(...
                        movieProj,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        1);
                end
                if getappdata(fig,'isScalebar')
                    movieProj = imprintScalebar(...
                        movieProj,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'),...
                        1);
                end %if
                if getappdata(fig,'isTimestamp')
                    movieProj = imprintTimestamp(...
                        movieProj,...
                        width,...
                        height,...
                        0.000,...
                        getappdata(fig,'timestampSize'),...
                        1);
                end %if                
            otherwise
                moviename = [];
                for ch = imCh
                    idx{ch} = [-1; cumsum(getappdata(srcFig(ch),'ctrsN'))];
                    
                    roi = getappdata(srcFig(ch),'roi');
                    if getappdata(srcFig(ch),'convMode') == 1
                        returnVal = [1 1 0 0 0 0 0 1 0 0 0 0];
                    else
                        returnVal = [1 1 0 0 0 0 0 1 1 0 0 0];
                    end %if
                    
                    %first movieframe
                                        setappdata(srcFig(ch),'startPnt',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1); %check 11/03/10
                                        setappdata(srcFig(ch),'elements',...
                                            idx{ch}(getappdata(srcFig(ch),'rStart')+... 
                                            getappdata(srcFig(ch),'rW'))-...
                                            max(1,getappdata(srcFig(ch),'startPnt'))+1); %check 11/03/10
                    
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    [movieFrame(:,:,ch),width(ch),height(ch),N(ch)] = renderImage(data,roi,...
                        getappdata(fig,'exfNew'),...
                        getappdata(srcFig(ch),'width'),...
                        getappdata(srcFig(ch),'height'),...
                        getappdata(srcFig(ch),'intWeight'),...
                        getappdata(srcFig(ch),'sizeFac'),...
                        getappdata(srcFig(ch),'pxSize'),...
                        getappdata(srcFig(ch),'convMode'));
                    
                    %%movie z-Projection
                    if getappdata(srcFig(ch),'rStart') == 1
                        setappdata(srcFig(ch),'startPnt',0)
                    else
                        setappdata(srcFig(ch),'startPnt',...
                            idx{ch}(getappdata(srcFig(ch),'rStart'))+1)
                    end %if
                    if isinf(getappdata(srcFig(ch),'rEnd'))
                        setappdata(srcFig(ch),'elements',inf)
                    else
                        setappdata(srcFig(ch),'elements',...
                            idx{ch}(getappdata(srcFig(ch),'rEnd')+1)-...
                            max(1,getappdata(srcFig(ch),'startPnt'))+1)
                    end %if
                    
                    data = preprocessData(srcFig(ch),returnVal,roi);
                    movieProj(:,:,ch) = renderImage(data,roi,...
                        getappdata(fig,'exfNew'),...
                        getappdata(srcFig(ch),'width'),...
                        getappdata(srcFig(ch),'height'),...
                        getappdata(srcFig(ch),'intWeight'),...
                        getappdata(srcFig(ch),'sizeFac'),...
                        getappdata(srcFig(ch),'pxSize'),...
                        getappdata(srcFig(ch),'convMode'));
                    
                    mask = find(poly2mask([0 0 width(ch)],...
                        [0 height(ch) height(ch)], height(ch), width(ch)));
                    movieProj(mask+(ch-1)*width(ch)*height(ch)) =...
                        movieFrame(mask+(ch-1)*width(ch)*height(ch));
                                        
                    movieFrames(ch) = max(ceil((getappdata(srcFig(ch),'rEnd')-...
                        getappdata(srcFig(ch),'rStart')+1-...
                        getappdata(srcFig(ch),'rW'))/getappdata(fig,'rStep')),1);
                    moviename = [moviename getappdata(srcFig(ch),'filename')...
                        '_WinSize_' num2str(getappdata(srcFig(imCh(1)),'rW')) '_'];
                end %for
                [height width depth] = size(movieProj);
                movieProj = cat(3,movieProj,...
                    zeros(height,width,3-depth));
                
                switch getappdata(fig,'viewMode')
                    case 'dualView'
                if getappdata(fig,'isColormap')
                    movieProj = imprintColormap(...
                        movieProj,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        2);
                end
                if getappdata(fig,'isScalebar')
                    movieProj = imprintScalebar(...
                        movieProj,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'),...
                        2);
                end %if
                if getappdata(fig,'isTimestamp')
                    movieProj = imprintTimestamp(...
                        movieProj,...
                        width,...
                        height,...
                        0.000,...
                        getappdata(fig,'timestampSize'),...
                        2);
                end %if
                    case 'tripleView'
                if getappdata(fig,'isColormap')
                    movieProj = imprintColormap(...
                        movieProj,...
                        width,...
                        getappdata(fig,'colormapWidth'),...
                        3);
                end
                if getappdata(fig,'isScalebar')
                    movieProj = imprintScalebar(...
                        movieProj,...
                        width,...
                        height,...
                        getappdata(fig,'exfNew'),...
                        getappdata(fig,'micronBarLength'),...
                        getappdata(fig,'pxSize'),...
                        getappdata(fig,'timestampSize'),...
                        3);
                end %if
                if getappdata(fig,'isTimestamp')
                    movieProj = imprintTimestamp(...
                        movieProj,...
                        width,...
                        height,...
                        0.000,...
                        getappdata(fig,'timestampSize'),...
                        3);
                end %if
                end %switch
        end %switch
        
        %open preview window
        previewFig = figure(...
            'Units','normalized',...
            'Position', figPos(width/height),...
            'Name', 'Movie Preview',...
            'ToolBar', 'none',...
            'Menubar', 'none',...
            'DockControls', 'off',...
            'NumberTitle', 'off',...
            'DeleteFcn', @passCmap,...
            'Visible', 'on');
        
        previewAx =...
            axes(...
            'Parent', previewFig,...
            'Units','normalized',...
            'Position', [0 0 1 1]);
        
        imshow(uint8(movieProj),...
            'Parent',previewAx);
        
        line([0 width],[0 height],...
            'Color', [1 1 1], 'LineWidth', 3)
        text(0.25*width,0.75*height,'Frame 1',...
            'Fontsize',15, 'Color', [1 1 1],...
            'HorizontalAlignment','center')
        text(0.75*width,0.25*height,'Accumulate',...
            'Fontsize',15, 'Color', [1 1 1],...
            'HorizontalAlignment','center')
        
    end
end
function [rI,width,height,N] = renderImage(data,roi,exf,width,height,intWeight,sizeFac,pxSize,mode)
%calculate right-sided edges of pixels for superres image
edgeY = (1:height*exf)/exf;
edgeX = (1:width*exf)/exf;

%calculate size of superres image
y0 = find(edgeY >= roi(2), 1, 'first');
y1 = find(edgeY >= roi(2)+roi(4), 1, 'first');
x0 = find(edgeX >= roi(1), 1, 'first');
x1 = find(edgeX >= roi(1)+roi(3), 1, 'first');

%preallocate superres image
height = y1-y0+1; width = x1-x0+1;
rI = zeros(height,width);

size(data.ctrsX)

if ~isempty(data.ctrsX) && ~isempty(data.ctrsY) && ~isempty(data.photons) 
    switch mode
        case 2 %dynamic
            lp2pix = (data.precision/(pxSize/exf)).^2*sizeFac^2;

            [cntY yc] = histc(data.ctrsY, edgeY(y0:y1));
            [cntX xc] = histc(data.ctrsX, edgeX(x0:x1));

            N=0;       
            for i=1:numel(xc)
                w = ceil(6*sqrt(lp2pix(i)));            
                if xc(i) - w >= 1 &&...
                        xc(i) + w < ceil(roi(3)*exf) &&...
                        yc(i) - w >= 1 &&...
                        yc(i) + w < ceil(roi(4)*exf)
                    N = N+1;                

    refi = (1:w)-floor(w/2)+yc(i);               
    ii = (refi-(data.ctrsY(i)-roi(2))*exf)' * ones(1,w) ;
    refj = (1:w)-floor(w/2)+xc(i);
    jj = ones(w,1) * (refj-(data.ctrsX(i)-roi(1))*exf) ;

    rI((1:w)-floor(w/2)+yc(i),...
        (1:w)-floor(w/2)+xc(i)) = ...
        rI((1:w)-floor(w/2)+yc(i),...
        (1:w)-floor(w/2)+xc(i)) +...
        intWeight*data.photons(i)/(2*pi*lp2pix(i))*...
        exp(-(1/(2*lp2pix(i)))*(ii.*ii + jj.*jj)) ;
                end %if
            end %for        
        case 1 %fixed
            N = numel(data.photons); %count # rendered particles

            %calculate linear indices of particle detection for 2d-matrix
            [cntY idxY] = histc(data.ctrsY, edgeY(y0:y1));
            [cntX idxX] = histc(data.ctrsX, edgeX(x0:x1));
            linIdx = idxX*height+idxY+1;
            [linIdx unused good] = unique(linIdx);

            rI(linIdx) = accumarray(good,intWeight);
            psf = buildPSF(sizeFac,width,height);
            rI = fftshift(ifft2(fft2(rI).* psf));
    end %switch
end %if

end
function I = imprintColormap(I, width, mapHeight, mode)
if mode == 1
    colorRamp = repmat(round(linspace(0, 255, width)),...
        mapHeight,1);
    I(end-mapHeight+1:end,:) = colorRamp;
else
    cmapWidth = floor(width/4);
    colorRamp = round(linspace(0, 255, cmapWidth));
    colorRamp = repmat([colorRamp,...
        ones(1,cmapWidth)*255, fliplr(colorRamp),...
        zeros(1,width-3*cmapWidth)],mapHeight,1);
    if mode == 3
        colorRamp3D = repmat(round(linspace(0, 255,...
            mapHeight))',1,width);
        I(end-mapHeight+1:end,:,:) =...
            cat(3,colorRamp, fliplr(colorRamp), colorRamp3D);
    else
        I(end-mapHeight+1:end,:,:) =...
            cat(3,colorRamp, fliplr(colorRamp), colorRamp*0);
    end %if
end %if
end
function I = imprintScalebar(I, width, height,...
    exf, barLength, pxSize, sizeFac, mode)
barUnit = pxChars(height,width,...
    [num2str(barLength) 'nm'],sizeFac);

pxBarLength = round(barLength/(1000*pxSize/exf));
pxBarHeight = ceil(max(exf/3,pxBarLength/20));
bar = ones(pxBarHeight,pxBarLength);

tmp = size(bar,2)-size(barUnit,2);
if tmp > 0
    bar = [[zeros(size(barUnit,1),floor(tmp/2)),...
        barUnit, zeros(size(barUnit,1),ceil(tmp/2))];...
        zeros(2,size(bar,2)); bar];
elseif tmp < 0
    bar = [barUnit;zeros(2,size(barUnit,2));...
        [zeros(pxBarHeight,floor(-tmp/2)),bar,...
        zeros(pxBarHeight,ceil(-tmp/2))]];
else
    bar = [barUnit;zeros(2,size(bar,2));bar];
end %sif

barOffsetX = 4*pxBarHeight;
barOffsetY = 4*pxBarHeight;
offset = height*(width-(size(bar,2)+barOffsetX))+barOffsetY;
idx = find([bar;zeros(height-size(bar,1),...
    size(bar,2))])+offset;

if mode == 1
    I(idx) = 255;
else
    I([idx;idx+height*width;idx+2*height*width]) = 255;
end %if
end
function I = imprintTimestamp(I, width, height,...
    time, sizeFac, mode)
stamp = pxChars(height,width,...
    [strrep(num2str(time, '%.3f'),'.','p') '_S'],...
    sizeFac);

barOffsetX = ceil(max(sizeFac*2,size(stamp,2)/5));
barOffsetY = barOffsetX;

idx = find([stamp;zeros(height-size(stamp,1),size(stamp,2))])+...
    barOffsetX*height+barOffsetY;
if mode == 1
    I(idx) = 255;
else
    I([idx;idx+height*width;idx+2*height*width]) = 255;
end %if
end

function zProject(src, event)
icon = getappdata(1, 'icons');
fig = gcbf;

%search for ROI
if isempty(getappdata(fig,'hROI'))
    roi = [1 1 ...
        getappdata(fig,'width') getappdata(fig,'height')];
else
    roi = ceil(getappdata(fig,'roi'));
end
region = {[roi(2) roi(2)+roi(4)-1],...
    [roi(1) roi(1)+roi(3)-1]};

hProgressbar = waitbar(0,'Processing...','Color',...
    get(0,'defaultUicontrolBackgroundColor'));
imageName = strcat(getappdata(fig,'pathname'),...
    getappdata(fig,'filename'));
if getappdata(fig,'isSuperstack')
    for stack = 1:numel(imageName)
        info = imfinfo(imageName{stack});
        frames = numel(info);
        if stack == 1 %initialize image
            I = double(imread(imageName{stack}, 1,...
                'info', info, 'PixelRegion', region));
        end %if
        for frame = 2:frames
            switch get(src, 'Tag')
                case 'max. Intensity'
                    I = max(I,double(imread(imageName{stack},...
                        frame, 'info', info, 'PixelRegion', region)));
                case 'mean Intensity'
                    I = (I + double(imread(imageName{stack},...
                        frame, 'info', info, 'PixelRegion', region)))/2;
            end %switch
            waitbar(frame/frames,hProgressbar,...
                'Processing...','Color',...
                get(0,'defaultUicontrolBackgroundColor'));
        end %for
    end %for
    delete(hProgressbar)
else
    info = imfinfo(imageName);
    frames = numel(info);
    I = double(imread(imageName, 1,...
        'info', info, 'PixelRegion', region));
    for frame = 2:frames
        switch get(src, 'Tag')
            case 'max. Intensity'
                I = max(I,double(imread(imageName,...
                    frame, 'info', info, 'PixelRegion', region)));
            case 'mean Intensity'
                I = (I + double(imread(imageName,...
                    frame, 'info', info, 'PixelRegion', region)))/2;
        end %switch
        waitbar(frame/frames,hProgressbar,...
            'Processing...','Color',...
            get(0,'defaultUicontrolBackgroundColor'));
    end %for
    delete(hProgressbar)
end %if
I = fix((I-min(I(:)))/(max(I(:))-min(I(:)))*255);

figNew =...
    figure(...
    'Units','normalized',...
    'Position', figPos(roi(3)/roi(4)),...
    'Color', get(fig,'Color')-unifrnd(0.09,0.11,1,3),...
    'Name', ['z-Projection (' ...
    get(src,'Tag') ') - ' get(fig,'Name')],...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');
axes(...
    'Parent', figNew,...
    'Units','normalized',...
    'Position', [0.05 0.05 0.9 0.9]);

hToolBar = findall(figNew,'Type','uitoolbar');
uipushtool(...
    'Parent', hToolBar,...
    'CData', repmat(icon.save, [1 1 3]),...
    'ClickedCallback', {@saveImage,I,'8bit'})
uipushtool(...
    'Parent', hToolBar,...
    'CData', repmat(icon.colormap, [1 1 3]),...
    'ClickedCallback', 'colormapeditor')
hToggleList = findall(hToolBar);
delete(hToggleList([4:12 15:19]))
imshow(uint8(I))
end

function scatterPlot(src, event)
fig = imgcf;
encodeType = {'x-coordinate [px]','y-coordinate [px]','signal amplitude [counts]',...
    'noise amplitude [counts]','background level [counts]','psf radius [px]','detection time [frames]',...
    '# collected photons','localization precision [micron]','signal to noise ratio',...
    'signal to background ratio','cluster','z-coordinate [px]','channel'};

menuFig =...
    figure(...
    'Units','normalized',...
    'Position', [0.3 0.25 0.4 0.5],...
    'Color', get(0,'defaultUicontrolBackgroundColor'),...
    'Name', 'Encoding Style',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'none',...
    'Resize', 'off');

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.8 0.9 0.2 0.1],...
    'FontSize', 15,...
    'String', 'weight')

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.05 0.8 0.2 0.1],...
    'FontSize', 15,...
    'String', '1st dim.:')

hxDim =...
    uicontrol(...
    'Style', 'popupmenu',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.8 0.55 0.1],...
    'FontSize', 15,...
    'String', encodeType,...
    'Value', 1,...
    'BackgroundColor', [1 1 1]);

hxDimWeight =...
    uicontrol(...
    'Style', 'edit',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.8 0.1 0.1],...
    'FontSize', 15,...
    'String', 1,...
    'BackgroundColor', [1 1 1]);

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.05 0.65 0.2 0.1],...
    'FontSize', 15,...
    'String', '2nd dim.:')

hyDim =...
    uicontrol(...
    'Style', 'popupmenu',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.65 0.55 0.1],...
    'FontSize', 15,...
    'String', encodeType,...
    'Value', 2,...
    'BackgroundColor', [1 1 1]);

hyDimWeight =...
    uicontrol(...
    'Style', 'edit',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.65 0.1 0.1],...
    'FontSize', 15,...
    'String', 1,...
    'BackgroundColor', [1 1 1]);

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.05 0.5 0.2 0.1],...
    'FontSize', 15,...
    'String', '3rd dim.:')

hzDim =...
    uicontrol(...
    'Style', 'popupmenu',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.5 0.55 0.1],...
    'FontSize', 15,...
    'String', encodeType,...
    'Value', 7,...
    'BackgroundColor', [1 1 1]);

hzDimWeight =...
    uicontrol(...
    'Style', 'edit',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.5 0.1 0.1],...
    'FontSize', 15,...
    'String', 1,...
    'BackgroundColor', [1 1 1]);

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.05 0.35 0.2 0.1],...
    'FontSize', 15,...
    'String', 'expansion:')

hExp =...
    uicontrol(...
    'Style', 'popupmenu',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.35 0.55 0.1],...
    'FontSize', 15,...
    'String', encodeType,...
    'Value', 9,...
    'BackgroundColor', [1 1 1]);

hExpWeight =...
    uicontrol(...
    'Style', 'edit',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.35 0.1 0.1],...
    'FontSize', 15,...
    'String', 1,...
    'BackgroundColor', [1 1 1]);

uicontrol(...
    'Style', 'text',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.05 0.2 0.2 0.1],...
    'FontSize', 15,...
    'String', 'color:')

hColor =...
    uicontrol(...
    'Style', 'popupmenu',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.2 0.55 0.1],...
    'FontSize', 15,...
    'String', encodeType,...
    'Value', 7,...
    'BackgroundColor', [1 1 1]);

hColorWeight =...
    uicontrol(...
    'Style', 'edit',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.2 0.1 0.1],...
    'FontSize', 15,...
    'String', 1,...
    'BackgroundColor', [1 1 1]);

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.25 0.05 0.5 0.1],...
    'FontSize', 15,...
    'String', 'accept settings',...
    'Callback', {@buildScatterPlot,...
    [hxDim,hyDim,hzDim,hExp,hColor...
    hxDimWeight,hyDimWeight,hzDimWeight,hExpWeight,hColorWeight],...
    get(src, 'Tag')})

    function buildScatterPlot(src,event,hList,mode)
        take = cell2mat(get(hList(1:5),'Value'));
        weight = str2double(get(hList(6:10),'String'));
        close(get(src,'Parent'))
        
        returnVar = zeros(1,14); returnVar(take) = true;
        varNames = {'ctrsX','ctrsY','signal','noise','offset','radius','frame',...
            'photons','precision','snr','sbr','class','ctrsZ','channel'};
        
        figNew = figure(...
            'MenuBar', 'none',...
            'Toolbar','figure',...
            'DockControls', 'off',...
            'NumberTitle', 'off',...
            'Color', get(fig,'Color')-unifrnd(0.09,0.11,1,3),...
            'Visible', 'off');
        
        switch mode
            case '2D ImScatter'
                        switch getappdata(fig,'viewMode')
                            case 'monoView'
                                transferVarList(figNew,fig,'render-mono')
                                if ~getappdata(fig,'isLoaded')
                                    localization(figNew);
                                end
                                
                                %framerange selected
                                idx = [-1; cumsum(getappdata(figNew,'ctrsN'))];
                                if getappdata(fig,'rStart') == 1
                                    setappdata(figNew,'startPnt',0)
                                else
                                    setappdata(figNew,'startPnt',...
                                        idx(getappdata(fig,'rStart'))+1)
                                end %if
                                if isinf(getappdata(fig,'rEnd'))
                                    setappdata(figNew,'rEnd',numel(getappdata(figNew,'ctrsN')))
                                    setappdata(figNew,'elements',inf)
                                else
                                    setappdata(figNew,'elements',...
                                        idx(getappdata(fig,'rEnd')+1)-...
                                        max(1,getappdata(figNew,'startPnt'))+1)
                                end %if
                                
                                %get ROI
                                roi = getappdata(fig,'roi');
                                data = preprocessData(figNew,returnVar(1:12),roi);
                                
                                setappdata(figNew,'roiX0', roi(1))
                                setappdata(figNew,'roiY0', roi(2))
                                setappdata(figNew,'exfOld',getappdata(fig,'exfNew'))
                                
                                set(figNew,...
                                    'Name', ['2D Scatter: ' num2str(numel(data.(varNames{take(1)})))...
                                    '\' num2str(sum(getappdata(fig,'ctrsN'))) ' rendered'],...
                                    'NumberTitle', 'off',...
                                    'MenuBar', 'none',...
                                    'ToolBar', 'figure',...
                                    'Visible', 'on');
                                axes(...
                                    'Parent', figNew,...
                                    'Units','normalized',...
                                    'Fontsize',15);
                                
                                hToolBar = findall(figNew,'Type','uitoolbar');
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))
                                
                                color = jet(256);
                                cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),...
                                    max(weight(5)*data.(varNames{take(5)})),256);
                                [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);
                                
                                rho = linspace(0,2*pi,10)';
                                patch(repmat((weight(1)*data.(varNames{take(1)}))',10,1)+...
                                    weight(4)*cos(rho)*data.(varNames{take(4)})',...
                                    repmat((weight(2)*data.(varNames{take(2)}))',10,1)+...
                                    weight(4)*sin(rho)*data.(varNames{take(4)})',...
                                    shiftdim(color(cIdx,:),-1),...
                                    'EdgeColor', 'none', 'FaceAlpha', 0.5)
                                axis ('equal','ij')
                                set(gca,'CLim', [min(weight(5)*data.(varNames{take(5)}))...
                                    max(weight(5)*data.(varNames{take(5)}))])
                                xlabel(encodeType{take(1)});
                                ylabel(encodeType{take(2)});
                                hCBar = colorbar;
                                set(get(hCBar, 'YLabel'),'String', encodeType{take(5)}, 'FontSize', 15)
                            case 'dualView'
                            case 'tripleView'
                        end %switch
            case '3D ImScatter'
                        switch getappdata(fig,'viewMode')
                            case 'monoView'
                                transferVarList(figNew,fig,'render-mono')
                                
                                %framerange selected
                                idx = [-1; cumsum(getappdata(figNew,'ctrsN'))];
                                if getappdata(fig,'rStart') == 1
                                    setappdata(figNew,'startPnt',0)
                                else
                                    setappdata(figNew,'startPnt',...
                                        idx(getappdata(fig,'rStart'))+1)
                                end %if
                                if isinf(getappdata(fig,'rEnd'))
                                    setappdata(figNew,'rEnd',numel(getappdata(figNew,'ctrsN')))
                                    setappdata(figNew,'elements',inf)
                                else
                                    setappdata(figNew,'elements',...
                                        idx(getappdata(fig,'rEnd')+1)-...
                                        max(1,getappdata(figNew,'startPnt'))+1)
                                end %if
                                
                                %get ROI
                                roi = getappdata(fig,'roi');
                                data = preprocessData(figNew,returnVar(1:12),roi);
                                
                                setappdata(figNew,'roiX0', roi(1))
                                setappdata(figNew,'roiY0', roi(2))
                                setappdata(figNew,'exfOld',getappdata(fig,'exfNew'))
                                
                                pnts = numel(data.(varNames{take(1)}));
                                set(figNew,...
                                    'Name', ['3D Scatter: ' num2str(pnts)...
                                    '\' num2str(sum(getappdata(fig,'ctrsN'))) ' rendered'],...
                                    'NumberTitle', 'off',...
                                    'MenuBar', 'none',...
                                    'ToolBar', 'figure',...
                                    'Visible', 'on');
                                axes(...
                                    'Parent', figNew,...
                                    'Units','normalized',...
                                    'FontSize', 15,...
                                    'Box', 'on',...
                                    'Projection', 'perspective',...
                                    'TickDir', 'in');
                                
                                hToolBar = findall(figNew,'Type','uitoolbar');
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 13 14 16 17 18]))
                                
                                x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*...
                                    [weight(1)*data.(varNames{take(1)}),...
                                    weight(4)*data.(varNames{take(4)})]';
                                y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*...
                                    [weight(2)*data.(varNames{take(2)}),...
                                    weight(4)*data.(varNames{take(4)})]';
                                z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*...
                                    [weight(3)*data.(varNames{take(3)}),...
                                    weight(4)*data.(varNames{take(4)})]';
                                vertices = [x(:) y(:) z(:)];
                                
                                faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;...
                                    6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                                face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                                face = faceIdx+face';
                                
                                color = jet(256);
                                cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),...
                                    max(weight(5)*data.(varNames{take(5)})),256);
                                [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);
                                cIdx = reshape(repmat(cIdx',8,1),[1 8*pnts]);
                                
                                patch('Faces',face,'Vertices',vertices,...
                                    'FaceVertexCData', color(cIdx,:),...
                                    'FaceColor', 'flat');
                                
                                view(3)
                                axis ('vis3d')
                                set(gca,'CLim', [min(weight(5)*data.(varNames{take(5)}))...
                                    max(weight(5)*data.(varNames{take(5)}))])
                                %xlabel(encodeType{take(1)});
                                %ylabel(encodeType{take(2)});
                                %zlabel(encodeType{take(3)})
                                hCBar = colorbar;
                                set(get(hCBar, 'YLabel'),'String',...
                                    encodeType{take(5)}, 'FontSize', 15)
                            case 'dualView'
                                %check for tracking data
                                if imageBin{2}.isTrack
                                    n = 1;
                                    m = 1;
                                else
                                    n = 2;
                                    m = 0;
                                end %if
                                
                                %get ROI
                                hRoi = findobj(hFig,'Tag', 'roi');
                                if isempty(hRoi)
                                    roi = imageBin{1}.roi;
                                else
                                    roi =...
                                        get(hRoi,'UserData')/imageBin{1}.exfOld;
                                end
                                
                                fig =...
                                    figure(...
                                    'Units','normalized',...
                                    'Position', figPos(imageBin{1}.roi(3)/imageBin{1}.roi(4)),...
                                    'Color', get(hFig,'Color'),...
                                    'NumberTitle', 'off',...
                                    'MenuBar', 'none',...
                                    'ToolBar', 'figure');
                                ax =...
                                    axes(...
                                    'Parent', fig,...
                                    'Units','normalized',...
                                    'FontSize', 15,...
                                    'Box', 'on',...
                                    'Projection', 'perspective',...
                                    'TickDir', 'in',...
                                    'NextPlot', 'add');
                                
                                hToolBar = findall(fig,'Type','uitoolbar');
                                hToggleList = findall(hToolBar);
                                delete(hToggleList([2 3 4 5 6 7 8 13 14 16 17 18]))
                                
                                for ch = 1:n
                                    idx{ch} = [-1; cumsum(imageBin{ch}.ctrsN)];
                                    %framerange selected
                                    if isnan(imageBin{ch}.rStart)
                                        startPnt = 0;
                                    else
                                        startPnt = idx{ch}(imageBin{ch}.rStart)+1;
                                    end %if
                                    if isnan(imageBin{ch}.rEnd)
                                        elements = inf;
                                    else
                                        elements = idx{ch}(imageBin{ch}.rEnd+1)-max(1,startPnt)+1;
                                    end %if
                                    
                                    data = preprocessData(returnVar(1:12),imageBin{ch},startPnt,elements);
                                    pnts = numel(data.(varNames{take(1)}));
                                    
                                    x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*...
                                        [weight(1)*data.(varNames{take(1)}),weight(4)*data.(varNames{take(4)})]';
                                    y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*...
                                        [weight(2)*data.(varNames{take(2)}),weight(4)*data.(varNames{take(4)})]';
                                    z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*...
                                        [weight(3)*data.(varNames{take(3)}),weight(4)*data.(varNames{take(4)})]';
                                    vertices = [x(:) y(:) z(:)];
                                    
                                    faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;...
                                        6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                                    face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                                    face = faceIdx+face';
                                    
                                    if strcmp(varNames{take(5)},'channel')
                                        color = [0 0 0]; color(ch) = 1;
                                        cIdx = 1;
                                    else
                                        color = jet(256);
                                        cCtrs = linspace(min(weight(5)*data.(varNames{take(5)})),...
                                            max(weight(5)*data.(varNames{take(5)})),256);
                                        [unused cIdx] = histc(weight(5)*data.(varNames{take(5)}),cCtrs);
                                        cIdx = reshape(repmat(cIdx',8,1),[1 8*pnts]);
                                    end %if
                                    
                                    patch('Faces',face,'Vertices',vertices,...
                                        'FaceVertexCData', color(cIdx,:),...
                                        'FaceColor', 'flat','Parent', ax);
                                end %for
                                view(3)
                                axis ('vis3d','tight')
                                %                                 set(ax,'CLim', [min(weight(5)*data.(varNames{take(5)}))...
                                %                                     max(weight(5)*data.(varNames{take(5)}))])
                                %                         xlabel(encodeType{take(1)}); ylabel(encodeType{take(2)});
                                %                         zlabel(encodeType{take(3)})
                                hCBar = colorbar;
                                set(get(hCBar, 'YLabel'),'String', encodeType{take(5)}, 'FontSize', 15)
                                
                                %                                 set(fig, 'Name', ['3D Scatter: ' num2str(pnts)...
                                %                                     '\' num2str(sum(imageBin.ctrsN)) ' rendered'])
                            case 'tripleView'
                        end %switch
        end %switch
    end
end

%% ANALYSIS
function intHist(src, event)
fig = gcbf;

figNew =...
    figure(...
    'Units','normalized',...
    'Position', figPos(1)+[0 0 0.1 0],...
    'Color', get(fig,'Color'),...
    'Name', 'Intensitydistribution',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');

hToolBar = findall(figNew,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

switch get(src, 'Tag')
    case 'Pixel Intensity'
        set(figNew, 'Name', 'Pixel Intensity')
        if getappdata(fig,'isSuperstack')
            pathname = getappdata(fig,'pathname');
            filename = getappdata(fig,'filename');
            I = double(imread([pathname{getappdata(fig,'stack')}...
                filename{getappdata(fig,'stack')}],getappdata(fig,'frame')));
        else
            I = double(imread([getappdata(fig,'pathname')...
                getappdata(fig,'filename')],getappdata(fig,'frame')));
        end %if
        
        ax =...
            axes(...
            'Parent', figNew,...
            'Units','normalized',...
            'FontSize', 15,...
            'NextPlot', 'add');
        
        buildHistogram(ax,I(:),'counts')
        xlabel(ax,'Pixelintensity [counts]')
        
    case 'Particle Intensity'
        icon = getappdata(1, 'icons');
        uipushtool(...
            'Parent', hToolBar,...
            'CData', repmat(icon.fit, [1 1 3]),...
            'ClickedCallback', @fitDist,...
            'Separator', 'on')
        
        ax =...
            subplot(20,1,[14,1],...
            'Parent', figNew,...
            'Units','normalized',...
            'FontSize', 20,...
            'NextPlot', 'add',...
            'XTickLabel','');
        
        idx = [-1; cumsum(getappdata(fig,'ctrsN'))];
        if getappdata(fig,'rStart') == 1
            setappdata(fig,'startPnt',0)
        else
            setappdata(fig,'startPnt',...
                idx(getappdata(fig,'rStart'))+1)
        end %if
        if isinf(getappdata(fig,'rEnd'))
            setappdata(fig,'rEnd',numel(getappdata(fig,'ctrsN')))
            setappdata(fig,'elements',inf)
        else
            setappdata(fig,'elements',...
                idx(getappdata(fig,'rEnd')+1)-...
                max(1,getappdata(fig,'startPnt'))+1)
        end %if
        
        %get roi
        roi = getappdata(fig,'roi');
        data = preprocessData(fig,[0 0 0 0 0 0 0 1 0 0 0 0],roi);
        
        [freq, ctrs] = hist(data.photons,calcnbins(data.photons,'fd'));
        hStair = stairs(ctrs,freq);
        set(hStair, ...
            'Tag', 'Intensityhistogram',...
            'Userdata', {freq,ksdensity(data.photons,ctrs)})
        set(fig, 'Name', ['Particle Intensity: ' num2str(numel(data.photons)) '\'...
            num2str(sum(getappdata(fig,'ctrsN'))) ' rendered'])
        
        axis tight
        ylabel('Frequency');
        
        errAx =...
            subplot(20,1,16:19,...
            'Parent', figNew,...
            'Units','normalized',...
            'FontSize', 20,...
            'NextPlot', 'add');
        ylabel('Residuals');
        xlabel('Particleintensity [photons]');
        linkaxes([ax errAx],'x')
end %switch

    function fitDist(src, event)
        fitFig =...
            figure(...
            'Units','normalized',...
            'Position', [0.6 0.4 0.3 0.4],...
            'Color', get(fig,'Color'),...
            'Name', 'Fit',...
            'NumberTitle', 'off',...
            'MenuBar', 'none',...
            'ToolBar', 'none');
        
        uicontrol(...
            'Style', 'text',...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.1 0.9 0.8 0.07],...
            'FontSize', 15,...
            'String', 'Subpopulations:')
        
        hTable =...
            uitable(...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.05 0.15 0.9 0.6],...
            'ColumnName', {'Fraction', 'Photons', 'Error'},...
            'ColumnFormat', {'numeric','numeric','numeric'},...
            'ColumnWidth', {104},...
            'data', cell(3,3),...
            'FontSize', 10);
        
        hSubpops(1) =...
            uicontrol(...
            'Style', 'popupmenu',...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.3 0.8 0.6 0.06],...
            'FontSize', 15,...
            'String', {'1x constraint'...
            '1x constraint + 1x free', '2x constraint',....
            '2x constraint + 1x free', '3x constraint',...
            '3x constraint + 1x free', '4x constraint'},...
            'Value', 3);
        
        hSubpops(2) =...
            uicontrol(...
            'Style', 'popupmenu',...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.3 0.8 0.6 0.06],...
            'FontSize', 15,...
            'String', {'Scan for optimal # of fractions',...
            'Set # of fractions w\o initial guess',...
            'Set # of fractions with initial guess'},...
            'Value', 1,...
            'Visible','off');
        
        hMethod =...
            uicontrol(...
            'Style', 'popupmenu',...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.1 0.8 0.2 0.06],...
            'FontSize', 15,...
            'String', {'OLS','MLE'},...
            'Value', 1,...
            'Callback', @changeMethod);
        
        uicontrol(...
            'Style', 'pushbutton',...
            'Parent', fitFig,...
            'Units','normalized',...
            'Position', [0.1 0.05 0.8 0.06],...
            'FontSize', 15,...
            'String', 'FIT',...
            'Callback', @estimatePar)
        
        function changeMethod(src,event)
            set(hSubpops,'Visible','off')
            set(hSubpops(get(src,'Value')),'Visible','on')
            vals = get(hStair,'UserData');
            set(hStair,'YData',vals{get(src,'Value')})
            
            delete(findobj(ax, 'Tag', 'fit'))
            axis(ax,'tight')
        end
        function estimatePar(src, event)
            switch get(hMethod,'Value')
                case 1
                    switch get(hSubpops(1), 'Value')
                        case 1
                            fractions = 1;
                            f = fittype('gauss1');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal)
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf];
                        case 2
                            fractions = 2;
                            f = fittype('gauss2');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,...
                                0,startPnts(5)-startPnts(5)/100,0];
                            uBnd = [inf,inf,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf];
                        case 3
                            fractions = 2;
                            f = fittype('gauss2');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,...
                                0,startPnts(5)-startPnts(5)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf];
                        case 4
                            fractions = 3;
                            f = fittype('gauss3');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,...
                                0,startPnts(5)-startPnts(5)/100,0,...
                                0,startPnts(8)-startPnts(8)/100,0];
                            uBnd = [inf,inf,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf,...
                                inf,startPnts(8)+startPnts(8)/100,inf];
                        case 5
                            fractions = 3;
                            f = fittype('gauss3');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,...
                                0,startPnts(5)-startPnts(5)/100,0,...
                                0,startPnts(8)-startPnts(8)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf,...
                                inf,startPnts(8)+startPnts(8)/100,inf];
                        case 6
                            fractions = 4;
                            f = fittype('gauss4');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,0,0,...
                                0,startPnts(5)-startPnts(5)/100,0,...
                                0,startPnts(8)-startPnts(8)/100,0,...
                                0,startPnts(11)-startPnts(11)/100,0];
                            uBnd = [inf,inf,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf,...
                                inf,startPnts(8)+startPnts(8)/100,inf,...
                                inf,startPnts(11)+startPnts(11)/100,inf];
                        case 7
                            fractions = 4;
                            f = fittype('gauss4');
                            preVal = getappdata(fig,'preVal');
                            if isempty(preVal) || numel(preVal) ~= 3*fractions
                                preOpt = fitoptions('method','NonlinearLeastSquares');
                                preFit = fit(ctrs',freq',f,preOpt);
                                preVal = cellstr(num2str(coeffvalues(preFit)'));
                            end
                            answer =...
                                inputdlg(...
                                coeffnames(f),...
                                'StartValues',1,...
                                preVal);
                            setappdata(fig,'preVal',answer)
                            startPnts = str2num(strvcat(answer{:}));
                            lBnd = [0,startPnts(2)-startPnts(2)/100,0,...
                                0,startPnts(5)-startPnts(5)/100,0,...
                                0,startPnts(8)-startPnts(8)/100,0,...
                                0,startPnts(11)-startPnts(11)/100,0];
                            uBnd = [inf,startPnts(2)+startPnts(2)/100,inf,...
                                inf,startPnts(5)+startPnts(5)/100,inf,...
                                inf,startPnts(8)+startPnts(8)/100,inf,...
                                inf,startPnts(11)+startPnts(11)/100,inf];
                    end %switch
                    delete(findobj(ax, 'Tag', 'fit'))
                    cla(errAx)
                    
                    opt = fitoptions('method','NonlinearLeastSquares',...
                        'StartPoint', startPnts,...
                        'Lower', lBnd, 'Upper', uBnd);
                    [fitFractions statsFraction outpuFractions] =...
                        fit(ctrs',freq',f,opt);
                    
                    plot(ax, ctrs, feval(fitFractions,ctrs),...
                        'Color', [1 0 0], 'LineWidth', 2, 'Tag', 'fit');
                    stem(errAx, ctrs, outpuFractions.residuals)
                    legend(errAx, ['RMSE = ' num2str(statsFraction.rmse)])
                    
                    results = transpose(reshape(coeffvalues(fitFractions),...
                        3,fractions));
                case 2
                    options = statset('MaxIter',1000);
                    
                    switch get(hSubpops(2), 'Value')
                        case 1
                            fractions = str2double(...
                                inputdlg('max. # Fractions:','Scan Options'));
                            
                            AIC = zeros(1,fractions);
                            mixComponents = cell(1,fractions);
                            for k = 1:fractions
                                mixComponents{k} = ...
                                    gmdistribution.fit(data.photons,k,...
                                    'Options', options);
                                AIC(k)= mixComponents{k}.AIC;
                            end
                            [minAIC,fractions] = min(AIC);
                            mixComponents = mixComponents{fractions};
                        case 2
                            fractions = str2double(...
                                inputdlg('# of Fractions:','Fit Options'));
                            
                            mixComponents = ...
                                gmdistribution.fit(data.photons,fractions,...
                                'Options', options);
                        case 3
                    end %switch
                    delete(findobj(ax, 'Tag', 'fit'))
                    cla(errAx)
                    
                    %                 [P,nlogl] = posterior(mixComponents,data.photons);
                    
                    plot(ax, ctrs', pdf(mixComponents,ctrs'),...
                        'Color', [1 0 0], 'LineWidth', 2, 'Tag', 'fit');
                    results = [mixComponents.PComponents'./...
                        sqrt(2*pi*mixComponents.Sigma(:)),...
                        mixComponents.mu,...
                        sqrt(mixComponents.Sigma(:))];
            end
            
            gauss = @(x,a,b,c) a*exp(-((x-b)/c).^2);
            ctrsInterp = linspace(min(ctrs),max(ctrs),10*numel(ctrs))';
            freqSub = zeros(fractions,numel(ctrsInterp));
            for N = 1:fractions
                freqSub(N,:) = gauss(ctrsInterp,...
                    results(N,1),results(N,2),results(N,3));
                plot(ax, ctrsInterp, freqSub(N,:), 'r', 'Tag', 'fit')
            end %for
            axis(ax,'tight')
            
            switch get(hMethod,'Value')
                case 1
                    set(hTable, 'data', [sum(freqSub,2)/sum(freq) results(:,2:3)])
                case 2
                    set(hTable, 'data', [mixComponents.PComponents' results(:,2:3)])
            end %switch
        end
    end
end
function locPrec(src, event)
fig = gcbf;

idx = [-1; cumsum(getappdata(fig,'ctrsN'))];
if getappdata(fig,'rStart') == 1
    setappdata(fig,'startPnt',0)
else
    setappdata(fig,'startPnt',...
        idx(getappdata(fig,'rStart'))+1)
end %if
if isinf(getappdata(fig,'rEnd'))
    setappdata(fig,'rEnd',numel(getappdata(fig,'ctrsN')))
    setappdata(fig,'elements',inf)
else
    setappdata(fig,'elements',...
        idx(getappdata(fig,'rEnd')+1)-...
        max(1,getappdata(fig,'startPnt'))+1)
end %if

%get ROI
roi = getappdata(fig,'roi');
data = preprocessData(fig,[0 0 0 0 0 0 0 0 1 0 0 0],roi);

figNew =...
    figure(...
    'Units','normalized',...
    'Position', figPos(1)+[0 0 0.2 0],...
    'Color', get(fig,'Color'),...
    'Name', ['Loc. Precision: ' num2str(numel(data.precision)) '\'...
    num2str(sum(getappdata(fig,'ctrsN'))) ' rendered'],...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');

hToolBar = findall(figNew,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax =...
    axes(...
    'Parent', figNew,...
    'Units','normalized',...
    'FontSize', 15,...
    'NextPlot', 'add');

buildHistogram(ax,data.precision*1000,'nm')
xlabel(ax,'Localization Precision [nm]')
end
function snrHist(src, event)
fig = gcbf;

idx = [-1; cumsum(getappdata(fig,'ctrsN'))];
if getappdata(fig,'rStart') == 1
    setappdata(fig,'startPnt',0)
else
    setappdata(fig,'startPnt',...
        idx(getappdata(fig,'rStart'))+1)
end %if
if isinf(getappdata(fig,'rEnd'))
    setappdata(fig,'rEnd',numel(getappdata(fig,'ctrsN')))
    setappdata(fig,'elements',inf)
else
    setappdata(fig,'elements',...
        idx(getappdata(fig,'rEnd')+1)-...
        max(1,getappdata(fig,'startPnt'))+1)
end %if

%get ROI
roi = getappdata(fig,'roi');
data = preprocessData(fig,[0 0 0 0 0 0 0 0 0 1 0 0],roi);

figNew =...
    figure(...
    'Units','normalized',...
    'Position', figPos(1)+[0 0 0.2 0],...
    'Color', get(fig,'Color'),...
    'Name', ['Loc. Precision: ' num2str(numel(data.snr)) '\'...
    num2str(sum(getappdata(fig,'ctrsN'))) ' rendered'],...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');

hToolBar = findall(figNew,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax =...
    axes(...
    'Parent', figNew,...
    'Units','normalized',...
    'FontSize', 15,...
    'NextPlot', 'add');

buildHistogram(ax,data.snr,'')
xlabel(ax,'Signal to Noise Ratio')
end
function detectionTrace(src, event)
fig = gcbf;

figNew =...
    figure(...
    'Units','normalized',...
    'Position', figPos(1)+[0 0 0.2 0],...
    'Color', get(fig,'Color'),...
    'Name', 'Detectiontrace',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure');
hToolBar = findall(figNew,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 9 10 13 14 16 17 18]))

ax(1) =...
    subplot(2,1,1,...
    'Parent', figNew,...
    'FontSize', 20,...
    'NextPlot', 'add');

ctrsN = getappdata(fig,'ctrsN');
plot(ax(1), ctrsN)
plot(ax(1), smooth(ctrsN,0.25,'loess'),...
    'Color', [1 0 0], 'LineWidth', 2)
axis tight
xlabel('Frame'); ylabel('Particledetections');

ax(2) =...
    subplot(2,1,2,...
    'Parent', figNew,...
    'FontSize', 20);

buildHistogram(ax(2),ctrsN,'')
xlabel(ax(2),'Particledetections')
end

function interactionStudy(src,event)
end

function colocFilter(src,event)
fig = imgcf;
srcFig = getappdata(fig,'imSrcFig');
imCh = getappdata(fig,'imCh');
nImCh = getappdata(fig,'nImCh');

returnValue = [1 1 0 0 0 0 1 1 0 0 0 0];
for ch = 1:nImCh
    %load whole list
    setappdata(srcFig(imCh(ch)),'startPnt',0)
    setappdata(srcFig(imCh(ch)),'endPnt',inf)
    roi = [0 0 ...
        getappdata(srcFig(imCh(ch)),'width')...
        getappdata(srcFig(imCh(ch)),'height')];
    data{ch} =...
        preprocessData(srcFig(imCh(ch)),returnValue,roi);
end %for
width = getappdata(srcFig(imCh(1)),'width');
height = getappdata(srcFig(imCh(1)),'height');

%max. allowed distance [px]
thresh = 2;

hProgressbar = waitbar(0,'Generating Images...','Color',...
    get(0,'defaultUicontrolBackgroundColor'));
for frame = 1:getappdata(srcFig(imCh(1)),'rEnd')
    [idx{1} idx{2}] = filterData(data);
    nColoc(frame) = numel(idx{1});
    
    if nColoc(frame) > 0
        %calculate linear indices of particle detection for 2d-matrix
        [cntY idxY] = histc(data{1}.ctrsY(idx{1}),1:height);
        [cntX idxX] = histc(data{1}.ctrsX(idx{1}),1:width);
        linIdx = idxX*height+idxY+1;
        [linIdx unused subs] = unique(linIdx);
        
        imRendered = zeros(height,width);
        imRendered(linIdx) = accumarray(subs,data{1}.photons(idx{1})*20.2);
        psf = buildPSF(1,width,height);
        imRendered = fftshift(ifft2(fft2(imRendered).* psf));
        imwrite(uint8(imRendered),...
            [getappdata(srcFig(imCh(1)),'pathname')...
            getappdata(srcFig(imCh(1)),'filename') '_faked.tif'],'compression','none',...
            'Writemode', 'append')
        
        [cntY idxY] = histc(data{2}.ctrsY(idx{2}),1:height);
        [cntX idxX] = histc(data{2}.ctrsX(idx{2}),1:width);
        linIdx = idxX*height+idxY+1;
        [linIdx unused subs] = unique(linIdx);
        
        imRendered = zeros(height,width);
        imRendered(linIdx) = accumarray(subs,data{1}.photons(idx{1})*20.2);
        psf = buildPSF(1,width,height);
        imRendered = fftshift(ifft2(fft2(imRendered).* psf));
        imwrite(uint8(imRendered),...
            [getappdata(srcFig(imCh(2)),'pathname')...
            getappdata(srcFig(imCh(2)),'filename') '_faked.tif'],'compression','none',...
            'Writemode', 'append')
    else
        imRendered = zeros(height,width,'uint8');
        imwrite(imRendered,...
            [getappdata(srcFig(imCh(1)),'pathname')...
            getappdata(srcFig(imCh(1)),'filename') '_faked.tif'],'compression','none',...
            'Writemode', 'append')
        imwrite(imRendered,...
            [getappdata(srcFig(imCh(2)),'pathname')...
            getappdata(srcFig(imCh(2)),'filename') '_faked.tif'],'compression','none',...
            'Writemode', 'append')
        continue
    end %if
    waitbar(frame/getappdata(srcFig(imCh(1)),'rEnd'),...
        hProgressbar,'Generating Images...','Color',...
        get(0,'defaultUicontrolBackgroundColor'));
end %for
delete(hProgressbar)

[outputname,outputpath,isOK] = uiputfile(...
    '.txt' ,'Save #CoLoc/Frame to', getappdata(0,'searchPath'));
fid = fopen([outputpath outputname], 'wt');
fprintf(fid,'%.0f \n',nColoc)
fclose(fid);

    function [idxCh1 idxCh2] = filterData(data)
        good{1} = (data{1}.frame == frame);
        good{2} = (data{2}.frame == frame);
        
        sizey1 = numel(data{1}.ctrsY(good{1}));
        sizey2 = numel(data{2}.ctrsY(good{2}));
        
        y1Mat = repmat(data{1}.ctrsY(good{1}),1,sizey2);
        y2Mat = repmat(data{2}.ctrsY(good{2})',sizey1,1);
        yDiffMat = (y1Mat-y2Mat).^2;
        
        sizex1 = numel(data{1}.ctrsX(good{1}));
        sizex2 = numel(data{2}.ctrsX(good{2}));
        
        x1Mat = repmat(data{1}.ctrsX(good{1}),1,sizex2);
        x2Mat = repmat(data{2}.ctrsX(good{2})',sizex1,1);
        xDiffMat = (x1Mat-x2Mat).^2;
        
        d = sqrt(yDiffMat+xDiffMat);
        good = min(d,1) & min(d,2);
        [idxCh1 idxCh2] = find(d <= thresh & good);
    end
end
function particleImageCorrelation(src,event)
fig = imgcf;

%set correlation sampling rate
samplingRate = 5; %[px^-1]
dMax = 15; %[px]

roi = getappdata(fig,'roi');
%reduce field of view to obtain
%true distribution of step sizes up
%to a distance dMax
roi = [max(roi(1:2),dMax),...
    min(roi(3:4),...
    [getappdata(fig,'width') ...
    getappdata(fig,'height')]-dMax)];

data = preprocessData(fig,[1 1 0 0 0 0 1 0 0 0 0 0],roi);

nIm = numel(getappdata(fig,'ctrsN'));
nPnts = numel(data.ctrsX);

%generate 2d-projected tree
pntList = [data.ctrsX data.ctrsY];
tree = kdtree_build(pntList);

%average particle # for increasing dt
pntsPerFrame = accumarray(data.frame,1);
muPnts = zeros(1,nIm-1);
for dt = 1:nIm-1
    muPnts(dt) = mean(pntsPerFrame(1:nIm-dt));
end

Ccum = zeros(dMax,nIm-1);
for d = 1:ceil(dMax*samplingRate)
    %reset count matrix
    cnts = zeros(nPnts,nIm-1);
    for pnt = 1:nPnts
        iNN = kdtree_ball_query(tree,...
            pntList(pnt,:),d/samplingRate);
        dt = data.frame(iNN)-data.frame(pnt);
        %allow only temporal forward correlation
        good = (dt>0);
        if any(good)
            %overlap integral for image pairs separated
            %by dt
            cnts(pnt,:) = accumarray(dt(good),1,[nIm-1 1]);
        end %if
    end %for
    %average over n*dt and normalize to average
    %particle # for n*dt
    Ccum(d,:) = (sum(cnts)./(nIm-1:-1:1))./muPnts;
end %for
kdtree_delete(tree)

%calculate spatial correction term
z = []; x = []; y = [];
for dt = 1:nIm-1
    linStart = find(Ccum(:,dt)>1,1,'first');
    z = [z; Ccum(linStart:end,dt)];
    y = [y; ((linStart:dMax*samplingRate)/samplingRate)'];
    x = [x; ones(dMax*samplingRate-linStart+1,1)*dt];
end
[b,bint,r,rint,stats] =...
    regress(z,[ones(size(z)) x y.^2]);
[XFIT,YFIT] = meshgrid(1:nIm-1,...
    ((1:ceil(dMax*samplingRate))/samplingRate).^2);
ZHAT = b(2)*XFIT + b(3)*YFIT;
Ccum = Ccum-ZHAT;

%control figure
% figure;
% surf(XFIT(1,:),YFIT(:,1),...
%     Ccum,'EdgeColor','flat','FaceAlpha', 0.9)
% hold on
% plot3(x, y.^2, z, 'm.')
% plot3(XFIT,YFIT,ZHAT+b(1), 'r-')
end

%% LOCALIZATION
function localization(src,event)
fig = gcbf;
imageBin = getappdata(fig);

imageBin.imageName = strcat(imageBin.pathname,...
    imageBin.filename);

%select localization output filename
if iscell(imageBin.filename)
    %if there are multiple filenames, find their union
    cnt = 1;
    while all(strncmp(imageBin.filename{1},...
            imageBin.filename,cnt))
        cnt = cnt+1;
    end %while
    if cnt > 1
        imageBin.filename = imageBin.filename{1}(1:cnt-1);
    else
        %no union
        imageBin.filename = [];
    end %if
else
    imageBin.filename = imageBin.filename(1:end-4);
end %if
[imageBin.filename,imageBin.pathname,isOK] =...
    uiputfile('','Save to',...
    [getappdata(0,'searchPath')...
    imageBin.filename]);
if isOK
    %check if filename already existent in folder
    [imageBin.filename, imageBin.pathname, abort] =...
        checkNameExistance(imageBin.filename,imageBin.pathname);
    if abort
        return
    end %if
else
    return
end %if

%search for ROI
if isempty(getappdata(fig,'hROI'))
    imageBin.roi =...
        [1 1 getappdata(fig,'width')...
        getappdata(fig,'height')];
else
    imageBin.roi = ceil(getappdata(fig,'roi'));
end
tic
if getappdata(fig,'isSuperstack')
    N = 0;
    findStartPnt = 1;
    foundEndPnt = 0;
    for file = 1:numel(imageBin.imageName)
        info = imfinfo(imageBin.imageName{file});
        
        N = N + numel(info);
        if findStartPnt
            if N >= getappdata(fig,'locStart')
                startPnt = getappdata(fig,'locStart')-...
                    (N-numel(info));
                findStartPnt = 0;
            else
                %loop until startPnt is inside actual stack
                continue
            end %if
        else
            startPnt = 1;
        end %if
        if isinf(getappdata(fig,'locEnd'))
            endPnt = numel(info);
        else
            if N > getappdata(fig,'locEnd')
                endPnt = numel(info)-...
                    (N-getappdata(fig,'locEnd'));
                foundEndPnt = 1;
            elseif N == getappdata(fig,'locEnd')
                endPnt = numel(info);
                foundEndPnt = 1;
            else
                endPnt = numel(info);
            end %if
        end %if
        imageBin.imageName{file}
        imageBin.ctrsN{file} = localizeParticles(imageBin.imageName{file},...
            startPnt,endPnt,info,imageBin);
        if foundEndPnt
            break
        end %if
    end %for
    imageBin.ctrsN = vertcat(imageBin.ctrsN{:});
else
    info = imfinfo(imageBin.imageName);
    if isnan(getappdata(fig,'locStart'))
        startPnt = 1;
    else
        startPnt = getappdata(fig,'locStart');
    end %if
    
    if isinf(getappdata(fig,'locEnd'))
        endPnt = numel(info);
    else
        endPnt = getappdata(fig,'locEnd');
    end %if
    imageBin.imageName
    imageBin.ctrsN = localizeParticles(imageBin.imageName,...
        startPnt,endPnt,info,imageBin);
end
toc
%save localization matrix
saveSettingsToDisk(imageBin)

    function saveSettingsToDisk(imageBin)
        save([imageBin.pathname imageBin.filename '.mat'],'imageBin')
    end
end
function batchLocalization(src,event)
menuFig =...
    figure(...
    'Units','normalized',...
    'Position', [0 0 1 1],...
    'Color', get(0,'defaultUicontrolBackgroundColor'),...
    'Name', 'Batch Container',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'none',...
    'Resize', 'on');

hList =...
    uicontrol(...
    'Style', 'listbox',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0 0 0.8 1],...
    'FontSize', 15,...
    'Backgroundcolor', [1 1 1],...
    'Callback', @updatePanelVisibility);

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.8 0.18 0.05 0.1],...
    'FontSize', 25,...
    'String', '+',...
    'Callback', {@addStack, hList})

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.85 0.18 0.05 0.1],...
    'FontSize', 30,...
    'String', '-',...
    'Callback', {@delStack, hList})

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.9 0.18 0.05 0.1],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'UP',...
    'Callback', {@moveUpStack, hList})

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.95 0.18 0.05 0.1],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'DOWN',...
    'Callback', {@moveDownStack, hList})

uicontrol(...
    'Style', 'pushbutton',...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.8 0 0.2 0.18],...
    'FontSize', 20,...
    'FontUnits', 'normalized',...
    'String', 'START',...
    'Callback', {@processBatch, hList})

hLocOptPanel =...
    uipanel(...
    'Parent', menuFig,...
    'Units','normalized',...
    'Position', [0.8 0.58 0.2 0.42],...
    'FontSize', 10,...
    'FontWeight', 'bold',...
    'Title','Localization');

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.9 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'Error Rate [10^]:',...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'This Value limits the Probability for Type One Error (False H0 Rejection), \n'...
    'while estimation of the generalized likelihood ratio test. \n'...
    'These Ratios follow aproximated a chi^2 distribution\n'...
    'with degree of freedom (3 [signal, offset, noise]-2[offset, noise]) = 1']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'errRate',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.89 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', -6);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.82 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'Detection Box [px]:',...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'Size of 2 dimensional sliding box inside whom a \n'...
    'generalized likelihood ratio test (H0/H1) is performed with: \n'...
    'H0 = no target (offset and noise) \n'...
    'H1 = presence of target (signal, offset and noise) \n'...
    'followed by subpixel estimation via Gauss-Newton Approximation']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'w2d',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.81 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 7);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.74 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'Deflation Loops:',...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'This Value determines how often the detection process will be iterated. \n'...
    'After each Iteration the detected Particles represented by their \n'...
    'gaussian Intensity Profile will be subtracted from the Image. \n'...
    'In this way small peaks initially covered can be detected.']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'dfltnLoops',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.73 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 0);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.66 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'Intensity Thresh [cnts]:',...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'Defines the min. Signal Intensity expressed as'...
    'offset-corrected amplitude of the Gaussian.']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'minInt',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.65 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 0);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'locParallel',...
    'Style', 'checkbox',...
    'Units','normalized',...
    'Position', [0.01 0.58 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'use multiple cores',...
    'Value', false,...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'If this option is checked the programm will perform \n'...
    'the particle localization process using the specefied \n'...
    'number of processor cores. \n'...
    'The maximum of available cores will be used by default.']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'nCores',...
    'Style', 'popupmenu',...
    'Units','normalized',...
    'Position', [0.71 0.57 0.28 0.06],...
    'FontSize', 7,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', {'max' '2' '3'},...
    'Value', 1);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.45 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'FontWeight', 'bold',...
    'String', 'Optimization Settings',...
    'HorizontalAlignment', 'left');

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.37 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'max. # iterations:',...
    'HorizontalAlignment', 'left');

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'maxOptimIter',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.36 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 50);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.29 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'term. tol. [10^]:',...
    'HorizontalAlignment', 'left');

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'termTol',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.28 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', -2);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'isRadiusTol',...
    'Style', 'checkbox',...
    'Units','normalized',...
    'Position', [0.01 0.21 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'r0 tolerance [%]:',...
    'Value', false,...
    'HorizontalAlignment', 'left',...
    'ToolTipString', sprintf(['\n'...
    'If this option is checked the programm will optimize for \n'...
    'the gaussian radius approximating the point spreads function std. \n'....
    'If the tolerancelevel set is exceeded the particle will be discarded.']));

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'radiusTol',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.2 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 10);

uicontrol(...
    'Parent', hLocOptPanel,...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.01 0.13 0.7 0.05],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'String', 'max. pos. refinement [px]:',...
    'HorizontalAlignment', 'left');

uicontrol(...
    'Parent', hLocOptPanel,...
    'Tag', 'posTol',...
    'Style', 'edit',...
    'Units','normalized',...
    'Position', [0.71 0.12 0.28 0.06],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'Backgroundcolor', [1 1 1],...
    'String', 1.5);

    function addStack(src, event, hList)
        [stackname, stackpath,isOK] = uigetfile('*.tif',...
            'Select Imagestacks', getappdata(0,'searchPath'),...
            'MultiSelect', 'on');
        if isOK
            setappdata(0, 'searchPath', stackpath)
            
            content = get(hList, 'String');
            contentNew = cellstr(strcat(stackpath, stackname));
            content = [content', contentNew];
            set(hList, 'String', content, 'Value', 1)
            
            for file = 1:numel(contentNew)
                set(findobj(get(src,'Parent'),...
                    'Title','Optics'),'Visible','off')
                hOpticsPanel =...
                    uipanel(...
                    'Parent', get(src,'Parent'),...
                    'Tag', contentNew{file},...
                    'Units','normalized',...
                    'Position', [0.8 0.28 0.2 0.3],...
                    'FontSize', 10,...
                    'FontWeight', 'bold',...
                    'Title','Optics');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.84 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'Pixel Size [?m]:',...
                    'HorizontalAlignment', 'left',...
                    'ToolTipString', sprintf(['\n'...
                    'This Value is used to estimate the pixel to micron conversion factor. \n'...
                    'In Theory: pixel size = phys. pixel size / total magnification(objectiv*ocular)\n'...
                    '60, 1x = 0.267?m per pixel \n 60, 1.6x = 0.167?m per pixel \n'...
                    '150, 1x = 0.107?m per pixel \n 150, 1.6x = 0.067?m per pixel']));
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'pxSize',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.83 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 0.107,...
                    'Callback', @calcPSF);
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.72 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'Emission [nm]:',...
                    'HorizontalAlignment', 'left');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'emWvlnth',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.71 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 571,...
                    'Callback', @calcPSF);
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.6 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'N.A.:',...
                    'HorizontalAlignment', 'left');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'NA',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.59 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 1.35,...
                    'Callback', @calcPSF);
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.48 0.66 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'PSF Scaling:',...
                    'HorizontalAlignment', 'left');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'psfScale',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.47 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 1.35,...
                    'Callback', @calcPSF);
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.36 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'PSF Std [px]:',...
                    'HorizontalAlignment', 'left',...
                    'ToolTipString', sprintf(['\n'...
                    'Standard deviation of the Gaussian modelling the \n'...
                    'Microscope associated Point Spread Function.']));
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'psfStd',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.35 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 1.03,...
                    'Enable', 'off');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Style', 'text',...
                    'Units','normalized',...
                    'Position', [0.01 0.24 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'Counts/Photon:',...
                    'HorizontalAlignment', 'left');
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'cntsPerPhoton',...
                    'Style', 'edit',...
                    'Units','normalized',...
                    'Position', [0.71 0.23 0.28 0.08],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'Backgroundcolor', [1 1 1],...
                    'String', 20.2);
                
                uicontrol(...
                    'Parent', hOpticsPanel,...
                    'Tag', 'spatialCorrection',...
                    'Style', 'checkbox',...
                    'Units','normalized',...
                    'Position', [0.01 0.12 0.7 0.07],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', 'apply spatial correction',...
                    'Value', false,...
                    'HorizontalAlignment', 'left',...
                    'Callback', @setSpatialCorrPath,...
                    'ToolTipString', sprintf(['\n'...
                    'If this option is checked the programm will perform \n'...
                    'a spatial transformation on the particle coordinates\n'...
                    'when the localization process is finished. \n'...
                    'The spatial transformation corrects for rotation and transition \n'...
                    'between image channels']));
            end %for
        else
            return
        end %if
    end
    function delStack(src, event, hList)
        bad = get(hList, 'Value');
        content = get(hList, 'String');
        if isempty(content)
            return
        else
            delete(findobj(get(src,'Parent'),...
                'Tag',content{bad}))
            content(bad) = [];
            set(hList, 'String', content, 'Value', [])
        end %if
    end
    function moveUpStack(src, event, hList)
        pos = get(hList, 'Value');
        if pos > 1
            content = get(hList, 'String');
            content(pos-1:pos) = [content(pos); content(pos-1)];
            set(hList, 'String', content, 'Value', pos-1)
        else
            return
        end %if
    end
    function moveDownStack(src, event, hList)
        pos = get(hList, 'Value');
        content = get(hList, 'String');
        if pos < numel(content)
            content(pos:pos+1) = [content(pos+1); content(pos)];
            set(hList, 'String', content, 'Value', pos+1)
        else
            return
        end %if
    end
    function updatePanelVisibility(src, event)
        if isempty(get(src,'String'))
            return
        else
            set(findobj(get(src,'Parent'),...
                'Title','Optics',...
                '-and','Type','Uipanel'),'Visible','off')
            content = get(src,'String');
            set(findobj(get(src,'Parent'),...
                'Tag',content{get(src,'Value')},...
                '-and','Type','Uipanel'),'Visible','on')
        end
    end
    function calcPSF(src,event)
        hOpticsPanel = get(src,'Parent');
        psfStd = str2double(get(findobj(hOpticsPanel,'Tag','psfScale'),'String'))*...
            0.55*(0.001*str2double(get(findobj(hOpticsPanel,'Tag','emWvlnth'),'String')))/...
            str2double(get(findobj(hOpticsPanel,'Tag','NA'),'String'))/1.17/...
            str2double(get(findobj(hOpticsPanel,'Tag','pxSize'),'String'))/2;
        set(findobj(hOpticsPanel,...
            'Tag','psfStd'),'String',psfStd);
    end
    function setSpatialCorrPath(src,event)
        if get(src,'Value')
            [tMatName, tMatPath, isOK] = uigetfile(...
                '*.mat', 'Select spatial Transformationmatrix',...
                getappdata(0,'searchPath'));
            if isOK
                set(src,'UserData',[tMatPath tMatName])
            end %if
        else %clear userdata
            set(src,'UserData',[])
        end %if
    end
    function processBatch(src, event, hList)
        files = get(hList,'String');
        for file = 1:numel(files)
            %Predefined Variables
            imageBin.isOwn = true;
            imageBin.isLoaded = true;
            imageBin.isSuperstack = false;
            imageBin.isTrack = false;
            imageBin.frame = 1;
            
            %Loc Options
            hLocPanel = findobj(get(src,'Parent'),...
                'Title','Localization', '-and', 'Type', 'Uipanel');
            imageBin.locStart = 1;
            imageBin.locEnd = inf;
            imageBin.errorRate = str2double(get(findobj(hLocPanel,'Tag','errRate'),'String'));
            imageBin.w2d = str2double(get(findobj(hLocPanel,'Tag','w2d'),'String'));
            imageBin.dfltnLoops = str2double(get(findobj(hLocPanel,'Tag','dfltnLoops'),'String'));
            imageBin.minInt = str2double(get(findobj(hLocPanel,'Tag','minInt'),'String'));
            imageBin.locParallel = get(findobj(hLocPanel,'Tag','locParallel'),'Value');
            imageBin.nCores = get(findobj(hLocPanel,'Tag','nCores'),'Value');
            imageBin.isRadiusTol = get(findobj(hLocPanel,'Tag','isRadiusTol'),'Value');
            imageBin.radiusTol = str2double(get(findobj(hLocPanel,'Tag','radiusTol'),'String'));
            imageBin.posTol = str2double(get(findobj(hLocPanel,'Tag','posTol'),'String'));
            imageBin.maxOptimIter = str2double(get(findobj(hLocPanel,'Tag','maxOptimIter'),'String'));
            imageBin.termTol = str2double(get(findobj(hLocPanel,'Tag','termTol'),'String'));
            
            %Bar Options
            imageBin.isScalebar = 0;
            imageBin.micronBarLength = 1000;
            imageBin.isColormap = 0;
            imageBin.colormapWidth = 20;
            imageBin.isTimestamp = 0;
            imageBin.timestampSize = 2;
            imageBin.timestampInkrement = 0.032;
            
            %Render Options
            imageBin.exfOld = 5;
            imageBin.exfNew = 5;
            imageBin.rW = 50;
            imageBin.rStep = 10;
            imageBin.rStart = 1;
            imageBin.rEnd = inf;
            imageBin.rLive = false;
            imageBin.fps = 25;
            imageBin.movCompression = 1;
            imageBin.convMode = 1;
            imageBin.intWeight = 0.01;
            imageBin.sizeFac = 1;
            imageBin.isCumsum = false;
            
            %Thresh Options
            imageBin.isThreshLocPrec = false;
            imageBin.minLoc = 0;
            imageBin.maxLoc = inf;
            imageBin.isThreshSNR = false;
            imageBin.minSNR = 0;
            imageBin.maxSNR = inf;
            imageBin.isThreshDensity = false;
            
            %Optics Options
            hOpticsPanel = findobj(get(src,'Parent'),...
                'Tag',files{file}, '-and', 'Type', 'Uipanel');
            imageBin.pxSize = str2double(get(findobj(hOpticsPanel,'Tag','pxSize'),'String'));
            imageBin.cntsPerPhoton = str2double(get(findobj(hOpticsPanel,'Tag','cntsPerPhoton'),'String'));
            imageBin.emWvlnth = str2double(get(findobj(hOpticsPanel,'Tag','emWvlnth'),'String'));
            imageBin.NA = str2double(get(findobj(hOpticsPanel,'Tag','NA'),'String'));
            imageBin.psfScale = str2double(get(findobj(hOpticsPanel,'Tag','psfScale'),'String'));
            imageBin.psfStd = str2double(get(findobj(hOpticsPanel,'Tag','psfStd'),'String'));
            imageBin.spatialCorrection = get(findobj(hOpticsPanel,'Tag','spatialCorrection'),'Value');
            if imageBin.spatialCorrection
                imageBin.spatialCorrPath = get(findobj(hOpticsPanel,'Tag','spatialCorrection'),'UserData');
            end %if
            
            imageBin.imageName = files{file};
            [imageBin.pathname, imageBin.filename, ext] = fileparts(imageBin.imageName);
            imageBin.pathname = [imageBin.pathname '\'];
            
            startPnt = 1;
            if 0
                for subfile = 1:numel(imageBin.imageName)
                    info = imfinfo(imageBin.imageName{subfile});
                    imageBin.width = info(1).Width;
                    imageBin.height = info(1).Height;
                    imageBin.roi =...
                        [1 1 imageBin.width imageBin.height];
                    if file == 1
                        N = numel(info)-startPnt+1;
                    else
                        startPnt = 1;
                        N = N + numel(info);
                        if N > endPnt
                            endPnt = N - endPnt;
                        end %if
                    end %if
                    imageBin = localizeParticles(imageBin.imageName{subfile},roi,...
                        startPnt,endPnt,info,imageBin);
                end %for
            else
                info = imfinfo(imageBin.imageName);
                endPnt = numel(info);
                
                imageBin.width = info(1).Width;
                imageBin.height = info(1).Height;
                imageBin.roi =...
                    [1 1 imageBin.width imageBin.height];
                
                imageBin.ctrsN = localizeParticles(imageBin.imageName,...
                    startPnt,endPnt,info,imageBin);
            end %if
            
            %save localization matrix
            save ([imageBin.pathname...
                imageBin.filename '.mat'], 'imageBin')
            clear imageBin
        end %for
        msgbox('Done!')
    end

end

function ctrsN = localizeParticles(...
    imagename,startPnt,endPnt,info,imageBin)

region = {[imageBin.roi(2) imageBin.roi(2)+imageBin.roi(4)-1],...
    [imageBin.roi(1) imageBin.roi(1)+imageBin.roi(3)-1]};

if imageBin.locParallel
    %startPnt localization procedure
    data = cell(endPnt-startPnt+1,1);
    ctrsN = cell(endPnt-startPnt+1,1);
    switch imageBin.nCores
        case 1
            matlabpool local
        case 2
            matlabpool 2
        case 3
            matlabpool 3
    end %switch
    roiWidth = imageBin.roi(3);
    roiHeight = imageBin.roi(4);
    w2d = imageBin.w2d;
    psfStd = imageBin.psfStd;
    errorRate = imageBin.errorRate;
    dfltnLoops = imageBin.dfltnLoops;
    minInt = imageBin.minInt;
    optim = [imageBin.maxOptimIter,imageBin.termTol,...
        imageBin.isRadiusTol,imageBin.radiusTol,...
        imageBin.posTol];
    
    parfor frame = startPnt:endPnt
        [data{frame} unused unused ctrsN{frame}] = ...
            detect_et_estime_part_1vue_deflt(...
            double(imread(imagename,...
            frame, 'info', info, 'PixelRegion', region)),...
            w2d, psfStd,chi2inv(1-1/10^(errorRate*-1),1),...
            dfltnLoops,roiWidth,roiHeight,minInt,optim);
    end %for
    matlabpool close
    
    time = [];
    for frame = startPnt:endPnt
        time = [time;ones(ctrsN{frame},1)*frame];
    end %for
    data = [vertcat(data{:}) time];
    if imageBin.spatialCorrection
        data(:,1:2) = fliplr(tformfwd(imageBin.tMat,data(:,2),data(:,1)));
        bad = data(:,2)<=roi(1) & data(:,2)>=roi(1)+roi(3)-1 &...
            data(:,1)<=roi(2) & data(:,1)>=roi(2)+roi(4)-1;
        data(bad,:) = [];
    end %if
    streamToDisk(data,...
        [imageBin.pathname imageBin.filename])
    
    ctrsN = vertcat(ctrsN{:});
else %linear computation
    iter = 0;
    hProgressbar = waitbar(0,'Localization...','Color',...
        get(0,'defaultUicontrolBackgroundColor'));
    for frame = startPnt:endPnt
        iter = iter+1;
        I = imread(imagename,...
            frame, 'info', info, 'PixelRegion', region);
        
        optim = [imageBin.maxOptimIter,imageBin.termTol,...
            imageBin.isRadiusTol,imageBin.radiusTol,...
            imageBin.posTol];
        
        [data deflatedIm binaryIm ctrsN(iter,1)] = ...
            detect_et_estime_part_1vue_deflt(...
            double(I),imageBin.w2d, imageBin.psfStd,...
            chi2inv(1-1/10^(imageBin.errorRate*-1),1),...
            imageBin.dfltnLoops,imageBin.roi(3),...
            imageBin.roi(4),imageBin.minInt,optim);
        
        if 0
            imwrite(uint16(deflatedIm),...
                [imagename(1:end-4) '_deflated.tif'],...
                'compression','none','writemode','append')
            imwrite(uint16(binaryIm),...
                [imagename(1:end-4) '_binary.tif'],...
                'compression','none','writemode','append')
        end
        
        if imageBin.rLive
            if frame == startPnt
                fig =...
                    figure(...
                    'Units','normalized',...
                    'Position', figPos(imageBin.roi(3)/imageBin.roi(4)),...
                    'Color', get(0,'defaultUicontrolBackgroundColor'),...
                    'Name', 'Live Localization',...
                    'NumberTitle', 'off',...
                    'MenuBar', 'none',...
                    'ToolBar', 'none');
                ax =...
                    axes(...
                    'Parent', fig,...
                    'Units','normalized',...
                    'Position', [0 0 1 1]);
                liveView = imshow(imadjust(I),[]);
                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                hDots = patch(repmat(1+data(:,2)',10,1)+cos(rho)*data(:,6)',...
                    repmat(1+data(:,1)',10,1)+sin(rho)*data(:,6)',...
                    repmat(shiftdim([1 0 0],-1),1,ctrsN(iter)),...
                    'EdgeColor', 'none', 'FaceAlpha', 0.5,...
                    'Parent', ax);
                drawnow
            elseif frame == endPnt
                set(liveView, 'CData', imadjust(I))
                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                set(hDots, 'XData', repmat(1+data(:,2)',10,1)+...
                    cos(rho)*data(:,6)', 'YData', repmat(1+data(:,1)',10,1)+...
                    sin(rho)*data(:,6)', 'CData', repmat(shiftdim([1 0 0],-1),1,...
                    ctrsN(iter)))
                drawnow
                close(fig)
            else
                set(liveView, 'CData', imadjust(I))
                
                rho = [0;0.69;1.39;2.09;2.79;3.49;4.18;4.88;5.58;6.28];
                set(hDots, 'XData', repmat(1+data(:,2)',10,1)+...
                    cos(rho)*data(:,6)', 'YData', repmat(1+data(:,1)',10,1)+...
                    sin(rho)*data(:,6)', 'CData', repmat(shiftdim([1 0 0],-1),1,...
                    ctrsN(iter)))
                drawnow
            end %if
        end %if
        %correct for imageBin.roi(crop)
        %data(:,1:2) = [data(:,1)+imageBin.roi(2)-1,data(:,2)+imageBin.roi(1)-1];
        
        %apply a nonreflective similarity transformation (correct for
        %scale, rotation and translation)
        if imageBin.spatialCorrection
            data(:,1:2) = fliplr(tformfwd(imageBin.tMat,data(:,2),data(:,1)));
            bad = data(:,2)<=imageBin.roi(1) & data(:,2)>=imageBin.roi(1)+imageBin.roi(3)-1 &...
                data(:,1)<=imageBin.roi(2) & data(:,1)>=imageBin.roi(2)+imageBin.roi(4)-1;
            data(bad,:) = [];
        end %if
        
        streamToDisk([data ones(ctrsN(iter),1)*frame],...
            [imageBin.pathname imageBin.filename])
        
        waitbar(iter/(endPnt-startPnt+1));
        %,hProgressbar,...
        %    'Localization...','Color',...
        %    get(0,'defaultUicontrolBackgroundColor'));
    end %for
    delete(hProgressbar)
end %if

    function streamToDisk(data,outputname)
        %stream data to harddisc
        fidY = fopen([outputname '.ctrsY'], 'a+');
        fidX = fopen([outputname '.ctrsX'], 'a+');
        fidSignal = fopen([outputname '.signal'], 'a+');
        fidNoise = fopen([outputname '.noise'], 'a+');
        fidOffset = fopen([outputname '.offset'], 'a+');
        fidRadius = fopen([outputname '.radius'], 'a+');
        fidFrame = fopen([outputname '.frame'], 'a+');

        fwrite(fidY,data(:,1),'real*8'); %y-coordinate
        fwrite(fidX,data(:,2),'real*8'); %x-coordinate
        fwrite(fidSignal,data(:,3)/sqrt(pi)./data(:,6),'real*8'); %peak amplitude
        fwrite(fidNoise,sqrt(data(:,4)),'real*8'); %noise std
        fwrite(fidOffset,data(:,5),'real*8'); %background level
        fwrite(fidRadius,data(:,6),'real*8'); %gaussian radius.
        fwrite(fidFrame,data(:,8),'real*8'); %detected frame
                
        fclose('all');
    end
end
function [lestime, input_deflt, dfin, ctrsN] =...
    detect_et_estime_part_1vue_deflt(input, wn, r0, pfa, n_deflt,...
    w,h,minInt,optim)

[lest,ldec,dfin] = detect_et_estime_part_1vue (input, wn, r0, pfa, optim) ;
input_deflt = deflat_part_est(input, lest, wn);
lestime = lest ;
if n_deflt == 0
            border = ceil(wn/2);
        good = lestime(:,7) & ...
            (lestime(:,4)/sqrt(pi)./lestime(:,6)>minInt) & ...
            (lestime(:,1)>border) & (lestime(:,1)<h-border) & ...
            (lestime(:,2)>border) & (lestime(:,2)<w-border) ;
        lestime = lestime(good,:);
        ctrsN = sum(good);
        return
end %if

for n=1:n_deflt
    [l,ld,d,N] = detect_et_estime_part_1vue (input_deflt, wn, r0, pfa, optim) ;
    lestime = [lestime ; l] ;
    %%dfin += d
    dfin = dfin | d ;
    input_deflt = deflat_part_est(input_deflt, l, wn);
    
    if (N==0) || n == n_deflt
        border = ceil(wn/2);
        good = lestime(:,7) & ...
            (lestime(:,4)/sqrt(pi)./lestime(:,6)>minInt) & ...
            (lestime(:,1)>border) & (lestime(:,1)<h-border) & ...
            (lestime(:,2)>border) & (lestime(:,2)<w-border) ;
        lestime = lestime(good,:);
        ctrsN = sum(good);
        return
    end

end%for
end%function
function [lestime, ldetect, d, Nestime] = detect_et_estime_part_1vue(input, wn, r0, pfa, optim)%%, pas_ijr)

[Ni, Nj] = size(input) ;

%% positions des parametres
Nparam = 7 ;
detect_i = 2 ;
detect_j = 3 ;
alpha = 4 ;
% sig2 = 5 ;

%% detection pour un rayon moyen r0
[c,ldetect,d] = carte_H0H1_1vue(input, r0, wn, wn, pfa);

%% estimation pour des pas de recherche
%% interval [-1,1] pour ij
%% interval [0.6,1.4] pour le rayon

Ndetect = size(ldetect, 1) ;
if (Ndetect==0) %no pixels meets glrt threshold
    lestime = zeros(1,Nparam) ;
    Nestime = 0 ;
    return ;
end%if

Nestime = 0 ;
bord = ceil(wn/2) ;
for n=1:Ndetect
    test_bord = (ldetect(n,detect_i) < bord) || (ldetect(n,detect_i) > Ni-bord) || ...
        (ldetect(n,detect_j) < bord) || (ldetect(n,detect_j) > Nj-bord) ;
    if ((ldetect(n,alpha) > 0.0) && (~test_bord) )
        Nestime = Nestime + 1 ;
        lestime(Nestime, :) = estim_param_part_GN(input, wn, ldetect(n,:), r0, optim) ;
    end%if
end%for

% a la bonne taille
if (Nestime==0)
    lestime = zeros(1,Nparam) ;
else
    lestime = lestime(1:Nestime,:) ;
end%if

end%function
function [carte_MV, liste_detect, detect_pfa] = carte_H0H1_1vue(im, rayon, wn_x, wn_y, s_pfa)

[N,M] = size(im) ;
T = wn_x*wn_y ; % nombre de pixel dans la fenetre


%% Hypothese H0
%% pas de particule dans la fenetre
m = ones(wn_x,wn_y) ;
hm = expand_w(m, N, M) ;
tfhm = fft2(hm) ;
tfim = fft2(im) ;
m0 = real(fftshift(ifft2(tfhm .* tfim))) /T ;

im2 = im .* im ;
tfim2 = fft2(im2) ;
Sim2 = real(fftshift(ifft2(tfhm .* tfim2)));

%% H0 = T/2*log(2*pi*sig0^2)-T/2 ;
T_sig0_2 = Sim2 - T*m0.^2 ;

%% Hypoth?se H1
%% une particule est au centre de la fenetre
%% amplitude inconnue, rayon fixe

%% generation masque gaussien de largeur (sigma)
%% egal a rayon

%%g = gausswin2(rayon, wn_x, wn_y) ;
g = gausswin2(rayon, wn_x, wn_y, 0, 0) ;
gc = g - sum(g(:))/T ;
Sgc2 = sum(gc(:).^2) ;
hgc = expand_w(gc, N, M) ;
tfhgc = fft2(hgc) ;

alpha = real(fftshift(ifft2(tfhgc .* tfim))) / Sgc2 ;

%% H1 = T/2*log(2*pi*sig1^2)-T/2 ;
%%sig1_2 = sig0_2 - alpha.^2 * Sgc2 / T ;

%% pour test
%sig1_2 = T_sig0_2/T - alpha.^2 * Sgc2 / T ;
%%imagesc(T_sig0_2/T);
%imagesc(sig1_2);
%%imagesc(sig1_2 ./ (T_sig0_2/T));

%%  carte_MV = -0.5*(H0 - H1) ;
% carte_MV = - T * log(1 - (Sgc2 * alpha.^2) ./ T_sig0_2) ;
test = 1 - (Sgc2 * alpha.^2) ./ T_sig0_2 ;
test = (test > 0) .* test + (test <= 0) ;
carte_MV = - T * log(test) ;
carte_MV(isnan(carte_MV)) = 0; %CPR

%% detection et recherche des maximas
%% s_pfa = 28 ;
detect_masque = carte_MV > s_pfa ;
if (sum(detect_masque(:))==0)
    %     warning('No target detected !') ; %#ok
    liste_detect = zeros(1,6) ;
    detect_pfa = zeros(size(detect_masque)) ; % ajout AS 4/12/7
else
    detect_pfa = all_max_2d(carte_MV) & detect_masque ;
    
    [di, dj] = find(detect_pfa) ;
    n_detect = size(di, 1) ;
    vind = N*(dj-1)+di ;
    valpha = alpha(:) ;
    alpha_detect = valpha(vind) ;
    
    sig1_2 = ( T_sig0_2 - alpha.^2 * Sgc2 ) / T ;
    vsig1_2 = sig1_2(:) ;
    sig2_detect = vsig1_2(vind) ;
    
    %% g de puissance unitaire
    %%RSBdB_detect = 10*log10(alpha_detect.^2  ./ sig2_detect) ;
    
    %%liste_detect = [(1:n_detect)', di, dj, alpha_detect, sqrt(sig2_detect), RSBdB_detect] ;
    liste_detect = [(1:n_detect)', di, dj, alpha_detect, sig2_detect, rayon*ones(n_detect,1),ones(n_detect,1)] ;
    
end%if
end %function
function out = expand_w(in, N, M)

[N_in, M_in] = size(in) ;

out = zeros(N,M) ;
%nc = 1+floor(N/2 - N_in/2) ;
%mc = 1+floor(M/2 - M_in/2) ;
%out(nc:(nc+N_in-1) , mc:(mc+M_in-1)) = in ;

nc = floor(N/2 - N_in/2) ;
mc = floor(M/2 - M_in/2) ;
out((nc+1):(nc+N_in) , (mc+1):(mc+M_in)) = in ;

end %function
function carte_max = all_max_2d(input)

[N,M] = size(input) ;
ref = input(2:N-1, 2:M-1) ;

pos_max_h = input(1:N-2, 2:M-1) < ref & ...
    input(3:N  , 2:M-1) < ref;
pos_max_v = input(2:N-1, 1:M-2) < ref & ...
    input(2:N-1, 3:M  ) < ref;
pos_max_135 = input(1:N-2, 1:M-2) < ref & ...
    input(3:N  , 3:M  ) < ref;
pos_max_45  = input(3:N  , 1:M-2) < ref & ...
    input(1:N-2, 3:M  ) < ref;

carte_max = zeros(N,M) ;
carte_max(2:N-1, 2:M-1) = pos_max_h & pos_max_v & pos_max_135 & pos_max_45 ;
carte_max = carte_max .* input ;

end %function
function liste_param = estim_param_part_GN(im, wn, liste_info_param, r0, optim)

Pi = liste_info_param(2) ;
Pj = liste_info_param(3) ;
di = (1:wn)+Pi-floor(wn/2) ;
dj = (1:wn)+Pj-floor(wn/2) ;
im_part = im(di, dj) ;

if 0
        options = optimset(...
        'Algorithm', 'Active-Set',...
        'Display','off',...
        'UseParallel', 'always');
    if 0
    guess = [0,0,r0];
    bounds = [-1.5,-1.5,r0-r0*0.1;1.5,1.5,r0+r0*0.6];
    liste_param = gaussMLE(im_part,guess,bounds,options);
    else
    guess = [0,0,r0,0,r0];
    bounds = [-1.5,-1.5,r0-r0*0.1,0,r0-r0*0.1;...
        1.5,1.5,r0+r0*0.6,0.8,r0+r0*0.6];
    liste_param = gaussEllipticMLE(im_part,guess,bounds,options);
    end   
    liste_param(1:2) = liste_param(1:2)+[Pi Pj];    
else
    %limits for optimization
    bornes_ijr(1) = -optim(5) ;
    bornes_ijr(2) = optim(5) ;
    bornes_ijr(3) = -optim(5) ;
    bornes_ijr(4) = optim(5) ;
    bornes_ijr(5) = r0-optim(4)*r0/100 ;
    bornes_ijr(6) = r0+optim(4)*r0/100 ;
    
    r = r0 ;
    i = 0.0 ;
    j = 0.0 ;
    dr = 1 ;
    di = 1 ;
    dj = 1 ;
    fin = 10^optim(2) ;
    sig2 = inf ;
    cpt = 0 ;
    test = 1 ;
    ITER_MAX = optim(1) ;
    while (test)
        %%[r, i, j, dr, di, dj, alpha, sig2] = deplt_GN_estimation (r, i, j, im_part) ;
        [r, i, j, dr, di, dj, alpha, sig2, offset] = deplt_GN_estimation (r, i, j, im_part, sig2, dr, di, dj, optim) ;
        cpt = cpt + 1 ;
        if optim(3)
            test = max([abs(di), abs(dj), abs(dr)]) > fin ;
        else
            test = max([abs(di), abs(dj)]) > fin ;
        end %if
        if (cpt > ITER_MAX)
            test = 0 ;
        end%if
        
        %% on stop si l_on sort des bornes
        result_ok = ~((i < bornes_ijr(1)) || (i > bornes_ijr(2)) || ...
            (j < bornes_ijr(3)) || (j > bornes_ijr(4)) || ...
            (r < bornes_ijr(5)) || (r > bornes_ijr(6)) ) ;
        test = test & result_ok ;
        
    end%while
    
    
    % liste_info_param = [num, i, j, alpha, sig^2]
    % liste_param = [num, i, j, alpha, sig^2, rayon, ok]
    
    liste_param = [Pi+i , ... %y-coordinate
        Pj+j , ... %x-coordinate
        alpha , ... %mean amplitude
        sig2 , ... %noise power
        offset, ... %background level
        r , ... %r0
        result_ok ];
end %if
end%fonction
function [n_r, n_i, n_j, dr, di, dj, alpha, sig2 m] = ...
    deplt_GN_estimation(p_r, p_i, p_j, x, sig2init, p_dr, p_di, p_dj, optim)

%%  p_di, p_dj les precedents deplacements
%% qui ont conduit a p_r, p_i, p_j

r0 = p_r ;
i0 = p_i ;
j0 = p_j ;
prec_rel = 10^optim(2) ;

verif_crit = 1 ;
pp_r = r0 - p_dr ;
pp_i = i0 - p_di ;
pp_j = j0 - p_dj ;

[wn_i, wn_j] = size(x) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;

%% on boucle, en diminuant les deplacements
%% tand que le nouveau critere en plus grand
again = 1 ;
loops = 0;
while (again)
    
    loops = loops + 1;
    i = refi - i0 ;
    j = refj - j0 ;
    ii = i' * ones(1,wn_j) ; %'
    jj = ones(wn_i,1) * j ;
    
    %% puissance unitaire
    iiii = ii.*ii ;
    jjjj = jj.*jj ;
    iiii_jjjj = iiii + jjjj ;
    g = (1/(sqrt(pi)*r0)) * exp(-(1/(2*r0^2))*(iiii_jjjj)) ;
    gc = g - sum(g(:))/N ;
    Sgc2 = sum(gc(:).^2) ;
    g_div_sq_r0 = inv(r0^2) * g ;
    
    %% alpha estime MV
    if (Sgc2 ~= 0)
        alpha = sum(sum(x .* gc)) / Sgc2 ;
    else
        alpha = 0 ;
    end%if
    %% m estime MV
    
    x_alphag = x - alpha.*g ;
    m = sum(sum(x_alphag))/N ;
    
    err = x_alphag - m ;
    
    %% critere avant deplacement
    sig2 = sum(sum(err.^2)) / N ;
    if ((verif_crit) && (sig2 > sig2init))
        p_di = p_di / 10.0 ;
        p_dj = p_dj / 10.0 ;
        i0 = pp_i + p_di ;
        j0 = pp_j + p_dj ;
        if optim(3)
            p_dr = p_dr / 10.0 ;
            r0 = pp_r + p_dr ;
        else
            p_dr = 0;
            r0 = pp_r;
        end %if
        if (max([abs(p_dr), abs(p_di), abs(p_dj)]) > prec_rel)
            %      if (max([abs(p_di), abs(p_dj)]) > prec_rel)
            n_r = p_r ;
            n_i = p_i ;
            n_j = p_j ;
            dr = 0 ;
            di = 0 ;
            dj = 0 ;
            return ;
        end%if
    else
        again = 0 ;
    end%if
    
    % to avoid getting stuck in this loop
    if (loops > 50)
        again = 0;
    end
    
end%while

%% der_g
der_g_i0 =  ii .* g_div_sq_r0 ;
der_g_j0 =  jj .* g_div_sq_r0 ;

%% derder_g
derder_g_i0 = (-1 + inv(r0^2)*iiii) .* g_div_sq_r0 ;
derder_g_j0 = (-1 + inv(r0^2)*jjjj) .* g_div_sq_r0 ;

%% der_J /2
der_J_i0 = alpha * sum(sum(der_g_i0 .* err)) ;
der_J_j0 = alpha * sum(sum(der_g_j0 .* err)) ;

%% derder_J /2
derder_J_i0 = alpha * sum(sum(derder_g_i0 .* err)) - alpha^2 * sum(sum(der_g_i0.^2)) ;
derder_J_j0 = alpha * sum(sum(derder_g_j0 .* err)) - alpha^2 * sum(sum(der_g_j0.^2)) ;

%% deplacement par Gauss-Newton
if optim(3)
    der_g_r0 = (-inv(r0) + inv(r0^3)*(iiii_jjjj)) .* g ;
    derder_g_r0 = (1 - 3*inv(r0^2)*iiii_jjjj) .* g_div_sq_r0 ...
        + (-inv(r0) + inv(r0^3)*(iiii_jjjj)) .* der_g_r0 ;
    der_J_r0 = alpha * sum(sum(der_g_r0 .* err)) ;
    derder_J_r0 = alpha * sum(sum(derder_g_r0 .* err)) - alpha^2 * sum(sum(der_g_r0.^2)) ;
    dr = - der_J_r0 / derder_J_r0 ;
    n_r = abs(r0 + dr) ; %% r0 > 0
else
    dr = 0;
    n_r = r0;
end %if

di = - der_J_i0 / derder_J_i0 ;
dj = - der_J_j0 / derder_J_j0 ;

n_i = i0 + di ;
n_j = j0 + dj ;

end %function
function output = deflat_part_est(input, liste_est, wn)

[idim, jdim] = size(input) ;
nb_part = size(liste_est, 1) ;

output = input ;

%% parametre dans liste_est :
%% liste_param = [num, i, j, alpha, sig^2, rayon, ok]

for part=1:nb_part
    if (liste_est(part, 7) == 1)
        i0 = liste_est(part, 1) ;
        j0 = liste_est(part, 2) ;
        alpha = liste_est(part, 3) ;
        r0 = liste_est(part, 6) ;
        wn = ceil(6*r0); % by CPR: 99% of Gaussian
        
        pos_i = round(i0) ;
        dep_i = i0 - pos_i ;
        pos_j = round(j0) ;
        dep_j = j0 - pos_j ;
        
        alpha_g = alpha * gausswin2(r0, wn, wn, dep_i, dep_j) ;
        
        dd = (1:wn) - floor(wn/2) ;
        di = dd + pos_i ;
        iin = di > 0 & di < idim+1;
                
        dj = dd + pos_j ;
        jin = dj > 0 & dj < jdim+1;
                
        output(di(iin), dj(jin)) = ...
            output(di(iin), dj(jin)) - alpha_g(iin,jin) ;
    end%if
end%for


end%function
function g = gausswin2(sig, wn_i, wn_j, offset_i, offset_j)

if (nargin < 5)
    offset_i = 0.0 ;
    offset_j = 0.0 ;
end%if

if (nargin < 3)
    wn_j = wn_i ;
end%if

refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
i = refi - offset_i ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;
j = refj - offset_j ;
ii = i' * ones(1,wn_j) ; %'
jj = ones(wn_i,1) * j ;

%%% puissance unitaire
g = (1/(sqrt(pi)*sig)) * exp(-(1/(2*sig^2))*(ii.*ii + jj.*jj)) ;
end %function
function output = gaussMLE(raw,guess,bounds,options)
[wn_i, wn_j] = size(raw) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;

alpha = []; m = [];
[x,fval,flag] = fmincon(@modelfun,guess,[],[],[],[],...
    bounds(1,:),bounds(2,:),[],options);
output = [x(1) x(2) alpha fval m  x(3) flag-flag+1];

    function sig2 = modelfun(x)
        i = refi - x(1) ;
        j = refj - x(2) ;
        ii = i' * ones(1,wn_j) ;
        jj = ones(wn_i,1) * j ;
        
        %% noise model
        iiii = ii.*ii ;
        jjjj = jj.*jj ;
        iiii_jjjj = iiii + jjjj ;
        g = (1/(sqrt(pi)*x(3)))*...
            exp(-(1/(2*x(3)^2))*(iiii_jjjj)) ;
        gc = g - sum(g(:))/N ;
        Sgc2 = sum(gc(:).^2) ;
        
        %% mean amplitude
        alpha = sum(sum(raw .* gc)) / Sgc2 ;
        
        %% offset
        x_alphag = raw - alpha.*g ;
        m = sum(sum(x_alphag))/N ;
        
        %% residuals
        err = x_alphag - m ;
        
        %% noise power
        sig2 = sum(sum(err.^2)) / N ;
        
    end
end
function output = gaussEllipticMLE(raw,guess,bounds,options)
[wn_i, wn_j] = size(raw) ;
N = wn_i * wn_j ;
refi = 0.5 + (0:(wn_i-1)) - wn_i/2 ;
refj = 0.5 + (0:(wn_j-1)) - wn_j/2 ;

        ii = refi' * ones(1,wn_j) ;
        jj = ones(wn_i,1) * refj ;
        
        %% noise model
        iiii = ii.*ii ;
        jjjj = jj.*jj ;
        iiii_jjjj = iiii + jjjj ;

alpha = []; m = [];

[x,fval,flag] = fmincon(@modelfun,guess,[],[],[],[],...
    bounds(1,:),bounds(2,:),[],options);
output = [x(1) x(2) alpha fval m x(3) flag-flag+1];

[V, D] = eig([x(3),x(4);x(4),x(5)]);
t = linspace(0, 2*pi, 20);
u = [cos(t(:))'; sin(t(:))'];
w = (V * sqrt(D)) * u;
z = repmat([x(1); x(2)], [1 20]) + w;

figure;
imagesc(raw)
colormap gray
patch(z(1,:)+5,z(2,:)+5,[1 0 0],...
    'FaceAlpha', 0.6)
waitforbuttonpress
delete(gcf)
    
    function sig2 = modelfun(x)
        
        g = reshape(2*sqrt(pi)*...
            mvnpdf(sqrt([iiii(:) jjjj(:)]),...
            [x(1) x(2)],[x(3),x(4);x(4),x(5)]),...
            [wn_i, wn_j]) ;
        gc = g - sum(g(:))/N ;
        Sgc2 = sum(gc(:).^2) ;
        
        %% mean amplitude
        alpha = sum(sum(raw .* gc)) / Sgc2 ;
        
        %% offset
        x_alphag = raw - alpha.*g ;
        m = sum(sum(x_alphag))/N ;
        
        %% residuals
        err = x_alphag - m ;
        
        %% noise power
        sig2 = sum(sum(err.^2)) / N ;
        
    end
end

%% TRACKING
function buildTracks(src,event)

global tab_param ;
global tab_var ;
global tab_moy ;

fig = gcbf;

settings.Width = getappdata(fig,'width');
settings.Height = getappdata(fig,'height');
settings.px2micron = getappdata(fig,'pxSize');
settings.Delay = getappdata(fig,'frameSize')/1000;

seuil_detec_1vue = chi2inv(1-10^getappdata(fig,'errorRate'),1);
settings.TrackingOptions.FinalDetectionTresh = seuil_detec_1vue;

wn = getappdata(fig,'w2d');
settings.TrackingOptions.SizeDetectionBox = wn;

r0 = getappdata(fig,'psfStd');
settings.TrackingOptions.GaussianRadius = r0;

seuil_alpha = getappdata(fig,'minInt');
settings.TrackingOptions.ValidationTresh = seuil_alpha;

nb_defl = getappdata(fig,'dfltnLoops');
settings.TrackingOptions.NumberDeflationLoops = nb_defl;

T = getappdata(fig,'statWin');
settings.TrackingOptions.AvaragingTimeWindow = T;
assignin('base', 'T', T)

T_off = getappdata(fig,'maxOffTime')*-1;
settings.TrackingOptions.BlinkingProbability = T_off;
assignin('base', 'T_off', T_off)

sig_free = sqrt(getappdata(fig,'Dmax')/...
    getappdata(fig,'pxSize')^2*...
    4*getappdata(fig,'frameSize')/1000);
settings.TrackingOptions.MaxDiffusionCoefficient =...
    getappdata(fig,'Dmax');
assignin('base', 'sig_free', sig_free)

Boule_free = getappdata(fig,'searchExpFac');
settings.TrackingOptions.ResearchDiameter = Boule_free;
assignin('base', 'Boule_free', Boule_free)

Nb_combi = getappdata(fig,'maxComp');
settings.TrackingOptions.CombinationTresh = Nb_combi;
assignin('base', 'Nb_combi', Nb_combi)

Poids_melange_aplha = getappdata(fig,'intLawWeight');
settings.TrackingOptions.WeightUniformGaussianLaw = Poids_melange_aplha;
assignin('base', 'Poids_melange_aplha', Poids_melange_aplha)

Poids_melange_diff = getappdata(fig,'diffLawWeight');
settings.TrackingOptions.WeightMaxLocalDiffusion = Poids_melange_diff;
assignin('base', 'Poids_melange_diff', Poids_melange_diff)

ctrsN = getappdata(fig,'ctrsN');
Nb_STK =  numel(ctrsN);
assignin('base', 'Nb_STK', Nb_STK)

%t == T-T_off dans les tab_x reduits
t_red = T-T_off ;
assignin('base', 't_red', t_red)

filename = getappdata(fig,'imageName');
info = imfinfo(filename);
im_t = double(imread(filename, 1, 'info', info)) ;
assignin('base', 'im_t', im_t)

idx = [-1; cumsum(getappdata(fig,'ctrsN'))];
if getappdata(fig,'trackStart') == 1
    setappdata(fig,'startPnt',0)
else
    setappdata(fig,'startPnt',...
        idx(getappdata(fig,'trackStart'))+1)
end %if
if isinf(getappdata(fig,'trackEnd'))
    setappdata(fig,'trackEnd',...
        numel(getappdata(fig,'ctrsN')))
    setappdata(fig,'elements',inf)
else
    setappdata(fig,'elements',...
        idx(getappdata(fig,'trackEnd')+1)-...
        max(1,getappdata(fig,'startPnt'))+1)
end %if
settings.Frames = getappdata(fig,'trackEnd')-...
    getappdata(fig,'trackStart')+1;

%get ROI
roi = getappdata(fig,'roi');
data = preprocessData(fig,[1 1 1 1 1 1 1 0 0 0 0 0],roi);
trackID = 1:size(data.signal);

hProgressbar = waitbar(0,['Processing Frame: ' num2str(1) ':'...
    num2str(Nb_STK)],'Color', get(0,'defaultUicontrolBackgroundColor'));
for t = getappdata(fig,'trackStart'):getappdata(fig,'trackEnd')
    %first iteration
    if t == getappdata(fig,'trackStart')
        %fake detection list
ind_valid = data.frame == 1;
par_per_frame(t) = sum(ind_valid);
lest = [(1:par_per_frame(t))' data.ctrsY(ind_valid) data.ctrsX(ind_valid)...
    data.signal(ind_valid)*sqrt(pi).*data.radius(ind_valid)...
    data.noise(ind_valid).^2 data.radius(ind_valid) ones(par_per_frame(t),1)];

%preallocate tables
tab_param = zeros(par_per_frame(t), 1+7*(t_red+1));
tab_var = tab_param;
%tab_moy = zeros(ctrsN, 1+7*(t_red+1)) ;

%% initialize parameter tables
tab_param(:,1) = (1:par_per_frame(t))' ;
tab_param(:,2+7*(t_red-1):1+7*(t_red)) = [ones(par_per_frame(t),1), ...
    lest(:,[2,3,4,6]), zeros(par_per_frame(t),1), Nb_STK*ones(par_per_frame(t),1)];
tab_param(:,2+7*(t_red)) = 2*ones(par_per_frame(t),1) ;

tab_var(:,1)   = (1:par_per_frame(t))' ;
tab_var(:,2+7*(t_red-1):1+7*(t_red)) = [ones(par_per_frame(t),1), ...
    zeros(par_per_frame(t),4), lest(:,5), Nb_STK*ones(par_per_frame(t),1)];
tab_var(:,2+7*(t_red)) = 2*ones(par_per_frame(t),1) ;
tab_moy = tab_var ;

%% set initial variance guess (20% by default) -> nested by CPR
init_tab;

%% initialize tracks
trackList = cell(1,par_per_frame(t));
for track = tab_param(:,1)'
    if tab_param(track,1+7*(t_red))>0
        trackList{trackID(track)}(1,:) =...
            [tab_param(track,7*(t_red-1)+[4 3 2])...
            trackID(track) tab_param(track,7*(t_red-1)+5)...
            tab_var(track,7*(t_red-1)+[7 3 5])];
    end %if
end %for

        continue
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%  CYCLE THROUGH ACTIVE TRAJECTORIES   %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    im_t = double(imread(filename, t, 'info', info)) ;
assignin('base', 'im_t', im_t)

    ind_valid = data.frame == t;
    par_per_frame(t) = sum(ind_valid);
    lest = [(1:sum(ind_valid))' data.ctrsY(ind_valid) data.ctrsX(ind_valid)...
    data.signal(ind_valid)*sqrt(pi).*data.radius(ind_valid)...
    data.noise(ind_valid).^2 data.radius(ind_valid) ones(par_per_frame(t),1)];

    nb_traj_active = 0 ;
    nb_traj_blink = 0 ;
    
    isClosed = (tab_param(:,7*(t_red-1)+8) == T_off);
    if any(isClosed)
        trackID(find(isClosed)) = [];
        tab_param(isClosed,:) = [];
        tab_var(isClosed,:) = [];
        tab_moy(isClosed,:) = [];
    end %if

        if ~isempty(tab_param)
        tab_param(:,1) = 1:size(tab_param,1);
        tab_var(:,1) = tab_param(:,1);
        tab_moy(:,1) = tab_param(:,1);

        %from longest ON to longest OFF(blink)
    [unused, part_ordre_blk] = sort(-tab_param(:,7*(t_red-1)+8)) ;
    for traj = part_ordre_blk'
        %% reconnection test
        if (tab_param(traj, 7*(t_red-1)+8) > T_off)
            part = reconnect_part(traj, t_red-1, lest, wn) ;
            nb_traj_active = nb_traj_active + 1 ;
            if part == 0
                nb_traj_blink = nb_traj_blink + 1 ; %counts # of trajectories with BLINK status
            end%if
        else %no testing if trajectory is already terminated
            part = 0;
        end %if
        
        %% update tables
        if (part>0)
            tab_param(traj, 7*(t_red)+[3 4 5 6]) =...
                lest(part, [2 3 4 6]);
            tab_var(traj, 7*(t_red)+7) = lest(part, 5);
            if (tab_param(traj, 7*(t_red-1)+8) > 0) %trajectory was not OFF
                [LV_traj_part, flag_full_alpha] = rapport_detection(traj, t_red-1, lest, part, wn) ;
                %increase BLINK value by Nb_STK
                tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red-1)+8) + Nb_STK ;
                if (flag_full_alpha==1) %full ON
                    %increase BLINK value by 1
                    tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red)+8) + 1 ;
                else
                    tab_param(traj, 7*(t_red)+8) = ...
                        tab_param(traj, 7*(t_red)+8) - mod(tab_param(traj, 7*(t_red)+8), Nb_STK);
                end%if
            else
                %set BLINK value to initial ON value
                tab_param(traj, 7*(t_red)+8) = Nb_STK ;
            end %if
        else
            tab_param(traj, 7*(t_red)+[3 4 5 6]) =...
                [tab_param(traj, 7*(t_red-1)+[3 4]) 0 0];
            tab_var(traj, 7*(t_red)+7) = 0;
            
            %decrease BLINK value
            if (tab_param(traj, 7*(t_red-1)+8) < 0)
                tab_param(traj, 7*(t_red)+8) = tab_param(traj, 7*(t_red-1)+8)-1; %blink -1
            else
                %set BLINK value to initial OFF value
                tab_param(traj, 7*(t_red)+8) = -1 ;
            end %if
            
            %% 11/07/06
            %% test for ephemerid detection
            if (t>3)
                if (tab_param(traj, 7*(t_red-2)+8) == 0)
                    tab_param(traj, 7*(t_red)+8) = T_off ;
                end %if
            end %if
            
        end %if
        %take reconnected particle out of game
        if (part>0)
            lest(part, 2) = -lest(part, 2) ;
            lest(part, 3) = -lest(part, 3) ;
        end %if
    end %for
        end %if
    
%     nb_traj_on = sum(tab_param(:, 7*(t_red)+8) > 0) ;
%     set(h.activeTracksInfo,'String', sprintf('# elongated Trajectories: %g',nb_traj_on))
    
%     nb_traj_off = sum(tab_param(:, 7*(t_red)+8) <= T_off);
%     set(h.terminatedTracksInfo,'String', sprintf('# terminated Trajectories: %g',nb_traj_off))
    
%     set(h.blinkingTracksInfo,'String', sprintf('# blinking Trajectories: %g',...
%         sum(tab_param(:, 7*(t_red)+8) < 0)-nb_traj_off))
    
    %nb_non_affectees = sum(lest(:,2) > 0) ; % # particles not belonging to a trajectory
    nb_traj_avant_new = size(tab_param, 1) ;
    
    %check on particles not assigned to an active trajectory
    %and in case initiate a new one
    nb_non_aff_detect = false(par_per_frame(t),1);
    for p=1:par_per_frame(t)
        if (lest(p, 2) > 0)
            glrt_1vue = rapport_detection(0, 0, lest, p, wn) ;
            if ((glrt_1vue > seuil_detec_1vue) && (lest(p,4)/(sqrt(pi)*r0) > seuil_alpha))
                nb_non_aff_detect(p) = true;
            end %if
        end %if
    end %for
    new_traj = sum(nb_non_aff_detect) ;
%     set(h.newTracksInfo,'String', sprintf('# initiated Trajectories: %g',new_traj))
    
    tab_param_new = [(1:new_traj)'+nb_traj_avant_new, zeros(new_traj,7*(t_red)),...
        [ones(new_traj,1)*t, lest(nb_non_aff_detect, [2 3 4 6]),...
        zeros(new_traj,1) ones(new_traj,1)*Nb_STK]]; %by CPR
    
    tab_param = [tab_param; tab_param_new];
    tab_var = [tab_var; zeros(new_traj,7*(t_red+1)+1)];
    tab_moy = [tab_moy; zeros(new_traj,7*(t_red+1)+1)];
    
    tab_var((1:new_traj)+nb_traj_avant_new, 7*(t_red)+7) =...
        lest(nb_non_aff_detect, 5) ; %sig2_b
    
    %% shift tables one step to the left
    new_nb_traj = size(tab_param, 1) ;
    tab_param = [tab_param(:,1), ...
        tab_param(:,2+7*(1):1+7*(t_red+1)), ...
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;%correction arnauld
    
    tab_var = [tab_var(:,1), ...
        tab_var(:,2+7*(1):1+7*(t_red+1)), ...
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;
    
    tab_moy = [tab_moy(:,1), ...
        tab_moy(:,2+7*(1):1+7*(t_red+1)), ...
        (t+1)*ones(new_nb_traj,1), zeros(new_nb_traj,6)] ;
    
    init_tab((1+nb_traj_avant_new):new_nb_traj) ; %nested by CPR;
    mise_a_jour_tab %nested by CPR;
    
    %% update tracks
    trackList = [trackList cell(1,new_traj)];
for track = tab_param(:,1)'
    if tab_param(track,1+7*(t_red))>0
        trackList{trackID(track)}(end+1,:) =...
            [tab_param(track,7*(t_red-1)+[4 3 2])...
            trackID(track) tab_param(track,7*(t_red-1)+5)...
            tab_var(track,7*(t_red-1)+[7 3 5])];
    end %if
end %for

    waitbar(t/Nb_STK,hProgressbar,['Processing Frame: ' num2str(t) ':'...
        num2str(Nb_STK)],'Color',get(0,'defaultUicontrolBackgroundColor'));
        
end %%for
delete(hProgressbar)
   
[filename,pathname,isOK] =...
            uiputfile('.mat' ,'Save Tracking Data to',...
            [getappdata(0,'searchPath')...
            getappdata(fig,'filename') '_tracked']);
        settings.Filename = [pathname filename];
if isOK
    setappdata(0,'searchPath',pathname)
    clear('data')
    data.tr = trackList;
    par_per_frame = ctrsN;
        save ([pathname filename],...
            'data', 'settings', 'par_per_frame')
end %if

    function init_tab(new_traj)
        % EN/ initialisation of tables of values
        % mean of parameters and variances (std)
        %
        % if input new_traj non null
        % then only this traj is init
        % otherwise all trajectories are (at the beginning)
        if (nargin < 1)
            tab_traj = 1:par_per_frame(t) ;
            new = 0 ;
        else
            tab_traj = new_traj ;
            new = 1 ;
        end%if
        
        %% boucle sur les particules
        for iTraj = tab_traj ;
            
            %% alpha
            local_param = tab_param(iTraj, 7*(t_red-1)+5) ; % alpha
            tab_moy(iTraj, 7*(t_red-1)+5) = local_param + sqrt(-1)*local_param ;% moyenne,max
            tab_var(iTraj, 7*(t_red-1)+5) = 0.2*local_param ; % std
            
            %% r
            local_param = tab_param(iTraj, 7*(t_red-1)+6) ;
            tab_moy(iTraj, 7*(t_red-1)+6) = local_param ;
            tab_var(iTraj, 7*(t_red-1)+6) = 0.2*local_param ;
            
            %% i,j
            tab_var(iTraj, 7*(t_red-1)+3) = sig_free ;
            tab_var(iTraj, 7*(t_red-1)+4) = sig_free ;
            
            %% blink pour info
            tab_moy(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
            tab_var(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
            
            %% affection identique a (t_red-1)-1
            %% pour compat avec mise_a_jour_tab
            if (new)
                
                %% alpha
                local_param = tab_param(iTraj, 7*(t_red-1)+5) ; % alpha
                tab_moy(iTraj, 7*((t_red-1)-1)+5) = local_param + sqrt(-1)*local_param ;% moyenne,max
                tab_var(iTraj, 7*((t_red-1)-1)+5) = 0.2*local_param ; % std
                
                %% r
                local_param = tab_param(iTraj, 7*(t_red-1)+6) ;
                tab_moy(iTraj, 7*((t_red-1)-1)+6) = local_param ;
                tab_var(iTraj, 7*((t_red-1)-1)+6) = 0.2*local_param ;
                
                %% i,j
                tab_var(iTraj, 7*((t_red-1)-1)+3) = sig_free ;
                tab_var(iTraj, 7*((t_red-1)-1)+4) = sig_free ;
                
                %% blink pour info
                tab_moy(iTraj, 7*((t_red-1)-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                tab_var(iTraj, 7*((t_red-1)-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                
            end %if
            
            
        end %for
        
    end %function
    function mise_a_jour_tab
        % EN/ update of the tables of values
        % mean of parameters and variances (std)
        
        %fprintf(stderr,"in maj\n");
        %% boucle sur les particules
        for iTraj=1:new_nb_traj
            if (tab_param(iTraj, 7*(t_red-1)+8)>T_off)
                %% alpha
                %% modif le 12-11-07
                %% compatibilite avec rapport_detection
                %% suite a la prise en compte de la loi
                %% uniforme + gaussien pour alpha
                %% si modif verifer rapport_detection.m
                %%
                %%param = 5 ;
                %%[moy, sig] = calcul_reference(iTraj, (t_red-1), param, T) ;
                %%tab_moy(iTraj, 7*(t_red-1)+param) = moy ;%% test modif 160307
                %%tab_var(iTraj, 7*(t_red-1)+param) = sig ;
                [moy, sig_alpha] = calcul_reference(5) ;
                alpha_moy = real(moy) ;
                alpha_max = imag(moy) ;
                %% on ne met a jour des stats mean var
                %% que si on est en hypothese gaussienne
                %% sinon on bloque les stats
                %% determination du mode par vraisemblance
                LV_uni = -T*log(alpha_max) ;
                LV_gauss = -T/2*(1+log(2*pi*sig_alpha^2)) ;
                
                if (LV_gauss > LV_uni)
                    %% gaussienne (1)
                    tab_moy(iTraj, 7*(t_red-1)+5) = alpha_moy + sqrt(-1)*alpha_max ;
                    tab_var(iTraj, 7*(t_red-1)+5) = sig_alpha ;
                else
                    %% uniforme (2)
                    tab_moy(iTraj, 7*(t_red-1)+5) = tab_moy(iTraj, 7*((t_red-1)-1)+5) ;
                    tab_var(iTraj, 7*(t_red-1)+5) = tab_var(iTraj, 7*((t_red-1)-1)+5) ;
                end%if
                
                
                %% r
                [moy, sig] = calcul_reference(6) ;
                tab_moy(iTraj, 7*(t_red-1)+6) = moy ;
                tab_var(iTraj, 7*(t_red-1)+6) = sig ;
                
                %% i,j
                [moy, sig_i] = calcul_reference(3) ;
                [moy, sig_j] = calcul_reference(4) ;
                %%tab_moy(iTraj, 7*(t_red-1)+4) = moy ;  %% inutile
                sig_ij = sqrt(0.5*(sig_i^2+sig_j^2)) ;
                if (sig_free < sig_ij)
                    %% borne a diff libre
                    sig_ij = sig_free ;
                end%if
                tab_var(iTraj, 7*(t_red-1)+3) = sig_ij ;
                tab_var(iTraj, 7*(t_red-1)+4) = sig_ij ;
                
                %% blink pour info
                tab_moy(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                tab_var(iTraj, 7*(t_red-1)+8) = tab_param(iTraj, 7*(t_red-1)+8) ;
                
            end %if
        end %for
        function [param_ref, sig_param] = calcul_reference(param)
            %% determine la reference (parametre moyen)
            %% et ecart type du param
            %% determine sur la derniere zone de non blink
            %% et limite a une longueur T
            %% moy_alpha et sig_alpha (resp r) gardent leur valeur pendant un blink
            %% moy_i/j ne sert pas
            %% sig_i/j
            %% sig_i/j voient leur valeur augmenter pendant le blink
            %% en suivant la variation sqrt(nb_blink)*sig_i_avant_blink
            %% pris en compte dans sigij_blink
            %% param = 5 : alpha
            %% param = 6 : r
            %% param = 3 : i
            %% param = 4 : j
            
            %% offset de zone de blink nb_blink==(-offset)
            if (tab_param(iTraj, 7*(t_red-1)+8) < 0)
                offset = tab_param(iTraj, 7*(t_red-1)+8)  ;
            else
                offset = 0 ;
            end %if
            
            %% duree de la derniere partie ON de la iTraj
            nb_on = floor(tab_param(iTraj, 7*((t_red-1)+offset)+8)  / Nb_STK) ; %% correct bug suite modif
            if (nb_on > T)
                nb_on = T ;
            end %if
            
            seuil = 3+1 ; %T/2
            
            if (nb_on >= seuil)
                
                n=0:(nb_on-1) ;
                local_param = tab_param(iTraj, 7*((t_red-1)+offset-n)+param) ;
                sum_param = sum(local_param) ;
                sum_param2 = sum(local_param.^2) ;
                param_max = max(local_param) ; %% 160307
                param_ref = sum_param / nb_on ;
                sig_param = sqrt( sum_param2 / nb_on - param_ref^2) ;
                
                %% si alpha, il faut aussi la valeur max
                %% en plus de la valeur moyenne
                %% on le met sur l'axe imaginaire! 160307
                if (param == 5)
                    param_ref = param_ref + sqrt(-1)*param_max ;
                end%if
                
            else
                %% On bloque la valeur a la derniere valeur avant zone de blink
                %% la derniere info valable dans le passe
                if (offset == 0)
                    pos_info = 1 ;% la valeur precedente
                else
                    pos_info = -offset ; % la derniere valeur avant blink
                end%if
                
                param_ref = tab_moy(iTraj, 7*((t_red-1)-pos_info)+param) ;
                sig_param = tab_var(iTraj, 7*((t_red-1)-pos_info)+param) ;
                
            end %if
            
            
        end %function
        
    end %function
end

function part = reconnect_part(traj, t, lest, wn)
% EN/ function that search/detect the particle
% among those pre-detected, which best corresponds
% to the given trajectory
% returns the number of the particle in lest

%% evite les allocations sur des constantes
% global tab_param ;
% global tab_var ;
Nb_combi = evalin('base', 'Nb_combi');

%%% Pre-detection
%%% liste_param = [num, i, j, alpha, sig^2, rayon, ok]

%%% Estimation/Reconnexion
%%%              1    2  3     4       5          6          7      8
%%% tab_param = [num, t, i,    j,      alpha,     rayon,     m0,   ,blink] 
%%% tab_var =   [num, t, sig_i,sig_jj, sig_alpha, sig_rayon, sig_b ,blink] 

%% reconnexion de la particule num part

%search for particles inside search radius of trajectory
ind_boule = liste_part_boule([], traj, lest, t) ;
nb_part_boule = size(ind_boule, 1) ;


if (nb_part_boule == 0)
  %% set trajectory status to BLINK
  part = 0 ;
else
  %% plusieurs particule candidate
  %% on prend celle la plus probable

  %look up if other trajectory are in competition for one of the particles
  vec_traj_inter = liste_traj_inter(ind_boule, traj, lest, t) ;
  vec_traj = [traj; vec_traj_inter] ;
  nb_traj = size(vec_traj,1) ;

  %% limitation du nb de trajectoire
  %% en competition
  if (nb_traj > Nb_combi)
%     fprintf('REPLACE_WITH_DASH_DASH> limitation combi for traj : traj %d\n', traj) ;
    vec_traj = limite_combi_traj_blk(vec_traj, t) ;
    %%vec_traj = limite_combi_traj_dst(vec_traj, t) ;
    nb_traj = Nb_combi ;
  end %if

  %% prise en compte des particules
  %% qui seraient dans les boules de recherche
  %% des trajectoires en competition
  %% "On travail ici a l'ordre 1"
  ind_boule_O1 = ind_boule ;
  for ntraj = 2:nb_traj
    traj_inter = vec_traj(ntraj) ;
    ind_boule_O1 =  liste_part_boule(ind_boule_O1, traj_inter, lest, t) ;
  end %for
  nb_part_boule_O1 = size(ind_boule_O1, 1) ;

  %% passage a l_ordre 1
  ind_boule = ind_boule_O1 ;
  nb_part_boule = nb_part_boule_O1 ;

  %% limite du nb de particules
  %% en competition
  if (nb_part_boule > Nb_combi)
%     fprintf('REPLACE_WITH_DASH_DASH> limitation combi for part : traj %d\n', traj) ;
     ind_boule = limite_combi_part_dst(traj,ind_boule,lest,t) ;
     nb_part_boule = Nb_combi ;
  end %if

  %% recherche de la meilleur config par 
  %% maximum de vraisemblance
  if nb_traj <= nb_part_boule
    %% pas le blink
    %% mais possiblilite de nouvelle particule (<)
    vec_part = ind_boule ;
  else
    %% nb_traj > nb_part_boule
    %% des particules ont blinkees
    vec_part = [ind_boule; zeros(nb_traj-nb_part_boule,1)] ;
  end %if

  part = best_config_reconnex(vec_traj, vec_part, t, lest, wn);


end %if

end %function
function [indice, dist2] = N_plus_proche(ic, jc, liste_i, liste_j, N)
% renvoie les indices des N point les plus proche 
% de C(ic,jc)
% dans l'ordre d'eloignement
  
dim_liste = size(liste_i(:),1) ;
  %% distances au point C
  sq_dist = (liste_i-ic).^2 + (liste_j-jc).^2 ;
  %% classement
  [sq_dist_classe, ind_classe] = sort(sq_dist) ;
  if (dim_liste > N)
    indice = ind_classe(1:N) ;
    dist2 = sq_dist_classe(1:N) ;
  else
    indice = ind_classe ;
    dist2 = sq_dist_classe ;
  end%if
end%function
function vec_part_out = limite_combi_part_dst(traj, vec_part_in, lest, t)
% limite le nombre de part
% a celle les plus proche de la ref traj
% au nombre Nb_combi (global)
  
global tab_param ;
  Nb_combi = evalin('base', 'Nb_combi');
  
  ic = tab_param(traj, 7*t+3) ;
  jc = tab_param(traj, 7*t+4) ;
  tabi = lest(vec_part_in, 2) ;
  tabj = lest(vec_part_in, 3) ;
  indice = N_plus_proche(ic, jc, tabi, tabj, Nb_combi) ;
  vec_part_out = vec_part_in(indice) ;
end%function
function vec_traj_out = limite_combi_traj_blk(vec_traj_in, t)
% limite le nombre de traj 
% a celle les plus anciennes (en blink)
% au nombre Nb_combi (global)
% la premiere reste : ref
  
global tab_param ;
  Nb_combi = evalin('base', 'Nb_combi');
  
  tab_blk = tab_param(vec_traj_in(2:end), 7*t+8) ;
  [blk,indice] = sort(tab_blk, 'descend') ; 
  vec_traj_out = [vec_traj_in(1); vec_traj_in(indice(1:(Nb_combi-1))+1)] ;
end%function
function liste_traj = liste_traj_inter(liste_part, traj_ref, lest, t)
% function qui renvoie les trajectoires (non reconnectees)
% dont les boules (espace libre) de recherche intersecte
% au moins une des particules de la liste

global tab_param ;
Boule_free = evalin('base', 'Boule_free');

%% init des trajectoires a tester
traj_boule = zeros(size(tab_param,1), 1) ;

nb_traj = size(tab_param, 1) ;
boules = Boule_free * sigij_free_blink(1:nb_traj, t) ;


for p = liste_part'

  ic = lest(p,2) ;
  jc = lest(p,3) ;

  %% fenetre de recherche des trajectoires
  %% boule de recherche en ecartype
  icm = max(ic - boules, 0) ; 
  icM = ic + boules ; 
  jcm = max(jc - boules, 0) ; 
  jcM = jc + boules ;
  
  traj_boule = traj_boule | ...
      ((tab_param(:, 7*t+3) < icM) & (tab_param(:, 7*t+3) > icm) & ...
      (tab_param(:, 7*t+4) < jcM) & (tab_param(:, 7*t+4) > jcm)) ;

%    traj_boule = traj_boule | ...
%        (sqrt((tab_param(:, 7*t+3)-ic).^2+...
%        (tab_param(:, 7*t+4)-jc).^2)-boules) <= 0; %CPR
 
end %for

%% trajectoires a tester
%% celles non encore reconnectees
traj_boule = traj_boule & (tab_param(:, 7*(t+1)+8) == 0)  ;

%% test 22 11 07 : celles qui ne sont pas blinkee
traj_boule = traj_boule & (tab_param(:, 7*t+8) > 0)  ;

%% on enleve la ref
traj_boule(traj_ref) = 0 ;

%% les trajectoires en question
liste_traj = find(traj_boule) ;

end %function
function liste_part = liste_part_boule(liste_part_ref, traj, lest, t) 
%finds particles inside search radius of trajectory
% si liste_par_ref == [] alors pas de ref

%% evite les allocations sur des constantes
global tab_param ;
Boule_free = evalin('base', 'Boule_free');
% global tab_var ;

nb_part = size(lest, 1) ;
dim_liste = size(liste_part_ref,1) ;

if (dim_liste ~= 0)
  %% generation d_un masque
  masque_part_ref = ones(nb_part, 1) ;
  masque_part_ref(liste_part_ref) = 0 ;
end %if

%last spacecoordinates for trajectory
ic = tab_param(traj, 7*t+3) ;
jc = tab_param(traj, 7*t+4) ;
%calc search radius
boule = Boule_free * sigij_free_blink(traj, t) ; 

icm = max(ic - boule, 0) ; % en ecart type sur i
icM = ic + boule ; % en ecart type
jcm = max(jc - boule, 0) ; % en ecart type sur j
jcM = jc + boule ; % en ecart type
% 
% %% liste locale a la boule (carree!!) <<<====================================!!!
part_boule = ...
    (lest(:,2) < icM) & (lest(:,2) > icm) & ...
    (lest(:,3) < jcM) & (lest(:,3) > jcm) ;

% part_boule = sqrt((lest(:,2)-ic).^2+(lest(:,3)-jc).^2) <= boule; %CPR

%remove the ones already in ref list
if (dim_liste ~= 0)
  part_boule = part_boule & masque_part_ref ;
end %if

liste_new_part = find(part_boule) ;
liste_part = [liste_part_ref; liste_new_part] ;
end %function
function [out, flag_full_alpha] = rapport_detection(traj, t, lest, part, wn)%, T)
% EN/ returns the likelihood for reconnection between 
% the particle num_test (in list lest) and the trajectory traj
%
% flag_full_alpha indicates if the particle
% is ON (FULL, belongs to the Gaussian)


%% evite les allocations sur des constantes
global tab_param ;
global tab_moy ;
global tab_var ;
Poids_melange_aplha = evalin('base', 'Poids_melange_aplha');
Poids_melange_diff = evalin('base', 'Poids_melange_diff');
T_off = evalin('base', 'T_off');
im_t = evalin('base', 'im_t');

N = wn*wn ;% carree

%% ==============================================
%% test glrt avec parametre estime pour new traj
%% ==============================================
%%
%% glrt_1vue : le meme que dans carte_H0H1
%% mais ici calcule pour les parametres estimes
%% pour les particules nouvelles

if (traj<=0)

  %% P(x|H1)
  %% deja calcule lors de l'estimation 1 vue
  sig2_H1 = lest(part, 5 ) ;
  LxH1 = -N/2*log(sig2_H1) ; % -N/2

  %% P(x|H0)
  %% probleme lors des deflations!!!
  Pi = round(lest(part, 2)) ;
  Pj = round(lest(part, 3)) ;
  di = (1:wn)+Pi-floor(wn/2) ;
  dj = (1:wn)+Pj-floor(wn/2) ;
  im_part = im_t(di, dj) ;
%   im_part = im_t(dj, di) ;
  sig2_H0 = var(im_part(:)) ;
  LxH0 = -N/2*log(sig2_H0) ; % -N/2

  % glrt = -2*( LxH0 - LxH1 ) ;
  out = -2*( LxH0 - LxH1 ) ;
  return ;

end%if


%% ==============================================
%% vraisemblance de la reconnexion traj <-> part
%% ==============================================

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% proba de reapparition pendant un blink (blinch)
%% gaussienne > 0
%% nb_blink
if (tab_param(traj, 7*t+8) < 0)
  nb_blink = -tab_param(traj, 7*t+8)  ;
  sig_blink = -T_off/3 ;
  Pblink = 2*inv(sqrt(2*pi)*sig_blink) * exp(-inv(2*sig_blink^2)*nb_blink^2) ;
  Lblink = log(Pblink) ;
else
  % nb_blink = 0 ;
  Lblink = 0 ;
end %if

%%%%%%%%%%%%%%%%%%%%%
%% intensite des pics
%% P(alpha|H1)
%% c'est un melange de loi uniforme et gaussienne
%% on travail a tres faible nombre d'echantillons
%% estimer la proportion uni/gauss est tres difficile

%% ancienne version _old
%% on fait plutot un test de vraisemblance uni/gauss
%% on est don, soit gaussienne, soit uniforme

%% nouvelle version : la loi est une combinaison
%% d'une loi uniforme et gaussienne
%% en effet, l'estimation conjointe des parametres
%% avec melange n'est possible qu'a grand nombre d echantillons
%% ici : a nombre d echantillons reduits on test si 
%% le comportement et plutot gaussien ou uniforme (MV)
%% si uniforme, on garde les anciens parametres
%% si gaussien, on met a jour moyenne et variance
%%
%% Attention, les para metres des lois (les stats m, var)
%% sont mis a jour par la fonction mise_a_jour_tab.m
%% dans les tableaux tab_moy et tab_var
%%
%% si modif verifer mise_a_jour_tab.m

alpha =  lest(part, 4 ) ;
alpha_moy = real(tab_moy(traj, 7*t+5)) ; %% sur tout l'echantillon
sig_alpha = tab_var(traj, 7*t+5) ; %% sur tout l'echantillon
%%alpha_max = imag(tab_moy(traj, 7*t+5)) ;
alpha_max = alpha_moy ;

%% gaussienne (1)
Palpha_gaus = inv(sqrt(2*pi)*sig_alpha) * exp(-inv(2*sig_alpha^2)*(alpha-alpha_moy)^2) ;
%% uniforme (2)
if (alpha < alpha_max)
  Palpha_univ = 1/alpha_max ;
else
  Palpha_univ = 0.0 ;
end%if

poids = Poids_melange_aplha ;
Lalpha = log(poids*Palpha_gaus + (1-poids)*Palpha_univ) ;

if (Palpha_gaus > Palpha_univ)
  flag_full_alpha = 1 ;
else
  flag_full_alpha = 0 ;
end%if


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% vraisemblance de traj a intensitee full
%% nb_alpha_full = mod(tab_param(traj,7*t+8), Nb_STK);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% vraisemblance position / mvt brownien (libre/confine)
%% P(n0|H1)
i0 = lest(part, 2) ;
j0 = lest(part, 3) ;
ic = tab_param(traj, 7*t+3) ; % derniere position
jc = tab_param(traj, 7*t+4) ;
% sig_ij_ref = tab_var(traj, 7*t+3);
sig_ij_ref = sigij_blink(traj, t) ;%% avec blk
sig_free_blk = sigij_free_blink(traj, t) ;%% avec blk  !!! 

poids = Poids_melange_diff ; %% entre gaussienne ref et gaussienne libre
Pn_ref =  inv(2*pi*sig_ij_ref^2) * exp(- inv(2*sig_ij_ref^2) * ((i0-ic)^2 + (j0-jc)^2)) ;
Pn_free = inv(2*pi*sig_free_blk^2) * exp(- inv(2*sig_free_blk^2) * ((i0-ic)^2 + (j0-jc)^2)) ;
Ln0 = log(poids*Pn_ref + (1-poids)*Pn_free);

%%%%%%%%%%
%% P(r|H1)
r =  lest(part, 6) ;
r_ref = tab_moy(traj, 7*t+6) ;
sig_r_ref = tab_var(traj, 7*t+6) ;
if (sig_r_ref ~= 0)
  Lr = -0.5*log(sig_r_ref) - inv(2*sig_r_ref^2) * (r-r_ref)^2;
else
  Lr = 0 ;
end%if

%% vraisemblance
out = Lalpha + Ln0 + Lblink + 0*Lr;


end %function
function sig_blk = sigij_blink(traj, t)
% EN/ if blink, increase of the std
    
global tab_param ;
global tab_var ;

%% offset de zone de blink nb_blink==(-offset)
if (tab_param(traj, 7*t+8) < 0)
  offset = tab_param(traj, 7*t+8)  ;
else
  offset = 0 ;
end %if

%% sigi = sigj
sig_blk = tab_var(traj, 7*t+3)  ;  %% sur i 

%% prise en compte du blink pour sig_i/j
if (offset < 0)
    sig_blk = sig_blk * sqrt(1-offset) ;
end %if

end%function
function sig_free_blk = sigij_free_blink(traj, t, sig_free)
% EN/ if blink, increase of the std
% traj scalar or vector of trajectories

global tab_param ;
sig_free = evalin('base', 'sig_free');

traj = traj(:) ;
nb_traj = size(traj, 1) ;

%% offset
offset = tab_param(traj, 7*t+8) ;

%% offset de zone de blink nb_blink==(-offset)
%% offset = 0 si non_blink (>0)
%% idem sinon ;
nb_blink = - (offset .* (offset < 0))  ;

%% sigi = sigj
sig_free_blk = sig_free*ones(nb_traj, 1) ; 

%% prise en compte du blink pour sig_i/j
sig_free_blk = sig_free_blk .* sqrt(1+nb_blink) ;

end%function
function part = best_config_reconnex(vec_traj, vec_part, t, lest, wn)%,T)
% EN/ This function looks for the best config
% according to the ML and sends back 
% the most probable particle (O if blinked)
% The refering trace IS the first one
% of the list in vect_traj 
%
% Caution with combinatory tests beyond nb_part = 4

% Exemple de calcul de Log-vraisemblance
% de reconnexion a 3 trajectoires/Particules
% reprenant les notations de la figure 3
% 
% 
% - T_domain = P_domain
% 3 trajectoires (a,k,b) pour 3 particules (1,2,3)
% on cherche la meilleure combinaison en comparant leur vraisemblance
% respective :
% L(a,1)  +  L(k,2)  +  L(b,3)  <>
% L(a,1)  +  L(k,3)  +  L(b,2)  <>
% L(a,2)  +  L(k,1)  +  L(b,3)  <>
%   etc.
% 
% - T_domain > P_domain
% 3 trajectoires (a,k,b) pour 2 particules : On en cree une 3eme OFF
% (1,2,OFF).
% Alors les tests deviennent :
% L(a,1) + L(k,2)   + L(b,OFF)  <>
% L(a,1) + L(k,OFF) + L(b,2)    <>
% L(a,2) + L(k,1)   + L(b,OFF)  <>
%   etc.
% Dans ce cas, seulement 2 termes de vraisemblance sont
% presents car le troisieme L(T,OFF), probabilite de disparition d'une 
% trajectoire, est identique pour toute trajectoires T.
% 
% - T_domain < P_domain
% 2 trajectoires (a,k) pour 3 particules (1,2,3) : On cree une nouvelle
% trajectoire (a,k,NEW)
% Alors les tests deviennent :
% L(a,1) + L(k,2)  + L(NEW,3)  <>
% L(a,1) + L(k,3)  + L(NEW,2)  <>
% L(a,2) + L(k,1)  + L(NEW,3)  <>
%   etc.
% La encore, dans ce cas, seulement 2 termes de vraisemblance sont
% presents car le troisieme terme L(NEW,P), probabilite d'apparition
% d'une nouvelle trajectoire dans l'image, est suppose constant.
% Elle ne depend ni de la position, ni de l'intensite.

  %% permutation circulaire sur vec_part
  %% limite a la taille nb_traj
  % nb_part = size(vec_part(:), 1) ;
  nb_traj = size(vec_traj(:), 1) ;
  best_part = vec_part(1) ;
  vec_part_ref = vec_part(1:nb_traj) ;
  vrais =  vrais_config_reconnex(vec_traj, vec_part_ref, t, lest, wn);%,T)


  tab_perms_vec_part = perms(vec_part)' ;
  nb_perms = size(tab_perms_vec_part, 2) ;

  for p=2:nb_perms
    vec_part_perm = tab_perms_vec_part(:,p) ;
    %% si plus de particules que de traj
    %% cas de nouvelle traj
    %% on test les nb_traj premiere
    vec_part_perm = vec_part_perm(1:nb_traj) ;
    vrais_tmp =  vrais_config_reconnex(vec_traj, vec_part_perm, t, ...
				       lest, wn);%, T) ;

    if (vrais_tmp > vrais)
      vrais = vrais_tmp ;
      best_part = vec_part_perm(1) ;
    end %if
  end %for

part = best_part ;


end %function
function vrais = vrais_config_reconnex(vec_traj, vec_part, t, lest, wn)%,T)
% function qui renvoie la vraisemblance
% d'une configuration de reconnexion/blink
% pour plusieurs trajectoires et particules
%
% les cardinaux des deux vecteurs d'entrees 
% sont forcement egaux

  % vec_part peut avoir des valeurs nulles
  % correspondant aux particules blinkees
  % la proba de blink est sans a priori
  % et c'est la meme pour tout traj
  % toute comparaison ce fera a nombre de
  % blink egal, donc on fait rien

  vrais = 0 ;
  nb_part = size(vec_part(:), 1) ;
  for p = 1:nb_part
    part = vec_part(p) ;
    traj = vec_traj(p) ;
    if part ~= 0
      vrais_p = rapport_detection(traj, t, lest, part, wn) ;
      vrais = vrais + vrais_p ;
    end %if
  end %for

end %function

%% EXTRAS
function setOptions(src, event)
fig = gcbf;

switch get(src,'State')
    case 'on'
        ss = get(0,'ScreenSize');
        
        switch getappdata(fig, 'viewMode')
            case 'monoView'
                
                if getappdata(fig, 'isTrack')
                    nImCh = 0;
                    nTrackCh = 1;
                    trackSrcFig = fig;
                else
                    nImCh = 1;
                    imCh = 1;
                    nTrackCh = 0;
                    srcFig = fig;
                end %if
                
            otherwise
                
                srcFig = getappdata(fig,'imSrcFig');
                imCh = getappdata(fig,'imCh');
                srcFig = srcFig(imCh);
                nImCh = getappdata(fig,'nImCh');
                
                trackSrcFig = getappdata(fig,'trackSrcFig');
                nTrackCh = getappdata(fig,'nTrackCh');
                
        end %switch
        
        figOpt =...
            figure(...
            'Units','pixels',...
            'Position', [50 150 ...
            202+98*(nImCh+nTrackCh) ss(4)-300],...
            'Color', get(fig,'Color'),...
            'Name', 'Options',...
            'NumberTitle', 'off',...
            'MenuBar', 'none',...
            'ToolBar', 'none',...
            'Resize', 'off');
        
        %save settings profile
        hMenu = uicontextmenu;
        uimenu(hMenu, 'Label', 'save settings',...
            'Callback', @saveSet);
        uimenu(hMenu, 'Label', 'load settings',...
            'Callback', @loadSet);
        set(figOpt, 'UIContextMenu', hMenu)
        
        inputPosY = ss(4)-(370:30:1010);
        x = [176 274 372 470];
        if nImCh > 0
            %% localization
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Framerange:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Error Rate [10^]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Detection Box [px]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Deflation Loops:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(6) 161 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Intensity Thresh [cnts]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(7) 161 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'use multiple cores:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'),...
                'ToolTipString', sprintf(['\n'...
                'If this option is checked the programm will perform \n'...
                'the particle localization process using the specefied \n'...
                'number of processor cores. \n'...
                'The maximum of available cores will be used by default.']));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(8) 161 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'apply spatial correction:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'),...
                'ToolTipString', sprintf(['\n'...
                'If this option is checked the programm will perform \n'...
                'a spatial transformation on the particle coordinates\n'...
                'when the localization process is finished. \n'...
                'The spatial transformation corrects for rotation and transition \n'...
                'between image channels']));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(9) 161 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'live localization:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'),...
                'ToolTipString', sprintf(['\n'...
                'If this option is checked the programm will directly \n'...
                'stream the localization process into a preview window.']));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(11) 167 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'FontWeight', 'bold',...
                'String', 'Optimization Settings',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(12) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'max. # iterations:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(13) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'term. tol. [10^]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(14) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'r0 tolerance [%]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'),...
                'ToolTipString', sprintf(['\n'...
                'If this option is checked the programm will optimize for \n'...
                'the gaussian radius approximating the point spreads function std. \n'....
                'If the tolerancelevel set is exceeded the particle will be discarded.']));
            
            uicontrol(...
                'Tag', 'locButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(15) 155 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'max. pos. refinement [px]:',...
                'HorizontalAlignment', 'left',...
                'BackgroundColor', get(fig,'Color'));
            
            %% render
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Framerange:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Expansion Factor:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(3) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'exfNew'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'exfNew'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Convolution Mode:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Int. Weight:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(6) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Size Factor:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(8) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'FontWeight', 'bold',...
                'String', 'Movie Settings',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(9) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Windowsize:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(10) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Stepsize:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(10) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'rStep'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig, 'rStep'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(11) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'fps:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(11) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'fps'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'fps'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(12) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Compression:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'popupmenu',...
                'Units','pixels',...
                'Position', [176 inputPosY(12) 84 20],...
                'FontSize', 7,...
                'FontUnits', 'normalized',...
                'String', {'RLE' 'MSVC' 'none'},...
                'Value', getappdata(fig,'movCompression'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'movCompression'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'renderButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(13) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'accumultative movie:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            %% filters
            uicontrol(...
                'Tag', 'threshButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Loc.Prec. [nm]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'threshButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Signal to Noise:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'threshButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Detection Density:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            %% scalebar
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'checkbox',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Colormap [px]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'Value', getappdata(fig,'isColormap'),...
                'Callback',{@changeValue, fig,'isColormap'},...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(2) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'colormapWidth'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'colormapWidth'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'checkbox',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Scalebar [nm]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'Value', getappdata(fig,'isScalebar'),...
                'Callback',{@changeValue, fig,'isScalebar'},...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(3) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'micronBarLength'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'micronBarLength'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'checkbox',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Timestamp [sec]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'Value', getappdata(fig,'isTimestamp'),...
                'Callback',{@changeValue, fig,'isTimestamp'},...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(4) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'timestampInkrement'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'timestampInkrement'},...
                'Visible', 'off');
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Charactersize:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'barButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(5) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', getappdata(fig,'timestampSize'),...
                'BackgroundColor', [1 1 1],...
                'Callback',{@changeValue, fig,'timestampSize'},...
                'Visible', 'off');
            
            %% optics
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Pixel Size [?m]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(2) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String',getappdata(fig,'pxSize'),...
                'BackgroundColor', [1 1 1],...
                'Callback', {@calcPSF, fig, 'pxSize'},...
                'Visible', 'off',...
                'ToolTipString', sprintf(['\n'...
                'This Value is used to estimate the pixel to micron conversion factor. \n'...
                'In Theory: pixel size = phys. pixel size / total magnification(objectiv*ocular)\n'...
                '60, 1x = 0.267?m per pixel \n 60, 1.6x = 0.167?m per pixel \n'...
                '150, 1x = 0.107?m per pixel \n 150, 1.6x = 0.067?m per pixel']));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 156 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Emission [nm]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'N.A.:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'PSF Scaling:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(6) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'PSF Std [px]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'),...
                'ToolTipString', sprintf(['\n'...
                'Standard deviation of the Gaussian modelling the \n'...
                'Microscope associated Point Spread Function.']));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(8) 156 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Counts/Photon:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
                        uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(9) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Lag Time [ms]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'opticsButton',...
                'Style', 'edit',...
                'Units','pixels',...
                'Position', [176 inputPosY(9) 84 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String',getappdata(fig,'frameSize'),...
                'BackgroundColor', [1 1 1],...
                'Callback', {@calcPSF, fig, 'frameSize'},...
                'Visible', 'off');

            %% tracking
            
              uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2)-20 147 40],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Max. expected Diffusion Coefficient [?m^2/s]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3)-20 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Searchexp. Factor:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4)-20 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Statistics Win. [frames]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5)-20 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Max. # Competitors:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(6)-20 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Max. OFF-Time [frames]:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(7)-20 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Int. Fluc. Weight:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

                          uicontrol(...
                'Tag', 'trackingButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(8)-40 147 40],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Local vs. Max. expected Diffusion Weight:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));

            %%
            for ch = 1:nImCh
                %% channel
                uicontrol(...
                    'Style', 'text',...
                    'Units','pixels',...
                    'Position', [x(ch)+10 inputPosY(1) 84 20],...
                    'FontSize', 10,...
                    'FontWeight', 'bold',...
                    'FontUnits', 'normalized',...
                    'String', ['Channel ' num2str(imCh(ch)) ':'],...
                    'HorizontalAlignment', 'left',...
                    'BackgroundColor', get(fig,'Color'));
                
                %% localization
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'locStart'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'locStart'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+43 inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'locEnd'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'locEnd'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(3) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'errorRate'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback', {@changeValue, srcFig(ch), 'errorRate'},...
                    'ToolTipString', sprintf(['\n'...
                    'This Value limits the Probability for Type One Error (False H0 Rejection), \n'...
                    'while estimation of the generalized likelihood ratio test. \n'...
                    'These Ratios follow aproximated a chi^2 distribution\n'...
                    'with degree of freedom (3 [signal, offset, noise]-2[offset, noise]) = 1']));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'w2d'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'w2d'},...
                    'ToolTipString', sprintf(['\n'...
                    'Size of 2 dimensional sliding box inside whom a \n'...
                    'generalized likelihood ratio test (H0/H1) is performed with: \n'...
                    'H0 = no target (offset and noise) \n'...
                    'H1 = presence of target (signal, offset and noise) \n'...
                    'followed by subpixel estimation via Gauss-Newton Approximation. \n'...
                    'By rule of thumb this value should be set to 6*PSFstd+1. \n'...
                    'Strictly avoid an even number!!!']));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(5) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'dfltnLoops'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'dfltnLoops'},...
                    'ToolTipString', sprintf(['\n'...
                    'This Value determines how often the detection process will be iterated. \n'...
                    'After each Iteration the detected Particles represented by their \n'...
                    'gaussian Intensity Profile will be subtracted from the Image. \n'...
                    'In this way small peaks initially covered can be detected.']));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(6) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'minInt'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'minInt'},...
                    'ToolTipString', sprintf(['\n'...
                    'Defines the min. Signal Intensity expressed as offset-corrected amplitude of the Gaussian.']));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(7) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(srcFig(ch),'locParallel'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue, srcFig(ch), 'locParallel'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'popupmenu',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(7) 64 20],...
                    'FontSize', 7,...
                    'FontUnits', 'normalized',...
                    'String', {'max' '2' '3'},...
                    'Value', getappdata(srcFig(ch),'nCores'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'nCores'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(8) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(srcFig(ch),'spatialCorrection'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@setSpatialCorrPath,srcFig(ch)},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(9) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(srcFig(ch),'rLive'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue,srcFig(ch),'rLive'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(12) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'maxOptimIter'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'maxOptimIter'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(13) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'termTol'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch),'termTol'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(14) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(srcFig(ch),'isRadiusTol'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue, srcFig(ch),'isRadiusTol'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(14) 64 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'radiusTol'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch),'radiusTol'});
                
                uicontrol(...
                    'Tag', 'locButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(15) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'posTol'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch),'posTol'});
                
                %% rendering
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'rStart'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'rStart'},...
                    'Visible', 'off');
                
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+43 inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'rEnd'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'rEnd'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'popupmenu',...
                    'Parent', gcf,...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4) 84 20],...
                    'FontSize', 7,...
                    'FontUnits', 'normalized',...
                    'String', {'fixed', 'dynamic', 'none'},...
                    'Value', getappdata(srcFig(ch),'convMode'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'convMode'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(5) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'intWeight'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'intWeight'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(6) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'sizeFac'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'sizeFac'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(9) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'rW'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'rW'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'renderButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(13) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(srcFig(ch),'isCumsum'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue, srcFig(ch),'isCumsum'},...
                    'Visible', 'off',...
                    'BackgroundColor', get(fig,'Color'));
                
                %% filters
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(2) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', ':',...
                    'HorizontalAlignment', 'left',...
                    'Value', getappdata(srcFig(ch),'isThreshLocPrec'),...
                    'Visible', 'off',...
                    'Callback',{@changeValue, srcFig(ch),'isThreshLocPrec'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(2) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'minLoc'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'minLoc'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+52 inputPosY(2) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'maxLoc'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'maxLoc'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(3) 147 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'HorizontalAlignment', 'left',...
                    'Value', getappdata(srcFig(ch),'isThreshSNR'),...
                    'Visible', 'off',...
                    'Callback',{@changeValue, srcFig(ch),'isThreshSNR'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(3) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'minSNR'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'minSNR'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+52 inputPosY(3) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'maxSNR'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'maxSNR'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'HorizontalAlignment', 'left',...
                    'Value', getappdata(srcFig(ch),'isThreshDensity'),...
                    'Visible', 'off',...
                    'Callback',{@changeValue, fig,'isThreshDensity'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'threshButton',...
                    'Style', 'popupmenu',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(4) 64 20],...
                    'FontSize', 7,...
                    'FontUnits', 'normalized',...
                    'String', {'inclusive', 'exclusiv'},...
                    'Value', getappdata(srcFig(ch),'clusterMode'),...
                    'BackgroundColor', [1 1 1],...
                    'Visible', 'off',...
                    'Callback',{@changeValue, srcFig(ch), 'clusterMode'});
                
                %% optics
                uicontrol(...
                    'Tag', 'opticsButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(3) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'emWvlnth'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@calcPSF, srcFig(ch), 'emWvlnth'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'opticsButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'NA'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@calcPSF, srcFig(ch), 'NA'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'opticsButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(5) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'psfScale'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback', {@calcPSF, srcFig(ch), 'psfScale'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'opticsButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(6) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', num2str(getappdata(srcFig(ch),'psfStd'),'%.2f'),...
                    'Enable', 'off',...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'opticsButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [176 inputPosY(8) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'cntsPerPhoton'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch),'cntsPerPhoton'},...
                    'Visible', 'off');
                
                %% tracking
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(2)-10 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'Dmax'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'Dmax'},...
                    'Visible', 'off');
                                
                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(3)-20 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'searchExpFac'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'searchExpFac'},...
                    'Visible', 'off');
                
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4)-20 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'statWin'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'statWin'},...
                    'Visible', 'off');
                
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(5)-20 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'maxComp'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'maxComp'},...
                    'Visible', 'off');
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(6)-20 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'maxOffTime'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'maxOffTime'},...
                    'Visible', 'off');
                
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(7)-20 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'intLawWeight'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'intLawWeight'},...
                    'Visible', 'off');
                
                                uicontrol(...
                    'Tag', 'trackingButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(8)-30 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(srcFig(ch),'diffLawWeight'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, srcFig(ch), 'diffLawWeight'},...
                    'Visible', 'off');

            end
        end %if
        
        if nTrackCh > 0
            %%
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(2) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Framerange:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(3) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Colorcoding:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(4) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Track Thickness:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(5) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Track Length:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(7) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'FontWeight', 'bold',...
                'String', 'Movie Settings',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(8) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'Windowsize:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(9) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'accumultative track:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            uicontrol(...
                'Tag', 'trackButton',...
                'Style', 'text',...
                'Units','pixels',...
                'Position', [22 inputPosY(10) 147 20],...
                'FontSize', 10,...
                'FontUnits', 'normalized',...
                'String', 'track always visible:',...
                'HorizontalAlignment', 'left',...
                'Visible', 'off',...
                'BackgroundColor', get(fig,'Color'));
            
            %%
            x = x+98*nImCh;
            for ch = 1:nTrackCh
                uicontrol(...
                    'Style', 'text',...
                    'Units','pixels',...
                    'Position', [x(ch)+10 inputPosY(1) 84 20],...
                    'FontSize', 10,...
                    'FontWeight', 'bold',...
                    'FontUnits', 'normalized',...
                    'String', ['Track ' num2str(ch) ':'],...
                    'HorizontalAlignment', 'left',...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'rStart'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, trackSrcFig(ch), 'rStart'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+42 inputPosY(2) 42 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'rEnd'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeValue, trackSrcFig(ch), 'rEnd'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'popupmenu',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(3) 64 20],...
                    'FontSize', 7,...
                    'FontUnits', 'normalized',...
                    'String', {'ensemble', 'individual'},...
                    'Value', getappdata(trackSrcFig(ch),'trackColorMode'),...
                    'BackgroundColor', [1 1 1],...
                    'Visible', 'off',...
                    'Callback',{@changeTrackColorcode,trackSrcFig(ch)});
                
                color = getappdata(trackSrcFig(ch),'trackColor');
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'pushbutton',...
                    'Units','pixels',...
                    'Position', [x(ch)+64 inputPosY(3) 20 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'FontWeight', 'bold',...
                    'BackgroundColor', color{1},...
                    'String', '',...
                    'Callback',{@changeTrackColor, trackSrcFig(ch)},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(4) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'trackWidth'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeTrackLinewidth, trackSrcFig(ch)},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(5) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'HorizontalAlignment', 'left',...
                    'Value', getappdata(trackSrcFig(ch),'isTracksizeThresh'),...
                    'Visible', 'off',...
                    'Callback',{@changeValue, trackSrcFig(ch),'isTracksizeThresh'},...
                    'BackgroundColor', get(fig,'Color'));
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+20 inputPosY(5) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'minTracksize'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeTracksize,trackSrcFig(ch),'minTracksize'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch)+52 inputPosY(5) 32 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'maxTracksize'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback',{@changeTracksize,trackSrcFig(ch),'maxTracksize'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'edit',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(8) 84 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', getappdata(trackSrcFig(ch),'rW'),...
                    'BackgroundColor', [1 1 1],...
                    'Callback', {@changeValue, trackSrcFig(ch), 'rW'},...
                    'Visible', 'off');
                
                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(9) 161 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(trackSrcFig(ch),'isCumsum'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue, trackSrcFig(ch), 'isCumsum'},...
                    'Visible', 'off',...
                    'BackgroundColor', get(fig,'Color'));
                
                                uicontrol(...
                    'Tag', 'trackButton',...
                    'Style', 'checkbox',...
                    'Units','pixels',...
                    'Position', [x(ch) inputPosY(10) 161 20],...
                    'FontSize', 10,...
                    'FontUnits', 'normalized',...
                    'String', '',...
                    'Value', getappdata(trackSrcFig(ch),'trackVisibility'),...
                    'HorizontalAlignment', 'left',...
                    'Callback', {@changeValue, trackSrcFig(ch), 'trackVisibility'},...
                    'Visible', 'off',...
                    'BackgroundColor', get(fig,'Color'));

            end
        end %if
        
        %% switch tabs
        uicontrol(...
            'Style', 'text',...
            'Units','normalized',...
            'Position', [0 0.95 0.3 0.05],...
            'FontSize', 19,...
            'FontUnits', 'normalized',...
            'String', 'Sheet:',...
            'HorizontalAlignment', 'center',...
            'BackgroundColor', get(fig,'Color'));
        
        hToggle =...
            uicontrol(...
            'Style', 'popupmenu',...
            'Units','normalized',...
            'Position', [0.3 0.95 0.7 0.05],...
            'FontSize', 15,...
            'FontUnits', 'normalized',...
            'HorizontalAlignment','right',...
            'String', {...
            'Localization',...
            'Tracking',...
            'Render',...
            'Trajectories',...
            'Acquisition',...
            'Bars',...
            'Filters'},...
            'Value', 3,...
            'BackgroundColor', get(fig,'Color'),...
            'CreateFcn', @changeTab,...
            'Callback', @changeTab);
        
        sliderPos = 1;
        uicontrol(...
            'Style', 'slider',...
            'Units','normalized',...
            'Position', [0.942 0 0.05 0.9],...
            'SliderStep', [0.01 0.01],...
            'Value',sliderPos,...
            'Callback', @adjustInputs);
        
    case 'off'
        delete(findobj(allchild(0),'Color',get(fig,'Color'),...
            '-and', 'Name', 'Options'))
end %switch

    function changeTab(src, event)
        selection = get(src, {'String','Value'});
        switch char(selection{1}(selection{2}))
            case 'Localization'
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Render'
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Bars'
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Acquisition'
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Filters'
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Trajectories'
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'off')
            case 'Tracking'
                set(findobj(figOpt,'Tag','trackingButton'), 'Visible', 'on')
                set(findobj(figOpt,'Tag','trackButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','threshButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','locButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','renderButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','barButton'), 'Visible', 'off')
                set(findobj(figOpt,'Tag','opticsButton'), 'Visible', 'off')
        end %switch
    end

    function changeValue(src, event, channel, fieldname)
        switch get(src, 'Style')
            case 'edit'
                for h = channel
                    setappdata(h,fieldname,str2double(get(src,'String')))
                end %for
            case 'checkbox'
                for h = channel
                    setappdata(h,fieldname,get(src,'Value'))
                end %for
            case 'popupmenu'
                for h = channel
                    setappdata(h,fieldname,get(src,'Value'))
                end %for
        end %switch
    end
    function calcPSF(src, event, channel, fieldname)
        setappdata(channel,fieldname,str2double(get(src,'String')));
        
        psfStd = getappdata(channel,'psfScale')*0.55*...
            getappdata(channel,'emWvlnth')/1000/...
            getappdata(channel,'NA')/1.17/2/...
            getappdata(channel,'pxSize');
        
        set(findobj(figOpt,'Tag','opticsButton', '-and', 'Enable', 'off'),...
            'String', num2str(psfStd,'%.2f'));
        setappdata(channel, 'psfStd', psfStd)
    end

    function changeTrackLinewidth(src, event, fig)
        setappdata(fig,'trackWidth', str2double(get(src,'String')));
        set(findobj(fig,'Type','Line'),'LineWidth', getappdata(fig,'trackWidth'))
    end
    function changeTrackColorcode(src,event,fig)
        switch get(src,'value')
            case 1
                setappdata(fig,'trackColorMode',1)
                color = getappdata(fig,'trackColor');
                set(findobj(fig,'Type','Line'),'Color',...
                    color{1});
            case 2
                setappdata(fig,'trackColorMode',2)
                color = getappdata(fig,'trackColor');
                set(findobj(fig,'Type','Line'),{'Color'},...
                    mat2cell(color{2},...
                    ones(getappdata(fig,'nTracks'),1),3));
        end %switch
    end
    function changeTrackColor(src, event, fig)
        if getappdata(fig,'trackColorMode') == 1
            color = getappdata(fig,'trackColor');
            colorNew = colorui(color{1}, 'Track Color');
            if numel(colorNew) > 1
                color{1} = colorNew;
                setappdata(fig,'trackColor',color);
                set(src, 'BackgroundColor', colorNew);
                set(findobj(fig,'Type','Line'),'Color', colorNew)
            end %if
        end %if
    end
    function changeTracksize(src,event,fig,field)
        tracks = getappdata(fig,'tracks');
        tracksize = cellfun('size',tracks,1);
        
        if strcmp(field,'minTracksize')
            minTracksize = str2double(get(src,'String'));
            setappdata(fig,field,minTracksize)
            maxTracksize = getappdata(fig,'maxTracksize');
        else
            minTracksize = getappdata(fig,'minTracksize');
            maxTracksize = str2double(get(src,'String'));
            setappdata(fig,field,maxTracksize)
        end %if
        
        if isinf(maxTracksize)
            hasSize = tracksize >= minTracksize;
        else
            hasSize = tracksize >= minTracksize &...
                tracksize <= maxTracksize;
        end %if
        hTracks = getappdata(fig,'hTracks');
        set(hTracks,'Visible','off')
        set(hTracks(hasSize),'Visible','on')
        
    end

    function saveSet(src, event)
        [optName,optPath,isOK] = uiputfile(...
            '.mat' ,'Save Profile to', getappdata(0,'searchPath'));
        if isOK
            setappdata(0,'searchPath', optPath)
            hEdit = get(findobj(figOpt,'Style', 'edit'), 'String');
            hCheck = get(findobj(figOpt,'Style', 'checkbox'), 'Value');
            hPopup = get(findobj(figOpt,'Style', 'popupmenu'), 'Value');
            save ([optPath optName], 'hEdit', 'hCheck', 'hPopup')
        else
            return
        end %if
    end
    function loadSet(src, event)
        [optName, optPath, isOK] = uigetfile(...
            '*.mat', 'Select Profile', getappdata(0,'searchPath'));
        if isOK
            setappdata(0,'searchPath', optPath)
            hEdit = []; hCheck = []; hPopup = [];
            load([optPath optName])
            set(findobj(figOpt,'Style', 'edit'), {'String'},hEdit)
            set(findobj(figOpt,'Style', 'checkbox'), {'Value'},hCheck)
            set(findobj(figOpt,'Style', 'popupmenu'), {'Value'}, hPopup)
        else
            return
        end %if
    end

    function adjustInputs(src,event)
        if get(src,'Value') < sliderPos
            slideVal = [0 5 0 0];
        else
            slideVal = [0 -6 0 0];
        end %if
        sliderPos = get(src,'Value');
        hList = findobj(figOpt,...
            'Style','Edit',...
            '-or','Style','Text',...
            '-or','Style','popupmenu',...
            '-or','Style','checkbox');
        oldPos = get(hList,'Position');
        newPos = cellfun(@(x) x+slideVal, oldPos, 'Un', 0);
        set(hList,{'Position'},newPos)
    end
    function setSpatialCorrPath(src,event,fig)
        if get(src,'Value')
            [tMatName, tMatPath, isOK] = uigetfile(...
                '*.mat', 'Select spatial Transformationmatrix',...
                getappdata(0,'searchPath'));
            if isOK
                tMat = [];
                load([tMatPath tMatName])
                setappdata(fig,'spatialCorrection',1)
                setappdata(fig,'tMat',tMat);
            end %if
        else
            setappdata(fig,'spatialCorrection',0)
            rmappdata(fig,'tMat');
        end %if
    end
end
function showCredits(src, event)
figure(...
    'Units','normalized',...
    'Position', [0.2 0.2 0.3 0.5],...
    'Color', get(0,'defaultUicontrolBackgroundColor'),...
    'Name', 'Credits',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'none',...
    'Resize', 'off');

text(0.5,0.8,...
    {'{\fontsize{12} Particle Localization:}',...
    '\copyright A. Serge, N. Bertaux,', 'H. Rigneault & D. Marguet',...
    '\bf Dynamic multiple-target tracing', 'to probe spatiotemporal',...
    'cartography of cell membranes', '\rm Nature Methods, Aug. 08'},...
    'Units','normalized', 'HorizontalAlignment', 'center',...
    'FontUnits', 'normalized');

text(0.5,0.5,...
    {'{\fontsize{12} Dynamic Convolution:}',...
    'M. Parent, T. Gould,', 'S.T. Hess'},...
    'Units','normalized', 'HorizontalAlignment', 'center',...
    'FontUnits', 'normalized');

text(0.5,0.35,...
    {'{\fontsize{12} kd-Tree & k-NN Search:}',...
    'A. Tagliasacchi'},...
    'Units','normalized', 'HorizontalAlignment', 'center',...
    'FontUnits', 'normalized');

text(0.5,0.1, {'{\fontsize{12} written by C.P.Richter}',...
    'Division of Biophysics / Group Piehler', 'University of Osnabrueck'},...
    'Units','normalized', 'HorizontalAlignment', 'center',...
    'FontUnits', 'normalized');

axis off
end
function showChangeLog(src, event)
fig =...
    figure(...
    'Units','normalized',...
    'Position', [0.2 0.2 0.5 0.5],...
    'Color', get(0,'defaultUicontrolBackgroundColor'),...
    'Name', 'Changelog',...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'none',...
    'Resize', 'off');
hList =...
    uicontrol(...
    'Style', 'listbox',...
    'Parent', fig,...
    'Units','normalized',...
    'Position', [0.1 0.1 0.8 0.8],...
    'FontSize', 10,...
    'FontUnits', 'normalized',...
    'FontWeight', 'bold',...
    'BackgroundColor', [1 1 1]);

set(hList, 'String',...
    {'1.101b',...
    '-batch processing of stacks',...
    '-2D and 3D scatterplot',...
    '-fixed calculation of loc. Prec.',...
    '',...
    '1.012b',...
    '-improved trajectory integration',...
    '',...
    '1.012a',...
    '-support for Hess FPALM restored',...
    '-added spatial correction after localization',...
    '-added compatibility mode for older SLIMfast builds',...
    '-counts2photon conversion factor fixed',...
    '-bugfix roi+expansion factor',...
    '',...
    '1.011c',...
    '-adjustable multicore mode',...
    '-z-Projection (max. & mean Intensity)',...
    '',...
    '1.011b',...
    '-localization parallelized',...
    '',...
    '1.011a',...
    '-improved colorID (gradually shading childs)',...
    '-lenghtstring added to scalebar',...
    '',...
    '1.010g',...
    '-density threshold by data clustering',...
    '',...
    '1.010f',...
    '-dualView mode enabled (movie)',...
    '-tripleView mode enabled (movie)',...
    '-colormaps for polyview improved',...
    '-scalebar moved to north-east',...
    '',...
    '1.010e',...
    '-sync ROI between channels',...
    '-tripleView mode enabled (image)',...
    '',...
    '1.010d',...
    '-load/save options profile (contextmenu on window)',...
    '-multiple fractions to intensity fit',...
    '(allows constraint mean intensities)',...
    '-options window on/off togglebutton',...
    '-changelog added',...
    '',...
    '1.010c',...
    '-colorcode for associated windows',...
    '-buttons to manipulate roi (contextmenu on roi)',...
    '-accumulative movie option',...
    '-fixed convolutionkernel effected by Int.Weight and SizeFactor',...
    '-imagestack locking into free channel (fixed)',...
    '-dualView mode enabled (image)',...
    '',...
    '1.010b',...
    '-next/previous frame on superstack (fixed)',...
    '-analysis histograms relate to roi and framerange',...
    '-Signal to noise ratio thresholds for rendering',...
    '-abort localization at any time (Strg-Alt-S)',...
    '-ascii-export of current used options (Opt2Txt-Pushbutton)',...
    '-actual searchpath is set to last used directory',...
    '-check on loc.data name and possibility to overwrite',...
    '-save button if imagestack loaded (fixed)',...
    '-# rendered particles / total # particles added to windowtitles',...
    '(analysis histograms & rendered images)'})
end

function [imFig trackFig] = getSelectedFigHandles
varList = {...
    'menuRedChannel',...
    'menuGreenChannel',...
    'menuBlueChannel',...
    'menuGrayChannel',...
    'menuTrackChannel'};

rootFig = findobj(0,'Tag','root');

imFig = nan(4,1);
for ch = 1:4
    hList = allchild(findobj(rootFig,'Tag',varList{ch}));
    isChecked = strcmp(get(hList,'Checked'),'on');
    if any(isChecked)
        imFig(ch) = get(hList(isChecked),'UserData');
    end %if
end %for

hList = allchild(findobj(rootFig,'Tag',varList{5}));
isChecked = strcmp(get(hList,'Checked'),'on');
if any(isChecked)
    trackFig = get(hList(isChecked),'UserData');
    if iscell(trackFig)
        trackFig = cell2mat(trackFig);
    end %if
else
    trackFig = [];
end %if
end
function transferVarList(targetFig,srcFig,mode)
switch mode
    case 'render-mono'
        varList = {...
            'isOwn',...
            'isLoaded',...
            'isSuperstack',...
            'isTrack',...
            'frame',...
            'viewMode',...
            'locStart',...
            'locEnd',...
            'errorRate',...
            'w2d',...
            'dfltnLoops',...
            'minInt',...
            'locParallel',...
            'nCores',...
            'spatialCorrection',...
            'isRadiusTol',...
            'radiusTol',...
            'posTol',...
            'maxOptimIter',...
            'termTol',...
            'isScalebar',...
            'micronBarLength',...
            'isColormap',...
            'colormapWidth',...
            'isTimestamp',...
            'timestampSize',...
            'timestampInkrement',...
            'clusterMode',...
            'exfOld',...
            'exfNew',...
            'rW',...
            'rStep',...
            'rStart',...
            'rEnd',...
            'rLive',...
            'fps',...
            'movCompression',...
            'convMode',...
            'intWeight',...
            'sizeFac',...
            'isCumsum',...
            'isThreshLocPrec',...
            'minLoc',...
            'maxLoc',...
            'isThreshSNR',...
            'minSNR',...
            'maxSNR',...
            'isThreshDensity',...
            'pxSize',...
            'cntsPerPhoton',...
            'emWvlnth',...
            'NA',...
            'psfScale',...
            'psfStd',...
            'imageName',...
            'pathname',...
            'filename',...
            'width',...
            'height',...
            'roiX0',...
            'roiY0',...
            'roi',...
            'hROI',...
            'intensityRange',...
            'ctrsN'};
        for var = 1:numel(varList)
            setappdata(targetFig,varList{var},...
                getappdata(srcFig,varList{var}))
        end %for
        
    case 'merge'
        varList = {...
            'pxSize',...
            'isScalebar',...
            'micronBarLength',...
            'isColormap',...
            'colormapWidth',...
            'isTimestamp',...
            'timestampSize',...
            'timestampInkrement',...
            'exfNew',...
            'rStep',...
            'fps',...
            'movCompression'};
        for var = 1:numel(varList)
            val = [];
            for ch = 1:numel(srcFig)
                val(ch) =...
                    getappdata(srcFig(ch),varList{var});
            end %for
            if isequal(val,circshift(val,[0 1]))
                setappdata(targetFig,varList{var},val(1))
            else
                answer = inputdlg(...
                    {sprintf('%s not equal between Channels',varList{var})},...
                    'set new Value');
                setappdata(targetFig,varList{var},str2double(answer{1}))
            end %if
        end %for
end %switch
end
function data = preprocessData(fig,returnValue,roi)
varNames = {'ctrsX', 'ctrsY', 'signal', 'noise', 'offset', 'radius', 'frame',...
    'photons', 'precision', 'snr', 'sbr', 'cluster'};

%define data to load
loadValue = returnValue(1:7);
if returnValue(3); loadValue(6) = true; end
if returnValue(8); loadValue([3 6]) = true; end
if returnValue(9); loadValue([3 4 6]) = true; end
if returnValue(10); loadValue([3 4 6]) = true; end
if returnValue(11); loadValue([3 5]) = true; end
if returnValue(12) || getappdata(fig,'isThreshDensity');...
        loadValue([1 2 6 7]) = true; end
if getappdata(fig,'isThreshSNR') || getappdata(fig,'isThreshLocPrec');...
        loadValue([3 4 6]) = true; end
if ~isempty(getappdata(fig,'hROI')); loadValue([1 2]) = true; end

%load data from disk
for value = find(loadValue(1,:))
    if loadValue(1,value)
        fid = fopen([getappdata(fig,'pathname') getappdata(fig,'filename') '.' varNames{value}], 'r');
        if isinf(getappdata(fig,'elements')) %load complete list
            data.(varNames{value}) = fread(fid,inf,'real*8');
        else
            fseek(fid, getappdata(fig,'startPnt')*8, 'bof');
            data.(varNames{value}) = fread(fid,getappdata(fig,'elements'),'real*8');
        end %if
    end %if
    fclose(fid);
end %for

%remove points outside of ROI
if loadValue(1) && loadValue(2)
    good =...
        data.(varNames{1}) > roi(1) &...
        data.(varNames{1}) < roi(1)+roi(3) &...
        data.(varNames{2}) > roi(2) &...
        data.(varNames{2}) < roi(2)+roi(4);
    
    for value = find(loadValue)
        data.(varNames{value}) = data.(varNames{value})(good);
    end %for
end %if

if loadValue(3)
    %volume [photons]
    data.photons = data.(varNames{3})*2*pi.*data.(varNames{6}).^2/...
        getappdata(fig,'cntsPerPhoton'); %[photons]
    
    %calculate loc. prec.
    if returnValue(9) || getappdata(fig,'isThreshLocPrec')
        data.precision = calcLocPrecision(...
            data.radius, getappdata(fig,'pxSize'),...
            data.photons, data.(varNames{4})/getappdata(fig,'cntsPerPhoton')); %[?m]
    end %if
    
    %calculate snr
    if returnValue(10) || getappdata(fig,'isThreshSNR')
        data.snr = data.signal./data.noise;
    end %if
    
    %calculate sbr
    if returnValue(11)
        data.sbr = data.signal./data.offset;
    end %if
    
    %apply loc. prec. or snr threshold if selected
    if getappdata(fig,'isThreshLocPrec') || getappdata(fig,'isThreshSNR')
        if getappdata(fig,'isThreshLocPrec') && getappdata(fig,'isThreshSNR')
            good = data.precision > getappdata(fig,'minLoc')/1000 &...
                data.precision < getappdata(fig,'maxLoc')/1000 &...
                data.snr > getappdata(fig,'minSNR') &...
                data.snr < getappdata(fig,'maxSNR');
        elseif getappdata(fig,'isThreshLocPrec') && ~getappdata(fig,'isThreshSNR')
            good = data.precision > getappdata(fig,'minLoc')/1000 &...
                data.precision < getappdata(fig,'maxLoc')/1000;
        elseif ~getappdata(fig,'isThreshLocPrec') && getappdata(fig,'isThreshSNR')
            good = data.snr > getappdata(fig,'minSNR') &...
                data.snr < getappdata(fig,'maxSNR');
        end %if
        for value = find([loadValue 0 0 0 0 0] | returnValue)
            if isfield(data,(varNames{value}))
                data.(varNames{value}) = data.(varNames{value})(good);
            end %if
        end
    end %if
end %if

%apply density threshold if selected
if getappdata(fig,'isThreshDensity') || returnValue(12)
    if ~all([isappdata(fig,'clusterScore'),...
            isappdata(fig,'clusterRadius'),...
            isappdata(fig,'clusterWeights')])
        [data,tree,clusterScore,...
            clusterRadius,clusterWeights] =...
            densitybasedClustering(data);
        kdtree_delete(tree)
        
        setappdata(fig,'clusterScore',clusterScore)
        setappdata(fig,'clusterRadius',clusterRadius)
        setappdata(fig,'clusterWeights',clusterWeights)
        setappdata(fig,'cluster',data.cluster)
        
        for value = find([loadValue 0 0 0 0 0] | returnValue)
            if getappdata(fig,'clusterMode') == 1
                data.(varNames{value}) = data.(varNames{value})(data.cluster > 0);
            else
                data.(varNames{value}) = data.(varNames{value})(data.cluster == 0);
            end %if
        end %for
    else
        cluster = getappdata(fig,'cluster');
        if getappdata(fig,'startPnt') == 0
            startPnt = 1;
        else
            startPnt = getappdata(fig,'startPnt');
        end %if
        if isinf(getappdata(fig,'elements'))
            good = startPnt:numel(cluster);
        else
            good = startPnt:startPnt+getappdata(fig,'elements')-1;
        end %if
        for value = find([loadValue 0 0 0 0 0] | returnValue)
            if getappdata(fig,'clusterMode') == 1
                data.(varNames{value}) = data.(varNames{value})...
                    (cluster(good) > 0);
            else
                data.(varNames{value}) = data.(varNames{value})...
                    (cluster(good) == 0);
            end %if
        end %for
    end %if
end %if

%remove unnecessary variables
for value = find(~returnValue);
    if isfield(data,varNames{value})
        data = rmfield(data,varNames{value});
    end %if
end %for

    function precision =...
            calcLocPrecision(psfStd, pxSize, photons, noise)
        %calculates the localization uncertainty based on
        %   psfStd, pxSize, photons, noise. (Thompson and Webb)
        
        psfStd = psfStd*pxSize; % px -> ?m
        precision = sqrt((psfStd.^2+pxSize^2/12)./photons+...
            8*pi.*psfStd.^4.*noise.^2/pxSize^2./photons.^2); %[?m]
    end
end
function exportSettings(src, event, visMode)
fig = gcbf;

[filename,pathname,isOK] =...
    uiputfile('.txt' ,'Save to', getappdata(0,'searchPath'));
if isOK
    setappdata(0,'searchPath',pathname)
    fid = fopen([pathname filename], 'wt');
    
    fprintf(fid, 'Filename: %s \n',...
        [getappdata(fig,'pathname') getappdata(fig,'filename') '.mat']);
    if getappdata(fig,'isSuperstack')
        for idx = 1:numel(getappdata(fig,'imageName'))
            imageName = getappdata(fig,'imageName');
            fprintf(fid, 'Imagename: %s \n', imageName{idx});
        end %for
    else
        fprintf(fid, 'Imagename: %s \n', getappdata(fig,'imageName'));
    end
    fprintf(fid, 'Created: %s \n', datestr(clock));
    
    fprintf(fid, '\n Optics Options: \n');
    fprintf(fid,'Pixelsize [?m] = %g \n', getappdata(fig,'pxSize'));
    fprintf(fid,'Numerical Aperture = %g \n', getappdata(fig,'NA'));
    fprintf(fid,'Emission Wavelength [nm] = %g \n', getappdata(fig,'emWvlnth'));
    fprintf(fid,'PSF Scaling Factor = %g \n', getappdata(fig,'psfScale'));
    fprintf(fid,'PSF [px] = %g \n', getappdata(fig,'psfStd'));
    fprintf(fid,'Counts/Photon = %g \n', getappdata(fig,'cntsPerPhoton'));
    
    fprintf(fid, '\n Localization Options: \n');
    fprintf(fid,'Framerange = %g to %g \n', getappdata(fig,'locStart'), getappdata(fig,'locEnd'));
    fprintf(fid,'ErrorRate [10^] = %g \n', getappdata(fig,'errorRate'));
    fprintf(fid,'Detectionbox [px] = %g \n', getappdata(fig,'w2d'));
    fprintf(fid,'# of Deflationloops = %g \n', getappdata(fig,'dfltnLoops'));
    fprintf(fid,'Intensity Threshold [Photons] = %g \n', getappdata(fig,'minInt'));
    
    fprintf(fid, '\n Rendering Options: \n');
    fprintf(fid,'Framerange = %g to %g \n', getappdata(fig,'rStart'), getappdata(fig,'rEnd'));
    fprintf(fid,'Expansion Factor = %g \n', getappdata(fig,'exfNew'));
    switch getappdata(fig,'convMode')
        case 2
            fprintf(fid,'Rendering Method = dynamic convolution \n');
        case 1
            fprintf(fid,'Rendering Method = fixed convolution \n');
    end %if
    fprintf(fid,'Intensity Weighting Factor = %g \n', getappdata(fig,'intWeight'));
    fprintf(fid,'Size Factor (times Loc. Prec.) = %g \n', getappdata(fig,'sizeFac'));
    
    switch visMode
        case 'Image'
            fprintf(fid,'Visualization Method = Image \n');
        case 'Movie'
            fprintf(fid,'Visualization Method = Movie \n');
            fprintf(fid,'Windowsize = %g \n', getappdata(fig,'rW'));
            fprintf(fid,'Stepsize = %g \n', getappdata(fig,'rStep'));
            fprintf(fid,'Frames/Second = %g \n', getappdata(fig,'fps'));
            switch getappdata(fig,'movCompression')
                case 1
                    fprintf(fid,'Compression Algorithm = RLE \n');
                case 2
                    fprintf(fid,'Compression Algorithm = MSVL \n');
                case 3
                    fprintf(fid,'Compression Algorithm = no Compression \n');
            end %switch
    end %switch
    
    fprintf(fid, '\n Filter Options: \n');
    fprintf(fid,'Localization Precision = %g \n',...
        getappdata(fig,'isThreshLocPrec'))
    fprintf(fid,'Filter Range = %g to %g \n',...
        getappdata(fig,'minLoc'), getappdata(fig,'maxLoc'));
    
    fprintf(fid,'Signal to Noise Ratio = %g \n',...
        getappdata(fig,'isThreshSNR'))
    fprintf(fid,'Filter Range = %g to %g \n',...
        getappdata(fig,'minSNR'), getappdata(fig,'maxSNR'));
    
    fclose(fid);
end
end

function [data,tree,score,radius,sigma] = densitybasedClustering(data)
fig =...
    figure(...
    'Units','normalized',...
    'Position', [0.1 0.2 0.8 0.6],...
    'NumberTitle', 'off',...
    'MenuBar', 'none',...
    'ToolBar', 'figure',...
    'Resize', 'on',...
    'DockControls', 'off',...
    'Name', 'Densitybased Clustering',...
    'Renderer','zbuffer',...
    'Color', get(0,'defaultUicontrolBackgroundColor'));

%customize toolbar
hToolBar = findall(fig,'Type','uitoolbar');
hToggleList = findall(hToolBar);
delete(hToggleList([2 3 4 5 6 7 8 10 13 14 15 16 17 18]))

ax(1) =...
    axes(...
    'Parent', fig,...
    'Units','normalized',...
    'OuterPosition', [0 0 0.7 1],...
    'Box','on');
ax(2) =...
    axes(...
    'Parent', fig,...
    'Units','normalized',...
    'Position', [0.69 0.84 0.3 0.08]);

ax(3) =...
    axes(...
    'Parent', fig,...
    'Units','normalized',...
    'Position', [0.69 0.7 0.3 0.08]);

ax(4) =...
    axes(...
    'Parent', fig,...
    'Units','normalized',...
    'Position', [0.69 0.56 0.3 0.08]);

ax(5) =...
    axes(...
    'Parent', fig,...
    'Units','normalized',...
    'Position', [0.69 0.42 0.3 0.08]);


% ax(4) =...
%     axes(...
%     'Parent', fig,...
%     'Units','normalized',...
%     'Position', [0.7 0.41 0.29 0.15],...
%     'XTickLabel','',...
%     'YTickLabel','');


uicontrol(...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.7 0.26 0.1 0.05],...
    'FontSize', 13,...
    'FontUnits', 'normalized',...
    'String', 'Scale(x,y,z):',...
    'HorizontalAlignment', 'left');
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN scalex',...
    'Units','normalized',...
    'Position', [0.8 0.26 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN scaley',...
    'Units','normalized',...
    'Position', [0.85 0.26 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN scalez',...
    'Units','normalized',...
    'Position', [0.9 0.26 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '0.01',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'togglebutton',...
    'Units','normalized',...
    'Position', [0.95 0.26 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'lock',...
    'Callback', @lockScale);


uicontrol(...
    'Style', 'checkbox',...
    'Tag', 'DBSCAN isWeighted',...
    'Units','normalized',...
    'Position', [0.7 0.21 0.3 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'Value', 1,...
    'String', ' Set 3D-Gaussian Weights:',...
    'Callback', @activateWeights);
uicontrol(...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.7 0.16 0.15 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'Sigma(x,y,z):',...
    'HorizontalAlignment', 'left');
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN sigx',...
    'Units','normalized',...
    'Position', [0.85 0.16 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN sigy',...
    'Units','normalized',...
    'Position', [0.9 0.16 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN sigz',...
    'Units','normalized',...
    'Position', [0.95 0.16 0.05 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);


uicontrol(...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.7 0.11 0.15 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'min Score:',...
    'HorizontalAlignment', 'left');
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN score',...
    'Units','normalized',...
    'Position', [0.85 0.11 0.08 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1]);
uicontrol(...
    'Style', 'pushbutton',...
    'Units','normalized',...
    'Position', [0.93 0.11 0.07 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'critical',...
    'Callback', @evalCriticalScore);


uicontrol(...
    'Style', 'text',...
    'Units','normalized',...
    'Position', [0.7 0.06 0.15 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'Search Radius:',...
    'HorizontalAlignment', 'left');
uicontrol(...
    'Style', 'edit',...
    'Tag', 'DBSCAN radius',...
    'Units','normalized',...
    'Position', [0.85 0.06 0.08 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', '1',...
    'BackgroundColor', [1 1 1],...
    'Enable', 'off');
uicontrol(...
    'Style', 'popupmenu',...
    'Tag', 'DBSCAN units',...
    'Units','normalized',...
    'Position', [0.93 0.06 0.07 0.05],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', {'px', 'nm'},...
    'Value', 1,...
    'BackgroundColor', [1 1 1],...
    'Enable', 'off');

uicontrol(...
    'Style', 'pushbutton',...
    'Units','normalized',...
    'Position', [0.8 0 0.1 0.06],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'evaluate',...
    'Callback', @evalDensity);
% uicontrol(...
%     'Style', 'pushbutton',...
%     'Units','normalized',...
%     'Position', [0.8 0 0.1 0.06],...
%     'FontSize', 15,...
%     'FontUnits', 'normalized',...
%     'String', 'preview',...
%     'Callback', @showClusterPreview);
uicontrol(...
    'Style', 'pushbutton',...
    'Units','normalized',...
    'Position', [0.9 0 0.1 0.06],...
    'FontSize', 15,...
    'FontUnits', 'normalized',...
    'String', 'accept',...
    'Callback', @accept);

pnts = numel(data.ctrsX);
rescaled = struct('ctrsX',[],'ctrsY',[],'frame',[]);
drawnow
uiwait(fig)

    function activateWeights(src,event)
        switch get(src,'Value')
            case 1
                set(findobj(fig,'Tag','DBSCAN sigx',...
                    '-or','Tag','DBSCAN sigy','-or','Tag','DBSCAN sigz'),...
                    'Enable','on')
                set(findobj(fig,'Tag','DBSCAN radius',...
                    '-or','Tag','DBSCAN units'),'Enable','off')
            case 0
                set(findobj(fig,'Tag','DBSCAN sigx',...
                    '-or','Tag','DBSCAN sigy','-or','Tag','DBSCAN sigz'),...
                    'Enable','off')
                set(findobj(fig,'Tag','DBSCAN radius',...
                    '-or','Tag','DBSCAN units'),'Enable','on')
        end %switch
    end
    function lockScale(src,event)
        hScaleX = findobj(fig,'Tag','DBSCAN scalex');
        hScaleY = findobj(fig,'Tag','DBSCAN scaley');
        hScaleZ = findobj(fig,'Tag','DBSCAN scalez');
        
        if get(src,'Value')
            cla(ax(1),'reset'); set(ax(1),'UserData',[],'Box','on')
            hMsg =...
                text(0.5,0.5,...
                {'Please wait...',...
                'this may take approximatly',...
                [num2str(2e-10*pnts^2.14,'%.0f') ' seconds to finish'],...
                '(building kd-tree)'},...
                'Parent', ax(1),...
                'Units', 'normalized',...
                'FontSize', 25,...
                'FontUnits', 'normalized',...
                'HorizontalAlignment', 'center');
            drawnow
            
            %rescale data dimensions
            rescaled.ctrsX = str2double(get(hScaleX,'String'))*data.ctrsX;
            rescaled.ctrsY = str2double(get(hScaleY,'String'))*data.ctrsY;
            rescaled.frame = str2double(get(hScaleZ,'String'))*data.frame;
            
            set([hScaleX hScaleY hScaleZ],'Enable','off')
            
            if isappdata(fig,'tree')
                kdtree_delete(tree) %free memory from old tree
                rmappdata(fig,'tree')
            end %if
            tree = kdtree_build([rescaled.ctrsX rescaled.ctrsY rescaled.frame]);
            setappdata(fig,'tree',tree)
            
            if get(findobj(fig,'Tag','DBSCAN isWeighted'),'Value')
                sigma = [str2double(get(findobj(fig,'Tag','DBSCAN sigx'),'String')),...
                    str2double(get(findobj(fig,'Tag','DBSCAN sigy'),'String')),...
                    str2double(get(findobj(fig,'Tag','DBSCAN sigz'),'String'))];
                radius = 3*max(sigma);
            else
                sigma = [];
                radius = str2double(get(findobj(fig,'Tag','DBSCAN radius'),'String'));
            end %if
            
            delete(hMsg)
        else
            set([hScaleX hScaleY hScaleZ],'Enable','on')
        end %if
    end
    function evalDensity(src,event)
        if get(findobj(fig,'Tag','DBSCAN isWeighted'),'Value')
            sigma = [str2double(get(findobj(fig,'Tag','DBSCAN sigx'),'String')),...
                str2double(get(findobj(fig,'Tag','DBSCAN sigy'),'String')),...
                str2double(get(findobj(fig,'Tag','DBSCAN sigz'),'String'))];
            radius = 3*max(sigma);
        else
            sigma = [];
            radius = str2double(get(findobj(fig,'Tag','DBSCAN radius'),'String'));
        end %if
        score = str2double(get(findobj(fig,'Tag','DBSCAN score'),'String'));
        
        %perform cluster analysis
        tree = getappdata(fig,'tree');
        [data.cluster data.clusterClass data.densityScore] =...
            dbscan(tree,rescaled.ctrsX,rescaled.ctrsY,...
            rescaled.frame,score,radius,sigma);
        nBins = calcnbins(data.densityScore,'fd');
        
        clusterSize = accumarray(data.cluster+1,1);
        clusterScore = accumarray(data.cluster+1,data.densityScore);
        meanClusterScore = clusterScore./clusterSize;
        
        cla(ax(2))
        set(ax(2),'NextPlot','add')
        [freq bin] = hist(clusterSize(2:end),nBins);
        bar(ax(2),bin,freq,'hist')
        try
            fitHalfLife = fit(bin',freq','exp1');
            y = feval(fitHalfLife,bin);
            hold on
            plot(ax(2),bin,y,'Color',[1 0 0],'Linewidth',2)
            legend(ax(2),'Cluster Size',...
                sprintf('Average Life Time ~ %.0f',-1/fitHalfLife.b))
        catch
            legend(ax(2),'Cluster Size')
        end
        
        cla(ax(3))
        [freq bin] = hist(clusterScore,nBins);
        bar(ax(3),bin,freq,'hist')
        legend(ax(3),'Cluster Score')
        
        cla(ax(4))
        [freq bin] = hist(meanClusterScore,nBins);
        bar(ax(4),bin,freq,'hist')
        legend(ax(4),'Average Cluster Score')
        
        cla(ax(5))
        [freq bin] = hist(data.densityScore,nBins);
        bar(ax(5),bin,freq,'hist')
        legend(ax(5),'Point Score')
        
        
        title(ax(1),sprintf('%d clusters (%.2f %%noise)',...
            max(data.cluster),clusterSize(1)/pnts*100))
        
        %plot result
        if isempty(get(ax(1),'UserData'))
            hPatch = presentResult([]);
            set(ax(1),'UserData',hPatch)
        else
            presentResult(get(ax(1),'UserData'));
        end %if
        
        function hPatch = presentResult(hPatch)
            if isempty(hPatch)
                hScaleX = findobj(fig,'Tag','DBSCAN scalex');
                hScaleY = findobj(fig,'Tag','DBSCAN scaley');
                hScaleZ = findobj(fig,'Tag','DBSCAN scalez');
                
                x = [1 0; 1 1; 1 0; 1 -1; 1 0; 1 0]*...
                    [rescaled.ctrsX,str2double(get(hScaleX,'String'))*data.radius]';
                y = [1 0; 1 0; 1 1; 1 0; 1 -1; 1 0]*...
                    [rescaled.ctrsY,str2double(get(hScaleY,'String'))*data.radius]';
                z = [1 1; 1 0; 1 0; 1 0; 1 0; 1 -1]*...
                    [rescaled.frame,str2double(get(hScaleZ,'String'))*data.radius]';
                vertices = [x(:) y(:) z(:)];
                
                faceIdx = repmat([1 2 3; 1 3 4; 1 4 5; 1 5 2;...
                    6 2 3; 6 3 4; 6 4 5; 6 5 2],pnts,1);
                face = reshape(repmat(0:6:6*(pnts-1),24,1),[3 pnts*8]);
                face = faceIdx+face';
                
                color = [[1 1 1]; rand(max(data.cluster),3)];
                cIdx = reshape(repmat((data.cluster+1)',8,1),[1 8*pnts]);
                
                if 1
                    hPatch = patch('Faces',face(cIdx>1,:),'Vertices',vertices,...
                        'FaceVertexCData', color(cIdx(cIdx>1),:),...
                        'FaceColor', 'flat','UserData',face,'Parent',ax(1));
                else
                    hPatch = patch('Faces',face,'Vertices',vertices,...
                        'FaceVertexCData', color(cIdx,:),...
                        'FaceColor', 'flat','Parent', ax(1));
                end
                
                view(ax(1),-37.5,30)
                axis (ax(1),'vis3d','tight')
            else
                color = [[1 1 1]; rand(max(data.cluster),3)];
                cIdx = reshape(repmat((data.cluster+1)',8,1),[1 8*pnts]);
                if 1
                    face = get(hPatch,'UserData');
                    set(hPatch,'Faces',face(cIdx>1,:),...
                        'FaceVertexCData', color(cIdx(cIdx>1),:));
                else
                    set(hPatch,'FaceVertexCData', color(cIdx,:))
                end %if
            end %if
        end
    end
    function accept(src, event)
        if isappdata(fig,'tree')
            kdtree_delete(tree) %free memory from tree
            rmappdata(fig,'tree')
        end %if
        
        delete(gcbf)
    end
    function evalCriticalScore(src,event)
        samplesize = pnts;
        range = [min(data.ctrsX) max(data.ctrsX)...
            min(data.ctrsY) max(data.ctrsY)...
            min(data.frame) max(data.frame)];
        
        vals = inputdlg(...
            {'# Monte Carlo Simulations',...
            'Significance Level (alpha)'},...
            'Settings',...
            1,...
            {'10','0.001'});
        
        if get(findobj(fig,'Tag','DBSCAN isWeighted'),'Value')
            sigma = [str2double(get(findobj(fig,'Tag','DBSCAN sigx'),'String')),...
                str2double(get(findobj(fig,'Tag','DBSCAN sigy'),'String')),...
                str2double(get(findobj(fig,'Tag','DBSCAN sigz'),'String'))];
            radius = 3*max(sigma);
        else
            sigma = [];
            radius = str2double(get(findobj(fig,'Tag','DBSCAN radius'),'String'));
        end %if
        
        
        estimateCriticalScore(...
            [],[],str2double(vals{2}),samplesize,...
            range,str2double(vals{1}),sigma,radius);
        
        function criticalScore =...
                estimateCriticalScore(...
                tree,data,alpha,samplesize,range,iter,sigma,radius)
            if isempty(tree)
                auto = 1;
            end %if
            
            criticalScore = nan(iter,1);
            for test = 1:iter
                testpoints = [unifrnd(range(1),range(2),[samplesize 1])...
                    unifrnd(range(3),range(4),[samplesize 1])...
                    round(unifrnd(range(5),range(6),[samplesize,1]))];
                if auto
                    tree = kdtree_build(testpoints);
                    data.ctrsX = testpoints(:,1);
                    data.ctrsY = testpoints(:,2);
                    data.frame = testpoints(:,3);
                end %if
                
                if isempty(sigma)
                    applyWeight = false;
                else
                    applyWeight = true;
                end %if
                
                for p = 1:samplesize
                    ref = testpoints(p,:);
                    iNN = kdtree_ball_query(tree, ref, radius);
                    iNN(iNN == p) = [];
                    if applyWeight
                        score(p) = nansum(...
                            exp(-((data.ctrsX(iNN)-ref(1)).^2/2/sigma(1)+...
                            (data.ctrsY(iNN)-ref(2)).^2/2/sigma(2)+...
                            (data.frame(iNN)-ref(3)).^2/2/sigma(3))));
                    else
                        score(p) = numel(iNN);
                    end %if
                end %for
                [pScore score] = ecdf(score);
                criticalScore(test) = score(find(pScore >= 1-alpha, 1, 'first'));
            end %for
            criticalScore = mean(criticalScore);
            set(findobj(fig,'Tag','DBSCAN score'),'String', criticalScore)
        end
    end

end
function [clusterID pntClass pntScore] = dbscan(tree,x,y,t,criticalScore,radius,sigma)
%DBSCAN (Density-Based Spatial Clustering of Applications with Noise)
%is a data clustering algorithm proposed by Martin Ester, Hans-Peter Kriegel,
%J?rg Sander and Xiaowei Xu in 1996.

%written by C.P.Richter, 2010.10.25
if isempty(sigma)
    applyWeight = false;
else
    applyWeight = true;
end %if

pnts = sum(isfinite(x));
clusterID = nan(pnts,1); %unclassified
pntClass = zeros(pnts,1);
pntScore = clusterID;

cluster = 1;
for idx = 1:pnts
    pnt = [x(idx,:) y(idx,:) t(idx,:)];
    if isnan(clusterID(idx))
        output = expandCluster;
        if output
            cluster = cluster+1;
        end %if
    end %if
end %for

pntClass(pntClass < 0 & clusterID > 0) = 0;

    function output = expandCluster
        [iNN score] = findNeighbors(pnt);
        pntScore(idx) = score;
        
        if score < criticalScore
            output = false;
            clusterID(idx) = 0;
            pntClass(idx) = -1; %noise
            
            return
        else
            output = true;
            clusterID(iNN) = cluster;
            pntClass(idx) = 1; %core point
            
            iNN(iNN == idx) = [];
            seeds = [x(iNN) y(iNN) t(iNN) iNN];
            while ~isempty(seeds)
                [iNN score] = findNeighbors(seeds(1,1:3));
                pntScore(seeds(1,4)) = score;
                if score >= criticalScore %core point
                    pntClass(seeds(1,4)) = 1; %core point
                    
                    iNN(iNN == seeds(1,4)) = [];
                    result = [x(iNN) y(iNN) t(iNN) iNN];
                    %check if points are already assigned to a cluster
                    %                     good = isnan(clusterID(iNN));
                    %                     seeds = [seeds; result(good,:)];
                    %                     clusterID(good) = cluster;
                    for N = 1:numel(iNN)
                        if isnan(clusterID(iNN(N)))
                            seeds(end+1,:) = result(N,:);
                            clusterID(iNN(N)) = cluster;
                        end %if
                    end %for
                end %if
                seeds(1,:) = [];
            end %while
        end %if
        
        function [iNN score] = findNeighbors(ref)
            
            iNN = kdtree_ball_query(tree, ref, radius);
            if applyWeight
                score = nansum(...
                    exp(-((x(iNN)-ref(1)).^2/2/sigma(1)+...
                    (y(iNN)-ref(2)).^2/2/sigma(2)+...
                    (t(iNN)-ref(3)).^2/2/sigma(3))))-1;
            else
                score = numel(iNN);
            end %if
        end
    end
end

function changeCheckMode(src, event)
if strcmp(get(src, 'Checked'),'on')
    set(src, 'Checked', 'off')
else
    hList = allchild(get(src, 'Parent'));
    set(hList, 'Checked', 'off')
    set(src, 'Checked', 'on')
end %if
end
function psf = buildPSF(sig, xw, yw)
psf = zeros(yw,xw);
w = ceil(6*sig); % 99% of gaussian
x = floor(xw/2-w/2);
y = floor(yw/2-w/2);
[X Y] = meshgrid(-w/2:w/2);
psf(y:y+w,x:x+w) = 1/(2*pi*sig^2)*...
    exp(-(X.^2+Y.^2)/(2*sig^2));
psf = fft2(psf); %translate to frequency space
end
function [ax, h] = buildHistogram(ax,data,unit)
[freq(:,1), ctrs] = ksdensity(data,...
    'npoints',calcnbins(data,'fd'),...
    'function', 'cdf');
freq(:,2) = hist(data,ctrs);

[ax, h(1) h(2)] = ...
    plotyy(ax,ctrs,freq(:,2),ctrs,freq(:,1),'bar','plot');
set(ax,'FontSize',20)
ylabel(ax(1),'Frequency')
ylabel(ax(2),'Cumulative Probability')
set(h(2),'color','r','linewidth', 3)

legend({sprintf(['\t min = %.0f ' unit...
    ' \n max = %.0f ' unit...
    '\n mean = %.0f ' unit...
    ' \n std = %.0f' unit],...
    min(ctrs),max(ctrs),mean(ctrs),std(ctrs)),'CDF'})

axis(ax(1), [min(ctrs) max(ctrs) min(freq(:,2)) max(freq(:,2))])
axis(ax(2), [min(ctrs) max(ctrs) min(freq(:,1)) max(freq(:,1))])
end
function string = pxChars(N,M,num,scaleFactor) %#ok
n_ = [...
    0 0;...
    0 0;...
    0 0;...
    0 0;...
    0 0] ;%#ok

np = [...
    0;...
    0;...
    0;...
    0;...
    1] ;%#ok

n0 = [...
    1 1 1;...
    1 0 1;...
    1 0 1;...
    1 0 1;...
    1 1 1] ;%#ok
n1 = [...
    0 1 0;...
    0 1 0;...
    0 1 0;...
    0 1 0;...
    0 1 0] ;%#ok
n2= [...
    1 1 1;...
    0 0 1 ;...
    1 1 1;...
    1 0 0;...
    1 1 1] ;%#ok
n3= [...
    1 1 1;...
    0 0 1 ;...
    0 1 1;...
    0 0 1;...
    1 1 1] ;%#ok
n4= [...
    1 0 1;...
    1 0 1 ;...
    1 1 1;...
    0 0 1;...
    0 0 1] ;%#ok
n5 = [...
    1 1 1;...
    1 0 0;...
    1 1 1;...
    0 0 1;...
    1 1 1] ;%#ok
n6= [...
    1 1 1;...
    1 0 0 ;...
    1 1 1;...
    1 0 1;...
    1 1 1] ;%#ok
n7 = [...
    1 1 1;...
    0 0 1;...
    0 1 0;...
    0 1 0;...
    0 1 0] ;%#ok
n8 = [...
    1 1 1;...
    1 0 1;...
    1 1 1;...
    1 0 1;...
    1 1 1] ;%#ok
n9 = [...
    1 1 1;...
    1 0 1;...
    1 1 1;...
    0 0 1;...
    1 1 1] ;%#ok

nA = [...
    0 1 1 1 0;...
    1 0 0 0 1;...
    1 1 1 1 1;...
    1 0 0 0 1;...
    1 0 0 0 1] ;%#ok

nB = [...
    1 1 1 1 0;...
    1 0 0 0 1;...
    1 1 1 1 0;...
    1 0 0 0 1;...
    1 1 1 1 0] ;%#ok

nC = [...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 0 0 0 0;...
    1 0 0 0 0;...
    1 1 1 1 1] ;%#ok

nD = [...
    1 1 1 1 0;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 1 1 1 0] ;%#ok

nE = [...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 1 1 1 1] ;%#ok

nF = [...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 0 0 0 0] ;%#ok

nG = [...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 0 1 1 1;...
    1 0 0 0 1;...
    1 1 1 1 1] ;%#ok

nH = [...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 1 1 1 1;...
    1 0 0 0 1;...
    1 0 0 0 1] ;%#ok

nI = [...
    0 1 1 1 0;...
    0 0 1 0 0;...
    0 0 1 0 0;...
    0 0 1 0 0;...
    0 1 1 1 0] ;%#ok

nJ = [...
    1 1 1 1 1;...
    0 0 0 0 1;...
    0 0 0 0 1;...
    1 0 0 0 1;...
    0 1 1 1 0] ;%#ok

nK = [...
    1 0 0 0 1;...
    1 0 0 1 0;...
    1 1 1 0 0;...
    1 0 0 1 0;...
    1 0 0 0 1] ;%#ok

nL = [...
    1 0 0 0 0;...
    1 0 0 0 0;...
    1 0 0 0 0;...
    1 0 0 0 0;...
    1 1 1 1 1] ;%#ok

nM = [...
    1 1 0 1 1;...
    1 0 1 0 1;...
    1 0 1 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1] ;%#ok

nN = [...
    1 0 0 0 1;...
    1 1 0 0 1;...
    1 0 1 0 1;...
    1 0 0 1 1;...
    1 0 0 0 1] ;%#ok

nO = [...
    0 1 1 1 0;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    0 1 1 1 0] ;%#ok

nP = [...
    1 1 1 1 0;...
    1 0 0 0 1;...
    1 1 1 1 0;...
    1 0 0 0 0;...
    1 0 0 0 0] ;%#ok

nQ = [...
    0 1 1 1 0;...
    1 0 0 0 1;...
    1 0 1 0 1;...
    1 0 0 1 0;...
    0 1 1 0 1] ;%#ok

nR = [...
    1 1 1 1 0;...
    1 0 0 0 1;...
    1 1 1 1 0;...
    1 0 0 1 0;...
    1 0 0 0 1] ;%#ok

nS = [...
    1 1 1 1 1;...
    1 0 0 0 0;...
    1 1 1 1 1;...
    0 0 0 0 1;...
    1 1 1 1 1] ;%#ok

nT = [...
    1 1 1 1 1;...
    0 0 1 0 0;...
    0 0 1 0 0;...
    0 0 1 0 0;...
    0 0 1 0 0] ;%#ok

nU = [...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    0 1 1 1 0] ;%#ok

nV = [...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 0 0 1;...
    0 1 0 1 0;...
    0 0 1 0 0] ;%#ok

nW = [...
    1 0 0 0 1;...
    1 0 0 0 1;...
    1 0 1 0 1;...
    1 0 1 0 1;...
    0 1 0 1 0] ;%#ok

nX = [...
    1 0 0 0 1;...
    0 1 0 1 0;...
    0 0 1 0 0;...
    0 1 0 1 0;...
    1 0 0 0 1] ;%#ok

nY = [...
    1 0 0 0 1;...
    0 1 0 1 0;...
    0 0 1 0 0;...
    0 0 1 0 0;...
    0 0 1 0 0] ;%#ok

nZ = [...
    1 1 1 1 1;...
    0 0 0 1 0;...
    0 0 1 0 0;...
    0 1 0 0 0;...
    1 1 1 1 1] ;%#ok

nm = [...
    0 0 0 0 0;...
    0 0 0 0 0;...
    0 1 0 1 0;...
    1 0 1 0 1;...
    1 0 1 0 1] ;%#ok

nn = [...
    0 0 0;...
    0 0 0;...
    0 1 0;...
    1 0 1;...
    1 0 1] ;%#ok

strnum = num2str(num) ;


string = eval(sprintf('imresize(n%s,scaleFactor)>0.5;', strnum(1)));
for c=2:size(strnum, 2)
    string = [string, zeros(5*scaleFactor,1),...
        eval(sprintf('imresize(n%s,scaleFactor)>0.5;', strnum(c)))];
end%for
end%function
function pos = figPos(ratio)
scrSize = get(0, 'ScreenSize');
if ratio > 1
    pos = [0.3 0.09...
        0.65*scrSize(4)/scrSize(3) 0.65/ratio];
elseif ratio < 1
    pos = [0.3 0.09...
        0.65*scrSize(4)/scrSize(3)*ratio 0.65];
else
    pos = [0.3 0.09...
        0.65*scrSize(4)/scrSize(3) 0.65];
end %if
end
function nbins = calcnbins(x, method, minimum, maximum)
% Calculate the "ideal" number of bins to use in a histogram, using a
% choice of methods.
%
% NBINS = CALCNBINS(X, METHOD) calculates the "ideal" number of bins to use
% in a histogram, using a choice of methods.  The type of return value
% depends upon the method chosen.  Possible values for METHOD are:
% 'fd': A single integer is returned, and CALCNBINS uses the
% Freedman-Diaconis method,
% based upon the inter-quartile range and number of data.
% See Freedman, David; Diaconis, P. (1981). "On the histogram as a density
% estimator: L2 theory". Zeitschrift f?r Wahrscheinlichkeitstheorie und
% verwandte Gebiete 57 (4): 453-476.

% 'scott': A single integer is returned, and CALCNBINS uses Scott's method,
% based upon the sample standard deviation and number of data.
% See Scott, David W. (1979). "On optimal and data-based histograms".
% Biometrika 66 (3): 605-610.
%
% 'sturges': A single integer is returned, and CALCNBINS uses Sturges'
% method, based upon the number of data.
% See Sturges, H. A. (1926). "The choice of a class interval". J. American
% Statistical Association: 65-66.
%
% 'middle': A single integer is returned.  CALCNBINS uses all three
% methods, then picks the middle (median) value.
%
% 'all': A structure is returned with fields 'fd', 'scott' and 'sturges',
% each containing the calculation from the respective method.
%
% NBINS = CALCNBINS(X) works as NBINS = CALCNBINS(X, 'MIDDLE').
%
% NBINS = CALCNBINS(X, [], MINIMUM), where MINIMUM is a numeric scalar,
% defines the smallest acceptable number of bins.
%
% NBINS = CALCNBINS(X, [], MAXIMUM), where MAXIMUM is a numeric scalar,
% defines the largest acceptable number of bins.
%
% Notes:
% 1. If X is complex, any imaginary components will be ignored, with a
% warning.
%
% 2. If X is an matrix or multidimensional array, it will be coerced to a
% vector, with a warning.
%
% 3. Partial name matching is used on the method name, so 'st' matches
% sturges, etc.
%
% 4. This function is inspired by code from the free software package R
% (http://www.r-project.org).  See 'Modern Applied Statistics with S' by
% Venables & Ripley (Springer, 2002, p112) for more information.
%
% 5. The "ideal" number of depends on what you want to show, and none of
% the methods included are as good as the human eye.  It is recommended
% that you use this function as a starting point rather than a definitive
% guide.
%
% 6. The wikipedia page on histograms currently gives a reasonable
% description of the algorithms used.
% See http://en.wikipedia.org/w/index.php?title=Histogram&oldid=232222820
%
% Examples:
% y = randn(10000,1);
% nb = calcnbins(y, 'all')
%    nb =
%             fd: 66
%          scott: 51
%        sturges: 15
% calcnbins(y)
%    ans =
%        51
% subplot(3, 1, 1); hist(y, nb.fd);
% subplot(3, 1, 2); hist(y, nb.scott);
% subplot(3, 1, 3); hist(y, nb.sturges);
% y2 = rand(100,1);
% nb2 = calcnbins(y2, 'all')
%    nb2 =
%             fd: 5
%          scott: 5
%        sturges: 8
% hist(y2, calcnbins(y2))
%
% See also: HIST, HISTX
%
% $ Author: Richard Cotton $		$ Date: 2008/10/24 $    $ Version 1.5 $

% Input checking
error(nargchk(1, 4, nargin));

if ~isnumeric(x) && ~islogical(x)
    error('calcnbins:invalidX', 'The X argument must be numeric or logical.')
end

if ~isreal(x)
    x = real(x);
    warning('calcnbins:complexX', 'Imaginary parts of X will be ignored.');
end

% Ignore dimensions of x.
if ~isvector(x)
    x = x(:);
    warning('calcnbins:nonvectorX', 'X will be coerced to a vector.');
end

nanx = isnan(x);
if any(nanx)
    x = x(~nanx);
    warning('calcnbins:nanX', 'Values of X equal to NaN will be ignored.');
end

if nargin < 2 || isempty(method)
    method = 'middle';
end

if ~ischar(method)
    error('calcnbins:invalidMethod', 'The method argument must be a char array.');
end

validmethods = {'fd'; 'scott'; 'sturges'; 'all'; 'middle'};
methodmatches = strmatch(lower(method), validmethods);
nmatches = length(methodmatches);
if nmatches~=1
    error('calnbins:unknownMethod', 'The method specified is unknown or ambiguous.');
end
method = validmethods{methodmatches};

if nargin < 3 || isempty(minimum)
    minimum = 1;
end

if nargin < 4 || isempty(maximum)
    maximum = Inf;
end

% Perform the calculation
switch(method)
    case 'fd'
        nbins = calcfd(x);
    case 'scott'
        nbins = calcscott(x);
    case 'sturges'
        nbins = calcsturges(x);
    case 'all'
        nbins.fd = calcfd(x);
        nbins.scott = calcscott(x);
        nbins.sturges = calcsturges(x);
    case 'middle'
        nbins = median([calcfd(x) calcscott(x) calcsturges(x)]);
end

% Calculation details
    function nbins = calcfd(x)
        h = diff(prctile0(x, [25; 75])); %inter-quartile range
        if h == 0
            h = 2*median(abs(x-median(x))); %twice median absolute deviation
        end
        if h > 0
            nbins = ceil((max(x)-min(x))/(2*h*length(x)^(-1/3)));
        else
            nbins = 1;
        end
        nbins = confine2range(nbins, minimum, maximum);
    end

    function nbins = calcscott(x)
        h = 3.5*std(x)*length(x)^(-1/3);
        if h > 0
            nbins = ceil((max(x)-min(x))/h);
        else
            nbins = 1;
        end
        nbins = confine2range(nbins, minimum, maximum);
    end

    function nbins = calcsturges(x)
        nbins = ceil(log2(length(x)) + 1);
        nbins = confine2range(nbins, minimum, maximum);
    end

    function y = confine2range(x, lower, upper)
        y = ceil(max(x, lower));
        y = floor(min(y, upper));
    end


    function y = prctile0(x, prc)
        % Simple version of prctile that only operates on vectors, and skips
        % the input checking (In particluar, NaN values are now assumed to
        % have been removed.)
        lenx = length(x);
        if lenx == 0
            y = [];
            return
        end
        if lenx == 1
            y = x;
            return
        end
        
        function foo = makecolumnvector(foo)
            if size(foo, 2) > 1
                foo = foo';
            end
        end
        
        sortx = makecolumnvector(sort(x));
        posn = prc.*lenx/100 + 0.5;
        posn = makecolumnvector(posn);
        posn = confine2range(posn, 1, lenx);
        y = interp1q((1:lenx)', sortx, posn);
    end
end
function [filenameNew, pathnameNew, flag] =...
    checkNameExistance(filename, pathname)
if exist([pathname filename],'file')
    answer = questdlg(...
        'Do you want to override existing File?', ...
        'Warning', ...
        'Yes', 'No', 'No');
    switch answer
        case 'Yes' %data will be replaced
            setappdata(0, 'searchPath', pathname)
            delete([pathname filename '.*'])
            
            pathnameNew = pathname;
            filenameNew = filename;
            flag = 0;
        case 'No'
            %loop until unoccupied filename is selected
            while 1
                [filename,pathname,isOK] =...
                    uiputfile('','Save to',...
                    [getappdata(0,'searchPath') filename]);
                if isOK && ~exist([pathname filename],'file')
                    setappdata(0, 'searchPath', pathname)
                    
                    pathnameNew = pathname;
                    filenameNew = filename;
                    flag = 0;
                    break
                elseif ~isOK
                    %abort file saving
                    flag = 1;
                end %if
            end %while
    end %switch
else
    pathnameNew = pathname;
    filenameNew = filename;
    flag = 0;
end %if
end
##### SOURCE END #####
--></body></html>